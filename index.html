<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PneumoCare Pro | Academic Pulmonary Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #003366 0%, #005b8e 100%);
            padding: 2rem;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #005b8e, #008c8c);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 800;
            color: #003366;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #64748b;
            font-size: 1rem;
        }

        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .role-btn {
            padding: 1.25rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: 150ms;
            text-align: center;
        }

        .role-btn:hover {
            border-color: #005b8e;
            background: #f1f5f9;
        }

        .role-btn.active {
            border-color: #005b8e;
            background: rgba(0, 91, 142, 0.1);
        }

        .role-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: #005b8e;
        }

        .role-name {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .role-desc {
            font-size: 0.85rem;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1e293b;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            font-size: 0.95rem;
            transition: 250ms;
        }

        .form-input:focus {
            outline: none;
            border-color: #005b8e;
            box-shadow: 0 0 0 3px rgba(0, 91, 142, 0.2);
        }

        .btn {
            background: #005b8e;
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.925rem;
            transition: 150ms;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            background: #003366;
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 91, 142, 0.2);
            border-radius: 50%;
            border-top-color: #005b8e;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #003366 0%, #004080 50%, #005b8e 100%);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .brand-text h1 {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: white;
        }

        .brand-text .subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
        }

        .sidebar-nav {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.25rem;
            border: none;
            background: none;
            border-radius: 12px;
            cursor: pointer;
            color: rgba(255,255,255,0.85);
            transition: 250ms;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.12);
            color: white;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: white;
            padding: 1.5rem 2.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-title h1 {
            font-size: 1.85rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: #1e293b;
        }

        .header-title .subtitle {
            color: #64748b;
            font-size: 0.925rem;
            font-weight: 500;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.625rem 0.875rem;
            border-radius: 12px;
            cursor: pointer;
            transition: 150ms;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 700;
            font-size: 0.925rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.95rem;
        }

        .content-area {
            padding: 2.5rem;
            flex: 1;
            background: #f8fafc;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.75rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-size: 1.35rem;
            font-weight: 700;
            color: #1e293b;
        }

        .card-content {
            padding: 2rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #005b8e, #008c8c);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: #005b8e;
            margin-bottom: 0.75rem;
            line-height: 1;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        /* Person Cards */
        .person-card {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 0.875rem;
        }

        .person-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #005b8e, #06b6d4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .person-avatar.resident {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-weight: 800;
            margin-bottom: 4px;
            color: #1e293b;
            font-size: 1.05rem;
        }

        .person-clinic {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .person-meta {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 2px;
            line-height: 1.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #005b8e;
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: 12px;
            z-index: 1001;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.875rem;
            max-width: 400px;
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }

        /* Buttons */
        .btn-sm {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            width: auto;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #005b8e;
            color: #005b8e;
        }

        .btn-outline:hover {
            background: #005b8e;
            color: white;
        }

        .btn-resident {
            background: #8b5cf6;
        }

        .btn-resident:hover {
            background: #7c3aed;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-warning {
            background: #f59e0b;
        }

        /* Badges */
        .resident-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 8px;
        }

        .badge-resident {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .badge-attending {
            background: rgba(0, 91, 142, 0.1);
            color: #005b8e;
        }

        /* Form elements */
        .form-select {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            font-size: 0.95rem;
            transition: 250ms;
        }

        .form-select:focus {
            outline: none;
            border-color: #005b8e;
            box-shadow: 0 0 0 3px rgba(0, 91, 142, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1.75rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .login-container {
                padding: 1rem;
            }
            
            .login-card {
                padding: 2rem;
            }
            
            .role-selector {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 100%;
                max-width: 320px;
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .content-header {
                padding: 1.25rem;
                flex-direction: column;
                gap: 1.25rem;
            }
            
            .content-area {
                padding: 1.5rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">
                        <i class="fas fa-lungs"></i>
                    </div>
                    <h1 class="login-title">PneumoCare Pro</h1>
                    <div class="login-subtitle">Academic Pulmonary Management System</div>
                </div>
                
                <div class="role-selector">
                    <div class="role-btn" :class="{ active: loginForm.role === 'resident_manager' }" 
                         @click="loginForm.role = 'resident_manager'">
                        <div class="role-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="role-name">Resident Manager</div>
                        <div class="role-desc">Manage residents, units, rotations</div>
                    </div>
                    
                    <div class="role-btn" :class="{ active: loginForm.role === 'department_head' }" 
                         @click="loginForm.role = 'department_head'">
                        <div class="role-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="role-name">Head of Department</div>
                        <div class="role-desc">Oversee department operations</div>
                    </div>
                </div>
                
                <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="loginForm.email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="loginForm.password" placeholder="Enter your password" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn" :disabled="loading">
                            <span v-if="loading" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-sign-in-alt"></i> 
                                Sign In as {{ loginForm.role === 'resident_manager' ? 'Resident Manager' : 'Head of Department' }}
                            </span>
                        </button>
                    </div>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                    <div style="font-size: 0.8rem; color: #64748b; text-align: center;">
                        <i class="fas fa-shield-alt"></i> HIPAA Compliant • System ID: PC-2024-001
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else>
            <!-- Mobile Menu Toggle (will be added later) -->
            <div class="app-container">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <div class="brand">
                            <div class="brand-logo">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="brand-text">
                                <h1>PneumoCare Pro</h1>
                                <div class="subtitle">ACADEMIC PULMONARY v4.0</div>
                            </div>
                        </div>
                    </div>
                    
                    <nav class="sidebar-nav">
                        <!-- Resident Manager Features -->
                        <div v-if="currentUser.user_role === 'resident_manager'">
                            <button class="nav-item" :class="{ active: currentView === 'residents' }" 
                                    @click="switchView('residents')">
                                <i class="fas fa-user-graduate"></i>
                                <span>Residents</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'clinical_units' }" 
                                    @click="switchView('clinical_units')">
                                <i class="fas fa-hospital-alt"></i>
                                <span>Clinical Units</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'rotations' }" 
                                    @click="switchView('rotations')">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Rotations</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'placements' }" 
                                    @click="switchView('placements')">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Placements</span>
                            </button>
                        </div>
                        
                        <!-- HOD Features -->
                        <div v-if="currentUser.user_role === 'department_head'">
                            <button class="nav-item" :class="{ active: currentView === 'department_overview' }" 
                                    @click="switchView('department_overview')">
                                <i class="fas fa-chart-line"></i>
                                <span>Department Overview</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'staff_management' }" 
                                    @click="switchView('staff_management')">
                                <i class="fas fa-users"></i>
                                <span>Staff Management</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'schedule_approval' }" 
                                    @click="switchView('schedule_approval')">
                                <i class="fas fa-calendar-check"></i>
                                <span>Schedule Approval</span>
                            </button>
                        </div>
                        
                        <!-- Shared Features -->
                        <button class="nav-item" :class="{ active: currentView === 'schedule' }" 
                                @click="switchView('schedule')">
                            <i class="fas fa-calendar-day"></i>
                            <span>Schedule</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'oncall' }" 
                                @click="switchView('oncall')">
                            <i class="fas fa-phone-alt"></i>
                            <span>On-call</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'leave' }" 
                                @click="switchView('leave')">
                            <i class="fas fa-calendar-times"></i>
                            <span>Leave & Coverage</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'reports' }" 
                                @click="switchView('reports')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </button>
                    </nav>
                    
                    <div style="padding: 1.75rem; margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); text-align: center; font-weight: 500;">
                            <div>Logged in as: <strong>{{ getUserRoleName(currentUser.user_role) }}</strong></div>
                            <small>ID: {{ currentUser.user_id }}</small>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content">
                    <header class="content-header">
                        <div class="header-title">
                            <h1>{{ getCurrentTitle() }}</h1>
                            <div class="subtitle">{{ getCurrentSubtitle() }}</div>
                        </div>
                        <div class="user-profile">
                            <div class="user-info">
                                <div class="user-name">{{ currentUser.full_name }}</div>
                                <div class="user-role">{{ getUserRoleName(currentUser.user_role) }}</div>
                            </div>
                            <div class="user-avatar">{{ getInitials(currentUser.full_name) }}</div>
                        </div>
                    </header>

                    <div class="content-area">
                        <!-- Loading State -->
                        <div v-if="loading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading system data...</p>
                        </div>

                        <!-- Resident Manager Views -->
                        <div v-else-if="currentUser.user_role === 'resident_manager'">
                            <!-- Residents Management -->
                            <div v-if="currentView === 'residents'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-user-graduate"></i>
                                            Resident Management
                                        </div>
                                        <button class="btn btn-resident" @click="showAddResidentModal">
                                            <i class="fas fa-user-plus"></i> Add Resident
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div class="metrics-grid">
                                            <div class="metric-card">
                                                <div class="metric-value">{{ stats.totalResidents }}</div>
                                                <div class="metric-label">Total Residents</div>
                                                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                                    {{ stats.internalResidents }} Internal • {{ stats.rotatingResidents }} Rotating • {{ stats.externalResidents }} External
                                                </div>
                                            </div>
                                            
                                            <div class="metric-card">
                                                <div class="metric-value">{{ stats.assignedResidents }}/{{ stats.totalResidents }}</div>
                                                <div class="metric-label">Currently Placed</div>
                                                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                                    {{ stats.unassignedResidents }} awaiting placement
                                                </div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ stats.endingSoon }}</div>
                                                <div class="metric-label">Rotations Ending Soon</div>
                                                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                                    Within next 14 days
                                                </div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ stats.dutyHoursWarning }}</div>
                                                <div class="metric-label">Duty Hour Alerts</div>
                                                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                                    >70 hours this week
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Residents List -->
                                        <div style="margin-top: 2rem;">
                                            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                                <select class="form-select" style="width: 180px;" v-model="residentFilter.type" @change="filterResidents">
                                                    <option value="">All Types</option>
                                                    <option value="department_internal">Internal</option>
                                                    <option value="rotating_external">Rotating</option>
                                                    <option value="international">External</option>
                                                </select>
                                                <select class="form-select" style="width: 180px;" v-model="residentFilter.status" @change="filterResidents">
                                                    <option value="">All Status</option>
                                                    <option value="placed">Placed</option>
                                                    <option value="unplaced">Unplaced</option>
                                                    <option value="ending">Rotation Ending</option>
                                                </select>
                                                <input type="text" class="form-input" style="width: 200px;" 
                                                       v-model="residentSearch" placeholder="Search residents...">
                                            </div>

                                            <div v-if="filteredResidents.length > 0" style="display: grid; gap: 1rem;">
                                                <div v-for="resident in filteredResidents" :key="resident.id" class="person-card">
                                                    <div class="person-avatar resident">
                                                        {{ getInitials(resident.full_name) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">
                                                            {{ resident.full_name }}
                                                            <span class="resident-badge">
                                                                <i class="fas fa-graduation-cap"></i>
                                                                {{ formatResidentCategory(resident.resident_category) }}
                                                            </span>
                                                        </div>
                                                        <div class="person-clinic">
                                                            <span class="role-badge badge-resident">Resident</span>
                                                            ID: {{ resident.staff_id }}
                                                        </div>
                                                        <div class="person-meta">
                                                            <div v-if="resident.current_rotation">
                                                                <strong>Current Placement:</strong> {{ resident.current_rotation.unit_name }}
                                                                <br>
                                                                <strong>Supervisor:</strong> {{ resident.current_rotation.supervisor_name }}
                                                                <br>
                                                                <strong>Rotation:</strong> {{ formatDate(resident.current_rotation.rotation_start_date) }} to {{ formatDate(resident.current_rotation.rotation_end_date) }}
                                                            </div>
                                                            <div v-else style="color: #f59e0b;">
                                                                <i class="fas fa-exclamation-circle"></i> Awaiting placement
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn-outline btn-sm" @click="editResident(resident)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <button class="btn btn-sm" @click="viewResidentSchedule(resident)">
                                                            <i class="fas fa-calendar"></i> Schedule
                                                        </button>
                                                        <button v-if="!resident.current_rotation" class="btn btn-sm btn-resident" @click="placeResident(resident)">
                                                            <i class="fas fa-map-marker-alt"></i> Place
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="empty-state">
                                                <i class="fas fa-user-graduate empty-state-icon"></i>
                                                <h3>No residents found</h3>
                                                <p>Add residents to get started</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Clinical Units Management -->
                            <div v-else-if="currentView === 'clinical_units'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-hospital-alt"></i>
                                            Clinical Units Management
                                        </div>
                                        <button class="btn" @click="showAddUnitModal">
                                            <i class="fas fa-plus"></i> Add Clinical Unit
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div v-for="unit in clinicalUnits" :key="unit.id" class="metric-card" style="margin-bottom: 1.5rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                                <div style="font-size: 1.2rem; font-weight: 700;">{{ unit.unit_name }}</div>
                                                <div style="font-size: 0.9rem; color: #64748b;">
                                                    {{ unit.current_occupancy }}/{{ unit.maximum_residents }} residents
                                                </div>
                                            </div>
                                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                                {{ unit.department_name }}
                                            </div>
                                            <div v-if="unit.unit_description" style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">
                                                {{ unit.unit_description }}
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn-outline btn-sm" @click="editUnit(unit)">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm" :class="{'btn-danger': unit.unit_status === 'active', 'btn-success': unit.unit_status !== 'active'}" 
                                                        @click="toggleUnitStatus(unit)">
                                                    {{ unit.unit_status === 'active' ? 'Deactivate' : 'Activate' }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Rotations View -->
                            <div v-else-if="currentView === 'rotations'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-alt"></i>
                                            Rotation Calendar
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div style="text-align: center; padding: 3rem;">
                                            <i class="fas fa-calendar-alt" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                                            <h3>Rotation Calendar View</h3>
                                            <p style="color: #64748b; margin-top: 0.5rem;">Calendar view would display here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Placements View -->
                            <div v-else-if="currentView === 'placements'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-map-marker-alt"></i>
                                            Resident Placements
                                        </div>
                                        <button class="btn" @click="showNewPlacementModal">
                                            <i class="fas fa-plus"></i> New Placement
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <!-- Active Placements -->
                                        <div>
                                            <h3 style="margin-bottom: 1rem; color: #1e293b;">Active Placements</h3>
                                            <div v-if="activePlacements.length > 0" style="display: grid; gap: 1rem;">
                                                <div v-for="placement in activePlacements" :key="placement.id" class="person-card">
                                                    <div class="person-avatar resident">
                                                        {{ getInitials(placement.resident_name).charAt(0) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">{{ placement.resident_name }}</div>
                                                        <div class="person-clinic">{{ placement.unit_name }}</div>
                                                        <div class="person-meta">
                                                            <strong>Supervisor:</strong> {{ placement.supervisor_name }}
                                                            <br>
                                                            <strong>Rotation:</strong> {{ formatDate(placement.rotation_start_date) }} to {{ formatDate(placement.rotation_end_date) }}
                                                            <br>
                                                            <span style="color: #10b981; margin-top: 0.5rem; display: inline-block;">
                                                                {{ getDaysRemaining(placement.rotation_end_date) }} days remaining
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn-outline btn-sm" @click="editPlacement(placement)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <button class="btn btn-sm btn-warning" @click="extendPlacement(placement)">
                                                            <i class="fas fa-calendar-plus"></i> Extend
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" @click="endPlacement(placement)">
                                                            <i class="fas fa-stop"></i> End
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="empty-state">
                                                <i class="fas fa-map-marker-alt empty-state-icon"></i>
                                                <h3>No active placements</h3>
                                                <p>Place residents to start tracking rotations</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- HOD Views -->
                        <div v-else-if="currentUser.user_role === 'department_head'">
                            <!-- Department Overview -->
                            <div v-if="currentView === 'department_overview'">
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-value">{{ hodStats.totalStaff }}</div>
                                        <div class="metric-label">Total Staff</div>
                                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                            {{ hodStats.attendings }} Attendings • {{ hodStats.residents }} Residents
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-value">{{ hodStats.occupancyRate }}%</div>
                                        <div class="metric-label">Unit Occupancy</div>
                                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                            {{ hodStats.occupiedUnits }}/{{ hodStats.totalUnits }} units at capacity
                                        </div>
                                    </div>

                                    <div class="metric-card">
                                        <div class="metric-value">{{ hodStats.coverageToday }}%</div>
                                        <div class="metric-label">Coverage Today</div>
                                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                            {{ hodStats.onLeave }} staff on leave
                                        </div>
                                    </div>

                                    <div class="metric-card">
                                        <div class="metric-value">{{ hodStats.compliance }}%</div>
                                        <div class="metric-label">Duty Hour Compliance</div>
                                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                            {{ hodStats.dutyHourAlerts }} alerts
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-chart-line"></i>
                                            Department Summary
                                        </div>
                                        <button class="btn" @click="exportDepartmentReport">
                                            <i class="fas fa-download"></i> Export Report
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: #1e293b;">Unit Status</h3>
                                                <div v-for="unit in clinicalUnits" :key="unit.id" style="margin-bottom: 1rem;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                        <span>{{ unit.unit_name }}</span>
                                                        <span style="font-weight: 600;">
                                                            {{ unit.current_occupancy }}/{{ unit.maximum_residents }}
                                                        </span>
                                                    </div>
                                                    <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                                        <div :style="{ 
                                                            width: `${(unit.current_occupancy / unit.maximum_residents) * 100}%`,
                                                            background: unit.current_occupancy >= unit.maximum_residents ? '#ef4444' : '#10b981',
                                                            height: '100%'
                                                        }"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: #1e293b;">Supervisor Load</h3>
                                                <div v-for="supervisor in supervisors" :key="supervisor.id" style="margin-bottom: 1rem;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                        <span>{{ supervisor.full_name }}</span>
                                                        <span style="font-weight: 600;">
                                                            {{ supervisor.resident_count }} residents
                                                        </span>
                                                    </div>
                                                    <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                                        <div :style="{ 
                                                            width: `${Math.min(supervisor.resident_count / 6 * 100, 100)}%`,
                                                            background: supervisor.resident_count > 4 ? '#f59e0b' : '#10b981',
                                                            height: '100%'
                                                        }"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Staff Management -->
                            <div v-else-if="currentView === 'staff_management'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-users"></i>
                                            Department Staff
                                        </div>
                                        <button class="btn" @click="showAddStaffModal">
                                            <i class="fas fa-user-plus"></i> Add Staff
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                            <select class="form-select" style="width: 160px;" v-model="staffFilter.staff_type">
                                                <option value="">All Roles</option>
                                                <option value="attending_physician">Attending</option>
                                                <option value="medical_resident">Resident</option>
                                                <option value="nurse_practitioner">Nurse</option>
                                            </select>
                                            <select class="form-select" style="width: 160px;" v-model="staffFilter.employment_status">
                                                <option value="">All Status</option>
                                                <option value="active">Active</option>
                                                <option value="on_leave">On Leave</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                            <input type="text" class="form-input" style="width: 200px;" 
                                                   v-model="staffSearch" placeholder="Search staff...">
                                        </div>

                                        <div v-if="filteredStaff.length > 0" style="display: grid; gap: 1rem;">
                                            <div v-for="staff in filteredStaff" :key="staff.id" class="person-card">
                                                <div class="person-avatar" :class="{ resident: staff.staff_type === 'medical_resident' }">
                                                    {{ getInitials(staff.full_name) }}
                                                </div>
                                                <div class="person-info">
                                                    <div class="person-name">
                                                        {{ staff.full_name }}
                                                        <span class="role-badge" :class="{
                                                            'badge-attending': staff.staff_type === 'attending_physician',
                                                            'badge-resident': staff.staff_type === 'medical_resident'
                                                        }">
                                                            {{ formatStaffType(staff.staff_type) }}
                                                        </span>
                                                    </div>
                                                    <div class="person-clinic">
                                                        ID: {{ staff.staff_id }}
                                                        <span v-if="staff.primary_clinic" style="margin-left: 1rem;">
                                                            • {{ staff.primary_clinic }}
                                                        </span>
                                                    </div>
                                                    <div class="person-meta">
                                                        <div v-if="staff.staff_type === 'medical_resident' && staff.current_rotation">
                                                            <strong>Current Placement:</strong> {{ staff.current_rotation.unit_name }}
                                                            <br>
                                                            <strong>Supervisor:</strong> {{ staff.current_rotation.supervisor_name }}
                                                        </div>
                                                        <div v-if="staff.staff_type === 'attending_physician'">
                                                            <strong>Supervising:</strong> {{ staff.resident_count || 0 }} residents
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <button class="btn-outline btn-sm" @click="editStaff(staff)">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button v-if="staff.employment_status !== 'inactive'" class="btn btn-sm btn-warning" @click="toggleStaffStatus(staff)">
                                                        <i class="fas fa-user-slash"></i> Deactivate
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="empty-state">
                                            <i class="fas fa-users empty-state-icon"></i>
                                            <h3>No staff found</h3>
                                            <p>Add department staff to get started</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Schedule Approval -->
                            <div v-else-if="currentView === 'schedule_approval'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-check"></i>
                                            Schedule Approval
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="empty-state">
                                            <i class="fas fa-check-circle empty-state-icon"></i>
                                            <h3>No schedules pending approval</h3>
                                            <p>All schedules are approved</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shared Views -->
                        <div v-else>
                            <!-- Schedule View -->
                            <div v-if="currentView === 'schedule'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-day"></i>
                                            Department Schedule
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="empty-state">
                                            <i class="fas fa-calendar-plus empty-state-icon"></i>
                                            <h3>Schedule View</h3>
                                            <p>Schedule display would appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- On-call View -->
                            <div v-else-if="currentView === 'oncall'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-phone-alt"></i>
                                            On-call Schedule
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="empty-state">
                                            <i class="fas fa-phone-alt empty-state-icon"></i>
                                            <h3>On-call Schedule</h3>
                                            <p>On-call schedule would appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Leave & Coverage -->
                            <div v-else-if="currentView === 'leave'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-times"></i>
                                            Leave & Coverage Management
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="empty-state">
                                            <i class="fas fa-calendar-check empty-state-icon"></i>
                                            <h3>Leave Management</h3>
                                            <p>Leave requests and coverage would appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports -->
                            <div v-else-if="currentView === 'reports'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-chart-bar"></i>
                                            Department Reports
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="empty-state">
                                            <i class="fas fa-file-alt empty-state-icon"></i>
                                            <h3>Reports & Analytics</h3>
                                            <p>Department reports would appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.show" class="toast" :class="toast.type" @click="toast.show = false">
            <i :class="toast.icon"></i> {{ toast.message }}
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    createApp({
        setup() {
            // ============ STATE MANAGEMENT ============
            const currentUser = ref(null);
            const loginForm = ref({
                email: '',
                password: '',
                role: 'resident_manager'
            });
            
            const loading = ref(false);
            const currentView = ref('residents');
            
            // Mock data stores
            const medicalStaff = ref([]);
            const trainingUnits = ref([]);
            const residentRotations = ref([]);
            
            // Filters
            const residentFilter = ref({
                type: '',
                status: ''
            });
            const residentSearch = ref('');
            
            const staffFilter = ref({
                staff_type: '',
                employment_status: ''
            });
            const staffSearch = ref('');
            
            // Toast
            const toast = ref({
                show: false,
                message: '',
                icon: 'fas fa-info-circle',
                type: 'info'
            });
            
            // ============ UTILITY FUNCTIONS ============
            const showToast = (message, type = 'info') => {
                const icons = {
                    info: 'fas fa-info-circle',
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle'
                };
                
                toast.value = {
                    show: true,
                    message,
                    icon: icons[type] || icons.info,
                    type: type
                };
                
                setTimeout(() => {
                    toast.value.show = false;
                }, 4000);
            };
            
            const getInitials = (name) => {
                if (!name) return '??';
                return name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            };
            
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            const getUserRoleName = (role) => {
                const roleNames = {
                    'resident_manager': 'Resident Manager',
                    'department_head': 'Head of Department',
                    'system_admin': 'System Administrator',
                    'viewing_doctor': 'Viewing Doctor'
                };
                return roleNames[role] || role;
            };
            
            const formatResidentCategory = (category) => {
                const categories = {
                    'department_internal': 'Internal',
                    'rotating_external': 'Rotating',
                    'international': 'International'
                };
                return categories[category] || category;
            };
            
            const formatStaffType = (type) => {
                const types = {
                    'attending_physician': 'Attending',
                    'medical_resident': 'Resident',
                    'nurse_practitioner': 'Nurse',
                    'administrative': 'Admin'
                };
                return types[type] || type;
            };
            
            const getDaysRemaining = (endDate) => {
                if (!endDate) return 0;
                const today = new Date();
                const end = new Date(endDate);
                const diffTime = end - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };
            
            // ============ COMPUTED PROPERTIES ============
            const residents = computed(() => {
                return medicalStaff.value
                    .filter(staff => staff.staff_type === 'medical_resident')
                    .map(resident => {
                        const currentRotation = residentRotations.value.find(rotation => 
                            rotation.resident_id === resident.id && rotation.rotation_status === 'active'
                        );
                        
                        return {
                            ...resident,
                            current_rotation: currentRotation ? {
                                ...currentRotation,
                                unit_name: getUnitName(currentRotation.training_unit_id),
                                supervisor_name: getSupervisorName(currentRotation.supervising_attending_id)
                            } : null
                        };
                    });
            });
            
            const clinicalUnits = computed(() => {
                return trainingUnits.value.map(unit => {
                    const activeRotations = residentRotations.value.filter(rotation => 
                        rotation.training_unit_id === unit.id && rotation.rotation_status === 'active'
                    );
                    
                    return {
                        ...unit,
                        current_occupancy: activeRotations.length
                    };
                });
            });
            
            const stats = computed(() => {
                const residentList = residents.value;
                const total = residentList.length;
                
                const internal = residentList.filter(r => 
                    r.resident_category === 'department_internal'
                ).length;
                const rotating = residentList.filter(r => 
                    r.resident_category === 'rotating_external'
                ).length;
                const external = residentList.filter(r => 
                    r.resident_category === 'international'
                ).length;
                
                const placed = residentList.filter(r => r.current_rotation).length;
                const unplaced = total - placed;
                
                const today = new Date();
                const twoWeeksFromNow = new Date();
                twoWeeksFromNow.setDate(today.getDate() + 14);
                const endingSoon = residentRotations.value.filter(p => {
                    const endDate = new Date(p.rotation_end_date);
                    return endDate > today && endDate <= twoWeeksFromNow;
                }).length;
                
                return {
                    totalResidents: total,
                    internalResidents: internal,
                    rotatingResidents: rotating,
                    externalResidents: external,
                    assignedResidents: placed,
                    unassignedResidents: unplaced,
                    endingSoon: endingSoon,
                    dutyHoursWarning: 0
                };
            });
            
            const hodStats = computed(() => {
                const totalStaff = medicalStaff.value.length;
                const attendings = medicalStaff.value.filter(s => 
                    s.staff_type === 'attending_physician'
                ).length;
                const residentsCount = residents.value.length;
                
                const totalUnits = clinicalUnits.value.length;
                const occupiedUnits = clinicalUnits.value.filter(u => 
                    u.current_occupancy >= u.maximum_residents
                ).length;
                const occupancyRate = totalUnits > 0 ? 
                    Math.round((occupiedUnits / totalUnits) * 100) : 0;
                    
                return {
                    totalStaff,
                    attendings,
                    residents: residentsCount,
                    totalUnits,
                    occupiedUnits,
                    occupancyRate,
                    coverageToday: 95,
                    onLeave: 3,
                    compliance: 92,
                    dutyHourAlerts: 2
                };
            });
            
            const supervisors = computed(() => {
                return medicalStaff.value
                    .filter(staff => 
                        staff.staff_type === 'attending_physician' && 
                        staff.can_supervise_residents !== false
                    )
                    .map(supervisor => {
                        const residentCount = residentRotations.value.filter(rotation => 
                            rotation.supervising_attending_id === supervisor.id &&
                            rotation.rotation_status === 'active'
                        ).length;
                        
                        return {
                            ...supervisor,
                            resident_count: residentCount
                        };
                    });
            });
            
            const activePlacements = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                return residentRotations.value
                    .filter(p => p.rotation_end_date >= today && p.rotation_status === 'active')
                    .map(p => {
                        const resident = medicalStaff.value.find(staff => staff.id === p.resident_id);
                        const unit = trainingUnits.value.find(u => u.id === p.training_unit_id);
                        const supervisor = medicalStaff.value.find(staff => staff.id === p.supervising_attending_id);
                        
                        return {
                            ...p,
                            resident_name: resident ? resident.full_name : 'Unknown',
                            unit_name: unit ? unit.unit_name : 'Unknown Unit',
                            supervisor_name: supervisor ? supervisor.full_name : 'Not Assigned'
                        };
                    });
            });
            
            const filteredResidents = computed(() => {
                let filtered = residents.value;
                
                if (residentSearch.value) {
                    const search = residentSearch.value.toLowerCase();
                    filtered = filtered.filter(r => 
                        r.full_name.toLowerCase().includes(search) ||
                        r.staff_id.toLowerCase().includes(search)
                    );
                }
                
                if (residentFilter.value.type) {
                    filtered = filtered.filter(r => r.resident_category === residentFilter.value.type);
                }
                
                if (residentFilter.value.status === 'placed') {
                    filtered = filtered.filter(r => r.current_rotation);
                } else if (residentFilter.value.status === 'unplaced') {
                    filtered = filtered.filter(r => !r.current_rotation);
                }
                
                return filtered;
            });
            
            const filteredStaff = computed(() => {
                let filtered = medicalStaff.value;
                
                if (staffSearch.value) {
                    const search = staffSearch.value.toLowerCase();
                    filtered = filtered.filter(s => 
                        s.full_name.toLowerCase().includes(search) ||
                        s.staff_id.toLowerCase().includes(search)
                    );
                }
                
                if (staffFilter.value.staff_type) {
                    filtered = filtered.filter(s => s.staff_type === staffFilter.value.staff_type);
                }
                
                if (staffFilter.value.employment_status) {
                    filtered = filtered.filter(s => s.employment_status === staffFilter.value.employment_status);
                }
                
                return filtered.map(staff => {
                    let current_rotation = null;
                    let resident_count = 0;
                    
                    if (staff.staff_type === 'medical_resident') {
                        current_rotation = residentRotations.value.find(rotation => 
                            rotation.resident_id === staff.id && 
                            rotation.rotation_status === 'active'
                        );
                    } else if (staff.staff_type === 'attending_physician') {
                        resident_count = residentRotations.value.filter(rotation => 
                            rotation.supervising_attending_id === staff.id &&
                            rotation.rotation_status === 'active'
                        ).length;
                    }
                    
                    return {
                        ...staff,
                        current_rotation,
                        resident_count
                    };
                });
            });
            
            // Helper functions
            const getUnitName = (unitId) => {
                const unit = trainingUnits.value.find(u => u.id === unitId);
                return unit ? unit.unit_name : 'Unknown Unit';
            };
            
            const getSupervisorName = (supervisorId) => {
                const supervisor = medicalStaff.value.find(s => s.id === supervisorId);
                return supervisor ? supervisor.full_name : 'Not Assigned';
            };
            
            // ============ NAVIGATION ============
            const getCurrentTitle = () => {
                const titles = {
                    residents: 'Resident Management',
                    clinical_units: 'Clinical Units',
                    rotations: 'Rotation Calendar',
                    placements: 'Resident Placements',
                    department_overview: 'Department Overview',
                    staff_management: 'Staff Management',
                    schedule_approval: 'Schedule Approval',
                    schedule: 'Department Schedule',
                    oncall: 'On-call Schedule',
                    leave: 'Leave & Coverage',
                    reports: 'Reports & Analytics'
                };
                
                return titles[currentView.value] || 'PneumoCare Pro';
            };
            
            const getCurrentSubtitle = () => {
                const subtitles = {
                    residents: 'Manage resident placements and rotations',
                    clinical_units: 'Configure clinical units and capacities',
                    placements: 'Assign residents to clinical units',
                    department_overview: 'Monitor department operations',
                    staff_management: 'Manage department staff and roles'
                };
                
                return subtitles[currentView.value] || '';
            };
            
            const switchView = (view) => {
                currentView.value = view;
            };
            
            // ============ MOCK DATA ============
            const loadMockData = () => {
                // Mock Medical Staff
                medicalStaff.value = [
                    {
                        id: '1',
                        staff_id: 'RES-2024-001',
                        full_name: 'Dr. Maria Rodriguez',
                        professional_email: 'm.rodriguez@hospital.edu',
                        staff_type: 'medical_resident',
                        resident_category: 'department_internal',
                        training_year: 3,
                        work_phone: '+1234567890',
                        primary_clinic: 'ICU Pulmonary',
                        can_supervise_residents: false,
                        employment_status: 'active',
                        special_notes: 'Excellent procedural skills'
                    },
                    {
                        id: '2',
                        staff_id: 'RES-2024-002',
                        full_name: 'Dr. James Wilson',
                        professional_email: 'j.wilson@hospital.edu',
                        staff_type: 'medical_resident',
                        resident_category: 'rotating_external',
                        training_year: 2,
                        work_phone: '+1234567891',
                        primary_clinic: 'Bronchoscopy Suite',
                        can_supervise_residents: false,
                        employment_status: 'active',
                        special_notes: 'Cardiology rotation'
                    },
                    {
                        id: '3',
                        staff_id: 'RES-2024-003',
                        full_name: 'Dr. Anna Chen',
                        professional_email: 'a.chen@hospital.edu',
                        staff_type: 'medical_resident',
                        resident_category: 'international',
                        training_year: 4,
                        work_phone: '+1234567892',
                        primary_clinic: 'Sleep Disorders Center',
                        can_supervise_residents: false,
                        employment_status: 'active',
                        special_notes: 'Visiting from Stanford'
                    },
                    {
                        id: '101',
                        staff_id: 'ATT-2024-001',
                        full_name: 'Dr. Michael Thompson',
                        professional_email: 'm.thompson@hospital.edu',
                        staff_type: 'attending_physician',
                        resident_category: null,
                        training_year: null,
                        work_phone: '+1234567801',
                        primary_clinic: 'ICU Pulmonary',
                        can_supervise_residents: true,
                        employment_status: 'active',
                        special_notes: 'Director of ICU Pulmonary'
                    },
                    {
                        id: '102',
                        staff_id: 'ATT-2024-002',
                        full_name: 'Dr. Sarah Johnson',
                        professional_email: 's.johnson@hospital.edu',
                        staff_type: 'attending_physician',
                        resident_category: null,
                        training_year: null,
                        work_phone: '+1234567802',
                        primary_clinic: 'Bronchoscopy Suite',
                        can_supervise_residents: true,
                        employment_status: 'active',
                        special_notes: 'Chief of Bronchoscopy'
                    }
                ];
                
                // Mock Training Units
                trainingUnits.value = [
                    {
                        id: '1',
                        unit_code: 'ICU-PULM-1',
                        unit_name: 'ICU Pulmonary',
                        department_name: 'Pulmonology',
                        maximum_residents: 4,
                        default_supervisor_id: '101',
                        unit_description: 'Medical Intensive Care Unit - Pulmonary Service',
                        unit_status: 'active'
                    },
                    {
                        id: '2',
                        unit_code: 'BRONCH-1',
                        unit_name: 'Bronchoscopy Suite',
                        department_name: 'Pulmonology',
                        maximum_residents: 3,
                        default_supervisor_id: '102',
                        unit_description: 'Interventional Pulmonology and Bronchoscopy',
                        unit_status: 'active'
                    },
                    {
                        id: '3',
                        unit_code: 'SLEEP-1',
                        unit_name: 'Sleep Disorders Center',
                        department_name: 'Pulmonology',
                        maximum_residents: 2,
                        default_supervisor_id: '101',
                        unit_description: 'Sleep Medicine and Polysomnography',
                        unit_status: 'active'
                    }
                ];
                
                // Mock Rotations
                residentRotations.value = [
                    {
                        id: '1',
                        rotation_id: 'ROT-2024-001',
                        resident_id: '1',
                        training_unit_id: '1',
                        supervising_attending_id: '101',
                        rotation_start_date: '2024-01-15',
                        rotation_end_date: '2024-04-15',
                        rotation_category: 'clinical_rotation',
                        rotation_status: 'active',
                        clinical_notes: 'ICU Rotation - Primary'
                    },
                    {
                        id: '2',
                        rotation_id: 'ROT-2024-002',
                        resident_id: '2',
                        training_unit_id: '2',
                        supervising_attending_id: '102',
                        rotation_start_date: '2024-02-01',
                        rotation_end_date: '2024-05-01',
                        rotation_category: 'clinical_rotation',
                        rotation_status: 'active',
                        clinical_notes: 'Bronchoscopy Rotation'
                    }
                ];
                
                loading.value = false;
            };
            
            // ============ AUTHENTICATION ============
            const handleLogin = () => {
                loading.value = true;
                
                // Simulate API call
                setTimeout(() => {
                    // Mock user data based on role
                    if (loginForm.value.role === 'resident_manager') {
                        currentUser.value = {
                            id: '1',
                            user_id: 'RM-2024-001',
                            full_name: 'Dr. Sarah Johnson',
                            email: loginForm.value.email,
                            user_role: 'resident_manager',
                            department: 'Pulmonology'
                        };
                        currentView.value = 'residents';
                    } else {
                        currentUser.value = {
                            id: '2',
                            user_id: 'HOD-2024-001',
                            full_name: 'Dr. Robert Chen',
                            email: loginForm.value.email,
                            user_role: 'department_head',
                            department: 'Pulmonology'
                        };
                        currentView.value = 'department_overview';
                    }
                    
                    loadMockData();
                    showToast(`Welcome, ${currentUser.value.full_name}!`, 'success');
                    loading.value = false;
                }, 1000);
            };
            
            // ============ RESIDENT MANAGEMENT ============
            const showAddResidentModal = () => {
                showToast('Add resident modal would open here', 'info');
            };
            
            const editResident = (resident) => {
                showToast(`Edit resident: ${resident.full_name}`, 'info');
            };
            
            const viewResidentSchedule = (resident) => {
                showToast(`Schedule for ${resident.full_name}`, 'info');
            };
            
            const placeResident = (resident) => {
                showToast(`Place resident: ${resident.full_name}`, 'info');
            };
            
            // ============ UNIT MANAGEMENT ============
            const showAddUnitModal = () => {
                showToast('Add clinical unit modal would open here', 'info');
            };
            
            const editUnit = (unit) => {
                showToast(`Edit unit: ${unit.unit_name}`, 'info');
            };
            
            const toggleUnitStatus = (unit) => {
                showToast(`Unit ${unit.unit_status === 'active' ? 'deactivated' : 'activated'}`, 'success');
            };
            
            // ============ PLACEMENT MANAGEMENT ============
            const showNewPlacementModal = () => {
                showToast('New placement modal would open here', 'info');
            };
            
            const editPlacement = (placement) => {
                showToast(`Edit placement for ${placement.resident_name}`, 'info');
            };
            
            const extendPlacement = (placement) => {
                showToast(`Extend placement for ${placement.resident_name}`, 'info');
            };
            
            const endPlacement = (placement) => {
                showToast(`End placement for ${placement.resident_name}`, 'info');
            };
            
            // ============ STAFF MANAGEMENT ============
            const showAddStaffModal = () => {
                showToast('Add staff modal would open here', 'info');
            };
            
            const editStaff = (staff) => {
                showToast(`Edit staff: ${staff.full_name}`, 'info');
            };
            
            const toggleStaffStatus = (staff) => {
                showToast(`Staff ${staff.employment_status === 'active' ? 'deactivated' : 'activated'}`, 'success');
            };
            
            // ============ OTHER FUNCTIONS ============
            const exportDepartmentReport = () => {
                showToast('Department report exported', 'success');
            };
            
            // ============ INITIALIZATION ============
            onMounted(() => {
                // Initialize anything needed on mount
            });
            
            return {
                // State
                currentUser,
                loginForm,
                loading,
                currentView,
                
                // Data
                medicalStaff,
                trainingUnits,
                residentRotations,
                
                // Filters
                residentFilter,
                residentSearch,
                staffFilter,
                staffSearch,
                
                // Computed
                residents,
                clinicalUnits,
                stats,
                hodStats,
                supervisors,
                activePlacements,
                filteredResidents,
                filteredStaff,
                
                // UI
                toast,
                
                // Utility Functions
                getInitials,
                formatDate,
                getUserRoleName,
                formatResidentCategory,
                formatStaffType,
                getDaysRemaining,
                
                // Navigation
                switchView,
                getCurrentTitle,
                getCurrentSubtitle,
                
                // Authentication
                handleLogin,
                
                // Resident Management
                showAddResidentModal,
                editResident,
                viewResidentSchedule,
                placeResident,
                
                // Unit Management
                showAddUnitModal,
                editUnit,
                toggleUnitStatus,
                
                // Placement Management
                showNewPlacementModal,
                editPlacement,
                extendPlacement,
                endPlacement,
                
                // Staff Management
                showAddStaffModal,
                editStaff,
                toggleStaffStatus,
                
                // Other Functions
                exportDepartmentReport
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
