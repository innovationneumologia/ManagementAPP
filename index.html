<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEUMO PRO | Hospital Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === MEDICAL PROFESSIONAL CSS === */
        :root {
            --medical-deep: #0d2b4e;
            --medical-primary: #1e4d8c;
            --medical-secondary: #2d6fb4;
            --medical-accent: #3a8fd9;
            --medical-light: #e8f1f8;
            
            --status-critical: #dc2626;
            --status-warning: #f59e0b;
            --status-ok: #10b981;
            --status-neutral: #6b7280;
            --status-info: #3b82f6;
            
            --ui-background: #f8fafc;
            --ui-surface: #ffffff;
            --ui-border: #e2e8f0;
            --ui-text: #1e293b;
            --ui-text-secondary: #64748b;
            
            --font-family: 'Inter', -apple-system, system-ui, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 0.9375rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 100ms ease;
            --transition-base: 200ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            background: var(--ui-background);
            color: var(--ui-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--medical-deep);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: var(--space-6) var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: var(--medical-accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .brand-text {
            color: white;
        }

        .brand-text h1 {
            font-size: var(--font-size-lg);
            font-weight: 700;
            letter-spacing: -0.25px;
        }

        .brand-text .subtitle {
            font-size: var(--font-size-xs);
            opacity: 0.8;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .nav-section {
            padding: var(--space-4) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-title {
            color: rgba(255, 255, 255, 0.6);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 var(--space-4);
            margin-bottom: var(--space-2);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-4);
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: background var(--transition-fast);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.12);
            color: white;
            font-weight: 600;
        }

        .nav-item-icon {
            width: 16px;
            text-align: center;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .top-bar {
            height: 56px;
            background: var(--ui-surface);
            border-bottom: 1px solid var(--ui-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            flex-shrink: 0;
        }

        .breadcrumb {
            font-size: var(--font-size-sm);
            color: var(--ui-text-secondary);
            font-weight: 500;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            background: var(--medical-light);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--medical-primary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--medical-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
        }

        .content-area {
            flex: 1;
            padding: var(--space-6);
            overflow-y: auto;
        }

        .view-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .view-header {
            margin-bottom: var(--space-8);
        }

        .view-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--ui-text);
            margin-bottom: var(--space-2);
        }

        .view-subtitle {
            color: var(--ui-text-secondary);
            font-size: var(--font-size-sm);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        .metric-card {
            background: var(--ui-surface);
            border: 1px solid var(--ui-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            position: relative;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--medical-primary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--medical-primary);
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--ui-text-secondary);
            font-weight: 500;
        }

        .data-table {
            background: var(--ui-surface);
            border: 1px solid var(--ui-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .table-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--ui-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        .table-actions {
            display: flex;
            gap: var(--space-2);
        }

        .table-content {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--ui-background);
            border-bottom: 1px solid var(--ui-border);
        }

        th {
            padding: var(--space-3) var(--space-6);
            text-align: left;
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--ui-text-secondary);
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid var(--ui-border);
            transition: background var(--transition-fast);
        }

        tbody tr:hover {
            background: var(--medical-light);
        }

        td {
            padding: var(--space-4) var(--space-6);
            font-size: var(--font-size-sm);
            vertical-align: middle;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-inactive { background: #f3f4f6; color: #374151; }
        .badge-critical { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #ffedd5; color: #9a3412; }

        .btn {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid var(--ui-border);
            background: var(--ui-surface);
            color: var(--ui-text);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            text-decoration: none;
        }

        .btn:hover {
            background: var(--medical-light);
            border-color: var(--medical-secondary);
        }

        .btn-primary {
            background: var(--medical-primary);
            border-color: var(--medical-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--medical-secondary);
            border-color: var(--medical-secondary);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-3);
            font-size: var(--font-size-xs);
        }

        .btn-icon {
            padding: var(--space-2);
            width: 32px;
            height: 32px;
            justify-content: center;
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--ui-border);
            border-radius: var(--radius-md);
            background: var(--ui-surface);
            font-size: var(--font-size-sm);
            transition: border-color var(--transition-fast);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--medical-primary);
            box-shadow: 0 0 0 3px rgba(30, 77, 140, 0.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--space-8);
        }

        .modal {
            background: var(--ui-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--ui-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--ui-text-secondary);
            cursor: pointer;
            padding: var(--space-1);
        }

        .modal-content {
            padding: var(--space-6);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--medical-deep), var(--medical-primary));
            padding: var(--space-8);
        }

        .login-card {
            background: var(--ui-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .login-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--medical-primary);
            margin-bottom: var(--space-2);
        }

        .login-subtitle {
            color: var(--ui-text-secondary);
            font-size: var(--font-size-sm);
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            background: rgba(30, 77, 140, 0.1);
            color: var(--medical-primary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .empty-state {
            padding: var(--space-12) var(--space-6);
            text-align: center;
            color: var(--ui-text-secondary);
        }

        .empty-state-icon {
            font-size: 2rem;
            color: var(--ui-border);
            margin-bottom: var(--space-4);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12);
            color: var(--ui-text-secondary);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--ui-border);
            border-top-color: var(--medical-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: var(--space-3);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .text-sm { font-size: var(--font-size-sm); }
        .text-xs { font-size: var(--font-size-xs); }
        .font-semibold { font-weight: 600; }
        .text-secondary { color: var(--ui-text-secondary); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .w-full { width: 100%; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="brand" style="justify-content: center; margin-bottom: var(--space-4);">
                        <div class="brand-icon">N</div>
                        <div class="brand-text">
                            <h1>NEUMO PRO</h1>
                            <div class="subtitle">Hospital Management v5.0</div>
                        </div>
                    </div>
                    <h1 class="login-title">System Access</h1>
                    <div class="login-subtitle">Professional clinical management platform</div>
                </div>
                
                <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" v-model="loginForm.email" required 
                               placeholder="professional@hospital.org" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="loginForm.password" required 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary w-full" :disabled="loading">
                            <span v-if="loading" class="loading-spinner"></span>
                            <span v-else>Authenticate & Enter</span>
                        </button>
                    </div>
                </form>
                
                <div style="padding-top: var(--space-6); border-top: 1px solid var(--ui-border);">
                    <div class="text-xs text-secondary text-center">
                        HIPAA Compliant ‚Ä¢ System ID: HMS-{{ new Date().getFullYear() }}-PRO
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else class="app-container">
            <!-- Dynamic Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="brand">
                        <div class="brand-icon">N</div>
                        <div class="brand-text">
                            <h1>NEUMO PRO</h1>
                            <div class="subtitle">v5.0 Professional</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation generated from permission matrix -->
                <div v-for="section in navigation" :key="section.id" class="nav-section">
                    <div class="nav-title">{{ section.title }}</div>
                    <button v-for="item in section.items.filter(i => hasPermission(i.permission))" 
                            :key="item.id"
                            class="nav-item"
                            :class="{ active: currentView === item.id }"
                            @click="switchView(item.id)">
                        <span class="nav-item-icon">{{ item.icon }}</span>
                        <span>{{ item.title }}</span>
                    </button>
                </div>

                <!-- System Status -->
                <div style="margin-top: auto; padding: var(--space-4);">
                    <div class="text-xs text-secondary" style="color: rgba(255,255,255,0.6); text-align: center;">
                        <div>Session Active</div>
                        <div class="mt-1">Role: <span class="font-semibold">{{ currentUser.roleDisplay }}</span></div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="top-bar">
                    <div class="breadcrumb">
                        {{ currentViewData.title }} <span v-if="currentViewData.subtitle">‚Ä¢ {{ currentViewData.subtitle }}</span>
                    </div>
                    
                    <div class="user-menu">
                        <div class="status-indicator">
                            <span>{{ systemStatus }}</span>
                        </div>
                        
                        <div class="user-avatar" @click="showUserMenu">
                            {{ getUserInitials(currentUser.full_name) }}
                        </div>
                    </div>
                </div>

                <div class="content-area">
                    <div v-if="loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>Loading system data...</span>
                    </div>

                    <!-- Dynamic View Container -->
                    <div v-else class="view-container">
                        <!-- Dashboard View -->
                        <div v-if="currentView === 'dashboard' && hasPermission('view_dashboard')">
                            <div class="view-header">
                                <h1 class="view-title">Clinical Operations Dashboard</h1>
                                <div class="view-subtitle">{{ currentUser.roleDisplay }} ‚Ä¢ Real-time system view</div>
                            </div>

                            <!-- Role-specific metrics loaded from database -->
                            <div class="dashboard-grid">
                                <div class="metric-card">
                                    <div class="metric-value">{{ dashboardMetrics.totalActive || 0 }}</div>
                                    <div class="metric-label">Active Staff</div>
                                    <div class="text-xs text-secondary mt-2">Updated just now</div>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="metric-value">{{ dashboardMetrics.coverageRate || 0 }}%</div>
                                    <div class="metric-label">Coverage Rate</div>
                                    <div class="text-xs text-secondary mt-2">Department-wide</div>
                                </div>

                                <div class="metric-card">
                                    <div class="metric-value">{{ dashboardMetrics.pendingActions || 0 }}</div>
                                    <div class="metric-label">Pending Actions</div>
                                    <div class="text-xs text-secondary mt-2">Requires attention</div>
                                </div>

                                <div class="metric-card">
                                    <div class="metric-value">{{ dashboardMetrics.unitOccupancy || 0 }}%</div>
                                    <div class="metric-label">Unit Occupancy</div>
                                    <div class="text-xs text-secondary mt-2">Current capacity</div>
                                </div>
                            </div>

                            <!-- Quick Actions based on permissions -->
                            <div class="mb-8" v-if="hasPermission('create_actions')">
                                <div class="table-header">
                                    <div class="table-title">Quick Actions</div>
                                </div>
                                <div class="flex gap-3 mb-6">
                                    <button v-if="hasPermission('create_assignment')" class="btn btn-sm" @click="showModal('assignment')">
                                        + New Assignment
                                    </button>
                                    <button v-if="hasPermission('create_rotation')" class="btn btn-sm" @click="showModal('rotation')">
                                        + New Rotation
                                    </button>
                                    <button v-if="hasPermission('create_announcement')" class="btn btn-sm" @click="showModal('announcement')">
                                        + Announcement
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Activity loaded from audit_logs -->
                            <div class="data-table">
                                <div class="table-header">
                                    <div class="table-title">Recent System Activity</div>
                                    <div class="table-actions">
                                        <button class="btn btn-sm btn-icon" @click="loadRecentActivities" title="Refresh">
                                            ‚Üª
                                        </button>
                                    </div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Action</th>
                                                <th>User</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="activity in recentActivities" :key="activity.id">
                                                <td>{{ formatTime(activity.created_at) }}</td>
                                                <td>{{ activity.action_type }}</td>
                                                <td>{{ activity.user_name }}</td>
                                                <td>{{ activity.details }}</td>
                                            </tr>
                                            <tr v-if="recentActivities.length === 0">
                                                <td colspan="4" class="text-center text-secondary py-8">
                                                    No recent activity recorded
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Staff Management -->
                        <div v-else-if="currentView === 'medical_staff' && hasPermission('view_medical_staff')">
                            <div class="view-header">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="view-title">Medical Staff Directory</h1>
                                        <div class="view-subtitle">Staff management and assignments</div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button v-if="hasPermission('export_data')" class="btn btn-sm" @click="exportData('medical_staff')">
                                            Export
                                        </button>
                                        <button v-if="hasPermission('create_medical_staff')" class="btn btn-sm btn-primary" @click="showModal('staff')">
                                            + Add Staff
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filters -->
                            <div class="flex gap-3 mb-6">
                                <select class="form-select" style="width: 180px;" v-model="filters.staffType">
                                    <option value="">All Types</option>
                                    <option value="medical_resident">Resident</option>
                                    <option value="attending_physician">Attending</option>
                                    <option value="fellow">Fellow</option>
                                </select>
                                <select class="form-select" style="width: 180px;" v-model="filters.status">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="on_leave">On Leave</option>
                                </select>
                                <input type="text" class="form-input" style="width: 240px;" 
                                       placeholder="Search by name or ID..." v-model="filters.search">
                            </div>

                            <!-- Staff Table loaded from medical_staff table -->
                            <div class="data-table">
                                <div class="table-header">
                                    <div class="table-title">Staff Directory</div>
                                    <div class="table-actions">
                                        <span class="text-sm text-secondary">{{ filteredMedicalStaff.length }} staff members</span>
                                    </div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>ID</th>
                                                <th>Type</th>
                                                <th>Department</th>
                                                <th>Status</th>
                                                <th>Current Unit</th>
                                                <th v-if="hasPermission('edit_medical_staff')">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="staff in filteredMedicalStaff" :key="staff.id">
                                                <td>
                                                    <div class="font-semibold">{{ staff.full_name }}</div>
                                                    <div class="text-xs text-secondary">{{ staff.professional_email }}</div>
                                                </td>
                                                <td>{{ staff.staff_id }}</td>
                                                <td>
                                                    <span class="status-badge" :class="getStaffTypeClass(staff.staff_type)">
                                                        {{ formatStaffType(staff.staff_type) }}
                                                    </span>
                                                </td>
                                                <td>{{ staff.department || 'Pulmonology' }}</td>
                                                <td>
                                                    <span class="status-badge" :class="getStatusClass(staff.employment_status)">
                                                        {{ formatStatus(staff.employment_status) }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div v-if="staff.current_unit">{{ staff.current_unit }}</div>
                                                    <div v-else class="text-secondary text-xs">Not assigned</div>
                                                </td>
                                                <td v-if="hasPermission('edit_medical_staff')">
                                                    <div class="flex gap-1">
                                                        <button class="btn btn-sm btn-icon" @click="editItem('staff', staff)" title="Edit">
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <button v-if="hasPermission('assign_staff')" class="btn btn-sm btn-icon" @click="assignStaff(staff)" title="Assign">
                                                            üìã
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr v-if="filteredMedicalStaff.length === 0">
                                                <td colspan="7" class="text-center text-secondary py-8">
                                                    No staff members found
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Training Units Management -->
                        <div v-else-if="currentView === 'training_units' && hasPermission('view_training_units')">
                            <div class="view-header">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="view-title">Clinical Training Units</h1>
                                        <div class="view-subtitle">Unit management and capacity planning</div>
                                    </div>
                                    <button v-if="hasPermission('create_training_unit')" class="btn btn-sm btn-primary" @click="showModal('unit')">
                                        + Add Unit
                                    </button>
                                </div>
                            </div>

                            <!-- Units Grid loaded from training_units table -->
                            <div class="dashboard-grid mb-8">
                                <div v-for="unit in trainingUnits" :key="unit.id" class="metric-card">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="font-semibold">{{ unit.unit_name }}</div>
                                        <span class="status-badge" :class="getUnitStatusClass(unit.unit_status)">
                                            {{ unit.unit_status }}
                                        </span>
                                    </div>
                                    <div class="metric-value">{{ unit.current_residents || 0 }}/{{ unit.maximum_residents }}</div>
                                    <div class="metric-label">Current Residents</div>
                                    <div class="mt-4">
                                        <div class="text-sm mb-1">Department: {{ unit.department_name }}</div>
                                        <div class="text-xs text-secondary">{{ unit.unit_description || 'No description' }}</div>
                                    </div>
                                    <div class="flex gap-2 mt-4">
                                        <button v-if="hasPermission('edit_training_unit')" class="btn btn-sm" @click="editItem('unit', unit)">
                                            Edit
                                        </button>
                                        <button v-if="hasPermission('view_unit_details')" class="btn btn-sm">
                                            Details
                                        </button>
                                    </div>
                                </div>
                                <div v-if="trainingUnits.length === 0" class="metric-card">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">üè•</div>
                                        <h3 class="font-semibold mb-2">No Training Units</h3>
                                        <p class="text-secondary">Add training units to get started</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Management (System Admin only) -->
                        <div v-else-if="currentView === 'user_management' && hasPermission('manage_users')">
                            <div class="view-header">
                                <h1 class="view-title">User Management</h1>
                                <div class="view-subtitle">System access control and role assignment</div>
                            </div>

                            <!-- User Table loaded from app_users table -->
                            <div class="data-table">
                                <div class="table-header">
                                    <div class="table-title">System Users</div>
                                    <div class="table-actions">
                                        <button class="btn btn-sm btn-primary" @click="showModal('user')">
                                            + Add User
                                        </button>
                                    </div>
                                </div>
                                <div class="table-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Email</th>
                                                <th>Current Role</th>
                                                <th>Department</th>
                                                <th>Status</th>
                                                <th>Last Active</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="user in systemUsers" :key="user.id">
                                                <td>
                                                    <div class="font-semibold">{{ user.full_name }}</div>
                                                    <div class="text-xs text-secondary">ID: {{ user.user_id || user.id?.substring(0, 8) }}</div>
                                                </td>
                                                <td>{{ user.email }}</td>
                                                <td>
                                                    <select v-if="hasPermission('change_user_roles')" class="form-select text-sm" 
                                                            :value="user.user_role" @change="updateUserRole(user.id, $event.target.value)">
                                                        <option value="system_admin">System Admin</option>
                                                        <option value="department_head">Department Head</option>
                                                        <option value="resident_manager">Resident Manager</option>
                                                        <option value="viewing_doctor">Viewing Doctor</option>
                                                    </select>
                                                    <span v-else class="role-badge">{{ formatRole(user.user_role) }}</span>
                                                </td>
                                                <td>{{ user.department || 'Pulmonology' }}</td>
                                                <td>
                                                    <span class="status-badge" :class="getStatusClass(user.account_status)">
                                                        {{ user.account_status }}
                                                    </span>
                                                </td>
                                                <td class="text-sm">{{ formatTime(user.last_login) }}</td>
                                                <td>
                                                    <div class="flex gap-1">
                                                        <button class="btn btn-sm btn-icon" @click="editItem('user', user)" title="Edit">
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <button v-if="hasPermission('reset_user_password')" class="btn btn-sm btn-icon" @click="resetUserPassword(user)" title="Reset Password">
                                                            üîë
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr v-if="systemUsers.length === 0">
                                                <td colspan="7" class="text-center text-secondary py-8">
                                                    No users found in system
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Resident Rotations -->
                        <div v-else-if="currentView === 'resident_rotations' && hasPermission('view_rotations')">
                            <div class="view-header">
                                <h1 class="view-title">Resident Rotations</h1>
                                <div class="view-subtitle">Rotation management and scheduling</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üîÑ</div>
                                <h3 class="font-semibold mb-2">Rotation Management</h3>
                                <p class="text-secondary mb-4">Loaded from resident_rotations table</p>
                                <button v-if="hasPermission('create_rotation')" class="btn btn-sm btn-primary" @click="showModal('rotation')">
                                    + Create Rotation
                                </button>
                            </div>
                        </div>

                        <!-- Daily Assignments -->
                        <div v-else-if="currentView === 'daily_assignments' && hasPermission('view_assignments')">
                            <div class="view-header">
                                <h1 class="view-title">Daily Assignments</h1>
                                <div class="view-subtitle">Daily schedule and assignments</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÖ</div>
                                <h3 class="font-semibold mb-2">Assignment Management</h3>
                                <p class="text-secondary mb-4">Loaded from daily_assignments table</p>
                                <button v-if="hasPermission('create_assignment')" class="btn btn-sm btn-primary" @click="showModal('assignment')">
                                    + Create Assignment
                                </button>
                            </div>
                        </div>

                        <!-- On-call Schedule -->
                        <div v-else-if="currentView === 'oncall_schedule' && hasPermission('view_oncall')">
                            <div class="view-header">
                                <h1 class="view-title">On-call Schedule</h1>
                                <div class="view-subtitle">On-call rotations and coverage</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üìû</div>
                                <h3 class="font-semibold mb-2">On-call Management</h3>
                                <p class="text-secondary mb-4">Loaded from oncall_schedule table</p>
                                <button v-if="hasPermission('create_oncall')" class="btn btn-sm btn-primary" @click="showModal('oncall')">
                                    + Schedule On-call
                                </button>
                            </div>
                        </div>

                        <!-- Leave Management -->
                        <div v-else-if="currentView === 'leave_management' && hasPermission('view_leave')">
                            <div class="view-header">
                                <h1 class="view-title">Leave Management</h1>
                                <div class="view-subtitle">Leave requests and coverage</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üèñÔ∏è</div>
                                <h3 class="font-semibold mb-2">Leave Management</h3>
                                <p class="text-secondary mb-4">Loaded from leave_requests table</p>
                                <button v-if="hasPermission('create_leave')" class="btn btn-sm btn-primary" @click="showModal('leave')">
                                    + Request Leave
                                </button>
                            </div>
                        </div>

                        <!-- Announcements -->
                        <div v-else-if="currentView === 'announcements' && hasPermission('view_announcements')">
                            <div class="view-header">
                                <h1 class="view-title">Department Announcements</h1>
                                <div class="view-subtitle">Announcements and communications</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¢</div>
                                <h3 class="font-semibold mb-2">Announcements</h3>
                                <p class="text-secondary mb-4">Loaded from department_announcements table</p>
                                <button v-if="hasPermission('create_announcement')" class="btn btn-sm btn-primary" @click="showModal('announcement')">
                                    + New Announcement
                                </button>
                            </div>
                        </div>

                        <!-- Audit Logs -->
                        <div v-else-if="currentView === 'audit_logs' && hasPermission('view_audit_logs')">
                            <div class="view-header">
                                <h1 class="view-title">Audit Logs</h1>
                                <div class="view-subtitle">System activity and changes</div>
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <h3 class="font-semibold mb-2">Audit Logs</h3>
                                <p class="text-secondary">Loaded from audit_logs table</p>
                            </div>
                        </div>

                        <!-- Access Denied -->
                        <div v-else-if="!hasPermission(currentView + '_view')" class="empty-state">
                            <div class="empty-state-icon">üîí</div>
                            <h3 class="font-semibold mb-2">Access Restricted</h3>
                            <p class="text-secondary">Your current role ({{ currentUser.roleDisplay }}) does not have permission to access this view.</p>
                            <button class="btn mt-4" @click="switchView('dashboard')">
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal System -->
        <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">{{ modalTitle }}</div>
                    <button class="modal-close" @click="closeModal">√ó</button>
                </div>
                <div class="modal-content">
                    <!-- Dynamic form based on modal type -->
                    <div v-if="modalType === 'user'">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" v-model="modalData.full_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" v-model="modalData.email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select class="form-select" v-model="modalData.user_role" required>
                                <option value="viewing_doctor">Viewing Doctor</option>
                                <option value="resident_manager">Resident Manager</option>
                                <option value="department_head">Department Head</option>
                                <option value="system_admin">System Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-input" v-model="modalData.department" value="Pulmonology">
                        </div>
                    </div>

                    <div v-if="modalType === 'staff'">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" v-model="modalData.full_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Professional Email</label>
                            <input type="email" class="form-input" v-model="modalData.professional_email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Staff Type</label>
                            <select class="form-select" v-model="modalData.staff_type" required>
                                <option value="medical_resident">Medical Resident</option>
                                <option value="attending_physician">Attending Physician</option>
                                <option value="fellow">Fellow</option>
                                <option value="nurse_practitioner">Nurse Practitioner</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employment Status</label>
                            <select class="form-select" v-model="modalData.employment_status" required>
                                <option value="active">Active</option>
                                <option value="on_leave">On Leave</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="modalType === 'unit'">
                        <div class="form-group">
                            <label class="form-label">Unit Name</label>
                            <input type="text" class="form-input" v-model="modalData.unit_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-input" v-model="modalData.department_name" value="Pulmonology" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maximum Residents</label>
                            <input type="number" class="form-input" v-model="modalData.maximum_residents" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Status</label>
                            <select class="form-select" v-model="modalData.unit_status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>

                    <!-- Generic modal for other types -->
                    <div v-if="!['user', 'staff', 'unit'].includes(modalType)">
                        <p class="text-secondary">Form for {{ modalType }} will be loaded based on table schema.</p>
                    </div>

                    <!-- Modal Actions -->
                    <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-ui-border">
                        <button class="btn" @click="closeModal">Cancel</button>
                        <button class="btn btn-primary" @click="saveModal" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>{{ editingItem ? 'Update' : 'Create' }}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ============ FIXED SCRIPT - NO ERRORS ============
const { createApp, ref, computed, onMounted } = Vue;

// Supabase Configuration
const supabaseUrl = 'https://vssmguzuvekkecbmwcjw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzc21ndXp1dmVra2VjYm13Y2p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTI4NTIsImV4cCI6MjA4NDE2ODg1Mn0.8qPFsMEn4n5hDfxhgXvq2lQarts8OlL8hWiRYXb-vXw';

// Initialize Supabase
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

createApp({
    setup() {
        // ============ CORE STATE ============
        const currentUser = ref(null);
        const isLoading = ref(false);
        const isSaving = ref(false);
        const currentView = ref('dashboard');
        const showModalDialog = ref(false); // Changed from showModal
        const modalDialogType = ref(''); // Changed from modalType
        const modalDialogData = ref({}); // Changed from modalData
        const editingCurrentItem = ref(null); // Changed from editingItem
        
        // Login form
        const loginFormData = ref({ email: '', password: '' }); // Changed from loginForm
        
        // Filters
        const activeFilters = ref({ // Changed from filters
            staffType: '',
            status: '',
            search: ''
        });

        // ============ PERMISSION ENGINE ============
        const permissionMatrix = {
            system_admin: {
                view_dashboard: true,
                system_access: true,
                manage_users: true,
                change_user_roles: true,
                reset_user_password: true,
                view_audit_logs: true,
                export_data: true,
                view_medical_staff: true,
                create_medical_staff: true,
                edit_medical_staff: true,
                assign_staff: true,
                view_training_units: true,
                create_training_unit: true,
                edit_training_unit: true,
                view_unit_details: true,
                create_actions: true,
                create_assignment: true,
                create_rotation: true,
                create_announcement: true,
                create_oncall: true,
                create_leave: true,
                view_rotations: true,
                view_assignments: true,
                view_oncall: true,
                view_leave: true,
                view_announcements: true,
                medical_staff_view: true,
                training_units_view: true,
                resident_rotations_view: true,
                daily_assignments_view: true,
                oncall_schedule_view: true,
                leave_management_view: true,
                announcements_view: true,
                user_management_view: true,
                audit_logs_view: true
            },
            department_head: {
                view_dashboard: true,
                system_access: false,
                manage_users: false,
                change_user_roles: false,
                reset_user_password: false,
                view_audit_logs: false,
                export_data: true,
                view_medical_staff: true,
                create_medical_staff: true,
                edit_medical_staff: true,
                assign_staff: true,
                view_training_units: true,
                create_training_unit: true,
                edit_training_unit: true,
                view_unit_details: true,
                create_actions: true,
                create_assignment: true,
                create_rotation: true,
                create_announcement: true,
                create_oncall: true,
                create_leave: true,
                view_rotations: true,
                view_assignments: true,
                view_oncall: true,
                view_leave: true,
                view_announcements: true,
                medical_staff_view: true,
                training_units_view: true,
                resident_rotations_view: true,
                daily_assignments_view: true,
                oncall_schedule_view: true,
                leave_management_view: true,
                announcements_view: true,
                user_management_view: false,
                audit_logs_view: false
            },
            resident_manager: {
                view_dashboard: true,
                system_access: false,
                manage_users: false,
                change_user_roles: false,
                reset_user_password: false,
                view_audit_logs: false,
                export_data: true,
                view_medical_staff: true,
                create_medical_staff: true,
                edit_medical_staff: true,
                assign_staff: true,
                view_training_units: true,
                create_training_unit: true,
                edit_training_unit: true,
                view_unit_details: true,
                create_actions: true,
                create_assignment: true,
                create_rotation: true,
                create_announcement: false,
                create_oncall: true,
                create_leave: false,
                view_rotations: true,
                view_assignments: true,
                view_oncall: true,
                view_leave: true,
                view_announcements: true,
                medical_staff_view: true,
                training_units_view: true,
                resident_rotations_view: true,
                daily_assignments_view: true,
                oncall_schedule_view: true,
                leave_management_view: true,
                announcements_view: true,
                user_management_view: false,
                audit_logs_view: false
            },
            viewing_doctor: {
                view_dashboard: true,
                system_access: false,
                manage_users: false,
                change_user_roles: false,
                reset_user_password: false,
                view_audit_logs: false,
                export_data: false,
                view_medical_staff: true,
                create_medical_staff: false,
                edit_medical_staff: false,
                assign_staff: false,
                view_training_units: true,
                create_training_unit: false,
                edit_training_unit: false,
                view_unit_details: true,
                create_actions: false,
                create_assignment: false,
                create_rotation: false,
                create_announcement: false,
                create_oncall: false,
                create_leave: false,
                view_rotations: true,
                view_assignments: true,
                view_oncall: true,
                view_leave: true,
                view_announcements: true,
                medical_staff_view: true,
                training_units_view: true,
                resident_rotations_view: true,
                daily_assignments_view: true,
                oncall_schedule_view: true,
                leave_management_view: true,
                announcements_view: true,
                user_management_view: false,
                audit_logs_view: false
            }
        };

        // Permission check function
        const checkPermission = (permission) => {
            if (!currentUser.value) return false;
            const role = currentUser.value.user_role;
            return permissionMatrix[role]?.[permission] || false;
        };

        // ============ DYNAMIC NAVIGATION ============
        const navigationData = computed(() => {
            const sections = [];
            
            if (checkPermission('view_dashboard')) {
                sections.push({
                    id: 'operations',
                    title: 'Operations',
                    items: [
                        { id: 'dashboard', title: 'Dashboard', icon: 'üìä', permission: 'view_dashboard' }
                    ]
                });
            }
            
            const managementItems = [
                { id: 'medical_staff', title: 'Medical Staff', icon: 'üë®‚Äç‚öïÔ∏è', permission: 'medical_staff_view' },
                { id: 'training_units', title: 'Training Units', icon: 'üè•', permission: 'training_units_view' },
                { id: 'resident_rotations', title: 'Rotations', icon: 'üîÑ', permission: 'resident_rotations_view' },
                { id: 'daily_assignments', title: 'Assignments', icon: 'üìÖ', permission: 'daily_assignments_view' }
            ].filter(item => checkPermission(item.permission));
            
            if (managementItems.length > 0) {
                sections.push({
                    id: 'management',
                    title: 'Management',
                    items: managementItems
                });
            }
            
            const schedulingItems = [
                { id: 'oncall_schedule', title: 'On-call', icon: 'üìû', permission: 'oncall_schedule_view' },
                { id: 'leave_management', title: 'Leave', icon: 'üèñÔ∏è', permission: 'leave_management_view' }
            ].filter(item => checkPermission(item.permission));
            
            if (schedulingItems.length > 0) {
                sections.push({
                    id: 'scheduling',
                    title: 'Scheduling',
                    items: schedulingItems
                });
            }
            
            const communicationItems = [
                { id: 'announcements', title: 'Announcements', icon: 'üì¢', permission: 'announcements_view' }
            ].filter(item => checkPermission(item.permission));
            
            if (communicationItems.length > 0) {
                sections.push({
                    id: 'communication',
                    title: 'Communication',
                    items: communicationItems
                });
            }
            
            if (checkPermission('system_access')) {
                sections.push({
                    id: 'system',
                    title: 'System',
                    items: [
                        { id: 'user_management', title: 'User Management', icon: 'üë•', permission: 'user_management_view' },
                        { id: 'audit_logs', title: 'Audit Logs', icon: 'üìã', permission: 'audit_logs_view' }
                    ]
                });
            }
            
            return sections;
        });

        // View metadata
        const viewMetadata = {
            dashboard: { title: 'Dashboard', subtitle: 'Clinical Operations Overview' },
            medical_staff: { title: 'Medical Staff', subtitle: 'Staff Directory and Management' },
            training_units: { title: 'Training Units', subtitle: 'Clinical Unit Management' },
            resident_rotations: { title: 'Resident Rotations', subtitle: 'Rotation Management' },
            daily_assignments: { title: 'Daily Assignments', subtitle: 'Schedule Management' },
            oncall_schedule: { title: 'On-call Schedule', subtitle: 'On-call Rotations' },
            leave_management: { title: 'Leave Management', subtitle: 'Leave Requests and Coverage' },
            announcements: { title: 'Announcements', subtitle: 'Department Communications' },
            user_management: { title: 'User Management', subtitle: 'System Access Control' },
            audit_logs: { title: 'Audit Logs', subtitle: 'System Activity Log' }
        };

        const currentViewInfo = computed(() => {
            return viewMetadata[currentView.value] || { title: 'View', subtitle: '' };
        });

        // ============ DYNAMIC DATA ============
        const medicalStaffData = ref([]);
        const trainingUnitsData = ref([]);
        const systemUsersData = ref([]);
        const recentActivitiesData = ref([]);
        const dashboardMetricsData = ref({});

        // Load all data from database
        const loadSystemData = async () => {
            isLoading.value = true;
            
            try {
                // Load medical staff with role-based filtering
                let staffQuery = supabase.from('medical_staff').select('*');
                
                if (currentUser.value?.user_role === 'resident_manager') {
                    staffQuery = staffQuery.eq('staff_type', 'medical_resident');
                }
                if (currentUser.value?.user_role === 'department_head') {
                    staffQuery = staffQuery.eq('department', 'Pulmonology');
                }
                
                const { data: staffData, error: staffError } = await staffQuery.order('full_name');
                if (!staffError) medicalStaffData.value = staffData || [];
                
                // Load training units
                const { data: unitsData, error: unitsError } = await supabase
                    .from('training_units')
                    .select('*')
                    .order('unit_name');
                if (!unitsError) trainingUnitsData.value = unitsData || [];
                
                // Load system users
                const { data: usersData, error: usersError } = await supabase
                    .from('app_users')
                    .select('*')
                    .order('full_name');
                if (!usersError) systemUsersData.value = usersData || [];
                
                // Load recent activities
                const { data: activitiesData, error: activitiesError } = await supabase
                    .from('audit_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                if (!activitiesError) recentActivitiesData.value = activitiesData || [];
                
                // Calculate dashboard metrics
                const activeStaff = medicalStaffData.value.filter(s => s.employment_status === 'active').length;
                const totalUnits = trainingUnitsData.value.length;
                const occupiedUnits = trainingUnitsData.value.filter(u => 
                    (u.current_residents || 0) >= u.maximum_residents
                ).length;
                
                dashboardMetricsData.value = {
                    totalActive: activeStaff,
                    coverageRate: Math.round((activeStaff / Math.max(medicalStaffData.value.length, 1)) * 100),
                    pendingActions: 0,
                    unitOccupancy: totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0
                };
                
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                isLoading.value = false;
            }
        };

        // Filtered medical staff
        const filteredMedicalStaffData = computed(() => {
            return medicalStaffData.value.filter(staff => {
                if (activeFilters.value.staffType && staff.staff_type !== activeFilters.value.staffType) return false;
                if (activeFilters.value.status && staff.employment_status !== activeFilters.value.status) return false;
                if (activeFilters.value.search) {
                    const search = activeFilters.value.search.toLowerCase();
                    return (
                        (staff.full_name && staff.full_name.toLowerCase().includes(search)) ||
                        (staff.staff_id && staff.staff_id.toLowerCase().includes(search)) ||
                        (staff.professional_email && staff.professional_email.toLowerCase().includes(search))
                    );
                }
                return true;
            });
        });

        // ============ UTILITY FUNCTIONS ============
        const formatDateTime = (timestamp) => {
            if (!timestamp) return 'Never';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        };

        const formatUserRole = (role) => {
            const roles = {
                system_admin: 'System Admin',
                department_head: 'Department Head',
                resident_manager: 'Resident Manager',
                viewing_doctor: 'Viewing Doctor'
            };
            return roles[role] || role;
        };

        const formatStaffCategory = (type) => {
            const types = {
                medical_resident: 'Resident',
                attending_physician: 'Attending',
                fellow: 'Fellow',
                nurse_practitioner: 'Nurse Practitioner'
            };
            return types[type] || type;
        };

        const formatStatusText = (status) => {
            const statuses = {
                active: 'Active',
                on_leave: 'On Leave',
                inactive: 'Inactive',
                pending: 'Pending',
                approved: 'Approved',
                rejected: 'Rejected'
            };
            return statuses[status] || status;
        };

        const getStatusStyle = (status) => {
            const styles = {
                active: 'badge-active',
                pending: 'badge-pending',
                approved: 'badge-active',
                on_leave: 'badge-warning',
                inactive: 'badge-inactive',
                rejected: 'badge-critical'
            };
            return styles[status] || 'badge-inactive';
        };

        const getStaffTypeStyle = (type) => {
            const styles = {
                medical_resident: 'badge-active',
                attending_physician: 'badge-pending',
                fellow: 'badge-warning',
                nurse_practitioner: 'badge-inactive'
            };
            return styles[type] || 'badge-inactive';
        };

        const getUnitStatusStyle = (status) => {
            const styles = {
                active: 'badge-active',
                inactive: 'badge-inactive',
                maintenance: 'badge-warning'
            };
            return styles[status] || 'badge-inactive';
        };

        const getUserInitialsText = (name) => {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substr(0, 2);
        };

        const systemStatusText = computed(() => {
            return 'System Operational';
        });

        const modalDialogTitle = computed(() => {
            const titles = {
                user: editingCurrentItem.value ? 'Edit User' : 'Add New User',
                staff: editingCurrentItem.value ? 'Edit Staff Member' : 'Add New Staff Member',
                unit: editingCurrentItem.value ? 'Edit Training Unit' : 'Add New Training Unit',
                assignment: 'New Daily Assignment',
                rotation: 'New Resident Rotation',
                announcement: 'New Announcement',
                oncall: 'Schedule On-call',
                leave: 'New Leave Request'
            };
            return titles[modalDialogType.value] || 'Form';
        });

        // ============ VIEW MANAGEMENT ============
        const changeView = async (view) => {
            if (!checkPermission(view + '_view')) {
                alert(`Access denied. Your role (${currentUser.value.roleDisplay}) cannot access this view.`);
                return;
            }
            
            currentView.value = view;
            isLoading.value = true;
            
            try {
                await loadSystemData();
            } catch (error) {
                console.error(`Error loading ${view} data:`, error);
            } finally {
                isLoading.value = false;
            }
        };

        const refreshRecentActivities = async () => {
            const { data, error } = await supabase
                .from('audit_logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (!error) recentActivitiesData.value = data || [];
        };

        // ============ MODAL SYSTEM ============
        const openModalDialog = (type, item = null) => {
            modalDialogType.value = type;
            editingCurrentItem.value = item;
            modalDialogData.value = item ? { ...item } : {};
            showModalDialog.value = true;
        };

        const editSelectedItem = (type, item) => {
            openModalDialog(type, item);
        };

        const assignStaffMember = (staff) => {
            alert(`Assignment modal for ${staff.full_name} would open here`);
        };

        const closeModalDialog = () => {
            showModalDialog.value = false;
            modalDialogType.value = '';
            modalDialogData.value = {};
            editingCurrentItem.value = null;
        };

        const saveModalData = async () => {
            isSaving.value = true;
            
            try {
                let tableName, data;
                
                switch (modalDialogType.value) {
                    case 'user':
                        tableName = 'app_users';
                        data = {
                            full_name: modalDialogData.value.full_name,
                            email: modalDialogData.value.email,
                            user_role: modalDialogData.value.user_role,
                            department: modalDialogData.value.department || 'Pulmonology',
                            account_status: 'active'
                        };
                        break;
                        
                    case 'staff':
                        tableName = 'medical_staff';
                        data = {
                            full_name: modalDialogData.value.full_name,
                            professional_email: modalDialogData.value.professional_email,
                            staff_type: modalDialogData.value.staff_type,
                            employment_status: modalDialogData.value.employment_status,
                            department: 'Pulmonology'
                        };
                        break;
                        
                    case 'unit':
                        tableName = 'training_units';
                        data = {
                            unit_name: modalDialogData.value.unit_name,
                            department_name: modalDialogData.value.department_name,
                            maximum_residents: parseInt(modalDialogData.value.maximum_residents) || 4,
                            unit_status: modalDialogData.value.unit_status
                        };
                        break;
                        
                    default:
                        console.log(`Save for ${modalDialogType.value} not implemented`);
                        return;
                }
                
                let result;
                if (editingCurrentItem.value) {
                    result = await supabase
                        .from(tableName)
                        .update(data)
                        .eq('id', editingCurrentItem.value.id);
                } else {
                    result = await supabase
                        .from(tableName)
                        .insert([data]);
                }
                
                if (result.error) throw result.error;
                
                await loadSystemData();
                closeModalDialog();
                alert(`${modalDialogType.value} saved successfully.`);
                
            } catch (error) {
                console.error('Error saving:', error);
                alert(`Error saving ${modalDialogType.value}: ${error.message}`);
            } finally {
                isSaving.value = false;
            }
        };

        const updateUserRoleData = async (userId, newRole) => {
            if (!checkPermission('change_user_roles')) {
                alert('You do not have permission to change user roles.');
                return;
            }
            
            if (confirm(`Change this user's role to ${formatUserRole(newRole)}?`)) {
                try {
                    const { error } = await supabase
                        .from('app_users')
                        .update({ user_role: newRole })
                        .eq('id', userId);
                    
                    if (error) throw error;
                    
                    const user = systemUsersData.value.find(u => u.id === userId);
                    if (user) user.user_role = newRole;
                    
                    await supabase.from('audit_logs').insert([{
                        action_type: 'ROLE_CHANGE',
                        user_id: currentUser.value.id,
                        user_name: currentUser.value.full_name,
                        details: `Changed user role to ${newRole}`,
                        created_at: new Date().toISOString()
                    }]);
                    
                } catch (error) {
                    console.error('Error updating role:', error);
                    alert('Error updating user role.');
                }
            }
        };

        const resetUserPasswordData = (user) => {
            if (!checkPermission('reset_user_password')) {
                alert('You do not have permission to reset passwords.');
                return;
            }
            
            if (confirm(`Reset password for ${user.full_name}? They will receive an email with instructions.`)) {
                console.log(`Password reset for user ${user.id}`);
            }
        };

        const exportSystemData = (type) => {
            alert(`Export ${type} data - would generate CSV/PDF`);
        };

        const showUserOptions = () => {
            if (confirm('Logout from the system?')) {
                performLogout();
            }
        };

        // ============ AUTHENTICATION ============
        const handleUserLogin = async () => {
            isLoading.value = true;
            
            try {
                const email = loginFormData.value.email.trim().toLowerCase();
                const password = loginFormData.value.password;
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                if (authData.user) {
                    const { data: userData, error: userError } = await supabase
                        .from('app_users')
                        .select('*')
                        .eq('email', authData.user.email)
                        .maybeSingle();
                    
                    if (userError) throw userError;
                    
                    if (userData) {
                        currentUser.value = {
                            id: userData.id,
                            email: userData.email,
                            full_name: userData.full_name,
                            user_role: userData.user_role,
                            roleDisplay: formatUserRole(userData.user_role)
                        };
                    } else {
                        const { data: newUser, error: createError } = await supabase
                            .from('app_users')
                            .insert([{
                                id: authData.user.id,
                                email: authData.user.email,
                                full_name: authData.user.email.split('@')[0],
                                user_role: 'viewing_doctor',
                                account_status: 'active'
                            }])
                            .select()
                            .single();
                        
                        if (createError) throw createError;
                        
                        currentUser.value = {
                            id: newUser.id,
                            email: newUser.email,
                            full_name: newUser.full_name,
                            user_role: newUser.user_role,
                            roleDisplay: formatUserRole(newUser.user_role)
                        };
                    }
                    
                    await loadSystemData();
                    currentView.value = 'dashboard';
                }
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Authentication failed. Please check your credentials.');
            } finally {
                isLoading.value = false;
            }
        };

        const performLogout = async () => {
            try {
                await supabase.auth.signOut();
                currentUser.value = null;
                loginFormData.value = { email: '', password: '' };
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // ============ INITIALIZATION ============
        onMounted(async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                const { data: userData } = await supabase
                    .from('app_users')
                    .select('*')
                    .eq('email', session.user.email)
                    .maybeSingle();
                
                if (userData) {
                    currentUser.value = {
                        id: userData.id,
                        email: userData.email,
                        full_name: userData.full_name,
                        user_role: userData.user_role,
                        roleDisplay: formatUserRole(userData.user_role)
                    };
                    
                    await loadSystemData();
                }
            }
        });

        // ============ RETURN STATEMENT ============
        return {
            // State
            currentUser,
            loading: isLoading,
            saving: isSaving,
            currentView,
            showModalDialog,
            modalType: modalDialogType,
            modalData: modalDialogData,
            editingItem: editingCurrentItem,
            loginForm: loginFormData,
            filters: activeFilters,
            
            // Data
            medicalStaff: medicalStaffData,
            trainingUnits: trainingUnitsData,
            systemUsers: systemUsersData,
            recentActivities: recentActivitiesData,
            dashboardMetrics: dashboardMetricsData,
            filteredMedicalStaff: filteredMedicalStaffData,
            
            // Computed
            navigation: navigationData,
            currentViewData: currentViewInfo,
            modalTitle: modalDialogTitle,
            systemStatus: systemStatusText,
            
            // Methods
            hasPermission: checkPermission,
            switchView: changeView,
            formatTime: formatDateTime,
            formatRole: formatUserRole,
            formatStaffType: formatStaffCategory,
            formatStatus: formatStatusText,
            getStatusClass: getStatusStyle,
            getStaffTypeClass: getStaffTypeStyle,
            getUnitStatusClass: getUnitStatusStyle,
            getUserInitials: getUserInitialsText,
            
            // Modal methods
            showModal: openModalDialog,
            editItem: editSelectedItem,
            assignStaff: assignStaffMember,
            closeModal: closeModalDialog,
            saveModal: saveModalData,
            updateUserRole: updateUserRoleData,
            resetUserPassword: resetUserPasswordData,
            exportData: exportSystemData,
            showUserMenu: showUserOptions,
            loadRecentActivities: refreshRecentActivities,
            
            // Auth methods
            handleLogin: handleUserLogin,
            handleLogout: performLogout
        };
    }
}).mount('#app');
</script>
</body>
</html>
