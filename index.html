<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PneumoCare | Advanced Pulmonary Management Platform</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Advanced CSS System with DRBA Indicators */
        :root {
            /* Medical Color System */
            --medical-deep-blue: #003366;
            --medical-blue: #005b8e;
            --medical-teal: #008c8c;
            --medical-green: #10b981;
            --medical-amber: #f59e0b;
            --medical-red: #ef4444;
            --medical-purple: #8b5cf6;
            --medical-cyan: #06b6d4;
            --medical-emerald: #10b981;
            --medical-rose: #f43f5e;
            
            /* Permission Level Colors */
            --permission-full: var(--medical-green);
            --permission-write: var(--medical-blue);
            --permission-read: var(--medical-cyan);
            --permission-none: var(--medical-red);
            --permission-limited: var(--medical-amber);
            
            /* Gray Scale */
            --gray-10: #f8fafc;
            --gray-50: #f1f5f9;
            --gray-100: #e2e8f0;
            --gray-200: #cbd5e1;
            --gray-300: #94a3b8;
            --gray-400: #64748b;
            --gray-500: #475569;
            --gray-600: #334155;
            --gray-700: #1e293b;
            --gray-800: #0f172a;
            --gray-900: #020617;
            
            /* Semantic Colors */
            --primary: var(--medical-deep-blue);
            --secondary: var(--medical-blue);
            --accent: var(--medical-teal);
            --success: var(--medical-green);
            --warning: var(--medical-amber);
            --error: var(--medical-red);
            --info: var(--medical-cyan);
            
            /* Text & Background */
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --text-tertiary: var(--gray-500);
            --background-primary: #f8fafc;
            --background-secondary: #ffffff;
            --background-tertiary: #f1f5f9;
            --background-overlay: rgba(0, 0, 0, 0.5);
            
            /* Borders */
            --border-light: var(--gray-200);
            --border-medium: var(--gray-300);
            --border-dark: var(--gray-400);
            
            /* Shadows */
            --shadow-subtle: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Border Radius */
            --border-radius-xs: 2px;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 24px;
            --border-radius-full: 9999px;
            
            /* Focus States */
            --focus-ring: 0 0 0 3px rgba(0, 91, 142, 0.2);
            --focus-ring-success: 0 0 0 3px rgba(16, 185, 129, 0.2);
            --focus-ring-warning: 0 0 0 3px rgba(245, 158, 11, 0.2);
            --focus-ring-error: 0 0 0 3px rgba(239, 68, 68, 0.2);
            
            /* Z-index Layers */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            --z-toast: 1080;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* Advanced Login System */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, 
                var(--medical-deep-blue) 0%, 
                #004080 50%, 
                var(--medical-blue) 100%);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-2xl);
            padding: 3rem;
            width: 100%;
            max-width: 520px;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
            border-radius: var(--border-radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-large);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--medical-deep-blue);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--medical-deep-blue), var(--medical-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Luxury Role Selector */
        .role-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .role-card {
            padding: 1.75rem 1.25rem;
            border: 2px solid var(--border-light);
            background: var(--background-secondary);
            border-radius: var(--border-radius-xl);
            cursor: pointer;
            transition: all var(--transition-medium);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--medical-blue);
            transform: scaleX(0);
            transition: transform var(--transition-medium);
        }

        .role-card:hover {
            border-color: var(--medical-blue);
            background: var(--background-tertiary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-large);
        }

        .role-card:hover::before {
            transform: scaleX(1);
        }

        .role-card.active {
            border-color: var(--medical-blue);
            background: rgba(0, 91, 142, 0.1);
            box-shadow: var(--shadow-large);
            transform: translateY(-1px);
        }

        .role-card.active::before {
            transform: scaleX(1);
        }

        .role-icon {
            font-size: 2.25rem;
            margin-bottom: 1rem;
            color: var(--medical-blue);
            transition: transform var(--transition-bounce);
        }

        .role-card:hover .role-icon {
            transform: scale(1.1);
        }

        .role-name {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .role-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .role-permission-badge {
            margin-top: 0.75rem;
        }

        /* Permission Badges */
        .permission-badge-elegant {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.75rem;
            border-radius: var(--border-radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .permission-full-elegant {
            background: rgba(16, 185, 129, 0.15);
            color: var(--permission-full);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .permission-write-elegant {
            background: rgba(0, 91, 142, 0.15);
            color: var(--permission-write);
            border: 1px solid rgba(0, 91, 142, 0.3);
        }

        .permission-read-elegant {
            background: rgba(6, 182, 212, 0.15);
            color: var(--permission-read);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .permission-limited-elegant {
            background: rgba(245, 158, 11, 0.15);
            color: var(--permission-limited);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .permission-none-elegant {
            background: rgba(239, 68, 68, 0.15);
            color: var(--permission-none);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* App Container */
        .app-wrapper {
            min-height: 100vh;
            background: var(--background-primary);
        }

        /* Luxury Main Container */
        .main-app-container {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Luxury Sidebar */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, 
                var(--medical-deep-blue) 0%, 
                #004080 40%, 
                var(--medical-blue) 100%);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            z-index: var(--z-fixed);
            border-right: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition-medium);
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.mobile-open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
            flex-shrink: 0;
        }

        .collapse-toggle {
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.12);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .collapse-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo-elegant {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.75rem;
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .brand-text {
            color: white;
            flex: 1;
        }

        .brand-text h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 6px;
            letter-spacing: -0.25px;
            line-height: 1.2;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
        }

        .permission-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius-md);
            font-size: 0.75rem;
        }

        .permission-label {
            color: rgba(255,255,255,0.7);
        }

        .permission-level-badge {
            padding: 0.125rem 0.5rem;
            background: var(--medical-green);
            color: white;
            border-radius: var(--border-radius-full);
            font-weight: 700;
            font-size: 0.7rem;
        }

        .sidebar-nav {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .nav-item-elegant {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border: none;
            background: none;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            color: rgba(255,255,255,0.85);
            transition: var(--transition-medium);
            font-size: 0.95rem;
            font-weight: 500;
            position: relative;
            text-align: left;
            width: 100%;
        }

        .nav-item-elegant:hover {
            background: rgba(255,255,255,0.12);
            color: white;
            transform: translateX(5px);
        }

        .nav-item-elegant.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-inner);
        }

        .nav-item-elegant.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: white;
            border-radius: var(--border-radius-full);
        }

        .nav-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .nav-permission {
            margin-left: auto;
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
            flex-shrink: 0;
        }

        .user-profile-compact {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar-compact {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--medical-purple), var(--medical-cyan));
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .user-details-compact {
            flex: 1;
            min-width: 0;
        }

        .user-name-compact {
            font-weight: 700;
            color: white;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role-compact {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .permission-manager-toggle {
            background: rgba(255,255,255,0.12);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .permission-manager-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* Luxury Main Content */
        .main-content {
            flex: 1;
            margin-left: 320px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition-medium);
            background: var(--background-primary);
        }

        .main-content.expanded {
            margin-left: 80px;
        }

        /* Luxury Header */
        .content-header {
            background: var(--background-secondary);
            padding: 1.5rem 2.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-subtle);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .header-title .subtitle {
            color: var(--text-secondary);
            font-size: 0.925rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .permission-context {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--background-tertiary);
            border-radius: var(--border-radius-lg);
            border-left: 3px solid var(--medical-blue);
        }

        .permission-context-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .permission-context-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--medical-blue);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Advanced Search */
        .search-container {
            position: relative;
            width: 320px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.875rem 1.25rem 0.875rem 3rem;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            background: var(--background-secondary);
            font-size: 0.925rem;
            transition: var(--transition-medium);
            box-shadow: var(--shadow-subtle);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--medical-blue);
            box-shadow: var(--focus-ring);
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 1;
        }

        /* User Profile Header */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.625rem 0.875rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            background: var(--background-tertiary);
            position: relative;
        }

        .user-profile-header:hover {
            background: var(--gray-100);
        }

        .user-info-header {
            text-align: right;
        }

        .user-name-header {
            font-weight: 800;
            font-size: 0.925rem;
            color: var(--text-primary);
        }

        .user-role-header {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .dropdown-icon {
            font-size: 0.7rem;
        }

        .user-avatar-header {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--medical-purple), var(--medical-cyan));
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.95rem;
            position: relative;
        }

        .user-status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--medical-green);
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-status-indicator.active {
            background: var(--medical-green);
        }

        /* Content Area */
        .content-area {
            padding: 2.5rem;
            flex: 1;
            overflow-y: auto;
        }

        /* Luxury Cards */
        .card-elegant {
            background: var(--background-secondary);
            border-radius: var(--border-radius-2xl);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-large);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: var(--transition-medium);
        }

        .card-elegant:hover {
            box-shadow: var(--shadow-xl);
        }

        .card-header-elegant {
            padding: 1.75rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, 
                var(--background-tertiary) 0%, 
                var(--background-secondary) 100%);
        }

        .card-title-elegant {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .card-icon-elegant {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .card-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .permission-required {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            background: var(--background-tertiary);
            border-radius: var(--border-radius-md);
            border-left: 3px solid var(--medical-amber);
        }

        .card-content {
            padding: 2rem;
        }

        /* Advanced Metrics Grid */
        .metric-grid-elegant {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .metric-card-elegant {
            background: var(--background-secondary);
            border-radius: var(--border-radius-xl);
            padding: 2rem;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            transition: var(--transition-medium);
        }

        .metric-card-elegant:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-large);
        }

        .metric-card-elegant::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--medical-blue), var(--medical-teal));
        }

        .metric-value {
            font-size: 2.75rem;
            font-weight: 900;
            color: var(--medical-blue);
            margin-bottom: 0.75rem;
            line-height: 1;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-full);
        }

        .metric-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--medical-green);
        }

        .metric-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--medical-red);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-trend-elegant {
            height: 4px;
            background: var(--gray-200);
            border-radius: var(--border-radius-full);
            margin-top: 1rem;
            overflow: hidden;
        }

        .metric-trend-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--medical-blue), var(--medical-teal));
            transition: width 1s ease-out;
        }

        /* Person Cards */
        .person-card-elegant {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.5rem;
            background: var(--background-secondary);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--border-light);
            margin-bottom: 1rem;
            transition: var(--transition-medium);
            position: relative;
        }

        .person-card-elegant:hover {
            border-color: var(--medical-blue);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .person-avatar-elegant {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-cyan));
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: 800;
            flex-shrink: 0;
            position: relative;
        }

        .person-avatar-elegant.resident {
            background: linear-gradient(135deg, var(--medical-purple), var(--medical-cyan));
        }

        .person-avatar-elegant.attending {
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
        }

        .person-status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-active { background: var(--medical-green); }
        .status-on_leave { background: var(--medical-amber); }
        .status-inactive { background: var(--medical-red); }

        .person-info-elegant {
            flex: 1;
            min-width: 0;
        }

        .person-name-elegant {
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .staff-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-full);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-resident-advanced {
            background: rgba(139, 92, 246, 0.1);
            color: var(--medical-purple);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .badge-attending-advanced {
            background: rgba(0, 91, 142, 0.1);
            color: var(--medical-blue);
            border: 1px solid rgba(0, 91, 142, 0.2);
        }

        .supervisor-badge {
            background: rgba(245, 158, 11, 0.1);
            color: var(--medical-amber);
            border: 1px solid rgba(245, 158, 11, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
        }

        .person-clinic-elegant {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clinic-info {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .person-meta-elegant {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .employment-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .person-permissions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .action-buttons-elegant {
            display: flex;
            gap: 0.5rem;
        }

        .action-button-elegant {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-light);
            background: var(--background-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .action-button-elegant:hover {
            transform: translateY(-1px);
        }

        .action-button-elegant.view:hover {
            background: rgba(0, 91, 142, 0.1);
            color: var(--medical-blue);
            border-color: var(--medical-blue);
        }

        .action-button-elegant.edit:hover {
            background: rgba(245, 158, 11, 0.1);
            color: var(--medical-amber);
            border-color: var(--medical-amber);
        }

        .action-button-elegant.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--medical-red);
            border-color: var(--medical-red);
        }

        /* Form Elements */
        .form-group-elegant {
            margin-bottom: 1.75rem;
            position: relative;
        }

        .form-label-elegant {
            display: block;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-label-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label-icon {
            color: var(--medical-blue);
            font-size: 0.9rem;
        }

        .required-indicator {
            color: var(--medical-red);
        }

        .form-input-with-icon {
            position: relative;
        }

        .form-input-elegant {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            background: var(--background-secondary);
            font-size: 0.95rem;
            transition: var(--transition-medium);
            box-shadow: var(--shadow-subtle);
        }

        .form-input-elegant:focus {
            outline: none;
            border-color: var(--medical-blue);
            box-shadow: var(--focus-ring);
        }

        .form-input-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .form-select-elegant {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            background: var(--background-secondary);
            font-size: 0.95rem;
            transition: var(--transition-medium);
            box-shadow: var(--shadow-subtle);
        }

        .form-select-elegant:focus {
            outline: none;
            border-color: var(--medical-blue);
            box-shadow: var(--focus-ring);
        }

        /* Buttons */
        .btn-primary-elegant {
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.925rem;
            transition: var(--transition-medium);
            position: relative;
            overflow: hidden;
        }

        .btn-primary-elegant::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary-elegant:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary-elegant:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary-elegant:active {
            transform: translateY(0);
        }

        .btn-primary-elegant:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--gray-400);
        }

        .btn-primary-elegant:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn-secondary-elegant {
            background: var(--background-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-light);
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: var(--transition-medium);
        }

        .btn-secondary-elegant:hover {
            background: var(--background-tertiary);
            border-color: var(--medical-blue);
            transform: translateY(-1px);
        }

        .btn-outline-elegant {
            background: transparent;
            color: var(--medical-blue);
            border: 2px solid var(--medical-blue);
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: var(--transition-medium);
        }

        .btn-outline-elegant:hover {
            background: var(--medical-blue);
            color: white;
            transform: translateY(-1px);
        }

        .btn-success-elegant {
            background: linear-gradient(135deg, var(--medical-green), #0da67a);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.925rem;
            transition: var(--transition-medium);
        }

        .btn-success-elegant:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-danger-elegant {
            background: linear-gradient(135deg, var(--medical-red), #dc2626);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.925rem;
            transition: var(--transition-medium);
        }

        .btn-danger-elegant:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Loading Spinner */
        .loading-spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: var(--z-fixed);
            background: var(--medical-blue);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-lg);
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            transition: var(--transition-medium);
        }

        .mobile-menu-toggle:hover {
            background: var(--medical-deep-blue);
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state-elegant {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            position: relative;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--gray-300);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .empty-state-description {
            font-size: 1rem;
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-actions {
            margin-top: 1.5rem;
        }

        /* Toast System */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
            width: 90%;
            max-width: 400px;
        }

        .toast-elegant {
            background: var(--background-secondary);
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: var(--border-radius-xl);
            z-index: var(--z-toast);
            box-shadow: var(--shadow-2xl);
            display: flex;
            align-items: center;
            gap: 0.875rem;
            width: 100%;
            animation: toastSlideUp 0.3s ease-out;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .toast-elegant::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        @keyframes toastSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(16, 185, 129, 0.85));
        }
        .toast-success::before { background: var(--medical-green); }

        .toast-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(239, 68, 68, 0.85));
        }
        .toast-error::before { background: var(--medical-red); }

        .toast-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(245, 158, 11, 0.85));
        }
        .toast-warning::before { background: var(--medical-amber); }

        .toast-info {
            background: linear-gradient(135deg, rgba(0, 91, 142, 0.95), rgba(0, 91, 142, 0.85));
        }
        .toast-info::before { background: var(--medical-blue); }

        .toast-permission {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(139, 92, 246, 0.85));
        }
        .toast-permission::before { background: var(--medical-purple); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            opacity: 0.8;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Modal Overlay */
        .modal-overlay-elegant {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal-backdrop);
            padding: 2rem;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-elegant {
            background: var(--background-secondary);
            border-radius: var(--border-radius-2xl);
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid var(--border-light);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header-elegant {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
        }

        .modal-title-elegant {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.875rem;
        }

        .modal-title-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--medical-blue), var(--medical-teal));
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .modal-close-elegant {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .modal-close-elegant:hover {
            background: var(--gray-50);
            color: var(--text-primary);
        }

        .modal-permission-banner {
            background: linear-gradient(90deg, rgba(0, 91, 142, 0.1), rgba(6, 182, 212, 0.1));
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-left: 4px solid var(--medical-blue);
        }

        .modal-form {
            margin-top: 1.5rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 1rem;
            }
            
            .login-card {
                padding: 2rem;
            }
            
            .role-selector {
                grid-template-columns: 1fr;
            }
            
            .content-header {
                padding: 1.25rem;
                flex-direction: column;
                gap: 1.25rem;
            }
            
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .search-container {
                width: 100%;
            }
            
            .content-area {
                padding: 1.5rem;
            }
            
            .metric-grid-elegant {
                grid-template-columns: 1fr;
            }
            
            .modal-elegant {
                margin: 1rem;
                padding: 1.75rem;
            }
        }

        @media (max-width: 480px) {
            .person-card-elegant {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .person-info-elegant {
                width: 100%;
            }
            
            .action-buttons-elegant {
                align-self: flex-end;
            }
            
            .btn-primary-elegant,
            .btn-secondary-elegant,
            .btn-outline-elegant {
                width: 100%;
                justify-content: center;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-tertiary);
            border-radius: var(--border-radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: var(--border-radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .content-header,
            .btn-primary-elegant,
            .action-button-elegant,
            .permission-manager-toggle {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .card-elegant {
                box-shadow: none;
                border: 1px solid var(--border-dark);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ============ LUXURY LOGIN SCREEN ============ -->
        <div class="app-wrapper">
            <div v-if="!currentUser" class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <div class="login-logo">
                            <i class="fas fa-lungs"></i>
                        </div>
            
                        <h1 class="login-title">PneumoCare</h1>
                        <div class="login-subtitle">ADVANCED PULMONARY MANAGEMENT PLATFORM</div>
                        <div class="login-security-info">
                            <i class="fas fa-shield-alt"></i> 
                            <span>HIPAA Compliant  Enterprise Security  Real-time Analytics</span>
                        </div>
                    </div>
                    
                    <div class="role-selector">
                        <div class="role-card" 
                             :class="{ active: loginForm.user_role === 'resident_manager' }" 
                             @click="loginForm.user_role = 'resident_manager'">
                            <div class="role-icon">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="role-name">Resident Manager</div>
                            <div class="role-desc">Full resident management with administrative control</div>
                            <div class="role-permission-badge">
                                <span class="permission-badge-elegant permission-full-elegant">Full Access</span>
                            </div>
                        </div>
                        
                        <div class="role-card" 
                             :class="{ active: loginForm.user_role === 'department_head' }" 
                             @click="loginForm.user_role = 'department_head'">
                            <div class="role-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="role-name">Department Head</div>
                            <div class="role-desc">Strategic oversight and department administration</div>
                            <div class="role-permission-badge">
                                <span class="permission-badge-elegant permission-full-elegant">Executive</span>
                            </div>
                        </div>
                        
                        <div class="role-card" 
                             :class="{ active: loginForm.user_role === 'system_admin' }" 
                             @click="loginForm.user_role = 'system_admin'">
                            <div class="role-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="role-name">System Admin</div>
                            <div class="role-desc">Complete system configuration and permissions</div>
                            <div class="role-permission-badge">
                                <span class="permission-badge-elegant permission-full-elegant">Super Admin</span>
                            </div>
                        </div>
                        
                        <div class="role-card" 
                             :class="{ active: loginForm.user_role === 'viewing_doctor' }" 
                             @click="loginForm.user_role = 'viewing_doctor'">
                            <div class="role-icon">
                                <i class="fas fa-stethoscope"></i>
                            </div>
                            <div class="role-name">Viewing Doctor</div>
                            <div class="role-desc">Read-only access to schedules and assignments</div>
                            <div class="role-permission-badge">
                                <span class="permission-badge-elegant permission-read-elegant">Read Only</span>
                            </div>
                        </div>
                    </div>
                    
                    <form @submit.prevent="handleAdvancedLogin" class="login-form-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    Email Address
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="email" 
                                       class="form-input-elegant"
                                       v-model="loginForm.email" 
                                       required
                                       placeholder="your.email@hospital.org">
                                <i class="fas fa-envelope form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    Password
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="password" 
                                       class="form-input-elegant"
                                       v-model="loginForm.password" 
                                       required
                                       placeholder="">
                                <i class="fas fa-lock form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant" v-if="loginForm.require_mfa">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </span>
                                    Two-Factor Code
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="text" 
                                       class="form-input-elegant"
                                       v-model="loginForm.mfa_code"
                                       placeholder="000000"
                                       maxlength="6">
                                <i class="fas fa-shield-alt form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-actions-elegant">
                            <div class="login-info">
                                <span class="current-role-display">
                                    <i class="fas fa-user-tag"></i>
                                    Logging in as: <strong>{{ getUserRoleDisplay(loginForm.user_role) }}</strong>
                                </span>
                            </div>
                            <button type="submit" 
                                    class="btn-primary-elegant"
                                    :disabled="loading"
                                    style="min-width: 200px; padding: 1rem 2rem;">
                                <span v-if="loading" class="loading-spinner-small"></span>
                                <span v-else>
                                    <i class="fas fa-sign-in-alt"></i> 
                                    {{ loginForm.require_mfa ? 'Verify & Sign In' : 'Secure Sign In' }}
                                </span>
                            </button>
                        </div>
                    </form>
                    
                    <div class="login-footer">
                        <div class="system-stats">
                            <div class="stat-item">
                                <i class="fas fa-database"></i>
                                <span>System ID: PC-ENT-2024</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock"></i>
                                <span>Last Updated: {{ new Date().toLocaleDateString() }}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-users"></i>
                                <span>Active Users: {{ systemStats.active_users || 42 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ============ MAIN APPLICATION ============ -->
            <div v-else>
                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" @click="toggleMobileMenu">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- ============ LUXURY SIDEBAR ============ -->
                <div class="sidebar" :class="{ 
                    collapsed: sidebarCollapsed,
                    'mobile-open': mobileMenuOpen 
                }">
                    <div class="sidebar-header">
                        <div class="brand">
                            <div class="brand-logo-elegant">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="brand-text">
                                <h1>PneumoCare</h1>
                                <div class="brand-subtitle">PULMONARY EXCELLENCE</div>
                                <div class="permission-indicator">
                                    <span class="permission-label">Access Level:</span>
                                    <span class="permission-level-badge">{{ getUserPermissionLevel() }}</span>
                                </div>
                            </div>
                        </div>
                        <button class="collapse-toggle" @click="sidebarCollapsed = !sidebarCollapsed">
                            <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                        </button>
                    </div>
                    
                    <nav class="sidebar-nav">
                        <!-- Resident Management Section -->
                        <div class="nav-section" v-if="hasAnyPermission(['medical_staff', 'training_units', 'resident_rotations', 'placements'])">
                            <div class="nav-section-title">Resident Management</div>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'medical_staff' }" 
                                    @click="switchView('medical_staff'); closeMobileMenu()"
                                    :data-permission="getViewPermission('medical_staff')">
                                <i class="fas fa-user-graduate nav-icon"></i>
                                <span>Medical Staff</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('medical_staff')}`">
                                    {{ getViewPermission('medical_staff') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'training_units' }" 
                                    @click="switchView('training_units'); closeMobileMenu()"
                                    :data-permission="getViewPermission('training_units')">
                                <i class="fas fa-hospital-alt nav-icon"></i>
                                <span>Training Units</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('training_units')}`">
                                    {{ getViewPermission('training_units') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'resident_rotations' }" 
                                    @click="switchView('resident_rotations'); closeMobileMenu()"
                                    :data-permission="getViewPermission('resident_rotations')">
                                <i class="fas fa-calendar-alt nav-icon"></i>
                                <span>Resident Rotations</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('resident_rotations')}`">
                                    {{ getViewPermission('resident_rotations') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'placements' }" 
                                    @click="switchView('placements'); closeMobileMenu()"
                                    :data-permission="getViewPermission('placements')">
                                <i class="fas fa-map-marker-alt nav-icon"></i>
                                <span>Placements</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('placements')}`">
                                    {{ getViewPermission('placements') }}
                                </span>
                            </button>
                        </div>
                        
                        <!-- Department Oversight Section -->
                        <div class="nav-section" v-if="hasAnyPermission(['department_overview', 'staff_management', 'schedule_approval'])">
                            <div class="nav-section-title">Department Oversight</div>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'department_overview' }" 
                                    @click="switchView('department_overview'); closeMobileMenu()"
                                    :data-permission="getViewPermission('department_overview')">
                                <i class="fas fa-chart-line nav-icon"></i>
                                <span>Department Overview</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('department_overview')}`">
                                    {{ getViewPermission('department_overview') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'staff_management' }" 
                                    @click="switchView('staff_management'); closeMobileMenu()"
                                    :data-permission="getViewPermission('staff_management')">
                                <i class="fas fa-users nav-icon"></i>
                                <span>Staff Management</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('staff_management')}`">
                                    {{ getViewPermission('staff_management') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'schedule_approval' }" 
                                    @click="switchView('schedule_approval'); closeMobileMenu()"
                                    :data-permission="getViewPermission('schedule_approval')">
                                <i class="fas fa-calendar-check nav-icon"></i>
                                <span>Schedule Approval</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('schedule_approval')}`">
                                    {{ getViewPermission('schedule_approval') }}
                                </span>
                            </button>
                        </div>
                        
                        <!-- Operations Section -->
                        <div class="nav-section">
                            <div class="nav-section-title">Operations</div>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'daily_operations' }" 
                                    @click="switchView('daily_operations'); closeMobileMenu()"
                                    :data-permission="getViewPermission('daily_operations')">
                                <i class="fas fa-calendar-day nav-icon"></i>
                                <span>Daily Operations</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('daily_operations')}`">
                                    {{ getViewPermission('daily_operations') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'oncall_schedule' }" 
                                    @click="switchView('oncall_schedule'); closeMobileMenu()"
                                    :data-permission="getViewPermission('oncall_schedule')">
                                <i class="fas fa-phone-alt nav-icon"></i>
                                <span>On-call Schedule</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('oncall_schedule')}`">
                                    {{ getViewPermission('oncall_schedule') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'leave_requests' }" 
                                    @click="switchView('leave_requests'); closeMobileMenu()"
                                    :data-permission="getViewPermission('leave_requests')">
                                <i class="fas fa-calendar-times nav-icon"></i>
                                <span>Leave Requests</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('leave_requests')}`">
                                    {{ getViewPermission('leave_requests') }}
                                </span>
                            </button>
                        </div>
                        
                        <!-- Communications Section -->
                        <div class="nav-section">
                            <div class="nav-section-title">Communications</div>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'announcements' }" 
                                    @click="switchView('announcements'); closeMobileMenu()"
                                    :data-permission="getViewPermission('announcements')">
                                <i class="fas fa-bullhorn nav-icon"></i>
                                <span>Announcements</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('announcements')}`">
                                    {{ getViewPermission('announcements') }}
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'audit_logs' }" 
                                    @click="switchView('audit_logs'); closeMobileMenu()"
                                    :data-permission="getViewPermission('audit_logs')">
                                <i class="fas fa-clipboard-list nav-icon"></i>
                                <span>Audit Logs</span>
                                <span class="nav-permission" :class="`permission-${getViewPermission('audit_logs')}`">
                                    {{ getViewPermission('audit_logs') }}
                                </span>
                            </button>
                        </div>
                        
                        <!-- Administration Section -->
                        <div class="nav-section" v-if="hasPermission('system', 'admin')">
                            <div class="nav-section-title">Administration</div>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'permission_management' }" 
                                    @click="switchView('permission_management'); closeMobileMenu()">
                                <i class="fas fa-user-shield nav-icon"></i>
                                <span>Permission Management</span>
                                <span class="nav-permission permission-full-elegant">
                                    Admin
                                </span>
                            </button>
                            
                            <button class="nav-item-elegant" 
                                    :class="{ active: currentView === 'system_settings' }" 
                                    @click="switchView('system_settings'); closeMobileMenu()">
                                <i class="fas fa-cogs nav-icon"></i>
                                <span>System Settings</span>
                                <span class="nav-permission permission-full-elegant">
                                    Admin
                                </span>
                            </button>
                        </div>
                    </nav>
                    
                    <div class="sidebar-footer">
                        <div class="user-profile-compact">
                            <div class="user-avatar-compact">
                                {{ getInitials(currentUser.full_name) }}
                            </div>
                            <div class="user-details-compact">
                                <div class="user-name-compact">{{ currentUser.full_name }}</div>
                                <div class="user-role-compact">
                                    {{ getUserRoleDisplay(currentUser.user_role) }}
                                    <span class="permission-badge-elegant permission-limited-elegant">
                                        {{ getUserPermissionLevel() }}
                                    </span>
                                </div>
                            </div>
                            <button class="permission-manager-toggle" @click="togglePermissionManager" title="Permissions">
                                <i class="fas fa-shield-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ============ LUXURY MAIN CONTENT ============ -->
                <div class="main-content" :class="{ expanded: sidebarCollapsed }">
                    <!-- Luxury Header -->
                    <header class="content-header">
                        <div class="header-left">
                            <div class="header-title">
                                <h1>{{ getCurrentTitle() }}</h1>
                                <div class="subtitle">
                                    {{ getCurrentSubtitle() }}
                                    <span class="permission-context">
                                        <span class="permission-context-label">Access Level:</span>
                                        <span class="permission-context-value">{{ getViewPermission(currentView) }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="header-actions">
                            <div class="search-container">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" 
                                           class="search-input"
                                           v-model="searchQuery" 
                                           :placeholder="getSearchPlaceholder()"
                                           @input="handleAdvancedSearch">
                                </div>
                            </div>
                            <div class="user-profile-header" @click="toggleUserMenu">
                                <div class="user-info-header">
                                    <div class="user-name-header">{{ currentUser.full_name }}</div>
                                    <div class="user-role-header">
                                        {{ getUserRoleDisplay(currentUser.user_role) }}
                                        <i class="fas fa-chevron-down dropdown-icon"></i>
                                    </div>
                                </div>
                                <div class="user-avatar-header">
                                    {{ getInitials(currentUser.full_name) }}
                                    <div class="user-status-indicator active"></div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Content Area -->
                    <div class="content-area">
                        <!-- Loading State -->
                        <div v-if="loading && !permissionLoading" class="loading-container">
                            <div class="loading-spinner-elegant"></div>
                            <p class="loading-text">Loading System Data...</p>
                            <div class="loading-detail">
                                <i class="fas fa-shield-alt"></i>
                                <span>Verifying permissions...</span>
                            </div>
                        </div>

                        <!-- ============ MEDICAL STAFF VIEW ============ -->
                        <div v-if="currentView === 'medical_staff'">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-user-md"></i>
                                        </div>
                                        Medical Staff Management
                                        <span class="permission-badge-elegant" :class="`permission-${getViewPermission('medical_staff')}-elegant`"
                                              style="margin-left: 1rem;">
                                            {{ getViewPermission('medical_staff') }}
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-primary-elegant" 
                                                @click="showAddMedicalStaffModal"
                                                :disabled="!hasPermission('medical_staff', 'create')"
                                                :data-permission="hasPermission('medical_staff', 'create') ? 'write' : 'none'">
                                            <i class="fas fa-user-plus"></i> Add Medical Staff
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <!-- Metrics Grid -->
                                    <div class="metric-grid-elegant">
                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ stats.totalStaff }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-users"></i>
                                                Total Medical Staff
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '75%' }"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ stats.activeResidents }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-user-graduate"></i>
                                                Active Residents
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '60%' }"></div>
                                            </div>
                                        </div>

                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ stats.attendings }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-user-md"></i>
                                                Attending Physicians
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '85%' }"></div>
                                            </div>
                                        </div>

                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ stats.availableSupervisors }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-user-shield"></i>
                                                Available Supervisors
                                                <span class="permission-badge-elegant permission-limited-elegant">Limited</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '90%' }"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filters and Search -->
                                    <div class="filters-section">
                                        <div class="filter-group">
                                            <select class="form-select-elegant" 
                                                    style="width: 180px;" 
                                                    v-model="staffFilter.staff_type"
                                                    :data-permission="hasPermission('medical_staff', 'read') ? 'read' : 'none'">
                                                <option value="">All Types</option>
                                                <option value="medical_resident">Medical Resident</option>
                                                <option value="attending_physician">Attending Physician</option>
                                                <option value="fellow">Fellow</option>
                                                <option value="nurse_practitioner">Nurse Practitioner</option>
                                            </select>
                                            <select class="form-select-elegant" 
                                                    style="width: 180px;" 
                                                    v-model="staffFilter.employment_status"
                                                    :data-permission="hasPermission('medical_staff', 'read') ? 'read' : 'none'">
                                                <option value="">All Status</option>
                                                <option value="active">Active</option>
                                                <option value="on_leave">On Leave</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                            <div class="search-box-small">
                                                <i class="fas fa-search"></i>
                                                <input type="text" 
                                                       class="search-input-small"
                                                       v-model="staffSearch" 
                                                       placeholder="Search staff...">
                                            </div>
                                            <div class="filter-results">
                                                <span class="results-count">{{ filteredMedicalStaff.length }} results</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Staff List -->
                                    <div v-if="filteredMedicalStaff.length > 0" class="staff-list">
                                        <div v-for="staff in filteredMedicalStaff" 
                                             :key="staff.id" 
                                             class="person-card-elegant">
                                            <div class="person-avatar-elegant" 
                                                 :class="{ 
                                                     resident: staff.staff_type === 'medical_resident',
                                                     attending: staff.staff_type === 'attending_physician'
                                                 }">
                                                {{ getInitials(staff.full_name) }}
                                                <div class="person-status-indicator" 
                                                     :class="`status-${staff.employment_status}`"></div>
                                            </div>
                                            <div class="person-info-elegant">
                                                <div class="person-name-elegant">
                                                    {{ staff.full_name }}
                                                    <span class="staff-type-badge" :class="getStaffTypeClass(staff?.staff_type || '')">
                                                        {{ formatStaffType(staff.staff_type) }}
                                                    </span>
                                                    <span v-if="staff.can_supervise_residents" class="supervisor-badge">
                                                        <i class="fas fa-user-md"></i> Supervisor
                                                    </span>
                                                </div>
                                                <div class="person-clinic-elegant">
                                                    <i class="fas fa-id-card"></i> ID: {{ staff.staff_id }}
                                                    <span v-if="staff.primary_clinic" class="clinic-info">
                                                        <i class="fas fa-hospital"></i> {{ staff.primary_clinic }}
                                                    </span>
                                                </div>
                                                <div class="person-meta-elegant">
                                                    <div v-if="staff.staff_type === 'medical_resident'">
                                                        <strong>Category:</strong> {{ formatResidentCategory(staff.resident_category) }}
                                                        <span v-if="staff.training_year">  <strong>Year:</strong> {{ staff.training_year }}</span>
                                                    </div>
                                                    <div v-if="staff.professional_email">
                                                        <strong>Email:</strong> {{ staff.professional_email }}
                                                    </div>
                                                    <div class="employment-status">
                                                        <i class="fas fa-user-check"></i> {{ formatEmploymentStatus(staff.employment_status) }}
                                                    </div>
                                                </div>
                                                <div class="person-permissions">
                                                    <span class="permission-badge-elegant permission-read-elegant">
                                                        Viewable by: All Staff
                                                    </span>
                                                    <span v-if="hasPermission('medical_staff', 'update')" 
                                                          class="permission-badge-elegant permission-write-elegant">
                                                        Editable by: {{ getUserRoleDisplay(currentUser.user_role) }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="action-buttons-elegant">
                                                <button class="action-button-elegant view" 
                                                        @click="viewMedicalProfile(staff)"
                                                        title="View Complete Profile">
                                                    <i class="fas fa-user-md"></i>
                                                </button>
                                                <button class="action-button-elegant edit" 
                                                        @click="editMedicalStaff(staff)"
                                                        :title="hasPermission('medical_staff', 'update') ? 'Edit' : 'No edit permission'"
                                                        :disabled="!hasPermission('medical_staff', 'update')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-button-elegant delete" 
                                                        v-if="hasPermission('medical_staff', 'delete')"
                                                        @click="deleteMedicalStaff(staff)"
                                                        title="Delete"
                                                        data-permission-level="full">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="empty-state-elegant">
                                        <i class="fas fa-user-graduate empty-state-icon"></i>
                                        <div class="empty-state-title">No medical staff found</div>
                                        <div class="empty-state-description">
                                            {{ hasPermission('medical_staff', 'create') ? 
                                               'Add medical staff to get started' : 
                                               'You don\'t have permission to view medical staff' }}
                                        </div>
                                        <div class="empty-state-actions" v-if="hasPermission('medical_staff', 'create')">
                                            <button class="btn-primary-elegant" @click="showAddMedicalStaffModal">
                                                <i class="fas fa-user-plus"></i> Add First Staff Member
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ TRAINING UNITS VIEW ============ -->
                        <div v-if="currentView === 'training_units'">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-hospital-alt"></i>
                                        </div>
                                        Training Units Management
                                        <span class="permission-badge-elegant" :class="`permission-${getViewPermission('training_units')}-elegant`"
                                              style="margin-left: 1rem;">
                                            {{ getViewPermission('training_units') }}
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-primary-elegant" 
                                                @click="showAddTrainingUnitModal"
                                                :disabled="!hasPermission('training_units', 'create')">
                                            <i class="fas fa-plus"></i> Add Training Unit
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <!-- Metrics Grid -->
                                    <div class="metric-grid-elegant">
                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ trainingUnits.length }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-hospital"></i>
                                                Total Training Units
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '70%' }"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ stats.unitOccupancyRate }}%</div>
                                            <div class="metric-label">
                                                <i class="fas fa-chart-pie"></i>
                                                Occupancy Rate
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: stats.unitOccupancyRate + '%' }"></div>
                                            </div>
                                        </div>

                                        <div class="metric-card-elegant">
                                            <div class="metric-value">{{ trainingUnits.filter(u => u.unit_status === 'active').length }}</div>
                                            <div class="metric-label">
                                                <i class="fas fa-toggle-on"></i>
                                                Active Units
                                                <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                            </div>
                                            <div class="metric-trend-elegant">
                                                <div class="metric-trend-fill" :style="{ width: '90%' }"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Units Grid -->
                                    <div class="units-grid-elegant">
                                        <div v-for="unit in trainingUnits" 
                                             :key="unit.id" 
                                             class="unit-card-elegant">
                                            <div class="unit-header-elegant">
                                                <div class="unit-name-elegant">{{ unit.unit_name }}</div>
                                                <div class="unit-capacity-elegant">
                                                    <i class="fas fa-users"></i>
                                                    {{ unit.current_residents || 0 }}/{{ unit.maximum_residents }}
                                                </div>
                                                <div class="unit-permission-tag">
                                                    {{ getViewPermission('training_units') }}
                                                </div>
                                            </div>
                                            <div class="unit-description">
                                                {{ unit.unit_description }}
                                            </div>
                                            <div class="unit-tags">
                                                <span class="status-chip-elegant" :class="`status-${unit.unit_status}-elegant`">
                                                    {{ unit.unit_status }}
                                                </span>
                                                <span v-if="unit.specialty" class="specialty-badge">
                                                    {{ unit.specialty }}
                                                </span>
                                                <span class="occupancy-badge" :class="calculateUnitOccupancyRate(unit) > 80 ? 'high' : calculateUnitOccupancyRate(unit) > 50 ? 'medium' : 'low'">
                                                    {{ calculateUnitOccupancyRate(unit) }}% Occupancy
                                                </span>
                                            </div>
                                            <div class="unit-residents-section">
                                                <h4>Assigned Residents</h4>
                                                <div v-if="getAssignedResidents(unit.id).length > 0" class="resident-list">
                                                    <div v-for="resident in getAssignedResidents(unit.id).slice(0, 3)" 
                                                         :key="resident.id"
                                                         class="resident-item">
                                                        <div class="resident-avatar-small">
                                                            {{ getInitials(resident.full_name) }}
                                                        </div>
                                                        <div class="resident-name">{{ resident.full_name }}</div>
                                                    </div>
                                                    <div v-if="getAssignedResidents(unit.id).length > 3" class="more-residents">
                                                        +{{ getAssignedResidents(unit.id).length - 3 }} more residents
                                                    </div>
                                                </div>
                                                <div v-else class="no-residents">
                                                    No residents assigned
                                                </div>
                                            </div>
                                            <div class="unit-actions">
                                                <button class="btn-secondary-elegant"
                                                        @click="editTrainingUnit(unit)"
                                                        :disabled="!hasPermission('training_units', 'update')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn-outline-elegant"
                                                        @click="showAssignResidentsModal(unit)"
                                                        :disabled="!hasPermission('placements', 'create')">
                                                    <i class="fas fa-user-plus"></i> Assign
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div v-if="trainingUnits.length === 0" class="empty-state-elegant">
                                        <i class="fas fa-hospital-alt empty-state-icon"></i>
                                        <div class="empty-state-title">No training units found</div>
                                        <div class="empty-state-description">
                                            {{ hasPermission('training_units', 'create') ? 
                                               'Add training units to get started' : 
                                               'You don\'t have permission to view training units' }}
                                        </div>
                                        <div class="empty-state-actions" v-if="hasPermission('training_units', 'create')">
                                            <button class="btn-primary-elegant" @click="showAddTrainingUnitModal">
                                                <i class="fas fa-plus"></i> Add First Training Unit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ RESIDENT ROTATIONS VIEW ============ -->
                        <div v-if="currentView === 'resident_rotations'">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        Resident Rotations
                                        <span class="permission-badge-elegant" :class="`permission-${getViewPermission('resident_rotations')}-elegant`"
                                              style="margin-left: 1rem;">
                                            {{ getViewPermission('resident_rotations') }}
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-primary-elegant" 
                                                @click="showAddRotationModal"
                                                :disabled="!hasPermission('resident_rotations', 'create')">
                                            <i class="fas fa-plus"></i> Schedule Rotation
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <!-- Filters -->
                                    <div class="filters-section">
                                        <div class="filter-group">
                                            <select class="form-select-elegant" 
                                                    style="width: 200px;" 
                                                    v-model="rotationFilter.status">
                                                <option value="">All Status</option>
                                                <option value="scheduled">Scheduled</option>
                                                <option value="active">Active</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                            <select class="form-select-elegant" 
                                                    style="width: 200px;" 
                                                    v-model="rotationFilter.category">
                                                <option value="">All Categories</option>
                                                <option value="clinical_rotation">Clinical Rotation</option>
                                                <option value="elective_rotation">Elective Rotation</option>
                                                <option value="research_rotation">Research</option>
                                            </select>
                                            <div class="search-box-small">
                                                <i class="fas fa-search"></i>
                                                <input type="text" 
                                                       class="search-input-small"
                                                       v-model="rotationFilter.search" 
                                                       placeholder="Search rotations...">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rotations Table -->
                                    <div class="table-elegant">
                                        <div class="table-header-elegant">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Rotation ID</th>
                                                        <th>Resident</th>
                                                        <th>Training Unit</th>
                                                        <th>Duration</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                        <div class="table-body-elegant">
                                            <table>
                                                <tbody>
                                                    <tr v-for="rotation in filteredRotations" :key="rotation.id">
                                                        <td>{{ rotation.rotation_id }}</td>
                                                        <td>{{ getResidentName(rotation.resident_id) }}</td>
                                                        <td>{{ getTrainingUnitName(rotation.training_unit_id) }}</td>
                                                        <td>
                                                            {{ formatDate(rotation.rotation_start_date) }} - 
                                                            {{ formatDate(rotation.rotation_end_date) }}
                                                        </td>
                                                        <td>
                                                            <span class="status-chip-elegant" :class="`status-${rotation.rotation_status}-elegant`">
                                                                {{ rotation.rotation_status }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="action-buttons-elegant">
                                                                <button class="action-button-elegant view" 
                                                                        @click="viewRotationDetails(rotation)"
                                                                        title="View Details">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                                <button class="action-button-elegant edit" 
                                                                        @click="editRotation(rotation)"
                                                                        :disabled="!hasPermission('resident_rotations', 'update')"
                                                                        title="Edit">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="action-button-elegant delete" 
                                                                        v-if="hasPermission('resident_rotations', 'delete')"
                                                                        @click="deleteRotation(rotation)"
                                                                        title="Delete">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div v-if="filteredRotations.length === 0" class="empty-state-elegant">
                                        <i class="fas fa-calendar-alt empty-state-icon"></i>
                                        <div class="empty-state-title">No rotations found</div>
                                        <div class="empty-state-description">
                                            {{ hasPermission('resident_rotations', 'create') ? 
                                               'Schedule rotations to get started' : 
                                               'You don\'t have permission to view rotations' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ DAILY OPERATIONS VIEW ============ -->
                        <div v-if="currentView === 'daily_operations'">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-calendar-day"></i>
                                        </div>
                                        Daily Operations Board
                                        <span class="permission-badge-elegant permission-read-elegant" style="margin-left: 1rem;">
                                            Read Only
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <div class="permission-info">
                                            <i class="fas fa-eye"></i> Visible to all roles
                                        </div>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <!-- Real-time Operations Grid -->
                                    <div class="operations-grid">
                                        <!-- Today's Assignments -->
                                        <div class="operations-card">
                                            <div class="operations-card-header">
                                                <div class="operations-card-title">
                                                    <i class="fas fa-tasks"></i> Today's Assignments
                                                </div>
                                                <span class="permission-badge-elegant permission-read-elegant">Public</span>
                                            </div>
                                            <div class="operations-card-content">
                                                <div v-if="todaysAssignments.length > 0" class="assignments-list">
                                                    <div v-for="assignment in todaysAssignments" :key="assignment.id" 
                                                         class="assignment-item">
                                                        <div class="assignment-staff">{{ assignment.staff_name }}</div>
                                                        <div class="assignment-details">
                                                            {{ assignment.location_name }}  {{ formatTimeRange(assignment.start_time, assignment.end_time) }}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-else class="no-data">
                                                    No assignments today
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- On-call Today -->
                                        <div class="operations-card">
                                            <div class="operations-card-header">
                                                <div class="operations-card-title">
                                                    <i class="fas fa-phone"></i> On-call Today
                                                </div>
                                                <span class="permission-badge-elegant permission-read-elegant">Public</span>
                                            </div>
                                            <div class="operations-card-content">
                                                <div v-if="todaysOnCall.length > 0" class="oncall-list">
                                                    <div v-for="oncall in todaysOnCall" :key="oncall.id" 
                                                         class="oncall-item">
                                                        <div class="oncall-primary">{{ getAttendingName(oncall.primary_physician_id) }}</div>
                                                        <div class="oncall-details">
                                                            {{ oncall.shift_type }}  
                                                            <span v-if="oncall.backup_physician_id">
                                                                Backup: {{ getAttendingName(oncall.backup_physician_id) }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-else class="no-data">
                                                    No on-call scheduled
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Announcements -->
                                        <div class="operations-card">
                                            <div class="operations-card-header">
                                                <div class="operations-card-title">
                                                    <i class="fas fa-bullhorn"></i> Announcements
                                                </div>
                                                <span class="permission-badge-elegant" :class="`permission-${getViewPermission('announcements')}-elegant`">
                                                    {{ getViewPermission('announcements') }}
                                                </span>
                                            </div>
                                            <div class="operations-card-content">
                                                <div v-if="recentAnnouncements.length > 0" class="announcements-list">
                                                    <div v-for="announcement in recentAnnouncements" :key="announcement.id" 
                                                         class="announcement-item">
                                                        <div class="announcement-title">{{ announcement.announcement_title }}</div>
                                                        <div class="announcement-date">{{ formatDateShort(announcement.publish_start_date) }}</div>
                                                        <div class="announcement-priority" :class="announcement.priority_level">
                                                            {{ formatPriorityLevel(announcement.priority_level) }}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-else class="no-data">
                                                    No announcements
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Coverage Alerts -->
                                    <div v-if="coverageAlerts.length > 0" class="alerts-section">
                                        <h3 class="alerts-title">
                                            <i class="fas fa-exclamation-triangle" style="color: var(--medical-amber);"></i>
                                            Coverage Alerts
                                        </h3>
                                        <div class="alerts-list">
                                            <div v-for="alert in coverageAlerts" :key="alert.id" 
                                                 class="alert-card" 
                                                 style="border-left: 4px solid var(--medical-amber);">
                                                <div class="alert-content">
                                                    <div class="alert-title">
                                                        {{ alert.unit_name }} needs residents
                                                    </div>
                                                    <div class="alert-details">
                                                        Current: {{ alert.current }}/{{ alert.capacity }}  
                                                        Occupancy: {{ alert.occupancy_rate }}%  
                                                        Priority: <span class="status-chip-elegant status-critical-elegant">High</span>
                                                    </div>
                                                </div>
                                                <button class="btn-primary-elegant" 
                                                        v-if="hasPermission('placements', 'create')"
                                                        @click="quickAssignToUnit(alert)">
                                                    <i class="fas fa-user-plus"></i> Assign Residents
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Emergency Alerts -->
                                    <div v-if="emergencyAlerts.length > 0" class="emergency-alerts">
                                        <h3 class="emergency-title">
                                            <i class="fas fa-bell" style="color: var(--medical-red);"></i>
                                            Emergency Alerts
                                        </h3>
                                        <div class="emergency-list">
                                            <div v-for="alert in emergencyAlerts" :key="alert.id" 
                                                 class="emergency-card">
                                                <div class="emergency-content">
                                                    <div class="emergency-title">
                                                        <i class="fas fa-exclamation-circle"></i> {{ alert.title }}
                                                    </div>
                                                    <div class="emergency-details">
                                                        {{ alert.message }}
                                                    </div>
                                                </div>
                                                <span class="status-chip-elegant status-critical-elegant">Emergency</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ ON-CALL SCHEDULE VIEW ============ -->
                        <div v-if="currentView === 'oncall_schedule'">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-phone-alt"></i>
                                        </div>
                                        On-call Schedule
                                        <span class="permission-badge-elegant" :class="`permission-${getViewPermission('oncall_schedule')}-elegant`"
                                              style="margin-left: 1rem;">
                                            {{ getViewPermission('oncall_schedule') }}
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-primary-elegant" 
                                                @click="showAddOnCallModal"
                                                :disabled="!hasPermission('oncall_schedule', 'create')">
                                            <i class="fas fa-plus"></i> Schedule On-call
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <!-- Next 7 Days Schedule -->
                                    <div class="schedule-grid">
                                        <div v-for="day in nextSevenDays" :key="day.date" 
                                             class="schedule-day-card" :class="getDayStatus(day)">
                                            <div class="schedule-day-header">
                                                <div class="schedule-day-title">
                                                    {{ formatDateShort(day.date) }}
                                                    <span v-if="isToday(day.date)" class="today-badge">Today</span>
                                                </div>
                                                <span class="day-status" :class="day.status">
                                                    {{ day.status === 'covered' ? 'Covered' : 'Uncovered' }}
                                                </span>
                                            </div>
                                            
                                            <div v-if="day.schedule" class="schedule-details">
                                                <div class="schedule-physician">
                                                    <i class="fas fa-user-md"></i>
                                                    {{ getAttendingName(day.schedule.primary_physician_id) }}
                                                </div>
                                                <div class="schedule-time">
                                                    <i class="fas fa-clock"></i>
                                                    {{ formatTimeRange(day.schedule.start_time, day.schedule.end_time) }}
                                                </div>
                                                <div v-if="day.schedule.backup_physician_id" class="schedule-backup">
                                                    <i class="fas fa-user-plus"></i>
                                                    Backup: {{ getAttendingName(day.schedule.backup_physician_id) }}
                                                </div>
                                            </div>
                                            <div v-else class="no-schedule">
                                                <i class="fas fa-exclamation-circle"></i>
                                                No on-call scheduled
                                            </div>
                                            
                                            <div class="schedule-actions">
                                                <button class="btn-outline-elegant"
                                                        @click="editOnCallSchedule(day)"
                                                        :disabled="!hasPermission('oncall_schedule', 'update')">
                                                    {{ day.schedule ? 'Edit' : 'Schedule' }}
                                                </button>
                                                <button v-if="!day.schedule && hasPermission('oncall_schedule', 'override')"
                                                        class="btn-danger-elegant"
                                                        @click="overrideOnCall(day)">
                                                    Emergency Override
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ PERMISSION MANAGEMENT VIEW ============ -->
                        <div v-if="currentView === 'permission_management' && hasPermission('system', 'admin')">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-user-shield"></i>
                                        </div>
                                        Permission Management
                                    </div>
                                    <div class="card-actions">
                                        <span class="permission-required">
                                            <i class="fas fa-key"></i> Admin Access Required
                                        </span>
                                        <button class="btn-success-elegant" @click="showAddRoleModal">
                                            <i class="fas fa-plus"></i> New Role
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="permission-grid">
                                        <div v-for="role in systemRoles" :key="role.id" class="permission-card-elegant">
                                            <div class="permission-card-header">
                                                <div class="permission-card-title">{{ role.name }}</div>
                                                <div class="permission-badge-elegant" :class="`permission-${role.level}-elegant`">
                                                    {{ role.level }}
                                                </div>
                                            </div>
                                            <div class="permission-card-content">
                                                <div class="role-description">{{ role.description }}</div>
                                                <div class="resource-permissions">
                                                    <div v-for="(permissions, resource) in role.permissions" 
                                                         :key="resource"
                                                         class="resource-row">
                                                        <div class="resource-name">{{ formatResourceName(resource) }}</div>
                                                        <div class="permission-toggles">
                                                            <div class="permission-toggle-container" v-for="action in ['read', 'write', 'delete']" 
                                                                  :key="action">
                                                                <label class="toggle-label">{{ formatActionName(action) }}</label>
                                                                <div class="permission-toggle-elegant">
                                                                    <input type="checkbox" 
                                                                           :checked="permissions[action]"
                                                                           @change="togglePermission(role.id, resource, action)">
                                                                    <span class="permission-toggle-slider-elegant" :class="action"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="role-actions">
                                                    <button class="btn-outline-elegant" 
                                                            @click="editRole(role)">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn-secondary-elegant" 
                                                            @click="cloneRole(role)">
                                                        <i class="fas fa-copy"></i> Clone
                                                    </button>
                                                    <button v-if="role.id !== 'admin'" 
                                                            class="btn-danger-elegant" 
                                                            @click="deleteRole(role)">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============ AUDIT LOGS VIEW ============ -->
                        <div v-if="currentView === 'audit_logs' && hasPermission('audit', 'read')">
                            <div class="card-elegant">
                                <div class="card-header-elegant">
                                    <div class="card-title-elegant">
                                        <div class="card-icon-elegant">
                                            <i class="fas fa-clipboard-list"></i>
                                        </div>
                                        Audit Logs
                                        <span class="permission-badge-elegant permission-limited-elegant" style="margin-left: 1rem;">
                                            Admin View
                                        </span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-primary-elegant" 
                                                @click="exportAuditLogs"
                                                :disabled="!hasPermission('audit', 'export')">
                                            <i class="fas fa-download"></i> Export Logs
                                        </button>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="audit-log-elegant">
                                        <div class="audit-log-header">
                                            <div>Recent Activities</div>
                                            <div class="audit-log-count">
                                                <span class="permission-badge-elegant permission-full-elegant">
                                                    {{ auditLogs.length }} entries
                                                </span>
                                            </div>
                                        </div>
                                        <div class="audit-log-content">
                                            <div v-for="log in auditLogs" :key="log.id" class="audit-log-entry">
                                                <div class="audit-log-icon">
                                                    <i :class="getAuditIcon(log.action)"></i>
                                                </div>
                                                <div class="audit-log-details">
                                                    <div class="audit-log-action">{{ log.action }}</div>
                                                    <div class="audit-log-meta">
                                                        <span class="audit-log-user">{{ log.user_name }}</span>
                                                        <span>{{ formatDateTime(log.timestamp) }}</span>
                                                        <span class="permission-badge-elegant" :class="`permission-${log.permission_level}-elegant`">
                                                            {{ log.permission_level }}
                                                        </span>
                                                    </div>
                                                    <div class="audit-log-resource">
                                                        Resource: {{ log.resource }}  Details: {{ log.details }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============ LUXURY MODALS ============ -->
                
                <!-- 1. MEDICAL STAFF MODAL -->
                <div v-if="medicalStaffModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 700px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                {{ medicalStaffModal.mode === 'add' ? 'Add Medical Staff' : 'Edit Medical Staff' }}
                            </div>
                            <button class="modal-close-elegant" @click="medicalStaffModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-permission-banner">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <strong>Permission Level:</strong> 
                                <span class="permission-badge-elegant" :class="`permission-${getViewPermission('medical_staff')}-elegant`">
                                    {{ getViewPermission('medical_staff') }}
                                </span>
                            </div>
                        </div>
                        
                        <form @submit.prevent="saveMedicalStaff" class="modal-form">
                            <div class="form-container-elegant">
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-id-card"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Basic Information</div>
                                            <div class="form-section-description">Enter the staff member's basic details</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user"></i>
                                                    </span>
                                                    Full Name
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="medicalStaffModal.form.full_name" 
                                                       required
                                                       placeholder="Dr. John Doe">
                                                <i class="fas fa-user form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-tag"></i>
                                                    </span>
                                                    Staff Type
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="medicalStaffModal.form.staff_type" 
                                                    required
                                                    @change="updateStaffTypeFields">
                                                <option value="" disabled>Select staff type...</option>
                                                <option value="medical_resident">Medical Resident</option>
                                                <option value="attending_physician">Attending Physician</option>
                                                <option value="fellow">Fellow</option>
                                                <option value="nurse_practitioner">Nurse Practitioner</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-envelope"></i>
                                                    </span>
                                                    Professional Email
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="email" 
                                                       class="form-input-elegant"
                                                       v-model="medicalStaffModal.form.professional_email"
                                                       required
                                                       placeholder="doctor@hospital.org">
                                                <i class="fas fa-envelope form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-hospital"></i>
                                                    </span>
                                                    Primary Clinic
                                                </span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="medicalStaffModal.form.primary_clinic"
                                                       placeholder="e.g., ICU, Pulmonary Unit">
                                                <i class="fas fa-hospital form-input-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-id-badge"></i>
                                                    </span>
                                                    Staff ID
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="medicalStaffModal.form.staff_id"
                                                       required
                                                       :readonly="medicalStaffModal.mode === 'edit'"
                                                       placeholder="Auto-generated">
                                                <i class="fas fa-hashtag form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user-check"></i>
                                                    </span>
                                                    Employment Status
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="medicalStaffModal.form.employment_status" 
                                                    required>
                                                <option value="active">Active</option>
                                                <option value="on_leave">On Leave</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Resident-specific fields -->
                                <div v-if="medicalStaffModal.form.staff_type === 'medical_resident'" class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-graduation-cap"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Resident Information</div>
                                            <div class="form-section-description">Additional details for medical residents</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-layer-group"></i>
                                                    </span>
                                                    Resident Category
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="medicalStaffModal.form.resident_category"
                                                    required>
                                                <option value="" disabled>Select Category</option>
                                                <option value="pgy1">PGY-1</option>
                                                <option value="pgy2">PGY-2</option>
                                                <option value="pgy3">PGY-3</option>
                                                <option value="pgy4">PGY-4</option>
                                                <option value="pgy5">PGY-5</option>
                                                <option value="department_internal">Department Internal</option>
                                                <option value="rotating_other_dept">Rotating Other Dept</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                    Training Year
                                                </span>
                                            </label>
                                            <input type="number" 
                                                   class="form-input-elegant"
                                                   v-model="medicalStaffModal.form.training_year"
                                                   min="2020" 
                                                   max="2030"
                                                   placeholder="2024">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Permissions Section -->
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Permissions & Status</div>
                                            <div class="form-section-description">Configure staff capabilities and employment status</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-toggle-group">
                                        <div class="form-toggle-elegant" :class="{ active: medicalStaffModal.form.can_supervise_residents }">
                                            <div class="toggle-switch">
                                                <input type="checkbox" 
                                                       v-model="medicalStaffModal.form.can_supervise_residents"
                                                       :checked="medicalStaffModal.form.can_supervise_residents">
                                                <span class="toggle-slider"></span>
                                            </div>
                                            <div>
                                                <div class="toggle-label">Can Supervise Residents</div>
                                                <div class="toggle-description">Allow this staff member to supervise and evaluate residents</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Form Actions -->
                                <div class="form-actions-elegant">
                                    <div class="form-progress">
                                        <span>Form Complete:</span>
                                        <div class="progress-steps">
                                            <div class="progress-step active"></div>
                                            <div class="progress-step"></div>
                                            <div class="progress-step"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button type="button" 
                                                class="btn-secondary-elegant" 
                                                @click="medicalStaffModal.show = false">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="btn-primary-elegant" 
                                                :disabled="saving">
                                            <span v-if="saving" class="loading-spinner-small"></span>
                                            <span v-else>
                                                <i class="fas fa-save"></i>
                                                {{ medicalStaffModal.mode === 'add' ? 'Add Staff' : 'Update Staff' }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 2. TRAINING UNIT MODAL -->
                <div v-if="trainingUnitModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 750px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-hospital-alt"></i>
                                </div>
                                {{ trainingUnitModal.mode === 'add' ? 'Create Training Unit' : 'Edit Training Unit' }}
                            </div>
                            <button class="modal-close-elegant" @click="trainingUnitModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-permission-banner">
                            <i class="fas fa-graduation-cap"></i>
                            <div>
                                <strong>Training Unit Management:</strong> 
                                <span>Configure clinical training environments for residents</span>
                            </div>
                        </div>
                        
                        <form @submit.prevent="saveTrainingUnit" class="modal-form">
                            <div class="form-container-elegant">
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Unit Information</div>
                                            <div class="form-section-description">Define the training unit's basic details</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-hospital"></i>
                                                    </span>
                                                    Unit Name
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="trainingUnitModal.form.unit_name" 
                                                       required
                                                       placeholder="e.g., Pulmonary Intensive Care Unit">
                                                <i class="fas fa-building form-input-icon"></i>
                                            </div>
                                            <div class="unit-code">
                                                <span class="code-label">Unit Code:</span>
                                                <span class="code-value">{{ trainingUnitModal.form.unit_code || 'Auto-generated' }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-stethoscope"></i>
                                                    </span>
                                                    Specialty
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="trainingUnitModal.form.specialty" 
                                                    required>
                                                <option value="" disabled>Select specialty...</option>
                                                <option value="pulmonology">Pulmonology</option>
                                                <option value="critical_care">Critical Care</option>
                                                <option value="sleep_medicine">Sleep Medicine</option>
                                                <option value="interventional_pulmonology">Interventional Pulmonology</option>
                                                <option value="allergy_immunology">Allergy & Immunology</option>
                                                <option value="thoracic_surgery">Thoracic Surgery</option>
                                                <option value="pulmonary_rehabilitation">Pulmonary Rehabilitation</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-align-left"></i>
                                                </span>
                                                Description
                                            </span>
                                        </label>
                                        <textarea class="form-textarea-elegant" 
                                                  v-model="trainingUnitModal.form.unit_description"
                                                  rows="4"
                                                  placeholder="Describe the training unit's focus, facilities, and training objectives..."></textarea>
                                        <div class="description-tips">
                                            <i class="fas fa-lightbulb"></i>
                                            <span>Include key procedures, patient population, and training opportunities</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Location Details -->
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    Location
                                                </span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="trainingUnitModal.form.location"
                                                       placeholder="e.g., Main Hospital, 3rd Floor">
                                                <i class="fas fa-location-arrow form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-phone-alt"></i>
                                                    </span>
                                                    Contact Number
                                                </span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="tel" 
                                                       class="form-input-elegant"
                                                       v-model="trainingUnitModal.form.contact_number"
                                                       placeholder="e.g., (555) 123-4567">
                                                <i class="fas fa-phone form-input-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Capacity & Scheduling</div>
                                            <div class="form-section-description">Configure training capacity and scheduling parameters</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-users"></i>
                                                    </span>
                                                    Maximum Residents
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="capacity-input">
                                                <input type="number" 
                                                       class="form-input-elegant"
                                                       v-model="trainingUnitModal.form.maximum_residents" 
                                                       required
                                                       min="1" 
                                                       max="50">
                                                <div class="capacity-slider">
                                                    <input type="range" 
                                                           v-model="trainingUnitModal.form.maximum_residents"
                                                           min="1" 
                                                           max="50"
                                                           class="slider">
                                                </div>
                                            </div>
                                            <div class="capacity-preview">
                                                <div class="capacity-bar">
                                                    <div class="bar-fill" :style="{ width: (trainingUnitModal.form.current_residents || 0) / trainingUnitModal.form.maximum_residents * 100 + '%' }"></div>
                                                </div>
                                                <div class="capacity-stats">
                                                    <span class="current-capacity">{{ trainingUnitModal.form.current_residents || 0 }} current</span>
                                                    <span class="max-capacity">{{ trainingUnitModal.form.maximum_residents }} maximum</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                    Unit Status
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="trainingUnitModal.form.unit_status"
                                                    required>
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                                <option value="maintenance">Under Maintenance</option>
                                                <option value="closed">Closed</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions-elegant">
                                    <div class="form-validation">
                                        <i class="fas fa-check-circle" :class="trainingUnitModal.form.unit_name && trainingUnitModal.form.specialty && trainingUnitModal.form.maximum_residents ? 'valid' : 'invalid'"></i>
                                        <span>All required fields are complete</span>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button type="button" 
                                                class="btn-secondary-elegant" 
                                                @click="trainingUnitModal.show = false">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="btn-primary-elegant" 
                                                :disabled="saving || !trainingUnitModal.form.unit_name || !trainingUnitModal.form.specialty || !trainingUnitModal.form.maximum_residents">
                                            <span v-if="saving" class="loading-spinner-small"></span>
                                            <span v-else>
                                                <i class="fas fa-save"></i>
                                                {{ trainingUnitModal.mode === 'add' ? 'Create Training Unit' : 'Update Training Unit' }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 3. RESIDENT ROTATION MODAL -->
                <div v-if="rotationModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 850px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                {{ rotationModal.mode === 'add' ? 'Schedule Rotation' : 'Edit Rotation' }}
                            </div>
                            <button class="modal-close-elegant" @click="rotationModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-permission-banner">
                            <i class="fas fa-user-graduate"></i>
                            <div>
                                <strong>Rotation Management:</strong> 
                                <span>Schedule and track resident clinical rotations</span>
                            </div>
                        </div>
                        
                        <form @submit.prevent="saveRotation" class="modal-form">
                            <div class="form-container-elegant">
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-user-graduate"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Rotation Details</div>
                                            <div class="form-section-description">Configure the rotation schedule and assignments</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-hashtag"></i>
                                                    </span>
                                                    Rotation ID
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="text" 
                                                       class="form-input-elegant"
                                                       v-model="rotationModal.form.rotation_id"
                                                       required
                                                       :readonly="rotationModal.mode === 'edit'"
                                                       placeholder="Auto-generated">
                                                <i class="fas fa-id-badge form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-exchange-alt"></i>
                                                    </span>
                                                    Rotation Category
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="rotationModal.form.rotation_category"
                                                    required>
                                                <option value="" disabled>Select category...</option>
                                                <option value="clinical_rotation">Clinical Rotation</option>
                                                <option value="elective_rotation">Elective Rotation</option>
                                                <option value="research_rotation">Research Rotation</option>
                                                <option value="vacation_rotation">Vacation</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user-graduate"></i>
                                                    </span>
                                                    Resident
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="rotationModal.form.resident_id"
                                                    required>
                                                <option value="" disabled>Select resident...</option>
                                                <option v-for="resident in availableResidents" 
                                                        :key="resident.id" 
                                                        :value="resident.id">
                                                    {{ resident.full_name }} ({{ resident.staff_id }})
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-hospital-alt"></i>
                                                    </span>
                                                    Training Unit
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="rotationModal.form.training_unit_id"
                                                    required>
                                                <option value="" disabled>Select training unit...</option>
                                                <option v-for="unit in trainingUnits" 
                                                        :key="unit.id" 
                                                        :value="unit.id"
                                                        :disabled="(unit.current_residents || 0) >= unit.maximum_residents">
                                                    {{ unit.unit_name }} ({{ unit.current_residents || 0 }}/{{ unit.maximum_residents }})
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-plus"></i>
                                                    </span>
                                                    Start Date
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="date" 
                                                       class="form-input-elegant"
                                                       v-model="rotationModal.form.rotation_start_date"
                                                       required>
                                                <i class="fas fa-calendar form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-minus"></i>
                                                    </span>
                                                    End Date
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="date" 
                                                       class="form-input-elegant"
                                                       v-model="rotationModal.form.rotation_end_date"
                                                       required>
                                                <i class="fas fa-calendar form-input-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user-md"></i>
                                                    </span>
                                                    Supervising Attending
                                                </span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="rotationModal.form.supervising_attending_id">
                                                <option value="">Select attending...</option>
                                                <option v-for="attending in medicalStaff.filter(s => s.staff_type === 'attending_physician' && s.can_supervise_residents)" 
                                                        :key="attending.id" 
                                                        :value="attending.id">
                                                    {{ attending.full_name }} ({{ attending.staff_id }})
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-toggle-on"></i>
                                                    </span>
                                                    Rotation Status
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="rotationModal.form.rotation_status"
                                                    required>
                                                <option value="scheduled">Scheduled</option>
                                                <option value="active">Active</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-file-alt"></i>
                                                </span>
                                                Clinical Notes
                                            </span>
                                        </label>
                                        <textarea class="form-textarea-elegant" 
                                                  v-model="rotationModal.form.clinical_notes"
                                                  rows="3"
                                                  placeholder="Add any clinical notes or special instructions..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-actions-elegant">
                                    <div class="form-validation">
                                        <i class="fas fa-check-circle" 
                                           :class="rotationModal.form.rotation_id && rotationModal.form.resident_id && rotationModal.form.training_unit_id && rotationModal.form.rotation_start_date && rotationModal.form.rotation_end_date ? 'valid' : 'invalid'"></i>
                                        <span>All required fields are complete</span>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button type="button" 
                                                class="btn-secondary-elegant" 
                                                @click="rotationModal.show = false">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="btn-primary-elegant" 
                                                :disabled="saving || !rotationModal.form.rotation_id || !rotationModal.form.resident_id || !rotationModal.form.training_unit_id || !rotationModal.form.rotation_start_date || !rotationModal.form.rotation_end_date">
                                            <span v-if="saving" class="loading-spinner-small"></span>
                                            <span v-else>
                                                <i class="fas fa-save"></i>
                                                {{ rotationModal.mode === 'add' ? 'Schedule Rotation' : 'Update Rotation' }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 4. ON-CALL SCHEDULE MODAL -->
                <div v-if="onCallModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 700px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-phone-alt"></i>
                                </div>
                                {{ onCallModal.mode === 'add' ? 'Schedule On-Call Duty' : 'Edit On-Call Schedule' }}
                            </div>
                            <button class="modal-close-elegant" @click="onCallModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-permission-banner">
                            <i class="fas fa-calendar-check"></i>
                            <div>
                                <strong>Schedule Management:</strong> 
                                <span>Ensure 24/7 coverage for critical patient care</span>
                            </div>
                        </div>
                        
                        <form @submit.prevent="saveOnCallSchedule" class="modal-form">
                            <div class="form-container-elegant">
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-calendar-day"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Schedule Details</div>
                                            <div class="form-section-description">Define the on-call duty period and assignments</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar"></i>
                                                    </span>
                                                    Duty Date
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="date" 
                                                       class="form-input-elegant"
                                                       v-model="onCallModal.form.duty_date" 
                                                       required>
                                                <i class="fas fa-calendar-alt form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                    Shift Type
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="onCallModal.form.shift_type" 
                                                    required>
                                                <option value="" disabled>Select shift type...</option>
                                                <option value="primary_call">Primary Call (08:00 - 20:00)</option>
                                                <option value="backup_call">Backup Call (20:00 - 08:00)</option>
                                                <option value="weekend_call">Weekend Call (24 hours)</option>
                                                <option value="holiday_call">Holiday Call (24 hours)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user-md"></i>
                                                    </span>
                                                    Primary Physician
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="onCallModal.form.primary_physician_id" 
                                                    required>
                                                <option value="" disabled>Select primary physician...</option>
                                                <option v-for="doctor in medicalStaff.filter(s => s.staff_type === 'attending_physician' && s.employment_status === 'active')" 
                                                        :key="doctor.id" 
                                                        :value="doctor.id">
                                                    {{ doctor.full_name }} ({{ doctor.staff_id }})
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-user-plus"></i>
                                                    </span>
                                                    Backup Physician
                                                </span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="onCallModal.form.backup_physician_id">
                                                <option value="">None (No backup)</option>
                                                <option v-for="doctor in medicalStaff.filter(s => s.staff_type === 'attending_physician' && s.employment_status === 'active')" 
                                                        :key="doctor.id" 
                                                        :value="doctor.id"
                                                        :disabled="doctor.id === onCallModal.form.primary_physician_id">
                                                    {{ doctor.full_name }} ({{ doctor.staff_id }})
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-play-circle"></i>
                                                    </span>
                                                    Start Time
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="time" 
                                                       class="form-input-elegant"
                                                       v-model="onCallModal.form.start_time" 
                                                       required>
                                                <i class="fas fa-clock form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-stop-circle"></i>
                                                    </span>
                                                    End Time
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="time" 
                                                       class="form-input-elegant"
                                                       v-model="onCallModal.form.end_time" 
                                                       required>
                                                <i class="fas fa-clock form-input-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-stethoscope"></i>
                                                </span>
                                                Coverage Notes
                                            </span>
                                        </label>
                                        <textarea class="form-textarea-elegant" 
                                                  v-model="onCallModal.form.coverage_notes"
                                                  rows="3"
                                                  placeholder="Add any special instructions, contact information, or coverage details..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-actions-elegant">
                                    <div class="action-buttons">
                                        <button type="button" 
                                                class="btn-secondary-elegant" 
                                                @click="onCallModal.show = false">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="btn-primary-elegant" 
                                                :disabled="saving">
                                            <span v-if="saving" class="loading-spinner-small"></span>
                                            <span v-else>
                                                <i class="fas fa-calendar-plus"></i>
                                                {{ onCallModal.mode === 'add' ? 'Schedule On-Call' : 'Update Schedule' }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 5. ANNOUNCEMENT MODAL -->
                <div v-if="announcementModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 800px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                {{ announcementModal.mode === 'add' ? 'Create Announcement' : 'Edit Announcement' }}
                            </div>
                            <button class="modal-close-elegant" @click="announcementModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-permission-banner">
                            <i class="fas fa-megaphone"></i>
                            <div>
                                <strong>Announcement Publisher:</strong> 
                                <span>Communicate important updates to the department</span>
                            </div>
                        </div>
                        
                        <form @submit.prevent="saveAnnouncement" class="modal-form">
                            <div class="form-container-elegant">
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-newspaper"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Announcement Content</div>
                                            <div class="form-section-description">Create clear and informative announcements</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-heading"></i>
                                                </span>
                                                Announcement Title
                                            </span>
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <div class="form-input-with-icon">
                                            <input type="text" 
                                                   class="form-input-elegant"
                                                   v-model="announcementModal.form.announcement_title" 
                                                   required
                                                   placeholder="Enter a clear and descriptive title...">
                                            <i class="fas fa-font form-input-icon"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-align-left"></i>
                                                </span>
                                                Announcement Content
                                            </span>
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <textarea class="form-textarea-elegant"
                                                  v-model="announcementModal.form.announcement_content"
                                                  rows="8"
                                                  required
                                                  placeholder="Write your announcement here..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-section-elegant">
                                    <div class="form-section-header">
                                        <div class="form-section-icon">
                                            <i class="fas fa-cogs"></i>
                                        </div>
                                        <div>
                                            <div class="form-section-title">Distribution Settings</div>
                                            <div class="form-section-description">Control when and to whom this announcement is visible</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-plus"></i>
                                                    </span>
                                                    Publish Date
                                                </span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="date" 
                                                       class="form-input-elegant"
                                                       v-model="announcementModal.form.publish_start_date" 
                                                       required>
                                                <i class="fas fa-calendar-plus form-input-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-calendar-times"></i>
                                                    </span>
                                                    Expiry Date
                                                </span>
                                            </label>
                                            <div class="form-input-with-icon">
                                                <input type="date" 
                                                       class="form-input-elegant"
                                                       v-model="announcementModal.form.publish_end_date">
                                                <i class="fas fa-calendar-times form-input-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid-elegant">
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                    </span>
                                                    Priority Level
                                                </span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="announcementModal.form.priority_level">
                                                <option value="low">Low Priority (Information)</option>
                                                <option value="medium">Medium Priority (Important)</option>
                                                <option value="high">High Priority (Urgent)</option>
                                                <option value="urgent">Urgent (Critical)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group-elegant">
                                            <label class="form-label-elegant">
                                                <span class="form-label-text">
                                                    <span class="form-label-icon">
                                                        <i class="fas fa-users"></i>
                                                    </span>
                                                    Target Audience
                                                </span>
                                            </label>
                                            <select class="form-select-elegant" 
                                                    v-model="announcementModal.form.target_audience">
                                                <option value="all">All Staff</option>
                                                <option value="residents">Residents Only</option>
                                                <option value="attendings">Attending Physicians</option>
                                                <option value="nursing">Nursing Staff</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions-elegant">
                                    <div class="action-buttons">
                                        <button type="button" 
                                                class="btn-secondary-elegant" 
                                                @click="announcementModal.show = false">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="btn-primary-elegant" 
                                                :disabled="saving">
                                            <span v-if="saving" class="loading-spinner-small"></span>
                                            <span v-else>
                                                <i class="fas fa-paper-plane"></i>
                                                {{ announcementModal.mode === 'add' ? 'Publish Announcement' : 'Update Announcement' }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 6. PROFESSIONAL PROFILE MODAL (NEW) -->
                <div v-if="profileViewModal.show" class="modal-overlay-elegant">
                    <div class="modal-elegant" style="max-width: 950px;">
                        <div class="modal-header-elegant">
                            <div class="modal-title-elegant">
                                <div class="modal-title-icon">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                Professional Profile
                                <span class="profile-id-badge">
                                    ID: {{ profileViewModal.staff?.staff_id }}
                                </span>
                            </div>
                            <button class="modal-close-elegant" @click="profileViewModal.show = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Profile Tabs -->
                        <div class="profile-tabs">
                            <button class="tab-btn" 
                                    :class="{ active: profileViewModal.activeTab === 'overview' }" 
                                    @click="profileViewModal.activeTab = 'overview'">
                                <i class="fas fa-user"></i> Overview
                            </button>
                            <button class="tab-btn" 
                                    :class="{ active: profileViewModal.activeTab === 'clinical' }" 
                                    @click="profileViewModal.activeTab = 'clinical'">
                                <i class="fas fa-stethoscope"></i> Clinical
                            </button>
                            <button class="tab-btn" 
                                    :class="{ active: profileViewModal.activeTab === 'research' }" 
                                    @click="profileViewModal.activeTab = 'research'">
                                <i class="fas fa-flask"></i> Research
                            </button>
                            <button class="tab-btn" 
                                    :class="{ active: profileViewModal.activeTab === 'academic' }" 
                                    @click="profileViewModal.activeTab = 'academic'">
                                <i class="fas fa-graduation-cap"></i> Academic
                            </button>
                        </div>
                        
                        <div class="profile-content">
                            <!-- Overview Tab -->
                            <div v-if="profileViewModal.activeTab === 'overview'" class="profile-section">
                                <div class="profile-header-overview">
                                    <div class="profile-avatar-large">
                                        {{ getInitials(profileViewModal.staff?.full_name) }}
                                        <div class="profile-status-badge" :class="profileViewModal.profileData?.basicProfile?.profile_status || 'active'">
                                            {{ profileViewModal.profileData?.basicProfile?.profile_status || 'Active' }}
                                        </div>
                                    </div>
                                    
                                    <div class="profile-header-info">
                                        <h2>{{ profileViewModal.staff?.full_name }}</h2>
                                        <div class="profile-subtitle">
                                            <span class="staff-role">{{ formatStaffType(profileViewModal.staff?.staff_type) }}</span>
                                            <span class="staff-department">{{ profileViewModal.profileData?.basicProfile?.specialization || 'Pulmonary Medicine' }}</span>
                                            <span v-if="profileViewModal.profileData?.basicProfile?.board_certification" 
                                                  class="board-certification-badge">
                                                <i class="fas fa-award"></i> {{ profileViewModal.profileData.basicProfile.board_certification }}
                                            </span>
                                        </div>
                                        
                                        <!-- Quick Stats -->
                                        <div class="quick-stats">
                                            <div class="stat-item">
                                                <div class="stat-number">{{ profileYearsOfExperience }}</div>
                                                <div class="stat-label">Years Experience</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-number">{{ profileViewModal.profileData?.basicProfile?.publications_count || 0 }}</div>
                                                <div class="stat-label">Publications</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-number">{{ currentClinicalUnitAssignments?.length || 0 }}</div>
                                                <div class="stat-label">Current Units</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-number">{{ profileViewModal.profileData?.basicProfile?.grants_awarded_count || 0 }}</div>
                                                <div class="stat-label">Grants Awarded</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contact & Availability -->
                                <div class="contact-section">
                                    <h3><i class="fas fa-id-card"></i> Professional Information</h3>
                                    <div class="info-grid">
                                        <div class="info-card">
                                            <h4><i class="fas fa-graduation-cap"></i> Academic Title</h4>
                                            <p>{{ profileViewModal.profileData?.basicProfile?.academic_title || 'Not specified' }}</p>
                                        </div>
                                        <div class="info-card">
                                            <h4><i class="fas fa-calendar-alt"></i> Joined Institution</h4>
                                            <p>{{ formatDate(profileViewModal.profileData?.basicProfile?.joined_institution_date) || 'N/A' }}</p>
                                        </div>
                                        <div class="info-card">
                                            <h4><i class="fas fa-map-marker-alt"></i> Office Location</h4>
                                            <p>{{ profileViewModal.profileData?.basicProfile?.office_location || 'Main Hospital Building' }}</p>
                                        </div>
                                        <div class="info-card">
                                            <h4><i class="fas fa-clock"></i> Office Hours</h4>
                                            <p>{{ profileViewModal.profileData?.basicProfile?.office_hours || 'Mon-Fri, 9am-5pm' }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Basic Information -->
                                <div class="basic-info-section">
                                    <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                                    <div class="info-table">
                                        <div class="info-row">
                                            <span class="info-label">Staff ID:</span>
                                            <span class="info-value">{{ profileViewModal.staff?.staff_id }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Email:</span>
                                            <span class="info-value">{{ profileViewModal.staff?.professional_email || 'N/A' }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Status:</span>
                                            <span class="info-value status-badge" :class="profileViewModal.staff?.employment_status">
                                                {{ formatEmploymentStatus(profileViewModal.staff?.employment_status) }}
                                            </span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Primary Clinic:</span>
                                            <span class="info-value">{{ profileViewModal.staff?.primary_clinic || 'N/A' }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Can Supervise:</span>
                                            <span class="info-value status-badge" :class="profileViewModal.staff?.can_supervise_residents ? 'status-available' : 'status-inactive'">
                                                {{ profileViewModal.staff?.can_supervise_residents ? 'Yes' : 'No' }}
                                            </span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Last Updated:</span>
                                            <span class="info-value">{{ formatDate(profileViewModal.staff?.updated_at) || 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Professional Summary -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.professional_summary" class="summary-section">
                                    <h3><i class="fas fa-file-alt"></i> Professional Summary</h3>
                                    <div class="summary-content">
                                        {{ profileViewModal.profileData.basicProfile.professional_summary }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Clinical Tab -->
                            <div v-if="profileViewModal.activeTab === 'clinical'" class="profile-section">
                                <div class="profile-header-clinical">
                                    <h2><i class="fas fa-stethoscope"></i> Clinical Information</h2>
                                    <span class="permission-badge-elegant" :class="`permission-${getViewPermission('profile')}-elegant`">
                                        {{ getViewPermission('profile') }}
                                    </span>
                                </div>
                                
                                <!-- Current Clinical Units -->
                                <div v-if="currentClinicalUnitAssignments.length > 0" class="clinical-units-section">
                                    <h3><i class="fas fa-hospital-alt"></i> Current Clinical Units</h3>
                                    <div class="units-grid">
                                        <div v-for="unit in currentClinicalUnitAssignments" :key="unit.id" class="unit-card">
                                            <div class="unit-header">
                                                <div class="unit-name">{{ unit.training_units?.unit_name || 'Clinical Unit' }}</div>
                                                <span class="unit-role">{{ unit.role || 'Medical Staff' }}</span>
                                            </div>
                                            <div class="unit-details">
                                                <div class="unit-period">
                                                    <i class="fas fa-calendar"></i>
                                                    {{ formatDate(unit.start_date) }} - 
                                                    {{ unit.end_date ? formatDate(unit.end_date) : 'Present' }}
                                                </div>
                                                <div v-if="unit.responsibilities" class="unit-responsibilities">
                                                    <strong>Responsibilities:</strong> {{ unit.responsibilities }}
                                                </div>
                                                <div v-if="unit.supervisor" class="unit-supervisor">
                                                    <strong>Supervisor:</strong> {{ unit.supervisor }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Clinical Expertise -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.clinical_expertise" class="expertise-section">
                                    <h3><i class="fas fa-star"></i> Clinical Expertise</h3>
                                    <div class="expertise-tags">
                                        <span v-for="expertise in profileViewModal.profileData.basicProfile.clinical_expertise.split(',')" 
                                              :key="expertise.trim()" 
                                              class="expertise-tag">
                                            {{ expertise.trim() }}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Procedures -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.procedures" class="procedures-section">
                                    <h3><i class="fas fa-procedures"></i> Procedures & Specializations</h3>
                                    <div class="procedures-list">
                                        <div v-for="procedure in profileViewModal.profileData.basicProfile.procedures.split(',')" 
                                             :key="procedure.trim()" 
                                             class="procedure-item">
                                            <i class="fas fa-check-circle"></i>
                                            {{ procedure.trim() }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Research Tab -->
                            <div v-if="profileViewModal.activeTab === 'research'" class="profile-section">
                                <div class="profile-header-research">
                                    <h2><i class="fas fa-flask"></i> Research Profile</h2>
                                    <span class="permission-badge-elegant" :class="`permission-${getViewPermission('profile')}-elegant`">
                                        {{ getViewPermission('profile') }}
                                    </span>
                                </div>
                                
                                <!-- Research Overview -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.research_line" class="research-overview">
                                    <h3><i class="fas fa-microscope"></i> Research Line</h3>
                                    <div class="research-content">
                                        {{ profileViewModal.profileData.basicProfile.research_line }}
                                    </div>
                                </div>
                                
                                <!-- Research Interests -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.research_interests" class="interests-section">
                                    <h3><i class="fas fa-lightbulb"></i> Research Interests</h3>
                                    <div class="interests-tags">
                                        <span v-for="interest in profileViewModal.profileData.basicProfile.research_interests.split(',')" 
                                              :key="interest.trim()" 
                                              class="interest-tag">
                                            {{ interest.trim() }}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Recent Achievements -->
                                <div v-if="recentAchievements.length > 0" class="achievements-section">
                                    <h3><i class="fas fa-trophy"></i> Recent Achievements</h3>
                                    <div class="achievements-list">
                                        <div v-for="achievement in recentAchievements" :key="achievement.id" class="achievement-item">
                                            <div class="achievement-icon">
                                                <i :class="getAchievementIcon(achievement.type)"></i>
                                            </div>
                                            <div class="achievement-details">
                                                <div class="achievement-title">{{ achievement.title }}</div>
                                                <div class="achievement-meta">
                                                    <span class="achievement-type">{{ formatAchievementType(achievement.type) }}</span>
                                                    <span class="achievement-year">{{ achievement.year }}</span>
                                                    <span v-if="achievement.journal" class="achievement-journal">{{ achievement.journal }}</span>
                                                </div>
                                                <div v-if="achievement.description" class="achievement-description">
                                                    {{ achievement.description }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Grants & Funding -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.grants" class="grants-section">
                                    <h3><i class="fas fa-money-check-alt"></i> Grants & Funding</h3>
                                    <div class="grants-list">
                                        <div v-for="grant in profileViewModal.profileData.basicProfile.grants.split(';')" 
                                             :key="grant" 
                                             class="grant-item">
                                            <i class="fas fa-dollar-sign"></i>
                                            {{ grant.trim() }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Academic Tab -->
                            <div v-if="profileViewModal.activeTab === 'academic'" class="profile-section">
                                <div class="profile-header-academic">
                                    <h2><i class="fas fa-graduation-cap"></i> Academic Profile</h2>
                                    <span class="permission-badge-elegant" :class="`permission-${getViewPermission('profile')}-elegant`">
                                        {{ getViewPermission('profile') }}
                                    </span>
                                </div>
                                
                                <!-- Education -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.education" class="education-section">
                                    <h3><i class="fas fa-university"></i> Education</h3>
                                    <div class="education-list">
                                        <div v-for="edu in profileViewModal.profileData.basicProfile.education.split(';')" 
                                             :key="edu" 
                                             class="education-item">
                                            <i class="fas fa-graduation-cap"></i>
                                            {{ edu.trim() }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Committee Memberships -->
                                <div v-if="activeCommitteeMemberships.length > 0" class="committees-section">
                                    <h3><i class="fas fa-users"></i> Committee Memberships</h3>
                                    <div class="committees-list">
                                        <div v-for="committee in activeCommitteeMemberships" :key="committee.id" class="committee-item">
                                            <div class="committee-header">
                                                <div class="committee-name">{{ committee.committee_name }}</div>
                                                <span class="committee-role">{{ committee.role }}</span>
                                            </div>
                                            <div class="committee-details">
                                                <div class="committee-period">
                                                    <i class="fas fa-calendar"></i>
                                                    {{ formatDate(committee.start_date) }} - 
                                                    {{ committee.end_date ? formatDate(committee.end_date) : 'Present' }}
                                                </div>
                                                <div v-if="committee.responsibilities" class="committee-responsibilities">
                                                    <strong>Responsibilities:</strong> {{ committee.responsibilities }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Teaching Activities -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.teaching_activities" class="teaching-section">
                                    <h3><i class="fas fa-chalkboard-teacher"></i> Teaching Activities</h3>
                                    <div class="teaching-list">
                                        <div v-for="activity in profileViewModal.profileData.basicProfile.teaching_activities.split(';')" 
                                             :key="activity" 
                                             class="teaching-item">
                                            <i class="fas fa-chalkboard"></i>
                                            {{ activity.trim() }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Certifications -->
                                <div v-if="profileViewModal.profileData?.basicProfile?.certifications" class="certifications-section">
                                    <h3><i class="fas fa-certificate"></i> Certifications & Licenses</h3>
                                    <div class="certifications-list">
                                        <div v-for="cert in profileViewModal.profileData.basicProfile.certifications.split(';')" 
                                             :key="cert" 
                                             class="certification-item">
                                            <i class="fas fa-award"></i>
                                            {{ cert.trim() }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Actions -->
                        <div class="profile-actions">
                            <button class="btn-secondary-elegant" @click="printProfile">
                                <i class="fas fa-print"></i> Print Profile
                            </button>
                            <button class="btn-outline-elegant" @click="exportProfile" :disabled="!hasPermission('profile', 'export')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn-primary-elegant" @click="editProfile" :disabled="!hasPermission('profile', 'update')">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ============ TOAST SYSTEM ============ -->
                <div class="toast-container">
                    <div v-for="toast in toasts" :key="toast.id" class="toast-elegant" :class="`toast-${toast.type}`">
                        <div class="toast-icon">
                            <i :class="toast.icon"></i>
                        </div>
                        <div class="toast-content">
                            <div class="toast-title">{{ toast.title }}</div>
                            <div class="toast-message">{{ toast.message }}</div>
                        </div>
                        <button class="toast-close" @click="removeToast(toast.id)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- ============ USER MENU DROPDOWN ============ -->
                <div v-if="userMenuOpen" class="user-menu-dropdown" @click.stop>
                    <div class="user-menu-header">
                        <div class="user-menu-avatar">
                            {{ getInitials(currentUser.full_name) }}
                        </div>
                        <div class="user-menu-info">
                            <div class="user-menu-name">{{ currentUser.full_name }}</div>
                            <div class="user-menu-role">{{ getUserRoleDisplay(currentUser.user_role) }}</div>
                            <div class="user-menu-status">
                                <span class="status-indicator active"></span>
                                Online
                            </div>
                        </div>
                    </div>
                    <div class="user-menu-items">
                        <button class="user-menu-item" @click="switchView('user_profile'); userMenuOpen = false">
                            <i class="fas fa-user"></i>
                            <span>My Profile</span>
                            <span class="menu-permission-badge" :class="`permission-${getViewPermission('profile')}`">
                                {{ getViewPermission('profile') }}
                            </span>
                        </button>
                        <button class="user-menu-item" @click="togglePermissionManager(); userMenuOpen = false">
                            <i class="fas fa-shield-alt"></i>
                            <span>Permissions</span>
                            <span class="menu-permission-badge" :class="`permission-${getViewPermission('system')}`">
                                {{ getViewPermission('system') }}
                            </span>
                        </button>
                        <button class="user-menu-item" @click="loadUserNotifications(); userMenuOpen = false">
                            <i class="fas fa-bell"></i>
                            <span>Notifications</span>
                            <span v-if="userNotifications.length > 0" class="notification-badge">
                                {{ userNotifications.length }}
                            </span>
                        </button>
                        <button class="user-menu-item" @click="loadSystemSettings(); userMenuOpen = false">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </button>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item logout" @click="handleLogout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>

                <!-- ============ PERMISSION MANAGER OVERLAY ============ -->
                <div v-if="showPermissionManager" class="permission-manager-overlay" @click.self="showPermissionManager = false">
                    <div class="permission-manager-modal">
                        <div class="permission-manager-header">
                            <div class="permission-manager-title">
                                <i class="fas fa-user-shield"></i>
                                Permission Manager
                            </div>
                            <button class="permission-manager-close" @click="showPermissionManager = false">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="permission-manager-content">
                            <div class="current-permissions-section">
                                <h3>Your Current Permissions</h3>
                                <div class="permission-summary">
                                    <div class="summary-item">
                                        <span class="summary-label">Role:</span>
                                        <span class="summary-value">{{ getUserRoleDisplay(currentUser.user_role) }}</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Level:</span>
                                        <span class="summary-value permission-badge-elegant" :class="`permission-${getUserPermissionLevel()}-elegant`">
                                            {{ getUserPermissionLevel() }}
                                        </span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Accessible Modules:</span>
                                        <span class="summary-value">{{ PermissionSystem.getAccessibleResources(currentUser.user_role).length }}</span>
                                    </div>
                                </div>
                                
                                <div class="permission-details">
                                    <h4>Module Permissions</h4>
                                    <div class="permission-grid-small">
                                        <div v-for="resource in PermissionSystem.getAccessibleResources(currentUser.user_role)" 
                                             :key="resource" 
                                             class="permission-item-small">
                                            <div class="permission-resource">{{ PermissionSystem.resources[resource].name }}</div>
                                            <div class="permission-actions">
                                                <span v-for="action in PermissionSystem.resources[resource].actions" 
                                                      :key="action"
                                                      v-if="hasPermission(resource, action)"
                                                      class="action-badge" :class="action">
                                                    {{ formatActionName(action) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Admin-only section for permission management -->
                            <div v-if="hasPermission('system', 'admin')" class="permission-management-section">
                                <h3>Role Management</h3>
                                <div class="permission-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Admin access required to modify permissions</span>
                                </div>
                                
                                <div class="role-management-actions">
                                    <button class="btn-success-elegant" @click="showAddRoleModal">
                                        <i class="fas fa-plus"></i> Add New Role
                                    </button>
                                    <button class="btn-outline-elegant" @click="loadSystemRoles">
                                        <i class="fas fa-sync"></i> Refresh Roles
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="permission-manager-footer">
                            <button class="btn-secondary-elegant" @click="showPermissionManager = false">
                                Close
                            </button>
                            <button v-if="hasPermission('system', 'admin')" 
                                    class="btn-primary-elegant" 
                                    @click="savePermissionChanges"
                                    :disabled="savingPermissions">
                                <span v-if="savingPermissions" class="loading-spinner-small"></span>
                                <span v-else>
                                    <i class="fas fa-save"></i> Save Changes
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>    
    <script>

const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

// Supabase Configuration
const SUPABASE_URL = 'https://vssmguzuvekkecbmwcjw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzc21ndXp1dmVra2VjYm13Y2p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTI4NTIsImV4cCI6MjA4NDE2ODg1Mn0.8qPFsMEn4n5hDfxhgXvq2lQarts8OlL8hWiRYXb-vXw';

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false,
        storage: window.localStorage
    }
});

// Advanced DRBA Permission System
const PermissionSystem = {
    resources: {
        medical_staff: {
            name: 'Medical Staff',
            actions: ['create', 'read', 'update', 'delete', 'export'],
            description: 'Manage medical staff records'
        },
        training_units: {
            name: 'Training Units',
            actions: ['create', 'read', 'update', 'delete', 'assign'],
            description: 'Manage training units and capacities'
        },
        resident_rotations: {
            name: 'Resident Rotations',
            actions: ['create', 'read', 'update', 'delete', 'extend'],
            description: 'Manage resident rotation schedules'
        },
        placements: {
            name: 'Placements',
            actions: ['create', 'read', 'update', 'delete', 'drag_drop'],
            description: 'Assign residents to training units'
        },
        daily_operations: {
            name: 'Daily Operations',
            actions: ['read', 'update', 'alert'],
            description: 'View and manage daily operations'
        },
        oncall_schedule: {
            name: 'On-call Schedule',
            actions: ['create', 'read', 'update', 'delete', 'override'],
            description: 'Manage on-call schedules'
        },
        leave_requests: {
            name: 'Leave Requests',
            actions: ['create', 'read', 'update', 'approve', 'reject'],
            description: 'Manage leave requests and approvals'
        },
        announcements: {
            name: 'Announcements',
            actions: ['create', 'read', 'update', 'delete', 'publish'],
            description: 'Create and manage announcements'
        },
        audit: {
            name: 'Audit Logs',
            actions: ['read', 'export', 'clear'],
            description: 'View system audit logs'
        },
        system: {
            name: 'System Settings',
            actions: ['read', 'update', 'admin'],
            description: 'Manage system settings and permissions'
        },
        profile: {
            name: 'Professional Profiles',
            actions: ['read', 'update', 'export'],
            description: 'View and manage professional profiles'
        }
    },

    roles: {
        system_admin: {
            name: 'System Administrator',
            level: 'full',
            description: 'Full system access and permission management',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: true, export: true },
                training_units: { create: true, read: true, update: true, delete: true, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: true, extend: true },
                placements: { create: true, read: true, update: true, delete: true, drag_drop: true },
                daily_operations: { read: true, update: true, alert: true },
                oncall_schedule: { create: true, read: true, update: true, delete: true, override: true },
                leave_requests: { create: true, read: true, update: true, approve: true, reject: true },
                announcements: { create: true, read: true, update: true, delete: true, publish: true },
                audit: { read: true, export: true, clear: true },
                system: { read: true, update: true, admin: true },
                profile: { read: true, update: true, export: true }
            }
        },
        department_head: {
            name: 'Head of Department',
            level: 'full',
            description: 'Department-wide oversight and management',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: false, export: true },
                training_units: { create: true, read: true, update: true, delete: false, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: false, extend: true },
                placements: { create: true, read: true, update: true, delete: false, drag_drop: true },
                daily_operations: { read: true, update: true, alert: true },
                oncall_schedule: { create: true, read: true, update: true, delete: false, override: true },
                leave_requests: { create: true, read: true, update: true, approve: true, reject: true },
                announcements: { create: true, read: true, update: true, delete: true, publish: true },
                audit: { read: true, export: true, clear: false },
                system: { read: true, update: false, admin: false },
                profile: { read: true, update: true, export: true }
            }
        },
        resident_manager: {
            name: 'Resident Manager',
            level: 'write',
            description: 'Manage residents and training units',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: false, export: false },
                training_units: { create: true, read: true, update: true, delete: false, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: false, extend: true },
                placements: { create: true, read: true, update: true, delete: false, drag_drop: true },
                daily_operations: { read: true, update: true, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: true, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false },
                profile: { read: true, update: false, export: false }
            }
        },
        attending_physician: {
            name: 'Attending Physician',
            level: 'limited',
            description: 'Supervise residents and view schedules',
            permissions: {
                medical_staff: { create: false, read: true, update: false, delete: false, export: false },
                training_units: { create: false, read: true, update: false, delete: false, assign: false },
                resident_rotations: { create: false, read: true, update: false, delete: false, extend: false },
                placements: { create: false, read: true, update: false, delete: false, drag_drop: false },
                daily_operations: { read: true, update: false, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: true, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false },
                profile: { read: true, update: false, export: false }
            }
        },
        viewing_doctor: {
            name: 'Viewing Doctor',
            level: 'read',
            description: 'Read-only access to schedules and assignments',
            permissions: {
                medical_staff: { create: false, read: true, update: false, delete: false, export: false },
                training_units: { create: false, read: true, update: false, delete: false, assign: false },
                resident_rotations: { create: false, read: true, update: false, delete: false, extend: false },
                placements: { create: false, read: true, update: false, delete: false, drag_drop: false },
                daily_operations: { read: true, update: false, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: false, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false },
                profile: { read: true, update: false, export: false }
            }
        }
    },

    // Check if user has permission for a resource action
    hasPermission(userRole, resource, action) {
        const role = this.roles[userRole];
        if (!role || !role.permissions[resource]) return false;
        return role.permissions[resource][action] === true;
    },

    // Get permission level for a resource
    getPermissionLevel(userRole, resource) {
        const role = this.roles[userRole];
        if (!role || !role.permissions[resource]) return 'none';
        
        const permissions = role.permissions[resource];
        if (permissions.create && permissions.update && permissions.delete) return 'full';
        if (permissions.create || permissions.update) return 'write';
        if (permissions.read) return 'read';
        return 'none';
    },

    // Get all resources user has access to
    getAccessibleResources(userRole) {
        const role = this.roles[userRole];
        if (!role) return [];
        
        return Object.keys(this.resources).filter(resource => 
            Object.values(role.permissions[resource] || {}).some(v => v === true)
        );
    }
};

// Create the Vue App
const app = createApp({
    setup() {
        // ============ ADVANCED STATE MANAGEMENT ============
        const currentUser = ref(null);
        const loginForm = ref({
            email: '',
            password: '',
            user_role: 'resident_manager',
            require_mfa: false,
            mfa_code: ''
        });
        
        const loading = ref(false);
        const saving = ref(false);
        const permissionLoading = ref(false);
        const savingPermissions = ref(false);

        // Navigation states
        const currentView = ref('login');
        const sidebarCollapsed = ref(false);
        const mobileMenuOpen = ref(false);
        const showPermissionManager = ref(false);
        const searchQuery = ref('');
        const permissionFilter = ref([]);
        const userMenuOpen = ref(false);
        const activeProfileTab = ref('overview');

        // Data stores
        const medicalStaff = ref([]);
        const trainingUnits = ref([]);
        const residentRotations = ref([]);
        const dailyAssignments = ref([]);
        const leaveRequests = ref([]);
        const onCallSchedule = ref([]);
        const announcements = ref([]);
        const auditLogs = ref([]);
        const systemRoles = ref([]);
        const systemSettings = ref({});
        const userNotifications = ref([]);
        const emergencyContacts = ref([]);
        
        // Profile system states
        const profileViewModal = ref({
            show: false,
            staff: null,
            profileData: null,
            activeTab: 'overview'
        });

        const systemStats = ref({
            active_users: 0,
            total_staff: 0,
            today_assignments: 0,
            pending_approvals: 0,
            unit_occupancy_rate: 0
        });

        // Toast system
        const toasts = ref([]);
        let toastId = 0;

        // ============ MODAL STATES ============
        const medicalStaffModal = ref({
            show: false,
            mode: 'add',
            staff: null,
            form: {
                full_name: '',
                staff_type: 'medical_resident',
                staff_id: '',
                employment_status: 'active',
                can_supervise_residents: false,
                primary_clinic: '',
                professional_email: '',
                resident_category: '',
                training_year: null
            }
        });

        const addRoleModal = ref({
            show: false,
            mode: 'add',
            role: null,
            form: {
                name: '',
                description: '',
                level: 'read'
            }
        });

        const announcementModal = ref({
            show: false,
            mode: 'add',
            announcement: null,
            form: {
                announcement_title: '',
                announcement_content: '',
                publish_start_date: '',
                publish_end_date: '',
                priority_level: 'medium',
                target_audience: 'all'
            }
        });

        const onCallModal = ref({
            show: false,
            mode: 'add',
            schedule: null,
            form: {
                duty_date: '',
                schedule_id: '',
                shift_type: 'backup_call',
                primary_physician_id: '',
                backup_physician_id: '',
                start_time: '08:00',
                end_time: '20:00',
                coverage_notes: ''
            }
        });

        const trainingUnitModal = ref({
            show: false,
            mode: 'add',
            unit: null,
            form: {
                unit_name: '',
                unit_description: '',
                unit_status: 'active',
                maximum_residents: 10,
                specialty: '',
                current_residents: 0
            }
        });

        const leaveRequestModal = ref({
            show: false,
            mode: 'add',
            request: null,
            form: {
                start_date: '',
                end_date: '',
                leave_type: 'vacation',
                reason: '',
                status: 'pending',
                approver_notes: ''
            }
        });

        const rotationModal = ref({
            show: false,
            mode: 'add',
            rotation: null,
            form: {
                rotation_id: '',
                resident_id: '',
                training_unit_id: '',
                supervising_attending_id: '',
                rotation_start_date: '',
                rotation_end_date: '',
                rotation_category: 'clinical_rotation',
                rotation_status: 'scheduled',
                clinical_notes: '',
                supervisor_evaluation: ''
            }
        });

        // Filter states
        const staffSearch = ref('');
        const staffFilter = ref({
            staff_type: '',
            employment_status: ''
        });
        const rotationFilter = ref({
            status: '',
            category: '',
            search: ''
        });

        // ============ PERMISSION SYSTEM ============
        const userPermissions = ref({});
        const permissionResources = ref(PermissionSystem.resources);

        // Initialize user permissions based on role
        const initializePermissions = (userRole) => {
            const role = PermissionSystem.roles[userRole];
            if (role) {
                userPermissions.value = role.permissions;
            }
            logAudit('PERMISSION_INIT', `Permissions initialized for ${userRole}`, 'system');
        };

        const hasPermission = (resource, action) => {
            if (!currentUser.value) return false;
            
            // System admin always has permission
            if (currentUser.value.user_role === 'system_admin') {
                return true;
            }
            
            const role = PermissionSystem.roles[currentUser.value.user_role];
            if (!role || !role.permissions[resource]) {
                return false;
            }
            
            return role.permissions[resource][action] === true;
        };

        const hasAnyPermission = (resources) => {
            if (!currentUser.value) return false;
            return resources.some(resource => 
                Object.keys(userPermissions.value[resource] || {}).some(
                    action => userPermissions.value[resource][action]
                )
            );
        };

        const getViewPermission = (view) => {
            if (!currentUser.value) return 'none';
            
            const viewMap = {
                medical_staff: 'medical_staff',
                training_units: 'training_units',
                resident_rotations: 'resident_rotations',
                placements: 'placements',
                daily_operations: 'daily_operations',
                oncall_schedule: 'oncall_schedule',
                leave_requests: 'leave_requests',
                announcements: 'announcements',
                audit_logs: 'audit',
                department_overview: 'medical_staff',
                staff_management: 'medical_staff',
                schedule_approval: 'leave_requests',
                permission_management: 'system',
                system_settings: 'system',
                user_profile: 'profile'
            };
            
            const resource = viewMap[view];
            if (!resource) return 'none';
            
            return PermissionSystem.getPermissionLevel(currentUser.value.user_role, resource);
        };

        const getUserPermissionLevel = () => {
            if (!currentUser.value) return 'none';
            const role = PermissionSystem.roles[currentUser.value.user_role];
            return role ? role.level : 'none';
        };

        const togglePermission = (roleId, resource, action) => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            const roleIndex = systemRoles.value.findIndex(r => r.id === roleId);
            if (roleIndex === -1) return;
            
            const currentState = systemRoles.value[roleIndex].permissions[resource]?.[action] || false;
            const newState = !currentState;
            
            if (!systemRoles.value[roleIndex].permissions[resource]) {
                systemRoles.value[roleIndex].permissions[resource] = {};
            }
            systemRoles.value[roleIndex].permissions[resource][action] = newState;
            
            showAdvancedToast(
                'Permission Updated',
                `${action} permission for ${resource} ${newState ? 'granted' : 'revoked'}`,
                'permission'
            );
            
            logAudit('PERMISSION_TOGGLE', 
                `Toggled ${action} permission for ${resource} in role ${roleId} to ${newState}`, 
                'system'
            );
        };

        const savePermissionChanges = async () => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            savingPermissions.value = true;
            try {
                // Save to database
                for (const role of systemRoles.value) {
                    const { error } = await supabaseClient
                        .from('system_roles')
                        .upsert({
                            id: role.id,
                            name: role.name,
                            description: role.description,
                            level: role.level,
                            permissions: role.permissions,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                }
                
                showAdvancedToast(
                    'Permissions Saved',
                    'All permission changes have been saved',
                    'success'
                );
                logAudit('PERMISSIONS_SAVED', 'Updated system permissions', 'system');
            } catch (error) {
                console.error('Error saving permissions:', error);
                showAdvancedToast('Save Failed', 'Failed to save permission changes', 'error');
            } finally {
                savingPermissions.value = false;
                showPermissionManager.value = false;
            }
        };

        const getResourcePermissionLevel = (resource) => {
            if (!currentUser.value) return 'none';
            return PermissionSystem.getPermissionLevel(currentUser.value.user_role, resource);
        };

        const getPermissionDescription = (resource, action) => {
            const descriptions = {
                create: 'Create new records',
                read: 'View records',
                update: 'Edit existing records',
                delete: 'Remove records',
                export: 'Export data',
                approve: 'Approve requests',
                override: 'Override restrictions',
                assign: 'Assign to units',
                extend: 'Extend durations',
                drag_drop: 'Drag and drop assignments',
                alert: 'Create alerts',
                publish: 'Publish content',
                clear: 'Clear logs'
            };
            return descriptions[action] || action;
        };

        const formatActionName = (action) => {
            return action.charAt(0).toUpperCase() + action.slice(1);
        };

        const formatResourceName = (resource) => {
            return resource.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        };

        // ============ AUDIT LOGGING SYSTEM ============
        const generateAuditId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        const logAudit = async (action, details, resource, resourceId = null) => {
            const logEntry = {
                id: generateAuditId(),
                timestamp: new Date().toISOString(),
                user_id: currentUser.value?.id,
                user_name: currentUser.value?.full_name,
                user_role: currentUser.value?.user_role,
                action,
                details,
                resource,
                resource_id: resourceId,
                permission_level: getUserPermissionLevel(),
                ip_address: 'system',
                user_agent: navigator.userAgent
            };
            
            auditLogs.value.unshift(logEntry);
            
            try {
                await supabaseClient.from('audit_logs').insert([logEntry]);
            } catch (error) {
                console.error('Failed to save audit log:', error);
            }
        };

        // ============ ADVANCED UTILITIES ============
        const showAdvancedToast = (title, message, type = 'info', duration = 5000) => {
            const icons = {
                info: 'fas fa-info-circle',
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                permission: 'fas fa-shield-alt'
            };
            
            const toast = {
                id: ++toastId,
                title,
                message,
                type,
                icon: icons[type] || icons.info,
                duration
            };
            
            toasts.value.push(toast);
            
            setTimeout(() => {
                removeToast(toast.id);
            }, duration);
        };

        const removeToast = (id) => {
            const index = toasts.value.findIndex(t => t.id === id);
            if (index > -1) {
                toasts.value.splice(index, 1);
            }
        };

        const getInitials = (name) => {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        };

        const formatDateTime = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatTimeRange = (start, end) => {
            const formatTime = (time) => {
                if (!time) return '';
                const [hours, minutes] = time.split(':');
                const hour = parseInt(hours);
                return `${hour % 12 || 12}:${minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
            };
            return `${formatTime(start)} - ${formatTime(end)}`;
        };

        const generateUUID = () => {
            return crypto.randomUUID();
        };

        const getUserRoleDisplay = (role) => {
            const roles = {
                resident_manager: 'Resident Manager',
                department_head: 'Head of Department',
                system_admin: 'System Administrator',
                viewing_doctor: 'Viewing Doctor',
                attending_physician: 'Attending Physician'
            };
            return roles[role] || role;
        };

        const formatStaffType = (type) => {
            const types = {
                medical_resident: 'Medical Resident',
                attending_physician: 'Attending Physician',
                fellow: 'Fellow',
                nurse_practitioner: 'Nurse Practitioner'
            };
            return types[type] || type;
        };

        const getStaffTypeClass = (type) => {
            return type === 'medical_resident' ? 'badge-resident-advanced' : 
                   type === 'attending_physician' ? 'badge-attending-advanced' : 
                   'badge-admin-advanced';
        };

        const getAuditIcon = (action) => {
            const icons = {
                CREATE: 'fas fa-plus-circle',
                UPDATE: 'fas fa-edit',
                DELETE: 'fas fa-trash',
                READ: 'fas fa-eye',
                LOGIN: 'fas fa-sign-in-alt',
                LOGOUT: 'fas fa-sign-out-alt',
                PERMISSION_CHANGE: 'fas fa-user-shield',
                EXPORT: 'fas fa-download',
                IMPORT: 'fas fa-upload'
            };
            return icons[action] || 'fas fa-info-circle';
        };

        const formatResidentCategory = (category) => {
            if (!category || category === 'null' || category === null) return 'N/A';
            const categories = {
                department_internal: 'Department Internal',
                rotating_other_dept: 'Rotating Other Dept',
                pgy1: 'PGY-1',
                pgy2: 'PGY-2',
                pgy3: 'PGY-3',
                pgy4: 'PGY-4',
                pgy5: 'PGY-5'
            };
            return categories[category] || category;
        };

        const formatEmploymentStatus = (status) => {
            const statuses = {
                active: 'Active',
                on_leave: 'On Leave',
                inactive: 'Inactive'
            };
            return statuses[status] || status;
        };

        // ============ PROFILE SYSTEM UTILITIES ============
        const formatAchievementType = (type) => {
            const types = {
                'publication': 'Publication',
                'grant': 'Grant',
                'award': 'Award',
                'presentation': 'Presentation'
            };
            return types[type] || type;
        };

        const getAchievementIcon = (type) => {
            const icons = {
                'publication': 'fas fa-file-alt',
                'grant': 'fas fa-money-check-alt',
                'award': 'fas fa-trophy',
                'presentation': 'fas fa-chalkboard'
            };
            return icons[type] || 'fas fa-star';
        };

        const calculateYearsOfExperience = (joinedDate) => {
            if (!joinedDate) return 0;
            const start = new Date(joinedDate);
            const now = new Date();
            const diffYears = now.getFullYear() - start.getFullYear();
            const monthDiff = now.getMonth() - start.getMonth();
            return monthDiff < 0 ? diffYears - 1 : diffYears;
        };

        const calculateUnitOccupancyRate = (unit) => {
            if (!unit || unit.maximum_residents <= 0) return 0;
            const current = unit.current_residents || 0;
            return Math.round((current / unit.maximum_residents) * 100);
        };

        // ============ COMPUTED PROPERTIES ============
        const stats = computed(() => {
            const residents = medicalStaff.value.filter(s => 
                s.staff_type === 'medical_resident' && s.employment_status === 'active'
            );
            const attendings = medicalStaff.value.filter(s => 
                s.staff_type === 'attending_physician' && s.employment_status === 'active'
            );
            const supervisors = medicalStaff.value.filter(s => 
                s.can_supervise_residents && s.employment_status === 'active'
            );
            
            // Calculate unit occupancy
            let totalCapacity = 0;
            let totalOccupied = 0;
            trainingUnits.value.forEach(unit => {
                totalCapacity += unit.maximum_residents || 0;
                totalOccupied += unit.current_residents || 0;
            });
            const occupancyRate = totalCapacity > 0 ? Math.round((totalOccupied / totalCapacity) * 100) : 0;
            
            return {
                totalStaff: medicalStaff.value.length,
                activeResidents: residents.length,
                attendings: attendings.length,
                availableSupervisors: supervisors.length,
                unitOccupancyRate: occupancyRate
            };
        });

        const filteredMedicalStaff = computed(() => {
            let filtered = medicalStaff.value;
            
            if (staffSearch.value) {
                const search = staffSearch.value.toLowerCase();
                filtered = filtered.filter(s => 
                    s.full_name.toLowerCase().includes(search) ||
                    (s.staff_id && s.staff_id.toLowerCase().includes(search)) ||
                    (s.professional_email && s.professional_email.toLowerCase().includes(search))
                );
            }
            
            if (staffFilter.value.staff_type) {
                filtered = filtered.filter(s => s.staff_type === staffFilter.value.staff_type);
            }
            
            if (staffFilter.value.employment_status) {
                filtered = filtered.filter(s => s.employment_status === staffFilter.value.employment_status);
            }
            
            return filtered;
        });

        const todaysAssignments = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return dailyAssignments.value
                .filter(a => a.assignment_date === today)
                .slice(0, 5);
        });

        const todaysOnCall = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return onCallSchedule.value
                .filter(o => o.duty_date === today)
                .slice(0, 3);
        });

        const recentAnnouncements = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return announcements.value
                .filter(a => a.publish_start_date <= today && (!a.publish_end_date || a.publish_end_date >= today))
                .slice(0, 3);
        });

        const coverageAlerts = computed(() => {
            return trainingUnits.value
                .filter(u => u.unit_status === 'active' && (u.current_residents || 0) < u.maximum_residents * 0.5)
                .map(u => ({
                    id: u.id,
                    unit_name: u.unit_name,
                    current: u.current_residents || 0,
                    capacity: u.maximum_residents,
                    priority: 'high',
                    occupancy_rate: calculateUnitOccupancyRate(u)
                }));
        });

        const emergencyAlerts = computed(() => {
            const alerts = [];
            const today = new Date().toISOString().split('T')[0];
            
            // Check for uncovered on-call shifts
            const uncoveredShifts = onCallSchedule.value.filter(o => 
                o.duty_date === today && !o.primary_physician_id
            );
            
            if (uncoveredShifts.length > 0) {
                alerts.push({
                    id: 'uncovered-shifts',
                    title: 'Uncovered On-call Shifts',
                    message: `${uncoveredShifts.length} on-call shifts are uncovered today`,
                    priority: 'high'
                });
            }
            
            // Check for critical unit occupancy
            const criticalUnits = trainingUnits.value.filter(u => 
                u.unit_status === 'active' && calculateUnitOccupancyRate(u) > 90
            );
            
            if (criticalUnits.length > 0) {
                alerts.push({
                    id: 'high-occupancy',
                    title: 'High Unit Occupancy',
                    message: `${criticalUnits.length} units are at >90% occupancy`,
                    priority: 'medium'
                });
            }
            
            return alerts;
        });

        const departmentStats = computed(() => {
            const activeStaff = medicalStaff.value.filter(s => s.employment_status === 'active').length;
            const activeUnits = trainingUnits.value.filter(u => u.unit_status === 'active').length;
            const activeRotations = residentRotations.value.filter(r => 
                r.rotation_status === 'active'
            ).length;
            
            return {
                totalStaff: medicalStaff.value.length,
                activeStaff: activeStaff,
                activeUnits: activeUnits,
                activeRotations: activeRotations,
                coverageRate: medicalStaff.value.length > 0 ? Math.round((activeStaff / medicalStaff.value.length) * 100) : 0,
                pendingApprovals: leaveRequests.value.filter(r => r.status === 'pending').length
            };
        });

        const nextSevenDays = computed(() => {
            const days = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                
                const schedule = onCallSchedule.value.find(o => o.duty_date === dateString);
                
                days.push({
                    date: dateString,
                    schedule: schedule,
                    status: schedule ? 'covered' : 'uncovered'
                });
            }
            
            return days;
        });
        
        const filteredRotations = computed(() => {
            let filtered = residentRotations.value;
            
            if (rotationFilter.value.status) {
                filtered = filtered.filter(r => r.rotation_status === rotationFilter.value.status);
            }
            
            if (rotationFilter.value.category) {
                filtered = filtered.filter(r => r.rotation_category === rotationFilter.value.category);
            }
            
            if (rotationFilter.value.search) {
                const search = rotationFilter.value.search.toLowerCase();
                filtered = filtered.filter(r => 
                    r.rotation_id.toLowerCase().includes(search) ||
                    getResidentName(r.resident_id).toLowerCase().includes(search) ||
                    getTrainingUnitName(r.training_unit_id).toLowerCase().includes(search)
                );
            }
            
            return filtered;
        });

        const availableResidents = computed(() => {
            const residentsInRotations = new Set(
                residentRotations.value
                    .filter(r => r.rotation_status === 'active' || r.rotation_status === 'scheduled')
                    .map(r => r.resident_id)
            );
            
            return medicalStaff.value.filter(staff => 
                staff.staff_type === 'medical_resident' && 
                staff.employment_status === 'active' &&
                !residentsInRotations.has(staff.id)
            );
        });

        const pendingSchedules = computed(() => {
            return residentRotations.value.filter(r => 
                r.rotation_status === 'pending_approval' || 
                (r.approval_status && r.approval_status === 'pending')
            );
        });

        const departmentAnalytics = computed(() => {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const recentRotations = residentRotations.value.filter(r => 
                new Date(r.rotation_start_date) >= thirtyDaysAgo
            );
            
            const activeStaff = medicalStaff.value.filter(s => 
                s.employment_status === 'active'
            ).length;
            
            // Calculate occupancy rate
            let totalCapacity = 0;
            let totalOccupied = 0;
            trainingUnits.value.forEach(unit => {
                totalCapacity += unit.maximum_residents || 0;
                totalOccupied += unit.current_residents || 0;
            });
            
            const occupancyRate = totalCapacity > 0 ? Math.round((totalOccupied / totalCapacity) * 100) : 0;
            
            // Calculate completion rate
            const completedRotations = residentRotations.value.filter(r => 
                r.rotation_status === 'completed'
            ).length;
            const totalRotations = residentRotations.value.length;
            const completionRate = totalRotations > 0 ? Math.round((completedRotations / totalRotations) * 100) : 0;
            
            return {
                recentRotations: recentRotations.length,
                activeStaff: activeStaff,
                occupancyRate: occupancyRate,
                completionRate: completionRate,
                averageRotationDuration: calculateAverageRotationDuration()
            };
        });

        // ============ PROFILE COMPUTED PROPERTIES ============
        const currentClinicalUnitAssignments = computed(() => {
            if (!profileViewModal.value.profileData?.clinicalUnits) return [];
            return profileViewModal.value.profileData.clinicalUnits.filter(u => u.is_current);
        });

        const recentAchievements = computed(() => {
            if (!profileViewModal.value.profileData?.achievements) return [];
            return profileViewModal.value.profileData.achievements
                .sort((a, b) => b.year - a.year)
                .slice(0, 5);
        });

        const activeCommitteeMemberships = computed(() => {
            if (!profileViewModal.value.profileData?.committeeMemberships) return [];
            return profileViewModal.value.profileData.committeeMemberships.filter(c => c.is_active);
        });

        const profileYearsOfExperience = computed(() => {
            if (!profileViewModal.value.profileData?.basicProfile?.joined_institution_date) return 0;
            return calculateYearsOfExperience(profileViewModal.value.profileData.basicProfile.joined_institution_date);
        });

        // ============ HELPER FUNCTIONS ============
        const getResidentName = (residentId) => {
            const resident = medicalStaff.value.find(s => s.id === residentId);
            return resident ? resident.full_name : `Resident ${residentId?.substring(0, 8) || 'Unknown'}`;
        };

        const getTrainingUnitName = (unitId) => {
            const unit = trainingUnits.value.find(u => u.id === unitId);
            return unit ? unit.unit_name : `Unit ${unitId?.substring(0, 8) || 'Unknown'}`;
        };

        const getAttendingName = (attendingId) => {
            const attending = medicalStaff.value.find(s => s.id === attendingId && s.staff_type === 'attending_physician');
            return attending ? attending.full_name : `Attending ${attendingId?.substring(0, 8) || 'Unknown'}`;
        };

        const getAssignedResidents = (unitId) => {
            const rotationIds = residentRotations.value
                .filter(r => r.training_unit_id === unitId && (r.rotation_status === 'active' || r.rotation_status === 'scheduled'))
                .map(r => r.resident_id);
            
            return medicalStaff.value.filter(staff => 
                staff.staff_type === 'medical_resident' && rotationIds.includes(staff.id)
            );
        };

        const formatRotationCategory = (category) => {
            const categories = {
                clinical_rotation: 'Clinical Rotation',
                elective_rotation: 'Elective Rotation',
                research_rotation: 'Research',
                vacation_rotation: 'Vacation'
            };
            return categories[category] || category;
        };

        const getRotationCategoryClass = (category) => {
            return category === 'clinical_rotation' ? 'badge-attending-advanced' :
                   category === 'elective_rotation' ? 'badge-resident-advanced' :
                   category === 'research_rotation' ? 'badge-admin-advanced' :
                   'badge-supervisor-advanced';
        };

        const formatPriorityLevel = (priority) => {
            const priorities = {
                low: 'Low',
                medium: 'Medium',
                high: 'High',
                urgent: 'Urgent'
            };
            return priorities[priority] || priority;
        };

        const getPriorityClass = (priority) => {
            return priority === 'urgent' ? 'status-critical' :
                   priority === 'high' ? 'status-reported' :
                   priority === 'medium' ? 'status-oncall' :
                   'status-available';
        };

        const formatAudience = (audience) => {
            const audiences = {
                all: 'All Staff',
                residents: 'Residents Only',
                attendings: 'Attending Physicians',
                nursing: 'Nursing Staff'
            };
            return audiences[audience] || audience;
        };

        const formatDateShort = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        };

        const calculateAverageRotationDuration = () => {
            if (residentRotations.value.length === 0) return 0;
            
            let totalDays = 0;
            residentRotations.value.forEach(rotation => {
                if (rotation.rotation_start_date && rotation.rotation_end_date) {
                    const start = new Date(rotation.rotation_start_date);
                    const end = new Date(rotation.rotation_end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalDays += diffDays;
                }
            });
            
            return Math.round(totalDays / residentRotations.value.length);
        };

        // ============ NAVIGATION & UI ============
        const switchView = async (view) => {
            currentView.value = view;
            closeMobileMenu();
            logAudit('VIEW_CHANGE', `Switched to ${view} view`, 'navigation');
            
            await loadViewData(view);
        };

        const getCurrentTitle = () => {
            const titles = {
                medical_staff: 'Medical Staff Management',
                training_units: 'Training Units',
                daily_operations: 'Daily Operations Board',
                permission_management: 'Permission Management',
                audit_logs: 'Audit Logs',
                oncall_schedule: 'On-call Schedule',
                leave_requests: 'Leave Requests',
                department_overview: 'Department Overview',
                staff_management: 'Staff Management',
                schedule_approval: 'Schedule Approval',
                system_settings: 'System Settings',
                user_profile: 'User Profile'
            };
            return titles[currentView.value] || 'PneumoCare';
        };

        const getCurrentSubtitle = () => {
            const subtitles = {
                medical_staff: 'Manage medical staff with advanced permissions',
                daily_operations: 'Real-time department operations dashboard',
                permission_management: 'Configure system permissions and roles',
                audit_logs: 'Track all system activities and changes',
                oncall_schedule: 'Manage on-call duties and coverage',
                leave_requests: 'Review and approve leave requests',
                department_overview: 'Department analytics and insights',
                system_settings: 'Configure system-wide settings'
            };
            return subtitles[currentView.value] || 'Advanced DRBA Hospital Management System';
        };

        const getSearchPlaceholder = () => {
            const placeholders = {
                medical_staff: 'Search medical staff by name, ID, or department...',
                daily_operations: 'Search assignments, alerts, or announcements...',
                audit_logs: 'Search audit logs by user, action, or resource...',
                training_units: 'Search training units by name or specialty...',
                resident_rotations: 'Search rotations by resident, unit, or ID...'
            };
            return placeholders[currentView.value] || 'Search...';
        };

        const toggleMobileMenu = () => {
            mobileMenuOpen.value = !mobileMenuOpen.value;
        };

        const closeMobileMenu = () => {
            mobileMenuOpen.value = false;
        };

        const togglePermissionManager = () => {
            showPermissionManager.value = !showPermissionManager.value;
            userMenuOpen.value = false;
            if (showPermissionManager.value) {
                loadSystemRoles();
                logAudit('PERMISSION_MANAGER_OPEN', 'Opened permission manager', 'system');
            }
        };

        const toggleUserMenu = () => {
            userMenuOpen.value = !userMenuOpen.value;
        };

        const getDayStatus = (day) => {
            return day.status === 'covered' ? 'status-available' : 'status-critical';
        };

        // ============ PROFILE SYSTEM FUNCTIONS ============
        const loadCompleteProfile = async (staffId) => {
            try {
                // Load all professional profile data
                const [profile, achievements, units, committees] = await Promise.all([
                    // Main profile
                    supabaseClient
                        .from('medical_staff_profiles')
                        .select('*')
                        .eq('staff_id', staffId)
                        .single(),
                    
                    // Academic achievements
                    supabaseClient
                        .from('academic_achievements')
                        .select('*')
                        .eq('staff_id', staffId)
                        .order('year', { ascending: false }),
                    
                    // Clinical unit assignments
                    supabaseClient
                        .from('clinical_unit_assignments')
                        .select('*, training_units(unit_name)')
                        .eq('staff_id', staffId)
                        .order('start_date', { ascending: false }),
                    
                    // Committee memberships
                    supabaseClient
                        .from('committee_memberships')
                        .select('*')
                        .eq('staff_id', staffId)
                        .order('start_date', { ascending: false })
                ]);
                
                return {
                    basicProfile: profile.data || {},
                    achievements: achievements.data || [],
                    clinicalUnits: units.data || [],
                    committeeMemberships: committees.data || []
                };
                
            } catch (error) {
                console.error('Error loading profile:', error);
                throw error;
            }
        };

        const viewMedicalProfile = async (staff) => {
            if (!hasPermission('profile', 'read')) {
                showAdvancedToast('Permission Denied', 'Need read permission for profiles', 'permission');
                return;
            }
            
            profileViewModal.value.staff = staff;
            profileViewModal.value.activeTab = 'overview';
            
            try {
                // Load profile data from backend
                const profileData = await loadCompleteProfile(staff.id);
                profileViewModal.value.profileData = profileData;
                profileViewModal.value.show = true;
                
                logAudit('PROFILE_VIEW', `Viewed profile of ${staff.full_name}`, 'profile', staff.id);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showAdvancedToast('Profile Load Failed', 'Could not load profile information', 'error');
            }
        };

        const switchProfileTab = (tab) => {
            profileViewModal.value.activeTab = tab;
        };

        const printProfile = () => {
            window.print();
            logAudit('PROFILE_PRINT', `Printed profile of ${profileViewModal.value.staff?.full_name}`, 'profile');
        };

        const exportProfile = async () => {
            if (!hasPermission('profile', 'export')) {
                showAdvancedToast('Permission Denied', 'Need export permission for profiles', 'permission');
                return;
            }
            
            try {
                const profileData = profileViewModal.value.profileData;
                const staff = profileViewModal.value.staff;
                
                // Create PDF content
                const pdfContent = `
                    Professional Profile - ${staff.full_name}
                    =========================================
                    
                    Basic Information:
                    ------------------
                    Name: ${staff.full_name}
                    Staff ID: ${staff.staff_id}
                    Role: ${formatStaffType(staff.staff_type)}
                    Status: ${formatEmploymentStatus(staff.employment_status)}
                    Email: ${staff.professional_email || 'N/A'}
                    
                    Professional Details:
                    ---------------------
                    Specialization: ${profileData.basicProfile?.specialization || 'N/A'}
                    Board Certification: ${profileData.basicProfile?.board_certification || 'N/A'}
                    Academic Title: ${profileData.basicProfile?.academic_title || 'N/A'}
                    Years of Experience: ${profileYearsOfExperience.value}
                    
                    Clinical Information:
                    ---------------------
                    Primary Clinical Unit: ${profileData.basicProfile?.primary_clinical_unit || 'N/A'}
                    Clinical Specialties: ${profileData.basicProfile?.clinical_specialties?.join(', ') || 'N/A'}
                    
                    Research Profile:
                    -----------------
                    Research Line: ${profileData.basicProfile?.research_line || 'N/A'}
                    Research Interests: ${profileData.basicProfile?.research_interests?.join(', ') || 'N/A'}
                    
                    Generated on: ${new Date().toLocaleString()}
                    Generated by: ${currentUser.value.full_name}
                `;
                
                // Create and download file
                const blob = new Blob([pdfContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `profile_${staff.staff_id}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAdvancedToast('Export Complete', 'Profile exported successfully', 'success');
                logAudit('PROFILE_EXPORT', `Exported profile of ${staff.full_name}`, 'profile');
                
            } catch (error) {
                console.error('Error exporting profile:', error);
                showAdvancedToast('Export Failed', 'Failed to export profile', 'error');
            }
        };

        const editProfile = () => {
            if (!hasPermission('profile', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission for profiles', 'permission');
                return;
            }
            
            // Implementation for editing profile would go here
            showAdvancedToast('Edit Profile', 'Profile editing functionality to be implemented', 'info');
            logAudit('PROFILE_EDIT', `Started editing profile of ${profileViewModal.value.staff?.full_name}`, 'profile');
        };

        // ============ AUTHENTICATION ============
        const handleAdvancedLogin = async () => {
            loading.value = true;
            
            try {
                const email = loginForm.value.email.trim().toLowerCase();
                const password = loginForm.value.password;
                const selectedRole = loginForm.value.user_role;
                
                if (!email || !password || !selectedRole) {
                    throw new Error('Please fill in all fields');
                }
                
                // Check if user exists in app_users table
                const { data: existingUser, error: userError } = await supabaseClient
                    .from('app_users')
                    .select('*')
                    .eq('email', email)
                    .maybeSingle();
                
                if (userError) throw userError;
                
                if (!existingUser) {
                    // Create new user with hashed password (in production, use proper hashing)
                    const hashedPassword = btoa(password); // Simple encoding for demo
                    
                    const newUser = {
                        id: generateUUID(),
                        email: email,
                        full_name: email.split('@')[0].replace(/\./g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        user_role: selectedRole,
                        account_status: 'active',
                        hashed_password: hashedPassword,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    const { data: createdUser, error: createError } = await supabaseClient
                        .from('app_users')
                        .insert([newUser])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    currentUser.value = createdUser;
                    
                } else {
                    // Verify password (in production, use proper password verification)
                    const storedPassword = existingUser.hashed_password;
                    const enteredPassword = btoa(password);
                    
                    if (storedPassword !== enteredPassword) {
                        throw new Error('Invalid credentials');
                    }
                    
                    currentUser.value = existingUser;
                }
                
                initializePermissions(currentUser.value.user_role);
                
                // Update last login
                await supabaseClient
                    .from('app_users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', currentUser.value.id);
                
                showAdvancedToast(
                    'Login Successful',
                    `Welcome ${currentUser.value.full_name}!`,
                    'success'
                );
                
                logAudit('LOGIN_SUCCESS', `User logged in as ${currentUser.value.user_role}`, 'auth', currentUser.value.id);
                
                await loadInitialData();
                
                // Set initial view based on permissions
                if (hasPermission('daily_operations', 'read')) {
                    currentView.value = 'daily_operations';
                } else if (hasPermission('medical_staff', 'read')) {
                    currentView.value = 'medical_staff';
                } else {
                    currentView.value = 'daily_operations';
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showAdvancedToast(
                    'Login Failed',
                    error.message || 'Invalid credentials',
                    'error'
                );
                logAudit('LOGIN_FAILED', `Failed login attempt: ${error.message}`, 'auth');
            } finally {
                loading.value = false;
            }
        };

        const handleLogout = async () => {
            try {
                logAudit('LOGOUT', 'User logged out', 'auth');
                currentUser.value = null;
                currentView.value = 'login';
                userMenuOpen.value = false;
                showAdvancedToast('Logged Out', 'You have been successfully logged out', 'info');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // ============ DATA LOADING ============
        const loadInitialData = async () => {
            loading.value = true;
            try {
                await Promise.all([
                    loadMedicalStaff(),
                    loadTrainingUnits(),
                    loadResidentRotations(),
                    loadLeaveRequests(),
                    loadDailyAssignments(),
                    loadOnCallSchedule(),
                    loadAnnouncements(),
                    loadAuditLogs(),
                    loadSystemStats(),
                    loadEmergencyContacts(),
                    loadSystemSettings()
                ]);
                
                showAdvancedToast('System Ready', 'All data loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAdvancedToast('Data Load Error', 'Failed to load system data', 'error');
            } finally {
                loading.value = false;
            }
        };

        const loadViewData = async (view) => {
            try {
                switch (view) {
                    case 'medical_staff':
                        await loadMedicalStaff();
                        break;
                    case 'training_units':
                        await loadTrainingUnits();
                        break;
                    case 'daily_operations':
                        await Promise.all([
                            loadDailyAssignments(),
                            loadOnCallSchedule(),
                            loadAnnouncements()
                        ]);
                        break;
                    case 'audit_logs':
                        await loadAuditLogs();
                        break;
                    case 'leave_requests':
                        await loadLeaveRequests();
                        break;
                    case 'oncall_schedule':
                        await loadOnCallSchedule();
                        break;
                    case 'resident_rotations':
                        await loadResidentRotations();
                        break;
                    case 'department_overview':
                        await loadDepartmentAnalytics();
                        break;
                    case 'system_settings':
                        await loadSystemSettings();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${view} data:`, error);
            }
        };

        // ============ API FUNCTIONS ============
        const loadMedicalStaff = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('medical_staff')
                    .select('*')
                    .order('full_name');
                
                if (error) throw error;
                medicalStaff.value = data || [];
            } catch (error) {
                console.error('Error loading medical staff:', error);
                throw error;
            }
        };

        const loadTrainingUnits = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('training_units')
                    .select('*')
                    .order('unit_name');
                
                if (error) throw error;
                trainingUnits.value = data || [];
            } catch (error) {
                console.error('Error loading training units:', error);
                throw error;
            }
        };

        const loadResidentRotations = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('resident_rotations')
                    .select('*')
                    .order('rotation_start_date', { ascending: false });
                
                if (error) throw error;
                residentRotations.value = data || [];
            } catch (error) {
                console.error('Error loading resident rotations:', error);
                throw error;
            }
        };

        const loadLeaveRequests = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('leave_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                leaveRequests.value = data || [];
            } catch (error) {
                console.error('Error loading leave requests:', error);
                throw error;
            }
        };

        const loadDailyAssignments = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('daily_assignments')
                    .select('*')
                    .order('assignment_date', { ascending: false });
                
                if (error) throw error;
                dailyAssignments.value = data || [];
            } catch (error) {
                console.error('Error loading daily assignments:', error);
                throw error;
            }
        };

        const loadOnCallSchedule = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('oncall_schedule')
                    .select('*')
                    .order('duty_date', { ascending: true });
                
                if (error) throw error;
                onCallSchedule.value = data || [];
            } catch (error) {
                console.error('Error loading on-call schedule:', error);
                throw error;
            }
        };

        const loadAnnouncements = async () => {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('department_announcements')
                    .select('*')
                    .lte('publish_start_date', today)
                    .or(`publish_end_date.is.null,publish_end_date.gte.${today}`)
                    .order('priority_level', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                announcements.value = data || [];
            } catch (error) {
                console.error('Error loading announcements:', error);
                throw error;
            }
        };

        const loadAuditLogs = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('audit_logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                auditLogs.value = data || [];
            } catch (error) {
                console.error('Error loading audit logs:', error);
                throw error;
            }
        };

        const loadSystemStats = async () => {
            try {
                // Calculate active users
                const { data: activeUsers, error: usersError } = await supabaseClient
                    .from('app_users')
                    .select('id')
                    .eq('account_status', 'active');
                
                if (usersError) throw usersError;
                
                // Calculate today's assignments
                const today = new Date().toISOString().split('T')[0];
                const { data: todayAssignments, error: assignmentsError } = await supabaseClient
                    .from('daily_assignments')
                    .select('id')
                    .eq('assignment_date', today);
                
                if (assignmentsError) throw assignmentsError;
                
                systemStats.value = {
                    active_users: activeUsers?.length || 0,
                    total_staff: medicalStaff.value.length,
                    today_assignments: todayAssignments?.length || 0,
                    pending_approvals: leaveRequests.value.filter(r => r.status === 'pending').length,
                    unit_occupancy_rate: stats.value.unitOccupancyRate
                };
            } catch (error) {
                console.error('Error loading system stats:', error);
                // Use fallback calculations
                systemStats.value = {
                    active_users: 0,
                    total_staff: medicalStaff.value.length,
                    today_assignments: todaysAssignments.value.length,
                    pending_approvals: leaveRequests.value.filter(r => r.status === 'pending').length,
                    unit_occupancy_rate: stats.value.unitOccupancyRate
                };
            }
        };

        const loadSystemRoles = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('system_roles')
                    .select('*');
                
                if (error) throw error;
                systemRoles.value = data || Object.entries(PermissionSystem.roles).map(([id, role]) => ({
                    id,
                    ...role
                }));
            } catch (error) {
                console.error('Error loading system roles:', error);
                systemRoles.value = Object.entries(PermissionSystem.roles).map(([id, role]) => ({
                    id,
                    ...role
                }));
            }
        };

        const loadSystemSettings = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('system_settings')
                    .select('*')
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows returned
                
                systemSettings.value = data || {
                    hospital_name: 'PneumoCare Hospital',
                    department_name: 'Pulmonary Medicine',
                    max_residents_per_unit: 10,
                    enable_audit_logging: true,
                    require_mfa: false,
                    maintenance_mode: false
                };
            } catch (error) {
                console.error('Error loading system settings:', error);
                systemSettings.value = {
                    hospital_name: 'PneumoCare Hospital',
                    department_name: 'Pulmonary Medicine',
                    max_residents_per_unit: 10,
                    enable_audit_logging: true,
                    require_mfa: false,
                    maintenance_mode: false
                };
            }
        };

        const loadCurrentUserProfile = async () => {
            if (!currentUser.value) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('medical_staff_profiles')
                    .select('*')
                    .eq('staff_id', currentUser.value.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (data) {
                    currentUser.value.profile = data;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        };

        const loadUserNotifications = async () => {
            if (!currentUser.value) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_notifications')
                    .select('*')
                    .eq('user_id', currentUser.value.id)
                    .eq('read', false)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                userNotifications.value = data || [];
            } catch (error) {
                console.error('Error loading notifications:', error);
                userNotifications.value = [];
            }
        };

        const loadEmergencyContacts = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('emergency_contacts')
                    .select('*')
                    .order('contact_name');
                
                if (error) throw error;
                emergencyContacts.value = data || [];
            } catch (error) {
                console.error('Error loading emergency contacts:', error);
                emergencyContacts.value = [];
            }
        };

        const loadDepartmentAnalytics = async () => {
            // Analytics are computed from existing data
            return departmentAnalytics.value;
        };

        // ============ MEDICAL STAFF CRUD ============
        const showAddMedicalStaffModal = () => {
            if (!hasPermission('medical_staff', 'create')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need create permission to add medical staff',
                    'permission'
                );
                return;
            }
            
            // Generate staff ID
            const date = new Date();
            const staffId = `MD-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            
            medicalStaffModal.value = {
                show: true,
                mode: 'add',
                staff: null,
                form: {
                    full_name: '',
                    staff_type: 'medical_resident',
                    staff_id: staffId,
                    employment_status: 'active',
                    can_supervise_residents: false,
                    primary_clinic: '',
                    professional_email: '',
                    resident_category: '',
                    training_year: new Date().getFullYear()
                }
            };
            
            logAudit('STAFF_MODAL_OPEN', 'Opened add medical staff modal', 'medical_staff');
        };

        const editMedicalStaff = (staff) => {
            if (!hasPermission('medical_staff', 'update')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need update permission to edit medical staff',
                    'permission'
                );
                return;
            }
            
            medicalStaffModal.value = {
                show: true,
                mode: 'edit',
                staff: staff,
                form: { ...staff }
            };
            
            logAudit('STAFF_EDIT', `Editing staff member: ${staff.full_name}`, 'medical_staff', staff.id);
        };

        const saveMedicalStaff = async () => {
            if (!hasPermission('medical_staff', medicalStaffModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                // Validate form
                if (!medicalStaffModal.value.form.full_name.trim()) {
                    throw new Error('Full name is required');
                }
                
                if (medicalStaffModal.value.form.staff_type === 'medical_resident') {
                    if (!medicalStaffModal.value.form.resident_category) {
                        throw new Error('Resident category is required for medical residents');
                    }
                }
                
                const staffData = {
                    ...medicalStaffModal.value.form,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (medicalStaffModal.value.mode === 'add') {
                    // Add new staff
                    const { data, error } = await supabaseClient
                        .from('medical_staff')
                        .insert([{
                            ...staffData,
                            created_at: new Date().toISOString(),
                            created_by: currentUser.value.id
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    medicalStaff.value.unshift(result);
                    showAdvancedToast('Success', 'Medical staff added successfully', 'success');
                    logAudit('STAFF_CREATE', `Added: ${result.full_name}`, 'medical_staff', result.id);
                    
                } else {
                    // Update existing staff
                    const { data, error } = await supabaseClient
                        .from('medical_staff')
                        .update(staffData)
                        .eq('id', medicalStaffModal.value.staff.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    // Update in local array
                    const index = medicalStaff.value.findIndex(s => s.id === result.id);
                    if (index !== -1) {
                        medicalStaff.value[index] = result;
                    }
                    
                    showAdvancedToast('Success', 'Medical staff updated successfully', 'success');
                    logAudit('STAFF_UPDATE', `Updated: ${result.full_name}`, 'medical_staff', result.id);
                }
                
                medicalStaffModal.value.show = false;
            } catch (error) {
                console.error('Error saving medical staff:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const deleteMedicalStaff = async (staff) => {
            if (!hasPermission('medical_staff', 'delete')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need delete permission to remove medical staff',
                    'permission'
                );
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${staff.full_name}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('medical_staff')
                    .delete()
                    .eq('id', staff.id);
                
                if (error) throw error;
                
                // Remove from local array
                const index = medicalStaff.value.findIndex(s => s.id === staff.id);
                if (index !== -1) {
                    medicalStaff.value.splice(index, 1);
                }
                
                showAdvancedToast('Deleted', `${staff.full_name} has been removed`, 'success');
                logAudit('STAFF_DELETE', `Deleted: ${staff.full_name}`, 'medical_staff', staff.id);
            } catch (error) {
                console.error('Error deleting medical staff:', error);
                showAdvancedToast('Delete Failed', error.message, 'error');
            }
        };

        // ============ ANNOUNCEMENTS MODAL FUNCTIONS ============
        const showAddAnnouncementModal = () => {
            if (!hasPermission('announcements', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            announcementModal.value = {
                show: true,
                mode: 'add',
                announcement: null,
                form: {
                    announcement_title: '',
                    announcement_content: '',
                    publish_start_date: today,
                    publish_end_date: '',
                    priority_level: 'medium',
                    target_audience: 'all'
                }
            };
        };

        const editAnnouncement = (announcement) => {
            if (!hasPermission('announcements', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            announcementModal.value = {
                show: true,
                mode: 'edit',
                announcement: announcement,
                form: {
                    announcement_title: announcement.announcement_title,
                    announcement_content: announcement.announcement_content,
                    publish_start_date: announcement.publish_start_date,
                    publish_end_date: announcement.publish_end_date || '',
                    priority_level: announcement.priority_level || 'medium',
                    target_audience: announcement.target_audience || 'all'
                }
            };
        };

        const saveAnnouncement = async () => {
            if (!hasPermission('announcements', announcementModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!announcementModal.value.form.announcement_title.trim()) {
                    throw new Error('Title is required');
                }
                if (!announcementModal.value.form.announcement_content.trim()) {
                    throw new Error('Content is required');
                }
                if (!announcementModal.value.form.publish_start_date) {
                    throw new Error('Publish date is required');
                }
                
                const announcementData = {
                    announcement_title: announcementModal.value.form.announcement_title,
                    announcement_content: announcementModal.value.form.announcement_content,
                    publish_start_date: announcementModal.value.form.publish_start_date,
                    publish_end_date: announcementModal.value.form.publish_end_date || null,
                    priority_level: announcementModal.value.form.priority_level,
                    target_audience: announcementModal.value.form.target_audience,
                    created_by: currentUser.value?.id,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (announcementModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('department_announcements')
                        .insert([{
                            ...announcementData,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    announcements.value.unshift(result);
                    showAdvancedToast('Published', 'Announcement published successfully', 'success');
                    logAudit('ANNOUNCEMENT_CREATE', `Published: ${result.announcement_title}`, 'announcements', result.id);
                    
                } else {
                    const { data, error } = await supabaseClient
                        .from('department_announcements')
                        .update(announcementData)
                        .eq('id', announcementModal.value.announcement.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    const index = announcements.value.findIndex(a => a.id === result.id);
                    if (index !== -1) announcements.value[index] = result;
                    
                    showAdvancedToast('Updated', 'Announcement updated successfully', 'success');
                    logAudit('ANNOUNCEMENT_UPDATE', `Updated: ${result.announcement_title}`, 'announcements', result.id);
                }
                
                announcementModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving announcement:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const deleteAnnouncement = async (announcement) => {
            if (!hasPermission('announcements', 'delete')) {
                showAdvancedToast('Permission Denied', 'Need delete permission', 'permission');
                return;
            }
            
            if (!confirm(`Delete announcement "${announcement.announcement_title}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('department_announcements')
                    .delete()
                    .eq('id', announcement.id);
                
                if (error) throw error;
                
                announcements.value = announcements.value.filter(a => a.id !== announcement.id);
                
                showAdvancedToast('Deleted', 'Announcement deleted', 'success');
                logAudit('ANNOUNCEMENT_DELETE', `Deleted: ${announcement.announcement_title}`, 'announcements', announcement.id);
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showAdvancedToast('Delete Failed', error.message, 'error');
            }
        };

        // ============ ON-CALL SCHEDULE FUNCTIONS ============
        const showAddOnCallModal = () => {
            if (!hasPermission('oncall_schedule', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateString = tomorrow.toISOString().split('T')[0];
            
            // Generate schedule ID
            const scheduleId = `ONCALL-${dateString.replace(/-/g, '')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            
            onCallModal.value = {
                show: true,
                mode: 'add',
                schedule: null,
                form: {
                    duty_date: dateString,
                    schedule_id: scheduleId,
                    shift_type: 'backup_call',
                    primary_physician_id: '',
                    backup_physician_id: '',
                    start_time: '08:00',
                    end_time: '20:00',
                    coverage_notes: ''
                }
            };
        };

        const editOnCallSchedule = (schedule) => {
            if (!hasPermission('oncall_schedule', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            onCallModal.value = {
                show: true,
                mode: 'edit',
                schedule: schedule,
                form: {
                    duty_date: schedule.duty_date,
                    schedule_id: schedule.schedule_id,
                    shift_type: schedule.shift_type || 'backup_call',
                    primary_physician_id: schedule.primary_physician_id,
                    backup_physician_id: schedule.backup_physician_id || '',
                    start_time: schedule.start_time?.slice(0, 5) || '08:00',
                    end_time: schedule.end_time?.slice(0, 5) || '20:00',
                    coverage_notes: schedule.coverage_notes || ''
                }
            };
        };

        const saveOnCallSchedule = async () => {
            if (!hasPermission('oncall_schedule', onCallModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!onCallModal.value.form.duty_date) throw new Error('Date required');
                if (!onCallModal.value.form.primary_physician_id) throw new Error('Primary physician required');
                
                // Check for schedule conflicts
                const { data: conflicts, error: conflictError } = await supabaseClient
                    .from('oncall_schedule')
                    .select('*')
                    .eq('duty_date', onCallModal.value.form.duty_date)
                    .eq('primary_physician_id', onCallModal.value.form.primary_physician_id);
                
                if (conflictError) throw conflictError;
                
                if (conflicts && conflicts.length > 0 && onCallModal.value.mode === 'add') {
                    throw new Error('Physician already has an on-call schedule on this date');
                }
                
                const scheduleData = {
                    duty_date: onCallModal.value.form.duty_date,
                    schedule_id: onCallModal.value.form.schedule_id,
                    shift_type: onCallModal.value.form.shift_type,
                    primary_physician_id: onCallModal.value.form.primary_physician_id,
                    backup_physician_id: onCallModal.value.form.backup_physician_id || null,
                    start_time: onCallModal.value.form.start_time + ':00',
                    end_time: onCallModal.value.form.end_time + ':00',
                    coverage_notes: onCallModal.value.form.coverage_notes,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (onCallModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('oncall_schedule')
                        .insert([{
                            ...scheduleData,
                            created_at: new Date().toISOString(),
                            created_by: currentUser.value?.id
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    onCallSchedule.value.push(result);
                    showAdvancedToast('Success', 'On-call schedule created', 'success');
                    
                } else {
                    const { data, error } = await supabaseClient
                        .from('oncall_schedule')
                        .update(scheduleData)
                        .eq('id', onCallModal.value.schedule.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    const index = onCallSchedule.value.findIndex(s => s.id === result.id);
                    if (index !== -1) onCallSchedule.value[index] = result;
                    
                    showAdvancedToast('Success', 'On-call schedule updated', 'success');
                }
                
                onCallModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving on-call schedule:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ TRAINING UNIT FUNCTIONS ============
        const showAddTrainingUnitModal = () => {
            if (!hasPermission('training_units', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            // Generate unit code
            const unitCode = `UNIT-${Math.floor(Math.random()*10000).toString().padStart(4,'0')}`;
            
            trainingUnitModal.value = {
                show: true,
                mode: 'add',
                unit: null,
                form: {
                    unit_name: '',
                    unit_code: unitCode,
                    unit_description: '',
                    unit_status: 'active',
                    maximum_residents: 10,
                    specialty: '',
                    current_residents: 0
                }
            };
        };

        const editTrainingUnit = (unit) => {
            if (!hasPermission('training_units', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            trainingUnitModal.value = {
                show: true,
                mode: 'edit',
                unit: unit,
                form: { ...unit }
            };
        };

        const saveTrainingUnit = async () => {
            if (!hasPermission('training_units', trainingUnitModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!trainingUnitModal.value.form.unit_name.trim()) {
                    throw new Error('Unit name required');
                }
                
                if (!trainingUnitModal.value.form.maximum_residents || trainingUnitModal.value.form.maximum_residents <= 0) {
                    throw new Error('Maximum residents must be greater than 0');
                }
                
                const unitData = {
                    ...trainingUnitModal.value.form,
                    updated_at: new Date().toISOString()
                };
                
                if (trainingUnitModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('training_units')
                        .insert([{
                            ...unitData,
                            created_at: new Date().toISOString(),
                            created_by: currentUser.value.id
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    trainingUnits.value.unshift(data);
                    showAdvancedToast('Success', 'Training unit added', 'success');
                    logAudit('TRAINING_UNIT_CREATE', `Added unit: ${unitData.unit_name}`, 'training_units', data.id);
                } else {
                    const { data, error } = await supabaseClient
                        .from('training_units')
                        .update(unitData)
                        .eq('id', trainingUnitModal.value.unit.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    const index = trainingUnits.value.findIndex(u => u.id === data.id);
                    if (index !== -1) trainingUnits.value[index] = data;
                    showAdvancedToast('Success', 'Training unit updated', 'success');
                    logAudit('TRAINING_UNIT_UPDATE', `Updated unit: ${unitData.unit_name}`, 'training_units', data.id);
                }
                
                trainingUnitModal.value.show = false;
            } catch (error) {
                console.error('Error saving training unit:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };
        // ============ ROLE MANAGEMENT FUNCTIONS ============
const showAddRoleModal = () => {
    if (!hasPermission('system', 'admin')) {
        showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
        return;
    }
    
    addRoleModal.value = {
        show: true,
        mode: 'add',
        role: null,
        form: {
            name: '',
            description: '',
            level: 'read'
        }
    };
    
    logAudit('ROLE_MODAL_OPEN', 'Opened add role modal', 'system');
};

const editRole = (role) => {
    if (!hasPermission('system', 'admin')) {
        showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
        return;
    }
    
    addRoleModal.value = {
        show: true,
        mode: 'edit',
        role: role,
        form: { ...role }
    };
    
    logAudit('ROLE_EDIT', `Editing role: ${role.name}`, 'system', role.id);
};

const cloneRole = (role) => {
    if (!hasPermission('system', 'admin')) {
        showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
        return;
    }
    
    const newRole = {
        ...role,
        id: `role_${Date.now()}`,
        name: `${role.name} (Copy)`
    };
    
    systemRoles.value.push(newRole);
    
    showAdvancedToast('Role Cloned', `${role.name} cloned successfully`, 'success');
    logAudit('ROLE_CLONE', `Cloned role: ${role.name}`, 'system');
};

const deleteRole = async (role) => {
    if (!hasPermission('system', 'admin')) {
        showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
        return;
    }
    
    if (!confirm(`Delete role "${role.name}"? This cannot be undone.`)) {
        return;
    }
    
    if (role.id === 'admin') {
        showAdvancedToast('Cannot Delete', 'Admin role cannot be deleted', 'error');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('system_roles')
            .delete()
            .eq('id', role.id);
        
        if (error) throw error;
        
        systemRoles.value = systemRoles.value.filter(r => r.id !== role.id);
        
        showAdvancedToast('Deleted', `Role "${role.name}" deleted`, 'success');
        logAudit('ROLE_DELETE', `Deleted role: ${role.name}`, 'system', role.id);
        
    } catch (error) {
        console.error('Error deleting role:', error);
        showAdvancedToast('Delete Failed', error.message, 'error');
    }
};

const saveRole = async () => {
    if (!hasPermission('system', 'admin')) {
        showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
        return;
    }
    
    saving.value = true;
    try {
        if (!addRoleModal.value.form.name.trim()) {
            throw new Error('Role name is required');
        }
        
        const roleData = {
            ...addRoleModal.value.form,
            updated_at: new Date().toISOString(),
            permissions: addRoleModal.value.form.permissions || {}
        };
        
        let result;
        
        if (addRoleModal.value.mode === 'add') {
            // Add new role
            roleData.id = `role_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            roleData.created_at = new Date().toISOString();
            
            const { data, error } = await supabaseClient
                .from('system_roles')
                .insert([roleData])
                .select()
                .single();
            
            if (error) throw error;
            result = data;
            
            systemRoles.value.unshift(result);
            showAdvancedToast('Success', 'Role created successfully', 'success');
            logAudit('ROLE_CREATE', `Created role: ${result.name}`, 'system', result.id);
            
        } else {
            // Update existing role
            const { data, error } = await supabaseClient
                .from('system_roles')
                .update(roleData)
                .eq('id', addRoleModal.value.role.id)
                .select()
                .single();
            
            if (error) throw error;
            result = data;
            
            const index = systemRoles.value.findIndex(r => r.id === result.id);
            if (index !== -1) {
                systemRoles.value[index] = result;
            }
            
            showAdvancedToast('Success', 'Role updated successfully', 'success');
            logAudit('ROLE_UPDATE', `Updated role: ${result.name}`, 'system', result.id);
        }
        
        addRoleModal.value.show = false;
        
    } catch (error) {
        console.error('Error saving role:', error);
        showAdvancedToast('Save Failed', error.message, 'error');
    } finally {
        saving.value = false;
    }
};

        // ============ INITIALIZATION ============
        onMounted(() => {
            // Check for existing session
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('Existing session found');
                }
            }).catch(error => {
                console.error('Error getting session:', error);
            });
            
            // Load system roles
            loadSystemRoles();
        });

        // ============ RETURN ============
        return {
            // ============ STATE ============
            currentUser,
            loginForm,
            loading,
            saving,
            permissionLoading,
            savingPermissions,
            
            // Navigation
            currentView,
            sidebarCollapsed,
            mobileMenuOpen,
            showPermissionManager,
            searchQuery,
            permissionFilter,
            userMenuOpen,
            activeProfileTab,
            
            // ============ MODAL STATES ============
            medicalStaffModal,
            addRoleModal,
            announcementModal,
            onCallModal,
            leaveRequestModal,
            trainingUnitModal,
            rotationModal,
            profileViewModal,
            
            // ============ DATA STORES ============
            medicalStaff,
            trainingUnits,
            residentRotations,
            dailyAssignments,
            leaveRequests,
            onCallSchedule,
            announcements,
            auditLogs,
            systemRoles,
            systemSettings,
            userNotifications,
            emergencyContacts,
            systemStats,
            
            // ============ FILTER & SEARCH ============
            staffSearch,
            staffFilter,
            rotationFilter,
            
            // ============ UI STATES ============
            toasts,
            permissionResources,
            
            // ============ COMPUTED PROPERTIES ============
            stats,
            filteredMedicalStaff,
            todaysAssignments,
            todaysOnCall,
            recentAnnouncements,
            coverageAlerts,
            emergencyAlerts,
            departmentStats,
            nextSevenDays,
            filteredRotations,
            availableResidents,
            pendingSchedules,
            departmentAnalytics,
            
            // Profile computed properties
            currentClinicalUnitAssignments,
            recentAchievements,
            activeCommitteeMemberships,
            profileYearsOfExperience,
            
            // ============ PERMISSION SYSTEM ============
            hasPermission,
            hasAnyPermission,
            getViewPermission,
            getUserPermissionLevel,
            getResourcePermissionLevel,
            getPermissionDescription,
            formatActionName,
            formatResourceName,
            userPermissions,
            togglePermission,
            savePermissionChanges,
            
            // ============ NAVIGATION ============
            switchView,
            getCurrentTitle,
            getCurrentSubtitle,
            getSearchPlaceholder,
            toggleMobileMenu,
            closeMobileMenu,
            togglePermissionManager,
            toggleUserMenu,
            getDayStatus,
            
            // ============ PROFILE SYSTEM ============
            viewMedicalProfile,
            switchProfileTab,
            printProfile,
            exportProfile,
            editProfile,
            
            // ============ UTILITIES ============
            getInitials,
            formatDate,
            formatDateTime,
            formatTimeRange,
            getUserRoleDisplay,
            formatStaffType,
            getStaffTypeClass,
            getAuditIcon,
            formatResidentCategory,
            formatEmploymentStatus,
            generateUUID,
            showAdvancedToast,
            removeToast,
            
            // ============ HELPER FUNCTIONS ============
            getResidentName,
            getTrainingUnitName,
            getAttendingName,
            getAssignedResidents,
            formatRotationCategory,
            getRotationCategoryClass,
            formatPriorityLevel,
            getPriorityClass,
            formatAudience,
            formatDateShort,
            formatAchievementType,
            getAchievementIcon,
            
            // ============ AUTHENTICATION ============
            handleAdvancedLogin,
            handleLogout,
            
            // ============ MEDICAL STAFF ============
            showAddMedicalStaffModal,
            editMedicalStaff,
            saveMedicalStaff,
            deleteMedicalStaff,
            
            // ============ ROLE MANAGEMENT ============
            showAddRoleModal,
            editRole,
            cloneRole,
            deleteRole,
            saveRole,
            
            // ============ ANNOUNCEMENTS ============
            showAddAnnouncementModal,
            editAnnouncement,
            saveAnnouncement,
            deleteAnnouncement,
            
            // ============ ON-CALL SCHEDULE ============
            showAddOnCallModal,
            editOnCallSchedule,
            saveOnCallSchedule,
            
            // ============ TRAINING UNITS ============
            showAddTrainingUnitModal,
            editTrainingUnit,
            saveTrainingUnit,
            
            // ============ DATA LOADING ============
            loadInitialData,
            loadViewData,
            
            // ============ AUDIT LOGGING ============
            logAudit
        };
    }
});

app.mount('#app');
</script>
</body>
</html>
