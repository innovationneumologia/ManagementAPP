<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PneumoCare Pro | Academic Pulmonary Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [ALL CSS STYLES REMAIN EXACTLY THE SAME AS BEFORE] */
        :root {
            --medical-deep-blue: #003366;
            --medical-blue: #005b8e;
            --medical-teal: #008c8c;
            --medical-green: #10b981;
            --medical-amber: #f59e0b;
            --medical-red: #ef4444;
            --medical-purple: #8b5cf6;
            --medical-cyan: #06b6d4;
            
            --gray-10: #f8fafc;
            --gray-50: #f1f5f9;
            --gray-100: #e2e8f0;
            --gray-200: #cbd5e1;
            --gray-300: #94a3b8;
            --gray-400: #64748b;
            --gray-500: #475569;
            --gray-600: #334155;
            --gray-700: #1e293b;
            --gray-800: #0f172a;
            
            --primary: var(--medical-deep-blue);
            --secondary: var(--medical-blue);
            --accent: var(--medical-teal);
            --success: var(--medical-green);
            --warning: var(--medical-amber);
            --error: var(--medical-red);
            
            --text-primary: var(--gray-800);
            --text-secondary: var(--gray-600);
            --background-primary: #f8fafc;
            --background-secondary: #ffffff;
            --border-light: var(--gray-200);
            
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            --focus-ring: 0 0 0 3px rgba(0, 91, 142, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* [ALL OTHER CSS REMAINS EXACTLY THE SAME - ONLY SHOWING THE BEGINNING FOR BREVITY] */
        /* Login Container */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #003366 0%, #005b8e 100%);
            padding: 2rem;
        }

        .login-card {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 3rem;
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow-xl);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        /* [REST OF THE CSS REMAINS EXACTLY THE SAME AS YOUR ORIGINAL] */
        
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">
                        <i class="fas fa-lungs"></i>
                    </div>
                    <h1 class="login-title">PneumoCare Pro</h1>
                    <div class="login-subtitle">Academic Pulmonary Management System</div>
                </div>
                
                <div class="role-selector">
                    <div class="role-btn" :class="{ active: loginForm.role === 'resident_manager' }" 
                         @click="loginForm.role = 'resident_manager'">
                        <div class="role-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="role-name">Resident Manager</div>
                        <div class="role-desc">Manage residents, units, rotations</div>
                    </div>
                    
                    <div class="role-btn" :class="{ active: loginForm.role === 'department_head' }" 
                         @click="loginForm.role = 'department_head'">
                        <div class="role-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="role-name">Head of Department</div>
                        <div class="role-desc">Oversee department operations</div>
                    </div>
                </div>
                
                <form @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="loginForm.email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="loginForm.password" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn" style="width: 100%;" :disabled="loading">
                            <span v-if="loading" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-sign-in-alt"></i> Sign In as {{ loginForm.role === 'resident_manager' ? 'Resident Manager' : 'Head of Department' }}
                            </span>
                        </button>
                    </div>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-light);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                        <i class="fas fa-shield-alt"></i> HIPAA Compliant • System ID: PC-2024-001
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else>
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" @click="toggleMobileMenu">
                <i class="fas fa-bars"></i>
            </button>

            <div class="app-container">
                <!-- Sidebar -->
                <div class="sidebar" :class="{ 
                    collapsed: sidebarCollapsed,
                    'mobile-open': mobileMenuOpen 
                }">
                    <div class="sidebar-header">
                        <div class="brand">
                            <div class="brand-logo">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="brand-text">
                                <h1>PneumoCare Pro</h1>
                                <div class="subtitle">ACADEMIC PULMONARY v4.0</div>
                            </div>
                        </div>
                        <button class="collapse-toggle" @click="sidebarCollapsed = !sidebarCollapsed">
                            <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                        </button>
                    </div>
                    
                    <nav class="sidebar-nav">
                        <!-- Resident Manager Features -->
                        <div v-if="currentUser.user_role === 'resident_manager'">
                            <button class="nav-item" :class="{ active: currentView === 'residents' }" 
                                    @click="switchView('residents'); closeMobileMenu()">
                                <i class="fas fa-user-graduate"></i>
                                <span>Residents</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'clinical_units' }" 
                                    @click="switchView('clinical_units'); closeMobileMenu()">
                                <i class="fas fa-hospital-alt"></i>
                                <span>Clinical Units</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'rotations' }" 
                                    @click="switchView('rotations'); closeMobileMenu()">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Rotations</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'placements' }" 
                                    @click="switchView('placements'); closeMobileMenu()">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Placements</span>
                            </button>
                        </div>
                        
                        <!-- Department Head Features -->
                        <div v-if="currentUser.user_role === 'department_head'">
                            <button class="nav-item" :class="{ active: currentView === 'department_overview' }" 
                                    @click="switchView('department_overview'); closeMobileMenu()">
                                <i class="fas fa-chart-line"></i>
                                <span>Department Overview</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'staff_management' }" 
                                    @click="switchView('staff_management'); closeMobileMenu()">
                                <i class="fas fa-users"></i>
                                <span>Staff Management</span>
                            </button>
                            
                            <button class="nav-item" :class="{ active: currentView === 'schedule_approval' }" 
                                    @click="switchView('schedule_approval'); closeMobileMenu()">
                                <i class="fas fa-calendar-check"></i>
                                <span>Schedule Approval</span>
                            </button>
                        </div>
                        
                        <!-- Shared Features -->
                        <button class="nav-item" :class="{ active: currentView === 'schedule' }" 
                                @click="switchView('schedule'); closeMobileMenu()">
                            <i class="fas fa-calendar-day"></i>
                            <span>Schedule</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'oncall' }" 
                                @click="switchView('oncall'); closeMobileMenu()">
                            <i class="fas fa-phone-alt"></i>
                            <span>On-call</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'leave' }" 
                                @click="switchView('leave'); closeMobileMenu()">
                            <i class="fas fa-calendar-times"></i>
                            <span>Leave & Coverage</span>
                        </button>
                        
                        <button class="nav-item" :class="{ active: currentView === 'reports' }" 
                                @click="switchView('reports'); closeMobileMenu()">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </button>
                    </nav>
                    
                    <div style="padding: 1.75rem; margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); text-align: center; font-weight: 500;">
                            <div>Logged in as: <strong>{{ formatRole(currentUser.user_role) }}</strong></div>
                            <small>ID: {{ currentUser.user_id }}</small>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content" :class="{ expanded: sidebarCollapsed }">
                    <header class="content-header">
                        <div class="header-title">
                            <h1>{{ getCurrentTitle() }}</h1>
                            <div class="subtitle">{{ getCurrentSubtitle() }}</div>
                        </div>
                        <div class="header-actions">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" 
                                       v-model="searchQuery" 
                                       :placeholder="getSearchPlaceholder()"
                                       @input="handleSearch">
                            </div>
                            <div class="user-profile" @click="toggleUserMenu">
                                <div class="user-info">
                                    <div class="user-name">{{ currentUser.full_name }}</div>
                                    <div class="user-role">{{ formatRole(currentUser.user_role) }}</div>
                                </div>
                                <div class="user-avatar">{{ getInitials(currentUser.full_name) }}</div>
                            </div>
                        </div>
                    </header>

                    <div class="content-area">
                        <!-- Loading State -->
                        <div v-if="loading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading system data...</p>
                        </div>

                        <!-- Resident Manager Views -->
                        <div v-else-if="currentUser.user_role === 'resident_manager'">
                            <!-- Residents Management -->
                            <div v-if="currentView === 'residents'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-user-graduate"></i>
                                            Resident Management
                                        </div>
                                        <button class="btn btn-resident" @click="showAddResidentModal">
                                            <i class="fas fa-user-plus"></i> Add Resident
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div class="metrics-grid">
                                            <div class="metric-card">
                                                <div class="metric-value">{{ departmentMetrics.totalResidents }}</div>
                                                <div class="metric-label">Total Residents</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    <span v-if="departmentMetrics.residentTypes">{{ departmentMetrics.residentTypes.department_internal }} Internal • {{ departmentMetrics.residentTypes.rotating }} Rotating • {{ departmentMetrics.residentTypes.external }} External</span>
                                                </div>
                                            </div>
                                            
                                            <div class="metric-card">
                                                <div class="metric-value">{{ departmentMetrics.assignedResidents }}/{{ departmentMetrics.totalResidents }}</div>
                                                <div class="metric-label">Currently Placed</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    {{ departmentMetrics.unassignedResidents }} awaiting placement
                                                </div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ departmentMetrics.endingSoon }}</div>
                                                <div class="metric-label">Rotations Ending Soon</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    Within next 14 days
                                                </div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ departmentMetrics.dutyHoursWarning }}</div>
                                                <div class="metric-label">Duty Hour Alerts</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    >70 hours this week
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Residents List -->
                                        <div style="margin-top: 2rem;">
                                            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                                <select class="form-select" style="width: 180px;" v-model="residentFilter.type" @change="filterResidents">
                                                    <option value="">All Types</option>
                                                    <option value="department_internal">Internal</option>
                                                    <option value="rotating">Rotating</option>
                                                    <option value="external">External</option>
                                                </select>
                                                <select class="form-select" style="width: 180px;" v-model="residentFilter.status" @change="filterResidents">
                                                    <option value="">All Status</option>
                                                    <option value="placed">Placed</option>
                                                    <option value="unplaced">Unplaced</option>
                                                    <option value="ending">Rotation Ending</option>
                                                </select>
                                                <input type="text" class="form-input" style="width: 200px;" 
                                                       v-model="residentSearch" placeholder="Search residents...">
                                            </div>

                                            <div v-if="filteredResidents.length > 0" style="display: grid; gap: 1rem;">
                                                <div v-for="resident in filteredResidents" :key="resident.id" class="person-card">
                                                    <div class="person-avatar resident">
                                                        {{ getInitials(resident.full_name) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">
                                                            {{ resident.full_name }}
                                                            <span class="resident-badge">
                                                                <i class="fas fa-graduation-cap"></i>
                                                                {{ formatResidentCategory(resident.resident_category) }}
                                                            </span>
                                                        </div>
                                                        <div class="person-clinic">
                                                            <span class="role-badge badge-resident">Resident</span>
                                                            ID: {{ resident.staff_id }}
                                                        </div>
                                                        <div class="person-meta">
                                                            <div v-if="resident.current_rotation">
                                                                <strong>Current Placement:</strong> {{ getClinicalUnitName(resident.current_rotation.training_unit_id) }}
                                                                <br>
                                                                <strong>Supervisor:</strong> {{ getSupervisorName(resident.current_rotation.supervising_attending_id) }}
                                                                <br>
                                                                <strong>Rotation:</strong> {{ formatDate(resident.current_rotation.rotation_start_date) }} to {{ formatDate(resident.current_rotation.rotation_end_date) }}
                                                            </div>
                                                            <div v-else style="color: var(--medical-amber);">
                                                                <i class="fas fa-exclamation-circle"></i> Awaiting placement
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn-outline btn-sm" @click="editResident(resident)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <button class="btn btn-sm" @click="viewResidentSchedule(resident)">
                                                            <i class="fas fa-calendar"></i> Schedule
                                                        </button>
                                                        <button v-if="!resident.current_rotation" class="btn btn-sm btn-resident" @click="placeResident(resident)">
                                                            <i class="fas fa-map-marker-alt"></i> Place
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="empty-state">
                                                <i class="fas fa-user-graduate empty-state-icon"></i>
                                                <h3>No residents found</h3>
                                                <p>Add residents to get started</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Clinical Units Management -->
                            <div v-else-if="currentView === 'clinical_units'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-hospital-alt"></i>
                                            Clinical Units Management
                                        </div>
                                        <button class="btn" @click="showAddClinicalUnitModal">
                                            <i class="fas fa-plus"></i> Add Clinical Unit
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div class="units-grid">
                                            <div v-for="unit in clinicalUnits" :key="unit.id" class="unit-card">
                                                <div class="unit-header">
                                                    <div class="unit-name">{{ unit.unit_name }}</div>
                                                    <div class="unit-capacity">
                                                        {{ getClinicalUnitResidentsCount(unit.id) }}/{{ unit.maximum_residents }} residents
                                                    </div>
                                                </div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                                    {{ unit.department_name }}
                                                    <span v-if="unit.default_supervisor_id" style="display: block; margin-top: 0.25rem;">
                                                        Default Supervisor: {{ getSupervisorName(unit.default_supervisor_id) }}
                                                    </span>
                                                </div>
                                                
                                                <div v-if="unit.unit_description" style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                                    {{ unit.unit_description }}
                                                </div>
                                                
                                                <div class="unit-residents" v-if="getClinicalUnitResidents(unit.id).length > 0">
                                                    <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                                        Current Residents:
                                                    </div>
                                                    <div v-for="resident in getClinicalUnitResidents(unit.id)" :key="resident.id" class="unit-resident">
                                                        <div style="width: 24px; height: 24px; background: var(--medical-purple); 
                                                                  border-radius: 50%; display: flex; align-items: center; 
                                                                  justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                                                            {{ getInitials(resident.full_name).charAt(0) }}
                                                        </div>
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 500; font-size: 0.85rem;">{{ resident.full_name }}</div>
                                                            <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                                Supervisor: {{ getSupervisorName(resident.current_rotation.supervising_attending_id) }}
                                                            </div>
                                                        </div>
                                                        <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                            Ends: {{ formatDateShort(resident.current_rotation.rotation_end_date) }}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div v-else style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 1rem 0;">
                                                    No residents currently assigned
                                                </div>
                                                
                                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                                    <button class="btn-outline btn-sm" @click="editClinicalUnit(unit)">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm" :class="{'btn-danger': unit.unit_status === 'active', 'btn-success': unit.unit_status !== 'active'}" 
                                                            @click="toggleClinicalUnitStatus(unit)">
                                                        <i class="fas" :class="unit.unit_status === 'active' ? 'fa-times' : 'fa-check'"></i>
                                                        {{ unit.unit_status === 'active' ? 'Deactivate' : 'Activate' }}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Rotations View -->
                            <div v-else-if="currentView === 'rotations'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-alt"></i>
                                            Rotation Calendar
                                        </div>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <button class="btn-outline btn-sm" @click="previousMonth">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <div style="font-weight: 600; min-width: 200px; text-align: center;">
                                                {{ currentMonthName }} {{ currentYear }}
                                            </div>
                                            <button class="btn-outline btn-sm" @click="nextMonth">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <!-- Calendar View -->
                                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-light);">
                                            <div v-for="day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']" 
                                                 :key="day"
                                                 style="background: var(--gray-50); padding: 1rem; text-align: center; font-weight: 600;">
                                                {{ day }}
                                            </div>
                                            <div v-for="day in calendarDays" :key="day.date"
                                                 style="background: white; padding: 1rem; min-height: 120px; position: relative;">
                                                <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                                    {{ day.day }}
                                                    <span v-if="day.isToday" style="color: var(--medical-green); margin-left: 0.25rem;">•</span>
                                                </div>
                                                <div v-for="rotation in getRotationsForDate(day.date)" :key="rotation.id"
                                                     style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: rgba(139, 92, 246, 0.1); 
                                                            border-radius: 4px; margin-bottom: 0.25rem; border-left: 3px solid var(--medical-purple);">
                                                    {{ rotation.resident_name }}
                                                    <div style="font-size: 0.65rem; color: var(--text-secondary);">
                                                        {{ rotation.unit_name }}
                                                    </div>
                                                </div>
                                                <div v-for="event in getRotationEventsForDate(day.date)" :key="event.type"
                                                     style="position: absolute; bottom: 0.5rem; left: 0.5rem; right: 0.5rem;">
                                                    <div v-if="event.type === 'starts'" 
                                                         style="font-size: 0.7rem; color: var(--medical-green); background: rgba(16, 185, 129, 0.1); 
                                                                padding: 0.25rem; border-radius: 4px; text-align: center;">
                                                        <i class="fas fa-play"></i> {{ event.count }} start{{ event.count > 1 ? 's' : '' }}
                                                    </div>
                                                    <div v-if="event.type === 'ends'" 
                                                         style="font-size: 0.7rem; color: var(--medical-red); background: rgba(239, 68, 68, 0.1); 
                                                                padding: 0.25rem; border-radius: 4px; text-align: center; margin-top: 0.25rem;">
                                                        <i class="fas fa-stop"></i> {{ event.count }} end{{ event.count > 1 ? 's' : '' }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Placements View -->
                            <div v-else-if="currentView === 'placements'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-map-marker-alt"></i>
                                            Resident Placements
                                        </div>
                                        <button class="btn" @click="showNewPlacementModal">
                                            <i class="fas fa-plus"></i> New Placement
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <!-- Placement Actions -->
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Available Residents</h3>
                                                <div v-if="unplacedResidents.length > 0" style="display: grid; gap: 0.75rem;">
                                                    <div v-for="resident in unplacedResidents" :key="resident.id" 
                                                         class="person-card" draggable="true"
                                                         @dragstart="dragResident(resident)">
                                                        <div class="person-avatar resident">
                                                            {{ getInitials(resident.full_name).charAt(0) }}
                                                        </div>
                                                        <div>
                                                            <div style="font-weight: 600;">{{ resident.full_name }}</div>
                                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                                                {{ formatResidentCategory(resident.resident_category) }}
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-sm btn-resident" @click="quickPlaceResident(resident)">
                                                            <i class="fas fa-map-marker-alt"></i> Place
                                                        </button>
                                                    </div>
                                                </div>
                                                <div v-else style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                                                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--medical-green);"></i>
                                                    <div>All residents are placed</div>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Available Units</h3>
                                                <div style="display: grid; gap: 0.75rem;">
                                                    <div v-for="unit in availableClinicalUnits" :key="unit.id"
                                                         class="unit-card" @dragover.prevent="dragOverUnit($event, unit)"
                                                         @drop="dropResidentOnUnit($event, unit)">
                                                        <div class="unit-header">
                                                            <div class="unit-name">{{ unit.unit_name }}</div>
                                                            <div class="unit-capacity">
                                                                {{ getClinicalUnitResidentsCount(unit.id) }}/{{ unit.maximum_residents }}
                                                            </div>
                                                        </div>
                                                        <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                            {{ unit.department_name }}
                                                        </div>
                                                        <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); 
                                                                 border-radius: var(--border-radius-md); text-align: center; 
                                                                 border: 2px dashed var(--border-light);">
                                                            <i class="fas fa-arrow-down" style="margin-bottom: 0.5rem; color: var(--medical-blue);"></i>
                                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                                Drop resident here to place
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Active Placements -->
                                        <div>
                                            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Active Placements</h3>
                                            <div v-if="activePlacements.length > 0" style="display: grid; gap: 1rem;">
                                                <div v-for="placement in activePlacements" :key="placement.id" class="person-card">
                                                    <div class="person-avatar resident">
                                                        {{ getInitials(placement.resident_name).charAt(0) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">{{ placement.resident_name }}</div>
                                                        <div class="person-clinic">{{ placement.unit_name }}</div>
                                                        <div class="person-meta">
                                                            <strong>Supervisor:</strong> {{ placement.supervisor_name }}
                                                            <br>
                                                            <strong>Rotation:</strong> {{ formatDate(placement.rotation_start_date) }} to {{ formatDate(placement.rotation_end_date) }}
                                                            <br>
                                                            <span :class="getDaysRemainingClass(placement.rotation_end_date)" style="margin-top: 0.5rem; display: inline-block;">
                                                                {{ getDaysRemaining(placement.rotation_end_date) }} days remaining
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn-outline btn-sm" @click="editPlacement(placement)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <button class="btn btn-sm btn-warning" @click="extendPlacement(placement)">
                                                            <i class="fas fa-calendar-plus"></i> Extend
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" @click="endPlacement(placement)">
                                                            <i class="fas fa-stop"></i> End
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="empty-state">
                                                <i class="fas fa-map-marker-alt empty-state-icon"></i>
                                                <h3>No active placements</h3>
                                                <p>Place residents to start tracking rotations</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Department Head Views -->
                        <div v-else-if="currentUser.user_role === 'department_head'">
                            <!-- Department Overview -->
                            <div v-if="currentView === 'department_overview'">
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-value">{{ departmentMetrics.totalStaff }}</div>
                                        <div class="metric-label">Total Staff</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            {{ departmentMetrics.attendings }} Attendings • {{ departmentMetrics.residents }} Residents
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-value">{{ departmentMetrics.occupancyRate }}%</div>
                                        <div class="metric-label">Unit Occupancy</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            {{ departmentMetrics.occupiedUnits }}/{{ departmentMetrics.totalUnits }} units at capacity
                                        </div>
                                    </div>

                                    <div class="metric-card">
                                        <div class="metric-value">{{ departmentMetrics.coverageToday }}%</div>
                                        <div class="metric-label">Coverage Today</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            {{ departmentMetrics.onLeave }} staff on leave
                                        </div>
                                    </div>

                                    <div class="metric-card">
                                        <div class="metric-value">{{ departmentMetrics.compliance }}%</div>
                                        <div class="metric-label">Duty Hour Compliance</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            {{ departmentMetrics.dutyHourAlerts }} alerts
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-chart-line"></i>
                                            Department Summary
                                        </div>
                                        <button class="btn" @click="exportDepartmentReport">
                                            <i class="fas fa-download"></i> Export Report
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Unit Status</h3>
                                                <div v-for="unit in clinicalUnits" :key="unit.id" style="margin-bottom: 1rem;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                        <span>{{ unit.unit_name }}</span>
                                                        <span style="font-weight: 600;">
                                                            {{ getClinicalUnitResidentsCount(unit.id) }}/{{ unit.maximum_residents }}
                                                        </span>
                                                    </div>
                                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                                        <div :style="{ 
                                                            width: `${(getClinicalUnitResidentsCount(unit.id) / unit.maximum_residents) * 100}%`,
                                                            background: getClinicalUnitResidentsCount(unit.id) >= unit.maximum_residents ? 'var(--medical-red)' : 'var(--medical-green)',
                                                            height: '100%'
                                                        }"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Supervisor Load</h3>
                                                <div v-for="supervisor in supervisors" :key="supervisor.id" style="margin-bottom: 1rem;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                        <span>{{ supervisor.full_name }}</span>
                                                        <span style="font-weight: 600;">
                                                            {{ getSupervisorResidentsCount(supervisor.id) }} residents
                                                        </span>
                                                    </div>
                                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                                        <div :style="{ 
                                                            width: `${Math.min(getSupervisorResidentsCount(supervisor.id) / 6 * 100, 100)}%`,
                                                            background: getSupervisorResidentsCount(supervisor.id) > 4 ? 'var(--medical-amber)' : 'var(--medical-green)',
                                                            height: '100%'
                                                        }"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Staff Management -->
                            <div v-else-if="currentView === 'staff_management'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-users"></i>
                                            Department Staff
                                        </div>
                                        <button class="btn" @click="showAddStaffModal">
                                            <i class="fas fa-user-plus"></i> Add Staff
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                            <select class="form-select" style="width: 160px;" v-model="staffFilter.staff_type">
                                                <option value="">All Roles</option>
                                                <option value="attending_physician">Attending</option>
                                                <option value="medical_resident">Resident</option>
                                                <option value="nurse_practitioner">Nurse</option>
                                                <option value="administrator">Administrator</option>
                                            </select>
                                            <select class="form-select" style="width: 160px;" v-model="staffFilter.employment_status">
                                                <option value="">All Status</option>
                                                <option value="active">Active</option>
                                                <option value="on_leave">On Leave</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                            <input type="text" class="form-input" style="width: 200px;" 
                                                   v-model="staffSearch" placeholder="Search staff...">
                                        </div>

                                        <div v-if="filteredStaff.length > 0" style="display: grid; gap: 1rem;">
                                            <div v-for="staffMember in filteredStaff" :key="staffMember.id" class="person-card">
                                                <div class="person-avatar" :class="{ resident: staffMember.staff_type === 'medical_resident' }">
                                                    {{ getInitials(staffMember.full_name) }}
                                                </div>
                                                <div class="person-info">
                                                    <div class="person-name">
                                                        {{ staffMember.full_name }}
                                                        <span class="role-badge" :class="{
                                                            'badge-attending': staffMember.staff_type === 'attending_physician',
                                                            'badge-resident': staffMember.staff_type === 'medical_resident',
                                                            'badge-admin': staffMember.staff_type === 'administrator'
                                                        }">
                                                            {{ formatStaffType(staffMember.staff_type) }}
                                                        </span>
                                                    </div>
                                                    <div class="person-clinic">
                                                        ID: {{ staffMember.staff_id }}
                                                        <span v-if="staffMember.primary_clinic" style="margin-left: 1rem;">
                                                            • {{ staffMember.primary_clinic }}
                                                        </span>
                                                    </div>
                                                    <div class="person-meta">
                                                        <div v-if="staffMember.staff_type === 'medical_resident' && staffMember.current_rotation">
                                                            <strong>Current Placement:</strong> {{ getClinicalUnitName(staffMember.current_rotation.training_unit_id) }}
                                                            <br>
                                                            <strong>Supervisor:</strong> {{ getSupervisorName(staffMember.current_rotation.supervising_attending_id) }}
                                                        </div>
                                                        <div v-if="staffMember.staff_type === 'attending_physician'">
                                                            <strong>Supervising:</strong> {{ getSupervisorResidentsCount(staffMember.id) }} residents
                                                        </div>
                                                        <div class="duty-hours" :class="{
                                                            'warning': staffMember.duty_hours > 60,
                                                            'critical': staffMember.duty_hours > 70
                                                        }">
                                                            <i class="fas fa-clock"></i> {{ staffMember.duty_hours || 0 }}/80 hours this week
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <button class="btn-outline btn-sm" @click="editStaff(staffMember)">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn-outline btn-sm" @click="viewStaffSchedule(staffMember)">
                                                        <i class="fas fa-calendar"></i> Schedule
                                                    </button>
                                                    <button v-if="staffMember.employment_status !== 'inactive'" class="btn btn-sm btn-warning" @click="toggleStaffStatus(staffMember)">
                                                        <i class="fas fa-user-slash"></i> Deactivate
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="empty-state">
                                            <i class="fas fa-users empty-state-icon"></i>
                                            <h3>No staff found</h3>
                                            <p>Add department staff to get started</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Schedule Approval -->
                            <div v-else-if="currentView === 'schedule_approval'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-check"></i>
                                            Schedule Approval
                                        </div>
                                        <div style="display: flex; gap: 1rem;">
                                            <button class="btn-outline" @click="loadPendingSchedules">
                                                <i class="fas fa-sync"></i> Refresh
                                            </button>
                                            <button class="btn" @click="approveAllSchedules">
                                                <i class="fas fa-check-double"></i> Approve All
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div v-if="pendingSchedules.length > 0" style="display: grid; gap: 1.5rem;">
                                            <div v-for="schedule in pendingSchedules" :key="schedule.id" class="person-card">
                                                <div class="person-avatar">
                                                    {{ getInitials(schedule.submitted_by_name) }}
                                                </div>
                                                <div class="person-info">
                                                    <div class="person-name">{{ schedule.period_name }}</div>
                                                    <div class="person-clinic">Submitted by: {{ schedule.submitted_by_name }}</div>
                                                    <div class="person-meta">
                                                        <strong>Period:</strong> {{ formatDate(schedule.start_date) }} to {{ formatDate(schedule.end_date) }}
                                                        <br>
                                                        <strong>Submitted:</strong> {{ formatDateTime(schedule.submitted_at) }}
                                                        <br>
                                                        <strong>Coverage:</strong> {{ schedule.coverage_rate }}% • <strong>Duty Hours:</strong> {{ schedule.compliance_rate }}% compliant
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <button class="btn btn-sm btn-success" @click="viewScheduleDetails(schedule)">
                                                        <i class="fas fa-eye"></i> Review
                                                    </button>
                                                    <button class="btn btn-sm btn-success" @click="approveSchedule(schedule)">
                                                        <i class="fas fa-check"></i> Approve
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" @click="rejectSchedule(schedule)">
                                                        <i class="fas fa-times"></i> Reject
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="empty-state">
                                            <i class="fas fa-check-circle empty-state-icon"></i>
                                            <h3>No schedules pending approval</h3>
                                            <p>All schedules are approved</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shared Views -->
                        <div v-else>
                            <!-- Schedule View -->
                            <div v-if="currentView === 'schedule'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-day"></i>
                                            Department Schedule
                                        </div>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <button class="btn-outline btn-sm" @click="previousWeek">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <div style="font-weight: 600; min-width: 200px; text-align: center;">
                                                {{ formatDateRange(currentWeekStart, currentWeekEnd) }}
                                            </div>
                                            <button class="btn-outline btn-sm" @click="nextWeek">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                            <button class="btn" @click="showNewAssignmentModal">
                                                <i class="fas fa-plus"></i> New Assignment
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="timeline">
                                            <div v-for="day in weekDays" :key="day.date" class="timeline-day">
                                                <div class="timeline-header">
                                                    {{ formatDayHeader(day.date) }}
                                                    <span v-if="isToday(day.date)" style="color: var(--medical-green); margin-left: 0.5rem;">
                                                        • TODAY
                                                    </span>
                                                </div>
                                                <div class="timeline-slots">
                                                    <div v-for="assignment in getAssignmentsForDay(day.date)" 
                                                         :key="assignment.id"
                                                         class="time-slot" 
                                                         :class="{ 
                                                             'assigned': assignment.person_role !== 'medical_resident',
                                                             'resident': assignment.person_role === 'medical_resident'
                                                         }">
                                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                                            {{ assignment.person_name }}
                                                            <span v-if="assignment.person_role === 'medical_resident'" class="resident-badge">
                                                                <i class="fas fa-graduation-cap"></i> RES
                                                            </span>
                                                        </div>
                                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                            {{ formatAssignmentType(assignment.assignment_type) }} • {{ formatTimeRange(assignment.start_time, assignment.end_time) }}
                                                        </div>
                                                        <div style="font-size: 0.75rem; color: var(--medical-blue); margin-top: 0.25rem;">
                                                            {{ assignment.location_name }}
                                                            <span v-if="assignment.supervising_attending_id" style="color: var(--medical-purple); margin-left: 0.5rem;">
                                                                • Supervisor: {{ getSupervisorName(assignment.supervising_attending_id) }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div v-if="getAssignmentsForDay(day.date).length === 0" 
                                                         class="time-slot"
                                                         style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                                        <i class="fas fa-calendar-plus" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                                        <div>No assignments scheduled</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- On-call View -->
                            <div v-else-if="currentView === 'oncall'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-phone-alt"></i>
                                            On-call Schedule
                                        </div>
                                        <button class="btn" @click="showNewOnCallModal">
                                            <i class="fas fa-plus"></i> Assign On-call
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div class="call-schedule">
                                            <div v-for="day in onCallDays" :key="day.date" class="call-day">
                                                <div class="call-date">
                                                    {{ formatDayHeader(day.date) }}
                                                    <span v-if="isToday(day.date)" style="color: var(--medical-green); font-size: 0.8rem;">
                                                        • TODAY
                                                    </span>
                                                </div>
                                                <div v-if="day.oncall" style="margin-bottom: 1rem;">
                                                    <div style="font-weight: 600; color: var(--medical-blue); margin-bottom: 0.5rem;">
                                                        Primary: {{ day.oncall.primary_name }}
                                                    </div>
                                                    <div v-if="day.oncall.backup_name" style="font-size: 0.9rem; color: var(--text-secondary);">
                                                        Backup: {{ day.oncall.backup_name }}
                                                    </div>
                                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                        <i class="fas fa-clock"></i> {{ day.oncall.start_time }} - {{ day.oncall.end_time }}
                                                    </div>
                                                </div>
                                                <div v-else style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 1rem 0;">
                                                    No on-call assigned
                                                </div>
                                                <div v-if="day.coverage_gap" style="margin-top: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); 
                                                      border-radius: var(--border-radius-md); border-left: 3px solid var(--medical-amber);">
                                                    <div style="font-size: 0.8rem; color: var(--medical-amber); font-weight: 600;">
                                                        <i class="fas fa-exclamation-triangle"></i> Coverage Gap
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                                        {{ day.coverage_gap }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Leave & Coverage -->
                            <div v-else-if="currentView === 'leave'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-calendar-times"></i>
                                            Leave & Coverage Management
                                        </div>
                                        <button class="btn" @click="showNewLeaveModal">
                                            <i class="fas fa-plus"></i> Request Leave
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div class="metrics-grid">
                                            <div class="metric-card">
                                                <div class="metric-value">{{ leaveMetrics.pending }}</div>
                                                <div class="metric-label">Pending Requests</div>
                                            </div>
                                            
                                            <div class="metric-card">
                                                <div class="metric-value">{{ leaveMetrics.active }}</div>
                                                <div class="metric-label">Active Leave</div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ leaveMetrics.coverageAssigned }}/{{ leaveMetrics.needsCoverage }}</div>
                                                <div class="metric-label">Coverage Status</div>
                                            </div>

                                            <div class="metric-card">
                                                <div class="metric-value">{{ leaveMetrics.upcoming }}</div>
                                                <div class="metric-label">Upcoming Leave</div>
                                            </div>
                                        </div>

                                        <!-- Pending Approvals -->
                                        <div v-if="pendingLeaveRequests.length > 0" style="margin-top: 2rem;">
                                            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Pending Approval</h3>
                                            <div style="display: grid; gap: 1rem;">
                                                <div v-for="request in pendingLeaveRequests" :key="request.id" class="person-card">
                                                    <div class="person-avatar">
                                                        {{ getInitials(request.person_name) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">{{ request.person_name }}</div>
                                                        <div class="person-clinic">{{ formatLeaveType(request.leave_category) }}</div>
                                                        <div class="person-meta">
                                                            {{ formatDate(request.leave_start_date) }} to {{ formatDate(request.leave_end_date) }}
                                                            • {{ request.total_days }} days
                                                            <br>
                                                            <strong>Reason:</strong> {{ request.leave_reason }}
                                                            <br>
                                                            <span v-if="request.person_role === 'medical_resident'" style="color: var(--medical-purple); font-size: 0.8rem; margin-top: 0.25rem; display: inline-block;">
                                                                <i class="fas fa-user-md"></i> Resident • Supervisor: {{ getSupervisorName(request.supervisor_id) }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-sm btn-success" @click="approveLeaveRequest(request)">
                                                            <i class="fas fa-check"></i> Approve
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" @click="rejectLeaveRequest(request)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn-outline btn-sm" @click="viewCoverageOptions(request)">
                                                            <i class="fas fa-user-plus"></i> Coverage
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Active Leave -->
                                        <div v-if="activeLeave.length > 0" style="margin-top: 2rem;">
                                            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Active Leave</h3>
                                            <div style="display: grid; gap: 1rem;">
                                                <div v-for="request in activeLeave" :key="request.id" class="person-card">
                                                    <div class="person-avatar">
                                                        {{ getInitials(request.person_name) }}
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">{{ request.person_name }}</div>
                                                        <div class="person-clinic">{{ formatLeaveType(request.leave_category) }}</div>
                                                        <div class="person-meta">
                                                            {{ formatDate(request.leave_start_date) }} to {{ formatDate(request.leave_end_date) }}
                                                            <br>
                                                            <span :class="request.coverage_assigned ? 'status-approved' : 'status-reported'" 
                                                                  class="status-pill" style="margin-top: 0.5rem;">
                                                                {{ request.coverage_assigned ? 'Coverage Assigned' : 'Needs Coverage' }}
                                                            </span>
                                                            <span v-if="request.coverage_notes" style="display: block; margin-top: 0.5rem; font-size: 0.8rem;">
                                                                <strong>Coverage Notes:</strong> {{ request.coverage_notes }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button v-if="!request.coverage_assigned" class="btn btn-sm" @click="assignCoverage(request)">
                                                            <i class="fas fa-user-plus"></i> Assign Coverage
                                                        </button>
                                                        <button class="btn-outline btn-sm" @click="editLeaveRequest(request)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-if="pendingLeaveRequests.length === 0 && activeLeave.length === 0" 
                                             class="empty-state" style="margin-top: 2rem;">
                                            <i class="fas fa-calendar-check empty-state-icon"></i>
                                            <h3>No leave requests</h3>
                                            <p>All staff are currently available</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports -->
                            <div v-else-if="currentView === 'reports'">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-chart-bar"></i>
                                            Department Reports
                                        </div>
                                        <button class="btn" @click="generateMonthlyReport">
                                            <i class="fas fa-file-export"></i> Generate Monthly Report
                                        </button>
                                    </div>
                                    <div class="card-content">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                            <div class="metric-card" style="cursor: pointer;" @click="showResidentReport">
                                                <div class="metric-value">{{ reportMetrics.residentCount }}</div>
                                                <div class="metric-label">Resident Report</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    View placements, supervisors, rotations
                                                </div>
                                            </div>
                                            
                                            <div class="metric-card" style="cursor: pointer;" @click="showUnitReport">
                                                <div class="metric-value">{{ reportMetrics.unitCount }}</div>
                                                <div class="metric-label">Unit Utilization</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    Capacity, occupancy, trends
                                                </div>
                                            </div>

                                            <div class="metric-card" style="cursor: pointer;" @click="showDutyHourReport">
                                                <div class="metric-value">{{ reportMetrics.dutyHourAlerts }}</div>
                                                <div class="metric-label">Duty Hour Compliance</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    Weekly hours, alerts, compliance
                                                </div>
                                            </div>

                                            <div class="metric-card" style="cursor: pointer;" @click="showCoverageReport">
                                                <div class="metric-value">{{ reportMetrics.coverageRate }}%</div>
                                                <div class="metric-label">Coverage Analysis</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                                    Leave, coverage gaps, trends
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Recent Reports -->
                                        <div style="margin-top: 2rem;">
                                            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Recent Reports</h3>
                                            <div v-if="recentReports.length > 0" style="display: grid; gap: 1rem;">
                                                <div v-for="report in recentReports" :key="report.id" class="person-card">
                                                    <div class="person-avatar" style="background: var(--medical-teal);">
                                                        <i class="fas" :class="report.icon"></i>
                                                    </div>
                                                    <div class="person-info">
                                                        <div class="person-name">{{ report.name }}</div>
                                                        <div class="person-clinic">Generated: {{ formatDateTime(report.generated_at) }}</div>
                                                        <div class="person-meta">
                                                            Type: {{ report.type }} • Period: {{ report.period }}
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn-outline btn-sm" @click="viewReport(report)">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                        <button class="btn btn-sm" @click="downloadReport(report)">
                                                            <i class="fas fa-download"></i> Download
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="empty-state" style="margin-top: 1rem;">
                                                <i class="fas fa-file-alt empty-state-icon"></i>
                                                <h3>No reports generated yet</h3>
                                                <p>Generate reports to view department analytics</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Add Resident Modal -->
        <div v-if="showResidentModal" class="modal-overlay" @click.self="closeResidentModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-graduate"></i>
                        {{ editingResident ? 'Edit Resident' : 'Add New Resident' }}
                    </div>
                    <button class="modal-close" @click="closeResidentModal">×</button>
                </div>
                <form @submit.prevent="saveResident">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" v-model="residentForm.full_name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Professional Email</label>
                                <input type="email" class="form-input" v-model="residentForm.professional_email">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Resident Category</label>
                                <select class="form-select" v-model="residentForm.resident_category" required>
                                    <option value="department_internal">Internal (Pneumology Dept)</option>
                                    <option value="rotating">Rotating (Other Dept)</option>
                                    <option value="external">External (Other Hospital/Abroad)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Training Year</label>
                                <select class="form-select" v-model="residentForm.training_year">
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                    <option value="5">Year 5+</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Medical License Number</label>
                                <input type="text" class="form-input" v-model="residentForm.medical_license">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Work Phone</label>
                                <input type="tel" class="form-input" v-model="residentForm.work_phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Clinic</label>
                            <input type="text" class="form-input" v-model="residentForm.primary_clinic">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Special Notes</label>
                            <textarea class="form-textarea" v-model="residentForm.special_notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeResidentModal">Cancel</button>
                        <button type="submit" class="btn btn-resident" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> {{ editingResident ? 'Update' : 'Save' }} Resident
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Clinical Unit Modal -->
        <div v-if="showClinicalUnitModal" class="modal-overlay" @click.self="closeClinicalUnitModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-hospital-alt"></i>
                        {{ editingClinicalUnit ? 'Edit Clinical Unit' : 'Add New Clinical Unit' }}
                    </div>
                    <button class="modal-close" @click="closeClinicalUnitModal">×</button>
                </div>
                <form @submit.prevent="saveClinicalUnit">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Unit Code</label>
                                <input type="text" class="form-input" v-model="clinicalUnitForm.unit_code" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit Name</label>
                                <input type="text" class="form-input" v-model="clinicalUnitForm.unit_name" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Department Name</label>
                                <input type="text" class="form-input" v-model="clinicalUnitForm.department_name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Residents</label>
                                <input type="number" class="form-input" v-model="clinicalUnitForm.maximum_residents" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Supervisor</label>
                            <select class="form-select" v-model="clinicalUnitForm.default_supervisor_id">
                                <option value="">None (assign manually)</option>
                                <option v-for="supervisor in supervisors" :value="supervisor.id">
                                    {{ supervisor.full_name }} ({{ supervisor.staff_id }})
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Description</label>
                            <textarea class="form-textarea" v-model="clinicalUnitForm.unit_description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" v-model="clinicalUnitForm.unit_status" true-value="active" false-value="inactive">
                                Active (available for resident placement)
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeClinicalUnitModal">Cancel</button>
                        <button type="submit" class="btn" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> {{ editingClinicalUnit ? 'Update' : 'Save' }} Unit
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Placement Modal -->
        <div v-if="showPlacementModal" class="modal-overlay" @click.self="closePlacementModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ editingPlacement ? 'Edit Rotation' : 'New Resident Rotation' }}
                    </div>
                    <button class="modal-close" @click="closePlacementModal">×</button>
                </div>
                <form @submit.prevent="savePlacement">
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">Select Resident</label>
                            <select class="form-select" v-model="placementForm.resident_id" required>
                                <option value="">Select resident...</option>
                                <option v-for="resident in availableResidents" :value="resident.id">
                                    {{ resident.full_name }} ({{ formatResidentCategory(resident.resident_category) }} • {{ resident.staff_id }})
                                </option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Training Unit</label>
                                <select class="form-select" v-model="placementForm.training_unit_id" required @change="updateDefaultSupervisor">
                                    <option value="">Select unit...</option>
                                    <option v-for="unit in availableClinicalUnits" :value="unit.id" :disabled="getClinicalUnitResidentsCount(unit.id) >= unit.maximum_residents">
                                        {{ unit.unit_name }} ({{ getClinicalUnitResidentsCount(unit.id) }}/{{ unit.maximum_residents }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervising Attending</label>
                                <select class="form-select" v-model="placementForm.supervising_attending_id" required>
                                    <option value="">Select supervisor...</option>
                                    <option v-for="supervisor in supervisors" :value="supervisor.id">
                                        {{ supervisor.full_name }} ({{ supervisor.staff_id }})
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-input" v-model="placementForm.rotation_start_date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-input" v-model="placementForm.rotation_end_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rotation Category</label>
                            <select class="form-select" v-model="placementForm.rotation_category">
                                <option value="clinical_rotation">Clinical Rotation</option>
                                <option value="elective_rotation">Elective Rotation</option>
                                <option value="research_rotation">Research Rotation</option>
                                <option value="administrative_rotation">Administrative Rotation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clinical Notes</label>
                            <textarea class="form-textarea" v-model="placementForm.clinical_notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closePlacementModal">Cancel</button>
                        <button type="submit" class="btn btn-resident" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> {{ editingPlacement ? 'Update' : 'Create' }} Rotation
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Staff Modal -->
        <div v-if="showStaffModal" class="modal-overlay" @click.self="closeStaffModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-plus"></i>
                        {{ editingStaff ? 'Edit Staff' : 'Add New Staff' }}
                    </div>
                    <button class="modal-close" @click="closeStaffModal">×</button>
                </div>
                <form @submit.prevent="saveStaff">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" v-model="staffForm.full_name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Professional Email</label>
                                <input type="email" class="form-input" v-model="staffForm.professional_email">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Staff Type</label>
                                <select class="form-select" v-model="staffForm.staff_type" required @change="updateSupervisorField">
                                    <option value="attending_physician">Attending Physician</option>
                                    <option value="medical_resident">Medical Resident</option>
                                    <option value="fellow">Fellow</option>
                                    <option value="nurse_practitioner">Nurse Practitioner</option>
                                    <option value="administrator">Administrator</option>
                                    <option value="technician">Technician</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Clinic/Unit</label>
                                <input type="text" class="form-input" v-model="staffForm.primary_clinic">
                            </div>
                        </div>
                        <div v-if="staffForm.staff_type === 'attending_physician'" class="form-group">
                            <label class="form-label">
                                <input type="checkbox" v-model="staffForm.can_supervise_residents">
                                Can Supervise Residents
                            </label>
                        </div>
                        <div v-if="staffForm.staff_type === 'medical_resident'" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Resident Category</label>
                                <select class="form-select" v-model="staffForm.resident_category">
                                    <option value="department_internal">Internal</option>
                                    <option value="rotating">Rotating</option>
                                    <option value="external">External</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Training Year</label>
                                <input type="number" class="form-input" v-model="staffForm.training_year" min="1" max="7">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Medical License</label>
                                <input type="text" class="form-input" v-model="staffForm.medical_license">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Work Phone</label>
                                <input type="tel" class="form-input" v-model="staffForm.work_phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employment Status</label>
                            <select class="form-select" v-model="staffForm.employment_status" required>
                                <option value="active">Active</option>
                                <option value="on_leave">On Leave</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Special Notes</label>
                            <textarea class="form-textarea" v-model="staffForm.special_notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeStaffModal">Cancel</button>
                        <button type="submit" class="btn" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> {{ editingStaff ? 'Update' : 'Save' }} Staff
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Assignment Modal -->
        <div v-if="showAssignmentModal" class="modal-overlay" @click.self="closeAssignmentModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-calendar-plus"></i>
                        New Assignment
                    </div>
                    <button class="modal-close" @click="closeAssignmentModal">×</button>
                </div>
                <form @submit.prevent="saveAssignment">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" v-model="assignmentForm.assignment_date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assignment Type</label>
                                <select class="form-select" v-model="assignmentForm.assignment_type" required>
                                    <option value="outpatient_clinic">Outpatient Clinic</option>
                                    <option value="icu_rounds">ICU Rounds</option>
                                    <option value="procedure_duty">Procedure Duty</option>
                                    <option value="teaching_rounds">Teaching Rounds</option>
                                    <option value="department_meeting">Department Meeting</option>
                                    <option value="research_time">Research Time</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-input" v-model="assignmentForm.start_time" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-input" v-model="assignmentForm.end_time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" v-model="assignmentForm.location_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Assign to Staff Member</label>
                            <select class="form-select" v-model="assignmentForm.staff_member_id" required @change="updateAssignmentSupervisor">
                                <option value="">Select staff member...</option>
                                <optgroup label="Residents">
                                    <option v-for="resident in availableResidents" :value="resident.id">
                                        {{ resident.full_name }} (Resident • {{ resident.staff_id }})
                                    </option>
                                </optgroup>
                                <optgroup label="Attendings">
                                    <option v-for="attending in availableAttendings" :value="attending.id">
                                        {{ attending.full_name }} (Attending • {{ attending.staff_id }})
                                    </option>
                                </optgroup>
                                <optgroup label="Other Staff">
                                    <option v-for="staffMember in otherStaff" :value="staffMember.id">
                                        {{ staffMember.full_name }} ({{ formatStaffType(staffMember.staff_type) }} • {{ staffMember.staff_id }})
                                    </option>
                                </optgroup>
                            </select>
                        </div>
                        <div v-if="isResidentSelected" class="form-group">
                            <label class="form-label">Supervising Attending for this assignment</label>
                            <select class="form-select" v-model="assignmentForm.supervising_attending_id">
                                <option value="">No specific supervisor</option>
                                <option v-for="supervisor in supervisors" :value="supervisor.id">
                                    {{ supervisor.full_name }} ({{ supervisor.staff_id }})
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Assignment Notes</label>
                            <textarea class="form-textarea" v-model="assignmentForm.assignment_notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeAssignmentModal">Cancel</button>
                        <button type="submit" class="btn" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> Create Assignment
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Leave Request Modal -->
        <div v-if="showLeaveModal" class="modal-overlay" @click.self="closeLeaveModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-calendar-plus"></i>
                        New Leave Request
                    </div>
                    <button class="modal-close" @click="closeLeaveModal">×</button>
                </div>
                <form @submit.prevent="saveLeaveRequest">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Leave Category</label>
                                <select class="form-select" v-model="leaveRequestForm.leave_category" required>
                                    <option value="vacation_leave">Vacation</option>
                                    <option value="sick_leave">Sick Leave</option>
                                    <option value="conference_cme">Conference/CME</option>
                                    <option value="personal_leave">Personal</option>
                                    <option value="maternity_paternity">Maternity/Paternity</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Staff Member</label>
                                <select class="form-select" v-model="leaveRequestForm.staff_member_id" required>
                                    <option value="">Select staff member...</option>
                                    <optgroup label="Residents">
                                        <option v-for="resident in allResidents" :value="resident.id">
                                            {{ resident.full_name }} (Resident • {{ resident.staff_id }})
                                        </option>
                                    </optgroup>
                                    <optgroup label="Attendings">
                                        <option v-for="attending in allAttendings" :value="attending.id">
                                            {{ attending.full_name }} (Attending • {{ attending.staff_id }})
                                        </option>
                                    </optgroup>
                                    <optgroup label="Other Staff">
                                        <option v-for="staffMember in allOtherStaff" :value="staffMember.id">
                                            {{ staffMember.full_name }} ({{ formatStaffType(staffMember.staff_type) }} • {{ staffMember.staff_id }})
                                        </option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-input" v-model="leaveRequestForm.leave_start_date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-input" v-model="leaveRequestForm.leave_end_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Leave Reason</label>
                            <textarea class="form-textarea" v-model="leaveRequestForm.leave_reason" required rows="3"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Coverage Required?</label>
                                <select class="form-select" v-model="leaveRequestForm.coverage_required">
                                    <option :value="true">Yes</option>
                                    <option :value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group" v-if="leaveRequestForm.coverage_required">
                                <label class="form-label">Coverage Notes</label>
                                <textarea class="form-textarea" v-model="leaveRequestForm.coverage_notes" rows="2"></textarea>
                            </div>
                        </div>
                        <div v-if="isResidentOnLeave" class="form-group" style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: var(--border-radius-md);">
                            <label class="form-label" style="color: var(--medical-purple);">
                                <i class="fas fa-user-md"></i> Resident Leave Notice
                            </label>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                This leave will affect the resident's current rotation. Their supervising attending will be notified.
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeLeaveModal">Cancel</button>
                        <button type="submit" class="btn" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-paper-plane"></i> Submit Leave Request
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New On-call Assignment Modal -->
        <div v-if="showOnCallModal" class="modal-overlay" @click.self="closeOnCallModal">
            <div class="modal modal-large" @click.stop>
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-phone-alt"></i>
                        Assign On-call
                    </div>
                    <button class="modal-close" @click="closeOnCallModal">×</button>
                </div>
                <form @submit.prevent="saveOnCallAssignment">
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Duty Date</label>
                                <input type="date" class="form-input" v-model="onCallForm.duty_date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Shift Type</label>
                                <select class="form-select" v-model="onCallForm.shift_type" required>
                                    <option value="primary_call">Primary Call</option>
                                    <option value="backup_call">Backup Call</option>
                                    <option value="float_call">Float Call</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-input" v-model="onCallForm.start_time" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-input" v-model="onCallForm.end_time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Physician</label>
                            <select class="form-select" v-model="onCallForm.primary_physician_id" required>
                                <option value="">Select primary physician...</option>
                                <optgroup label="Attendings">
                                    <option v-for="attending in availableAttendings" :value="attending.id">
                                        {{ attending.full_name }} (Attending • {{ attending.staff_id }})
                                    </option>
                                </optgroup>
                                <optgroup label="Senior Residents (PGY-3+)">
                                    <option v-for="resident in seniorResidents" :value="resident.id">
                                        {{ resident.full_name }} (Resident • {{ resident.staff_id }})
                                    </option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Backup Physician (Optional)</label>
                            <select class="form-select" v-model="onCallForm.backup_physician_id">
                                <option value="">No backup</option>
                                <optgroup label="Attendings">
                                    <option v-for="attending in availableAttendings" :value="attending.id">
                                        {{ attending.full_name }} (Attending • {{ attending.staff_id }})
                                    </option>
                                </optgroup>
                                <optgroup label="Residents">
                                    <option v-for="resident in availableResidents" :value="resident.id">
                                        {{ resident.full_name }} (Resident • {{ resident.staff_id }})
                                    </option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coverage Notes</label>
                            <textarea class="form-textarea" v-model="onCallForm.coverage_notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-outline" @click="closeOnCallModal">Cancel</button>
                        <button type="submit" class="btn" :disabled="saving">
                            <span v-if="saving" class="loading-spinner"></span>
                            <span v-else>
                                <i class="fas fa-save"></i> Assign On-call
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.show" class="toast" :class="toast.type" @click="toast.show = false">
            <i :class="toast.icon"></i> {{ toast.message }}
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    // Supabase configuration
    const SUPABASE_URL = 'https://vssmguzuvekkecbmwcjw.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_QDZP5eQTlHHn0SZibWFvCQ_6RqH2f01';
    
    createApp({
        setup() {
            // ============ STATE MANAGEMENT ============
            // Supabase client
            const supabaseClient = ref(null);
            
            // Authentication
            const currentUser = ref(null);
            const loginForm = ref({
                email: '',
                password: '',
                role: 'resident_manager'
            });
            const loading = ref(false);
            const saving = ref(false);
            
            // Navigation
            const currentView = ref('residents');
            const sidebarCollapsed = ref(false);
            const mobileMenuOpen = ref(false);
            const searchQuery = ref('');
            
            // Data Stores
            const medicalStaff = ref([]);
            const clinicalUnits = ref([]);
            const residentRotations = ref([]);
            const dailyAssignments = ref([]);
            const onCallSchedules = ref([]);
            const leaveRequests = ref([]);
            const departmentAnnouncements = ref([]);
            
            // Modals
            const showResidentModal = ref(false);
            const showClinicalUnitModal = ref(false);
            const showPlacementModal = ref(false);
            const showStaffModal = ref(false);
            const showAssignmentModal = ref(false);
            const showLeaveModal = ref(false);
            const showOnCallModal = ref(false);
            
            // Forms
            const residentForm = ref({
                full_name: '',
                professional_email: '',
                staff_type: 'medical_resident',
                resident_category: 'department_internal',
                training_year: 1,
                medical_license: '',
                work_phone: '',
                primary_clinic: '',
                employment_status: 'active',
                special_notes: ''
            });
            
            const clinicalUnitForm = ref({
                unit_code: '',
                unit_name: '',
                department_name: 'Pulmonology',
                maximum_residents: 4,
                default_supervisor_id: '',
                unit_description: '',
                unit_status: 'active'
            });
            
            const placementForm = ref({
                resident_id: '',
                training_unit_id: '',
                supervising_attending_id: '',
                rotation_start_date: '',
                rotation_end_date: '',
                rotation_category: 'clinical_rotation',
                rotation_status: 'scheduled',
                clinical_notes: ''
            });
            
            const staffForm = ref({
                full_name: '',
                professional_email: '',
                staff_type: 'attending_physician',
                resident_category: 'department_internal',
                training_year: 1,
                primary_clinic: '',
                can_supervise_residents: true,
                medical_license: '',
                work_phone: '',
                employment_status: 'active',
                special_notes: ''
            });
            
            const assignmentForm = ref({
                assignment_date: '',
                assignment_type: 'outpatient_clinic',
                start_time: '08:00',
                end_time: '17:00',
                location_name: '',
                staff_member_id: '',
                supervising_attending_id: '',
                assignment_notes: ''
            });
            
            const leaveRequestForm = ref({
                leave_category: 'vacation_leave',
                staff_member_id: '',
                leave_start_date: '',
                leave_end_date: '',
                leave_reason: '',
                coverage_required: true,
                coverage_notes: '',
                approval_status: 'pending_review'
            });
            
            const onCallForm = ref({
                duty_date: '',
                shift_type: 'primary_call',
                start_time: '17:00',
                end_time: '08:00',
                primary_physician_id: '',
                backup_physician_id: '',
                coverage_notes: ''
            });
            
            // Editing State
            const editingResident = ref(null);
            const editingClinicalUnit = ref(null);
            const editingPlacement = ref(null);
            const editingStaff = ref(null);
            
            // Filters
            const residentFilter = ref({
                type: '',
                status: ''
            });
            const residentSearch = ref('');
            
            const staffFilter = ref({
                staff_type: '',
                employment_status: ''
            });
            const staffSearch = ref('');
            
            // Schedule
            const currentWeekStart = ref(new Date());
            const currentWeekEnd = ref(new Date());
            
            // Calendar
            const currentMonth = ref(new Date().getMonth());
            const currentYear = ref(new Date().getFullYear());
            
            // Toast
            const toast = ref({
                show: false,
                message: '',
                icon: 'fas fa-info-circle',
                type: 'info'
            });
            
            // ============ UTILITY FUNCTIONS ============
            const showToast = (message, type = 'info') => {
                const icons = {
                    info: 'fas fa-info-circle',
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle'
                };
                
                toast.value = {
                    show: true,
                    message,
                    icon: icons[type] || icons.info,
                    type: type
                };
                
                setTimeout(() => {
                    toast.value.show = false;
                }, 4000);
            };
            
            const getInitials = (name) => {
                if (!name) return '??';
                return name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            };
            
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            const formatDateShort = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            const formatDateTime = (dateTimeString) => {
                if (!dateTimeString) return '';
                const date = new Date(dateTimeString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            const formatTime = (timeString) => {
                if (!timeString) return '';
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            };
            
            const formatTimeRange = (start, end) => {
                return `${formatTime(start)} - ${formatTime(end)}`;
            };
            
            const formatDateRange = (start, end) => {
                return `${formatDate(start)} - ${formatDate(end)}`;
            };
            
            const formatDayHeader = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            const isToday = (dateString) => {
                const today = new Date().toISOString().split('T')[0];
                return dateString === today;
            };
            
            const generateSystemId = (prefix) => {
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}-${timestamp}-${random}`;
            };
            
            const formatRole = (role) => {
                const roles = {
                    resident_manager: 'Resident Manager',
                    department_head: 'Head of Department',
                    system_admin: 'System Administrator',
                    viewing_doctor: 'Viewing Doctor'
                };
                return roles[role] || role;
            };
            
            const formatResidentCategory = (category) => {
                const categories = {
                    department_internal: 'Internal',
                    rotating: 'Rotating',
                    external: 'External'
                };
                return categories[category] || category;
            };
            
            const formatStaffType = (type) => {
                const types = {
                    attending_physician: 'Attending',
                    medical_resident: 'Resident',
                    fellow: 'Fellow',
                    nurse_practitioner: 'Nurse',
                    administrator: 'Admin',
                    technician: 'Technician'
                };
                return types[type] || type;
            };
            
            const formatLeaveType = (type) => {
                const types = {
                    vacation_leave: 'Vacation',
                    sick_leave: 'Sick Leave',
                    conference_cme: 'Conference/CME',
                    personal_leave: 'Personal',
                    maternity_paternity: 'Maternity/Paternity',
                    other: 'Other'
                };
                return types[type] || type;
            };
            
            const formatAssignmentType = (type) => {
                const types = {
                    outpatient_clinic: 'Clinic',
                    icu_rounds: 'ICU',
                    procedure_duty: 'Procedure',
                    teaching_rounds: 'Rounds',
                    department_meeting: 'Meeting',
                    research_time: 'Research'
                };
                return types[type] || type;
            };
            
            // ============ COMPUTED PROPERTIES ============
            // Get all residents
            const residents = computed(() => {
                return medicalStaff.value.filter(staff => staff.staff_type === 'medical_resident');
            });
            
            // Get all attendings
            const attendings = computed(() => {
                return medicalStaff.value.filter(staff => staff.staff_type === 'attending_physician');
            });
            
            // Supervisors (Attendings who can supervise)
            const supervisors = computed(() => {
                return medicalStaff.value.filter(staff => 
                    staff.staff_type === 'attending_physician' && staff.can_supervise_residents !== false
                );
            });
            
            // Department Metrics
            const departmentMetrics = computed(() => {
                const totalResidents = residents.value.length;
                
                // Count by resident category
                const residentTypes = residents.value.reduce((acc, resident) => {
                    acc[resident.resident_category] = (acc[resident.resident_category] || 0) + 1;
                    return acc;
                }, { department_internal: 0, rotating: 0, external: 0 });
                
                // Count placed vs unplaced
                const placedResidents = residents.value.filter(r => r.current_rotation).length;
                const unplacedResidents = totalResidents - placedResidents;
                
                // Count rotations ending soon
                const today = new Date();
                const twoWeeksFromNow = new Date();
                twoWeeksFromNow.setDate(today.getDate() + 14);
                const endingSoon = residentRotations.value.filter(rotation => {
                    const endDate = new Date(rotation.rotation_end_date);
                    return rotation.rotation_status === 'active' && 
                           endDate > today && 
                           endDate <= twoWeeksFromNow;
                }).length;
                
                const totalStaff = medicalStaff.value.length;
                const attendingsCount = attendings.value.length;
                const residentsCount = totalResidents;
                
                const totalUnits = clinicalUnits.value.length;
                const occupiedUnits = clinicalUnits.value.filter(unit => 
                    getClinicalUnitResidentsCount(unit.id) >= unit.maximum_residents
                ).length;
                const occupancyRate = totalUnits > 0 ? 
                    Math.round((occupiedUnits / totalUnits) * 100) : 0;
                    
                return {
                    totalResidents,
                    residentTypes,
                    assignedResidents: placedResidents,
                    unassignedResidents: unplacedResidents,
                    endingSoon,
                    dutyHoursWarning: 0, // Would calculate from assignments
                    totalStaff,
                    attendings: attendingsCount,
                    residents: residentsCount,
                    totalUnits,
                    occupiedUnits,
                    occupancyRate,
                    coverageToday: 95, // Would calculate from schedule
                    onLeave: 3, // Would calculate from leave requests
                    compliance: 92, // Duty hour compliance
                    dutyHourAlerts: 2
                };
            });
            
            // Leave Metrics
            const leaveMetrics = computed(() => {
                const pending = leaveRequests.value.filter(l => l.approval_status === 'pending_review').length;
                const active = leaveRequests.value.filter(l => l.approval_status === 'approved').length;
                const upcoming = 0; // Would calculate
                const needsCoverage = 0; // Would calculate
                const coverageAssigned = 0; // Would calculate
                const coverageRate = needsCoverage > 0 ? 
                    Math.round((coverageAssigned / needsCoverage) * 100) : 100;
                    
                return {
                    pending,
                    active,
                    upcoming,
                    needsCoverage,
                    coverageAssigned,
                    coverageRate
                };
            });
            
            // Report Metrics
            const reportMetrics = computed(() => {
                return {
                    residentCount: residents.value.length,
                    unitCount: clinicalUnits.value.length,
                    dutyHourAlerts: 2,
                    coverageRate: 95
                };
            });
            
            // Filtered Lists
            const filteredResidents = computed(() => {
                let filtered = residents.value;
                
                // Search
                if (residentSearch.value) {
                    const search = residentSearch.value.toLowerCase();
                    filtered = filtered.filter(r => 
                        r.full_name.toLowerCase().includes(search) ||
                        r.staff_id?.toLowerCase().includes(search)
                    );
                }
                
                // Type filter
                if (residentFilter.value.type) {
                    filtered = filtered.filter(r => r.resident_category === residentFilter.value.type);
                }
                
                // Status filter
                if (residentFilter.value.status) {
                    if (residentFilter.value.status === 'placed') {
                        filtered = filtered.filter(r => r.current_rotation);
                    } else if (residentFilter.value.status === 'unplaced') {
                        filtered = filtered.filter(r => !r.current_rotation);
                    } else if (residentFilter.value.status === 'ending') {
                        const today = new Date();
                        const twoWeeksFromNow = new Date();
                        twoWeeksFromNow.setDate(today.getDate() + 14);
                        filtered = filtered.filter(r => {
                            if (!r.current_rotation) return false;
                            const endDate = new Date(r.current_rotation.rotation_end_date);
                            return endDate > today && endDate <= twoWeeksFromNow;
                        });
                    }
                }
                
                return filtered;
            });
            
            const filteredStaff = computed(() => {
                let filtered = medicalStaff.value;
                
                // Search
                if (staffSearch.value) {
                    const search = staffSearch.value.toLowerCase();
                    filtered = filtered.filter(s => 
                        s.full_name.toLowerCase().includes(search) ||
                        s.staff_id?.toLowerCase().includes(search)
                    );
                }
                
                // Role filter
                if (staffFilter.value.staff_type) {
                    filtered = filtered.filter(s => s.staff_type === staffFilter.value.staff_type);
                }
                
                // Status filter
                if (staffFilter.value.employment_status) {
                    filtered = filtered.filter(s => s.employment_status === staffFilter.value.employment_status);
                }
                
                return filtered;
            });
            
            // Available residents for placement (unplaced)
            const unplacedResidents = computed(() => {
                return residents.value.filter(r => !r.current_rotation);
            });
            
            // Available clinical units (active and with capacity)
            const availableClinicalUnits = computed(() => {
                return clinicalUnits.value.filter(unit => 
                    unit.unit_status === 'active' && getClinicalUnitResidentsCount(unit.id) < unit.maximum_residents
                );
            });
            
            // Active placements
            const activePlacements = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                return residentRotations.value
                    .filter(rotation => rotation.rotation_status === 'active' && rotation.rotation_end_date >= today)
                    .map(rotation => ({
                        ...rotation,
                        resident_name: getResidentName(rotation.resident_id),
                        unit_name: getClinicalUnitName(rotation.training_unit_id),
                        supervisor_name: getSupervisorName(rotation.supervising_attending_id)
                    }));
            });
            
            // Available staff for assignments
            const availableResidents = computed(() => {
                return residents.value.filter(r => r.employment_status === 'active');
            });
            
            const availableAttendings = computed(() => {
                return attendings.value.filter(a => a.employment_status === 'active');
            });
            
            const otherStaff = computed(() => {
                return medicalStaff.value.filter(s => 
                    !['attending_physician', 'medical_resident'].includes(s.staff_type) && 
                    s.employment_status === 'active'
                );
            });
            
            const seniorResidents = computed(() => {
                return residents.value.filter(r => 
                    parseInt(r.training_year) >= 3 && r.employment_status === 'active'
                );
            });
            
            // All staff for leave requests
            const allResidents = computed(() => residents.value.filter(r => r.employment_status === 'active'));
            const allAttendings = computed(() => availableAttendings.value);
            const allOtherStaff = computed(() => otherStaff.value);
            
            // Week days for schedule view
            const weekDays = computed(() => {
                const days = [];
                const start = new Date(currentWeekStart.value);
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + i);
                    
                    days.push({
                        date: date.toISOString().split('T')[0],
                        day: date.toLocaleDateString('en-US', { weekday: 'short' }),
                        number: date.getDate()
                    });
                }
                
                return days;
            });
            
            // On-call days
            const onCallDays = computed(() => {
                return weekDays.value.map(day => {
                    const oncall = onCallSchedules.value.find(a => a.duty_date === day.date);
                    return {
                        ...day,
                        oncall: oncall ? {
                            ...oncall,
                            primary_name: getStaffName(oncall.primary_physician_id),
                            backup_name: oncall.backup_physician_id ? getStaffName(oncall.backup_physician_id) : null
                        } : null,
                        coverage_gap: oncall ? null : 'No on-call assigned'
                    };
                });
            });
            
            // Calendar days for rotation view
            const calendarDays = computed(() => {
                const year = currentYear.value;
                const month = currentMonth.value;
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const days = [];
                const today = new Date().toISOString().split('T')[0];
                
                // Add padding for days before month start
                const startDay = firstDay.getDay();
                for (let i = 0; i < startDay; i++) {
                    const date = new Date(firstDay);
                    date.setDate(firstDay.getDate() - (startDay - i));
                    days.push({
                        date: date.toISOString().split('T')[0],
                        day: date.getDate(),
                        isToday: false,
                        isCurrentMonth: false
                    });
                }
                
                // Add month days
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const date = new Date(year, month, i);
                    days.push({
                        date: date.toISOString().split('T')[0],
                        day: i,
                        isToday: date.toISOString().split('T')[0] === today,
                        isCurrentMonth: true
                    });
                }
                
                // Add padding for days after month end
                const endDay = lastDay.getDay();
                for (let i = 1; i < (7 - endDay); i++) {
                    const date = new Date(lastDay);
                    date.setDate(lastDay.getDate() + i);
                    days.push({
                        date: date.toISOString().split('T')[0],
                        day: date.getDate(),
                        isToday: false,
                        isCurrentMonth: false
                    });
                }
                
                return days;
            });
            
            const currentMonthName = computed(() => {
                return new Date(currentYear.value, currentMonth.value).toLocaleDateString('en-US', {
                    month: 'long'
                });
            });
            
            // Pending leave requests
            const pendingLeaveRequests = computed(() => {
                return leaveRequests.value
                    .filter(request => request.approval_status === 'pending_review')
                    .map(request => ({
                        ...request,
                        person_name: getStaffName(request.staff_member_id),
                        person_role: getStaffRole(request.staff_member_id)
                    }));
            });
            
            const activeLeave = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                return leaveRequests.value
                    .filter(request => request.approval_status === 'approved' && request.leave_end_date >= today)
                    .map(request => ({
                        ...request,
                        person_name: getStaffName(request.staff_member_id)
                    }));
            });
            
            const pendingSchedules = computed(() => {
                // Would implement schedule approval system
                return [];
            });
            
            const recentReports = computed(() => {
                // Would implement reports system
                return [];
            });
            
            // Form helpers
            const isResidentSelected = computed(() => {
                const staffId = assignmentForm.value.staff_member_id;
                if (!staffId) return false;
                const staffMember = medicalStaff.value.find(s => s.id === staffId);
                return staffMember?.staff_type === 'medical_resident';
            });
            
            const isResidentOnLeave = computed(() => {
                const staffId = leaveRequestForm.value.staff_member_id;
                if (!staffId) return false;
                const staffMember = medicalStaff.value.find(s => s.id === staffId);
                return staffMember?.staff_type === 'medical_resident';
            });
            
            // ============ HELPER FUNCTIONS ============
            const getStaffName = (staffId) => {
                const staffMember = medicalStaff.value.find(s => s.id === staffId);
                return staffMember ? staffMember.full_name : 'Unknown';
            };
            
            const getStaffRole = (staffId) => {
                const staffMember = medicalStaff.value.find(s => s.id === staffId);
                return staffMember ? staffMember.staff_type : 'unknown';
            };
            
            const getResidentName = (residentId) => {
                const resident = residents.value.find(r => r.id === residentId);
                return resident ? resident.full_name : 'Unknown Resident';
            };
            
            const getClinicalUnitName = (unitId) => {
                const unit = clinicalUnits.value.find(u => u.id === unitId);
                return unit ? unit.unit_name : 'Unknown Unit';
            };
            
            const getSupervisorName = (supervisorId) => {
                const supervisor = supervisors.value.find(s => s.id === supervisorId);
                return supervisor ? supervisor.full_name : 'Not Assigned';
            };
            
            const getClinicalUnitResidentsCount = (unitId) => {
                return residentRotations.value.filter(rotation => 
                    rotation.training_unit_id === unitId && 
                    rotation.rotation_status === 'active' &&
                    rotation.rotation_end_date >= new Date().toISOString().split('T')[0]
                ).length;
            };
            
            const getClinicalUnitResidents = (unitId) => {
                const unitRotations = residentRotations.value.filter(rotation => 
                    rotation.training_unit_id === unitId && 
                    rotation.rotation_status === 'active' &&
                    rotation.rotation_end_date >= new Date().toISOString().split('T')[0]
                );
                
                return unitRotations.map(rotation => {
                    const resident = residents.value.find(r => r.id === rotation.resident_id);
                    return resident ? {
                        ...resident,
                        current_rotation: rotation
                    } : null;
                }).filter(r => r); // Remove null values
            };
            
            const getSupervisorResidentsCount = (supervisorId) => {
                return residentRotations.value.filter(rotation => 
                    rotation.supervising_attending_id === supervisorId && 
                    rotation.rotation_status === 'active' &&
                    rotation.rotation_end_date >= new Date().toISOString().split('T')[0]
                ).length;
            };
            
            const getAssignmentsForDay = (date) => {
                return dailyAssignments.value
                    .filter(assignment => assignment.assignment_date === date)
                    .map(assignment => ({
                        ...assignment,
                        person_name: getStaffName(assignment.staff_member_id),
                        person_role: getStaffRole(assignment.staff_member_id)
                    }));
            };
            
            const getRotationsForDate = (date) => {
                const targetDate = new Date(date);
                return residentRotations.value
                    .filter(rotation => {
                        const start = new Date(rotation.rotation_start_date);
                        const end = new Date(rotation.rotation_end_date);
                        return rotation.rotation_status === 'active' && 
                               targetDate >= start && targetDate <= end;
                    })
                    .map(rotation => ({
                        ...rotation,
                        resident_name: getResidentName(rotation.resident_id),
                        unit_name: getClinicalUnitName(rotation.training_unit_id)
                    }));
            };
            
            const getRotationEventsForDate = (date) => {
                const events = [];
                const starts = residentRotations.value.filter(r => 
                    r.rotation_start_date === date && r.rotation_status !== 'cancelled'
                ).length;
                const ends = residentRotations.value.filter(r => 
                    r.rotation_end_date === date && r.rotation_status !== 'cancelled'
                ).length;
                
                if (starts > 0) events.push({ type: 'starts', count: starts });
                if (ends > 0) events.push({ type: 'ends', count: ends });
                
                return events;
            };
            
            const getDaysRemaining = (endDate) => {
                const today = new Date();
                const end = new Date(endDate);
                const diffTime = end - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };
            
            const getDaysRemainingClass = (endDate) => {
                const days = getDaysRemaining(endDate);
                if (days <= 7) return 'duty-hours critical';
                if (days <= 14) return 'duty-hours warning';
                return '';
            };
            
            // ============ NAVIGATION ============
            const switchView = (view) => {
                currentView.value = view;
                closeMobileMenu();
                
                // Load data for the view
                switch (view) {
                    case 'residents':
                        loadMedicalStaff();
                        loadResidentRotations();
                        break;
                    case 'clinical_units':
                        loadClinicalUnits();
                        loadResidentRotations();
                        break;
                    case 'rotations':
                        loadResidentRotations();
                        break;
                    case 'placements':
                        loadMedicalStaff();
                        loadClinicalUnits();
                        loadResidentRotations();
                        break;
                    case 'department_overview':
                        loadMedicalStaff();
                        loadClinicalUnits();
                        break;
                    case 'staff_management':
                        loadMedicalStaff();
                        break;
                    case 'schedule':
                        loadDailyAssignments();
                        break;
                    case 'oncall':
                        loadOnCallSchedules();
                        break;
                    case 'leave':
                        loadLeaveRequests();
                        break;
                }
            };
            
            const getCurrentTitle = () => {
                const titles = {
                    // Resident Manager Views
                    residents: 'Resident Management',
                    clinical_units: 'Clinical Units',
                    rotations: 'Rotation Calendar',
                    placements: 'Resident Placements',
                    
                    // Department Head Views
                    department_overview: 'Department Overview',
                    staff_management: 'Staff Management',
                    schedule_approval: 'Schedule Approval',
                    
                    // Shared Views
                    schedule: 'Department Schedule',
                    oncall: 'On-call Schedule',
                    leave: 'Leave & Coverage',
                    reports: 'Reports & Analytics'
                };
                
                return titles[currentView.value] || 'PneumoCare Pro';
            };
            
            const getCurrentSubtitle = () => {
                const subtitles = {
                    residents: 'Manage resident placements and rotations',
                    clinical_units: 'Configure clinical units and capacities',
                    rotations: 'View rotation schedules and changes',
                    placements: 'Assign residents to clinical units',
                    department_overview: 'Monitor department operations and metrics',
                    staff_management: 'Manage department staff and roles',
                    schedule_approval: 'Review and approve department schedules',
                    schedule: 'View and manage weekly assignments',
                    oncall: 'Manage on-call rotations and coverage',
                    leave: 'Handle leave requests and coverage arrangements',
                    reports: 'Generate department reports and analytics'
                };
                
                return subtitles[currentView.value] || '';
            };
            
            const getSearchPlaceholder = () => {
                const placeholders = {
                    residents: 'Search residents by name or ID...',
                    clinical_units: 'Search clinical units...',
                    placements: 'Search placements...',
                    staff_management: 'Search staff...',
                    schedule: 'Search assignments...',
                    leave: 'Search leave requests...',
                    reports: 'Search reports...'
                };
                
                return placeholders[currentView.value] || 'Search...';
            };
            
            const toggleMobileMenu = () => {
                mobileMenuOpen.value = !mobileMenuOpen.value;
            };
            
            const closeMobileMenu = () => {
                mobileMenuOpen.value = false;
            };
            
            const toggleUserMenu = () => {
                showToast('User menu would open here', 'info');
            };
            
            // ============ SUPABASE INITIALIZATION ============
            const initializeSupabase = () => {
                supabaseClient.value = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            };
            
            // ============ API FUNCTIONS ============
            
            // Authentication
            const handleLogin = async () => {
                loading.value = true;
                
                try {
                    // Supabase authentication
                    const { data, error } = await supabaseClient.value.auth.signInWithPassword({
                        email: loginForm.value.email,
                        password: loginForm.value.password
                    });
                    
                    if (error) throw error;
                    
                    // Get user profile from app_users table
                    const { data: userData, error: userError } = await supabaseClient.value
                        .from('app_users')
                        .select('*')
                        .eq('user_id', data.user.id)
                        .single();
                    
                    if (userError) throw userError;
                    
                    currentUser.value = {
                        ...data.user,
                        ...userData
                    };
                    
                    // Load initial data based on role
                    await loadInitialData();
                    
                    showToast(`Welcome, ${currentUser.value.full_name}!`, 'success');
                    
                } catch (error) {
                    console.error('Login error:', error);
                    showToast(error.message || 'Login failed. Please check your credentials.', 'error');
                } finally {
                    loading.value = false;
                }
            };
            
            // Load initial data based on user role
            const loadInitialData = async () => {
                loading.value = true;
                
                try {
                    // Always load medical staff and clinical units
                    await loadMedicalStaff();
                    await loadClinicalUnits();
                    
                    // Set initial view based on role
                    if (currentUser.value.user_role === 'resident_manager') {
                        currentView.value = 'residents';
                        await loadResidentRotations();
                    } else if (currentUser.value.user_role === 'department_head') {
                        currentView.value = 'department_overview';
                    }
                    
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    showToast('Error loading system data', 'error');
                } finally {
                    loading.value = false;
                }
            };
            
            // Load medical staff
            const loadMedicalStaff = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('medical_staff')
                        .select('*')
                        .order('full_name');
                    
                    if (error) throw error;
                    
                    medicalStaff.value = data.map(staff => ({
                        ...staff,
                        current_rotation: residentRotations.value.find(
                            rotation => rotation.resident_id === staff.id && 
                            rotation.rotation_status === 'active'
                        )
                    }));
                    
                } catch (error) {
                    console.error('Error loading medical staff:', error);
                    showToast('Error loading medical staff data', 'error');
                }
            };
            
            // Load clinical units
            const loadClinicalUnits = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('training_units')
                        .select('*')
                        .order('unit_name');
                    
                    if (error) throw error;
                    
                    clinicalUnits.value = data;
                    
                } catch (error) {
                    console.error('Error loading clinical units:', error);
                    showToast('Error loading clinical units data', 'error');
                }
            };
            
            // Load resident rotations
            const loadResidentRotations = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('resident_rotations')
                        .select('*')
                        .in('rotation_status', ['active', 'scheduled'])
                        .order('rotation_start_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    residentRotations.value = data;
                    
                } catch (error) {
                    console.error('Error loading resident rotations:', error);
                    showToast('Error loading rotation data', 'error');
                }
            };
            
            // Load daily assignments
            const loadDailyAssignments = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('daily_assignments')
                        .select('*')
                        .order('assignment_date');
                    
                    if (error) throw error;
                    
                    dailyAssignments.value = data;
                    
                } catch (error) {
                    console.error('Error loading daily assignments:', error);
                    showToast('Error loading schedule data', 'error');
                }
            };
            
            // Load on-call schedules
            const loadOnCallSchedules = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('oncall_schedule')
                        .select('*')
                        .order('duty_date');
                    
                    if (error) throw error;
                    
                    onCallSchedules.value = data;
                    
                } catch (error) {
                    console.error('Error loading on-call schedules:', error);
                    showToast('Error loading on-call data', 'error');
                }
            };
            
            // Load leave requests
            const loadLeaveRequests = async () => {
                try {
                    const { data, error } = await supabaseClient.value
                        .from('leave_requests')
                        .select('*')
                        .order('leave_start_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    leaveRequests.value = data;
                    
                } catch (error) {
                    console.error('Error loading leave requests:', error);
                    showToast('Error loading leave data', 'error');
                }
            };
            
            const updateWeekRange = () => {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                
                const start = new Date(today);
                start.setDate(diff);
                start.setHours(0, 0, 0, 0);
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                
                currentWeekStart.value = start;
                currentWeekEnd.value = end;
            };
            
            // ============ RESIDENT MANAGEMENT ============
            const showAddResidentModal = () => {
                editingResident.value = null;
                residentForm.value = {
                    full_name: '',
                    professional_email: '',
                    staff_type: 'medical_resident',
                    resident_category: 'department_internal',
                    training_year: 1,
                    medical_license: '',
                    work_phone: '',
                    primary_clinic: '',
                    employment_status: 'active',
                    special_notes: ''
                };
                showResidentModal.value = true;
            };
            
            const editResident = (resident) => {
                editingResident.value = resident.id;
                residentForm.value = { ...resident };
                showResidentModal.value = true;
            };
            
            const closeResidentModal = () => {
                showResidentModal.value = false;
                editingResident.value = null;
            };
            
            const saveResident = async () => {
                saving.value = true;
                
                try {
                    const staffData = {
                        ...residentForm.value,
                        staff_id: editingResident.value ? undefined : generateSystemId('RES'),
                        can_supervise_residents: false
                    };
                    
                    if (editingResident.value) {
                        // Update existing resident
                        const { error } = await supabaseClient.value
                            .from('medical_staff')
                            .update(staffData)
                            .eq('id', editingResident.value);
                        
                        if (error) throw error;
                        showToast('Resident updated successfully', 'success');
                    } else {
                        // Add new resident
                        const { error } = await supabaseClient.value
                            .from('medical_staff')
                            .insert([staffData]);
                        
                        if (error) throw error;
                        showToast('Resident added successfully', 'success');
                    }
                    
                    await loadMedicalStaff();
                    closeResidentModal();
                    
                } catch (error) {
                    console.error('Error saving resident:', error);
                    showToast('Error saving resident: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            const filterResidents = () => {
                // Filtering is handled by computed property
            };
            
            // ============ CLINICAL UNIT MANAGEMENT ============
            const showAddClinicalUnitModal = () => {
                editingClinicalUnit.value = null;
                clinicalUnitForm.value = {
                    unit_code: '',
                    unit_name: '',
                    department_name: 'Pulmonology',
                    maximum_residents: 4,
                    default_supervisor_id: '',
                    unit_description: '',
                    unit_status: 'active'
                };
                showClinicalUnitModal.value = true;
            };
            
            const editClinicalUnit = (unit) => {
                editingClinicalUnit.value = unit.id;
                clinicalUnitForm.value = { ...unit };
                showClinicalUnitModal.value = true;
            };
            
            const closeClinicalUnitModal = () => {
                showClinicalUnitModal.value = false;
                editingClinicalUnit.value = null;
            };
            
            const saveClinicalUnit = async () => {
                saving.value = true;
                
                try {
                    if (editingClinicalUnit.value) {
                        // Update existing unit
                        const { error } = await supabaseClient.value
                            .from('training_units')
                            .update(clinicalUnitForm.value)
                            .eq('id', editingClinicalUnit.value);
                        
                        if (error) throw error;
                        showToast('Clinical unit updated successfully', 'success');
                    } else {
                        // Add new unit
                        const { error } = await supabaseClient.value
                            .from('training_units')
                            .insert([clinicalUnitForm.value]);
                        
                        if (error) throw error;
                        showToast('Clinical unit added successfully', 'success');
                    }
                    
                    await loadClinicalUnits();
                    closeClinicalUnitModal();
                    
                } catch (error) {
                    console.error('Error saving clinical unit:', error);
                    showToast('Error saving clinical unit: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            const toggleClinicalUnitStatus = async (unit) => {
                try {
                    const newStatus = unit.unit_status === 'active' ? 'inactive' : 'active';
                    const { error } = await supabaseClient.value
                        .from('training_units')
                        .update({ unit_status: newStatus })
                        .eq('id', unit.id);
                    
                    if (error) throw error;
                    
                    unit.unit_status = newStatus;
                    showToast(`Unit ${newStatus}`, 'success');
                    
                } catch (error) {
                    console.error('Error toggling clinical unit status:', error);
                    showToast('Error updating unit status', 'error');
                }
            };
            
            // ============ PLACEMENT MANAGEMENT ============
            const showNewPlacementModal = () => {
                editingPlacement.value = null;
                const today = new Date();
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(today.getMonth() + 3);
                
                placementForm.value = {
                    resident_id: '',
                    training_unit_id: '',
                    supervising_attending_id: '',
                    rotation_start_date: today.toISOString().split('T')[0],
                    rotation_end_date: threeMonthsLater.toISOString().split('T')[0],
                    rotation_category: 'clinical_rotation',
                    rotation_status: 'scheduled',
                    clinical_notes: ''
                };
                showPlacementModal.value = true;
            };
            
            const quickPlaceResident = (resident) => {
                const today = new Date();
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(today.getMonth() + 3);
                
                placementForm.value = {
                    resident_id: resident.id,
                    training_unit_id: '',
                    supervising_attending_id: '',
                    rotation_start_date: today.toISOString().split('T')[0],
                    rotation_end_date: threeMonthsLater.toISOString().split('T')[0],
                    rotation_category: 'clinical_rotation',
                    rotation_status: 'scheduled',
                    clinical_notes: ''
                };
                showPlacementModal.value = true;
            };
            
            const editPlacement = (placement) => {
                editingPlacement.value = placement.id;
                placementForm.value = { ...placement };
                showPlacementModal.value = true;
            };
            
            const closePlacementModal = () => {
                showPlacementModal.value = false;
                editingPlacement.value = null;
            };
            
            const updateDefaultSupervisor = () => {
                if (placementForm.value.training_unit_id) {
                    const unit = clinicalUnits.value.find(u => u.id === placementForm.value.training_unit_id);
                    if (unit && unit.default_supervisor_id) {
                        placementForm.value.supervising_attending_id = unit.default_supervisor_id;
                    }
                }
            };
            
            const savePlacement = async () => {
                saving.value = true;
                
                try {
                    // Check unit capacity
                    const unit = clinicalUnits.value.find(u => u.id === placementForm.value.training_unit_id);
                    if (!unit) {
                        throw new Error('Clinical unit not found');
                    }
                    
                    const currentCount = getClinicalUnitResidentsCount(unit.id);
                    if (currentCount >= unit.maximum_residents) {
                        throw new Error('Clinical unit is at full capacity');
                    }
                    
                    const rotationData = {
                        ...placementForm.value,
                        rotation_id: editingPlacement.value ? undefined : generateSystemId('ROT')
                    };
                    
                    if (editingPlacement.value) {
                        // Update existing rotation
                        const { error } = await supabaseClient.value
                            .from('resident_rotations')
                            .update(rotationData)
                            .eq('id', editingPlacement.value);
                        
                        if (error) throw error;
                        showToast('Rotation updated successfully', 'success');
                    } else {
                        // Create new rotation
                        const { error } = await supabaseClient.value
                            .from('resident_rotations')
                            .insert([rotationData]);
                        
                        if (error) throw error;
                        showToast('Resident placed successfully', 'success');
                    }
                    
                    // Reload data
                    await loadResidentRotations();
                    await loadMedicalStaff(); // To update current_rotation
                    
                    closePlacementModal();
                    
                } catch (error) {
                    console.error('Error saving placement:', error);
                    showToast('Error saving placement: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            const extendPlacement = async (placement) => {
                const newEndDate = prompt('Enter new end date (YYYY-MM-DD):', placement.rotation_end_date);
                if (newEndDate) {
                    try {
                        const { error } = await supabaseClient.value
                            .from('resident_rotations')
                            .update({ 
                                rotation_end_date: newEndDate,
                                rotation_status: 'extended'
                            })
                            .eq('id', placement.id);
                        
                        if (error) throw error;
                        
                        placement.rotation_end_date = newEndDate;
                        showToast('Placement extended successfully', 'success');
                        
                    } catch (error) {
                        console.error('Error extending placement:', error);
                        showToast('Error extending placement', 'error');
                    }
                }
            };
            
            const endPlacement = async (placement) => {
                if (confirm('End this rotation? The resident will be marked as unplaced.')) {
                    try {
                        const { error } = await supabaseClient.value
                            .from('resident_rotations')
                            .update({ 
                                rotation_end_date: new Date().toISOString().split('T')[0],
                                rotation_status: 'terminated_early',
                                clinical_notes: placement.clinical_notes + '\n\nRotation ended early by user request.'
                            })
                            .eq('id', placement.id);
                        
                        if (error) throw error;
                        
                        // Remove from local state
                        residentRotations.value = residentRotations.value.filter(r => r.id !== placement.id);
                        
                        // Update medical staff local state
                        const resident = medicalStaff.value.find(r => r.id === placement.resident_id);
                        if (resident) {
                            resident.current_rotation = null;
                        }
                        
                        showToast('Rotation ended successfully', 'success');
                        
                    } catch (error) {
                        console.error('Error ending placement:', error);
                        showToast('Error ending rotation', 'error');
                    }
                }
            };
            
            // ============ DRAG & DROP FOR PLACEMENTS ============
            let draggedResident = null;
            
            const dragResident = (resident) => {
                draggedResident = resident;
                event.target.classList.add('dragging');
            };
            
            const dragOverUnit = (event, unit) => {
                event.preventDefault();
                event.currentTarget.classList.add('drop-zone');
            };
            
            const dropResidentOnUnit = async (event, unit) => {
                event.preventDefault();
                event.currentTarget.classList.remove('drop-zone');
                
                if (draggedResident) {
                    const today = new Date();
                    const threeMonthsLater = new Date();
                    threeMonthsLater.setMonth(today.getMonth() + 3);
                    
                    // Auto-fill placement form
                    placementForm.value = {
                        resident_id: draggedResident.id,
                        training_unit_id: unit.id,
                        supervising_attending_id: unit.default_supervisor_id || '',
                        rotation_start_date: today.toISOString().split('T')[0],
                        rotation_end_date: threeMonthsLater.toISOString().split('T')[0],
                        rotation_category: 'clinical_rotation',
                        rotation_status: 'scheduled',
                        clinical_notes: 'Placed via drag & drop'
                    };
                    
                    showPlacementModal.value = true;
                }
                
                draggedResident = null;
            };
            
            // ============ STAFF MANAGEMENT ============
            const showAddStaffModal = () => {
                editingStaff.value = null;
                staffForm.value = {
                    full_name: '',
                    professional_email: '',
                    staff_type: 'attending_physician',
                    resident_category: 'department_internal',
                    training_year: 1,
                    primary_clinic: '',
                    can_supervise_residents: true,
                    medical_license: '',
                    work_phone: '',
                    employment_status: 'active',
                    special_notes: ''
                };
                showStaffModal.value = true;
            };
            
            const editStaff = (staffMember) => {
                editingStaff.value = staffMember.id;
                staffForm.value = { ...staffMember };
                showStaffModal.value = true;
            };
            
            const closeStaffModal = () => {
                showStaffModal.value = false;
                editingStaff.value = null;
            };
            
            const updateSupervisorField = () => {
                if (staffForm.value.staff_type !== 'attending_physician') {
                    staffForm.value.can_supervise_residents = false;
                }
            };
            
            const saveStaff = async () => {
                saving.value = true;
                
                try {
                    const staffData = {
                        ...staffForm.value,
                        staff_id: editingStaff.value ? undefined : generateSystemId(
                            staffForm.value.staff_type === 'attending_physician' ? 'ATT' : 
                            staffForm.value.staff_type === 'medical_resident' ? 'RES' : 'STAFF'
                        )
                    };
                    
                    if (editingStaff.value) {
                        // Update existing staff
                        const { error } = await supabaseClient.value
                            .from('medical_staff')
                            .update(staffData)
                            .eq('id', editingStaff.value);
                        
                        if (error) throw error;
                        showToast('Staff updated successfully', 'success');
                    } else {
                        // Add new staff
                        const { error } = await supabaseClient.value
                            .from('medical_staff')
                            .insert([staffData]);
                        
                        if (error) throw error;
                        showToast('Staff added successfully', 'success');
                    }
                    
                    await loadMedicalStaff();
                    closeStaffModal();
                    
                } catch (error) {
                    console.error('Error saving staff:', error);
                    showToast('Error saving staff: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            const toggleStaffStatus = async (staffMember) => {
                try {
                    const newStatus = staffMember.employment_status === 'active' ? 'inactive' : 'active';
                    const { error } = await supabaseClient.value
                        .from('medical_staff')
                        .update({ employment_status: newStatus })
                        .eq('id', staffMember.id);
                    
                    if (error) throw error;
                    
                    staffMember.employment_status = newStatus;
                    showToast(`Staff ${newStatus}`, 'success');
                    
                } catch (error) {
                    console.error('Error toggling staff status:', error);
                    showToast('Error updating staff status', 'error');
                }
            };
            
            const viewStaffSchedule = (staffMember) => {
                showToast(`Schedule for ${staffMember.full_name} would open here`, 'info');
            };
            
            const viewResidentSchedule = (resident) => {
                showToast(`Schedule for ${resident.full_name} would open here`, 'info');
            };
            
            // ============ SCHEDULE MANAGEMENT ============
            const previousWeek = () => {
                const newStart = new Date(currentWeekStart.value);
                newStart.setDate(newStart.getDate() - 7);
                currentWeekStart.value = newStart;
                
                const newEnd = new Date(newStart);
                newEnd.setDate(newStart.getDate() + 6);
                currentWeekEnd.value = newEnd;
                
                loadDailyAssignmentsForWeek();
            };
            
            const nextWeek = () => {
                const newStart = new Date(currentWeekStart.value);
                newStart.setDate(newStart.getDate() + 7);
                currentWeekStart.value = newStart;
                
                const newEnd = new Date(newStart);
                newEnd.setDate(newStart.getDate() + 6);
                currentWeekEnd.value = newEnd;
                
                loadDailyAssignmentsForWeek();
            };
            
            const loadDailyAssignmentsForWeek = async () => {
                try {
                    const startDate = currentWeekStart.value.toISOString().split('T')[0];
                    const endDate = currentWeekEnd.value.toISOString().split('T')[0];
                    
                    const { data, error } = await supabaseClient.value
                        .from('daily_assignments')
                        .select('*')
                        .gte('assignment_date', startDate)
                        .lte('assignment_date', endDate)
                        .order('assignment_date')
                        .order('start_time');
                    
                    if (error) throw error;
                    
                    dailyAssignments.value = data;
                    
                } catch (error) {
                    console.error('Error loading weekly assignments:', error);
                    showToast('Error loading schedule data', 'error');
                }
            };
            
            const showNewAssignmentModal = () => {
                const today = new Date();
                assignmentForm.value = {
                    assignment_date: today.toISOString().split('T')[0],
                    assignment_type: 'outpatient_clinic',
                    start_time: '08:00',
                    end_time: '17:00',
                    location_name: '',
                    staff_member_id: '',
                    supervising_attending_id: '',
                    assignment_notes: ''
                };
                showAssignmentModal.value = true;
            };
            
            const closeAssignmentModal = () => {
                showAssignmentModal.value = false;
            };
            
            const updateAssignmentSupervisor = () => {
                if (isResidentSelected.value && assignmentForm.value.staff_member_id) {
                    const resident = residents.value.find(r => r.id === assignmentForm.value.staff_member_id);
                    if (resident && resident.current_rotation) {
                        assignmentForm.value.supervising_attending_id = resident.current_rotation.supervising_attending_id;
                    }
                }
            };
            
            const saveAssignment = async () => {
                saving.value = true;
                
                try {
                    const assignmentData = {
                        ...assignmentForm.value,
                        assignment_id: generateSystemId('ASSIGN')
                    };
                    
                    const { error } = await supabaseClient.value
                        .from('daily_assignments')
                        .insert([assignmentData]);
                    
                    if (error) throw error;
                    
                    showToast('Assignment created successfully', 'success');
                    await loadDailyAssignments();
                    closeAssignmentModal();
                    
                } catch (error) {
                    console.error('Error creating assignment:', error);
                    showToast('Error creating assignment: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            // ============ LEAVE MANAGEMENT ============
            const showNewLeaveModal = () => {
                const today = new Date();
                leaveRequestForm.value = {
                    leave_category: 'vacation_leave',
                    staff_member_id: '',
                    leave_start_date: today.toISOString().split('T')[0],
                    leave_end_date: today.toISOString().split('T')[0],
                    leave_reason: '',
                    coverage_required: true,
                    coverage_notes: '',
                    approval_status: 'pending_review'
                };
                showLeaveModal.value = true;
            };
            
            const closeLeaveModal = () => {
                showLeaveModal.value = false;
            };
            
            const saveLeaveRequest = async () => {
                saving.value = true;
                
                try {
                    // Calculate total days
                    const startDate = new Date(leaveRequestForm.value.leave_start_date);
                    const endDate = new Date(leaveRequestForm.value.leave_end_date);
                    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    const leaveData = {
                        ...leaveRequestForm.value,
                        request_id: generateSystemId('LEAVE'),
                        total_days: totalDays,
                        submitted_by: currentUser.value.id
                    };
                    
                    const { error } = await supabaseClient.value
                        .from('leave_requests')
                        .insert([leaveData]);
                    
                    if (error) throw error;
                    
                    showToast('Leave request submitted successfully', 'success');
                    await loadLeaveRequests();
                    closeLeaveModal();
                    
                } catch (error) {
                    console.error('Error submitting leave request:', error);
                    showToast('Error submitting leave request: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            const approveLeaveRequest = async (request) => {
                try {
                    const { error } = await supabaseClient.value
                        .from('leave_requests')
                        .update({ 
                            approval_status: 'approved',
                            reviewed_by: currentUser.value.id,
                            reviewed_at: new Date().toISOString()
                        })
                        .eq('id', request.id);
                    
                    if (error) throw error;
                    
                    request.approval_status = 'approved';
                    showToast('Leave request approved', 'success');
                    
                } catch (error) {
                    console.error('Error approving leave request:', error);
                    showToast('Error approving leave request', 'error');
                }
            };
            
            const rejectLeaveRequest = async (request) => {
                try {
                    const { error } = await supabaseClient.value
                        .from('leave_requests')
                        .update({ 
                            approval_status: 'rejected',
                            reviewed_by: currentUser.value.id,
                            reviewed_at: new Date().toISOString()
                        })
                        .eq('id', request.id);
                    
                    if (error) throw error;
                    
                    request.approval_status = 'rejected';
                    showToast('Leave request rejected', 'success');
                    
                } catch (error) {
                    console.error('Error rejecting leave request:', error);
                    showToast('Error rejecting leave request', 'error');
                }
            };
            
            const assignCoverage = (request) => {
                showToast(`Coverage assignment for ${request.person_name} would open here`, 'info');
            };
            
            const viewCoverageOptions = (request) => {
                showToast(`Coverage options for ${request.person_name} would open here`, 'info');
            };
            
            const editLeaveRequest = (request) => {
                showToast(`Editing leave request for ${request.person_name}`, 'info');
            };
            
            // ============ ON-CALL MANAGEMENT ============
            const showNewOnCallModal = () => {
                const today = new Date();
                onCallForm.value = {
                    duty_date: today.toISOString().split('T')[0],
                    shift_type: 'primary_call',
                    start_time: '17:00',
                    end_time: '08:00',
                    primary_physician_id: '',
                    backup_physician_id: '',
                    coverage_notes: ''
                };
                showOnCallModal.value = true;
            };
            
            const closeOnCallModal = () => {
                showOnCallModal.value = false;
            };
            
            const saveOnCallAssignment = async () => {
                saving.value = true;
                
                try {
                    const onCallData = {
                        ...onCallForm.value,
                        schedule_id: generateSystemId('ONCALL')
                    };
                    
                    const { error } = await supabaseClient.value
                        .from('oncall_schedule')
                        .insert([onCallData]);
                    
                    if (error) throw error;
                    
                    showToast('On-call assignment created successfully', 'success');
                    await loadOnCallSchedules();
                    closeOnCallModal();
                    
                } catch (error) {
                    console.error('Error creating on-call assignment:', error);
                    showToast('Error creating on-call assignment: ' + error.message, 'error');
                } finally {
                    saving.value = false;
                }
            };
            
            // ============ REPORTS ============
            const generateMonthlyReport = () => {
                showToast('Monthly report generation started', 'info');
                // Would generate and add to reports list
            };
            
            const showResidentReport = () => {
                showToast('Resident report would open here', 'info');
            };
            
            const showUnitReport = () => {
                showToast('Unit utilization report would open here', 'info');
            };
            
            const showDutyHourReport = () => {
                showToast('Duty hour compliance report would open here', 'info');
            };
            
            const showCoverageReport = () => {
                showToast('Coverage analysis report would open here', 'info');
            };
            
            const viewReport = (report) => {
                showToast(`Viewing report: ${report.name}`, 'info');
            };
            
            const downloadReport = (report) => {
                showToast(`Downloading report: ${report.name}`, 'info');
            };
            
            const exportDepartmentReport = () => {
                showToast('Department report exported', 'success');
            };
            
            // ============ SCHEDULE APPROVAL ============
            const loadPendingSchedules = () => {
                showToast('Refreshing pending schedules', 'info');
            };
            
            const approveAllSchedules = () => {
                showToast('All schedules approved', 'success');
            };
            
            const viewScheduleDetails = (schedule) => {
                showToast(`Reviewing schedule: ${schedule.period_name}`, 'info');
            };
            
            const approveSchedule = (schedule) => {
                showToast(`Schedule approved: ${schedule.period_name}`, 'success');
            };
            
            const rejectSchedule = (schedule) => {
                showToast(`Schedule rejected: ${schedule.period_name}`, 'success');
            };
            
            // ============ CALENDAR NAVIGATION ============
            const previousMonth = () => {
                if (currentMonth.value === 0) {
                    currentMonth.value = 11;
                    currentYear.value -= 1;
                } else {
                    currentMonth.value -= 1;
                }
            };
            
            const nextMonth = () => {
                if (currentMonth.value === 11) {
                    currentMonth.value = 0;
                    currentYear.value += 1;
                } else {
                    currentMonth.value += 1;
                }
            };
            
            // ============ INITIALIZATION ============
            onMounted(() => {
                // Initialize Supabase
                initializeSupabase();
                
                // Set default dates
                const today = new Date();
                assignmentForm.value.assignment_date = today.toISOString().split('T')[0];
                leaveRequestForm.value.leave_start_date = today.toISOString().split('T')[0];
                leaveRequestForm.value.leave_end_date = today.toISOString().split('T')[0];
                onCallForm.value.duty_date = today.toISOString().split('T')[0];
                
                // Update week range
                updateWeekRange();
                
                // Check for existing session
                const checkSession = async () => {
                    const { data } = await supabaseClient.value?.auth.getSession();
                    if (data?.session) {
                        // User is already logged in
                        const { data: userData } = await supabaseClient.value
                            .from('app_users')
                            .select('*')
                            .eq('user_id', data.session.user.id)
                            .single();
                        
                        if (userData) {
                            currentUser.value = {
                                ...data.session.user,
                                ...userData
                            };
                            loadInitialData();
                        }
                    }
                };
                
                if (supabaseClient.value) {
                    checkSession();
                }
            });
            
            // ============ RETURN ============
            return {
                // State
                currentUser,
                loginForm,
                loading,
                saving,
                currentView,
                sidebarCollapsed,
                mobileMenuOpen,
                searchQuery,
                
                // Data
                medicalStaff,
                clinicalUnits,
                residentRotations,
                dailyAssignments,
                onCallSchedules,
                leaveRequests,
                
                // Computed Properties
                residents,
                attendings,
                supervisors,
                departmentMetrics,
                leaveMetrics,
                reportMetrics,
                filteredResidents,
                filteredStaff,
                unplacedResidents,
                availableClinicalUnits,
                activePlacements,
                availableResidents,
                availableAttendings,
                otherStaff,
                seniorResidents,
                allResidents,
                allAttendings,
                allOtherStaff,
                weekDays,
                onCallDays,
                calendarDays,
                currentMonthName,
                pendingLeaveRequests,
                activeLeave,
                pendingSchedules,
                recentReports,
                isResidentSelected,
                isResidentOnLeave,
                
                // Modals
                showResidentModal,
                showClinicalUnitModal,
                showPlacementModal,
                showStaffModal,
                showAssignmentModal,
                showLeaveModal,
                showOnCallModal,
                
                // Forms
                residentForm,
                clinicalUnitForm,
                placementForm,
                staffForm,
                assignmentForm,
                leaveRequestForm,
                onCallForm,
                
                // Editing State
                editingResident,
                editingClinicalUnit,
                editingPlacement,
                editingStaff,
                
                // Filters
                residentFilter,
                residentSearch,
                staffFilter,
                staffSearch,
                
                // UI
                toast,
                
                // Navigation
                switchView,
                getCurrentTitle,
                getCurrentSubtitle,
                getSearchPlaceholder,
                toggleMobileMenu,
                closeMobileMenu,
                toggleUserMenu,
                
                // Authentication
                handleLogin,
                
                // Utility Functions
                getInitials,
                formatDate,
                formatDateShort,
                formatDateTime,
                formatTime,
                formatTimeRange,
                formatDateRange,
                formatDayHeader,
                isToday,
                formatRole,
                formatResidentCategory,
                formatStaffType,
                formatLeaveType,
                formatAssignmentType,
                
                // Resident Management
                showAddResidentModal,
                editResident,
                closeResidentModal,
                saveResident,
                filterResidents,
                viewResidentSchedule,
                
                // Clinical Unit Management
                showAddClinicalUnitModal,
                editClinicalUnit,
                closeClinicalUnitModal,
                saveClinicalUnit,
                toggleClinicalUnitStatus,
                getClinicalUnitResidentsCount,
                getClinicalUnitResidents,
                getClinicalUnitName,
                
                // Placement Management
                showNewPlacementModal,
                quickPlaceResident,
                editPlacement,
                closePlacementModal,
                updateDefaultSupervisor,
                savePlacement,
                extendPlacement,
                endPlacement,
                getResidentName,
                getSupervisorName,
                getSupervisorResidentsCount,
                getDaysRemaining,
                getDaysRemainingClass,
                
                // Drag & Drop
                dragResident,
                dragOverUnit,
                dropResidentOnUnit,
                
                // Staff Management
                showAddStaffModal,
                editStaff,
                closeStaffModal,
                updateSupervisorField,
                saveStaff,
                toggleStaffStatus,
                viewStaffSchedule,
                
                // Schedule Management
                previousWeek,
                nextWeek,
                showNewAssignmentModal,
                closeAssignmentModal,
                updateAssignmentSupervisor,
                saveAssignment,
                getAssignmentsForDay,
                
                // Leave Management
                showNewLeaveModal,
                closeLeaveModal,
                saveLeaveRequest,
                approveLeaveRequest,
                rejectLeaveRequest,
                assignCoverage,
                viewCoverageOptions,
                editLeaveRequest,
                
                // On-call Management
                showNewOnCallModal,
                closeOnCallModal,
                saveOnCallAssignment,
                
                // Reports
                generateMonthlyReport,
                showResidentReport,
                showUnitReport,
                showDutyHourReport,
                showCoverageReport,
                viewReport,
                downloadReport,
                exportDepartmentReport,
                
                // Schedule Approval
                loadPendingSchedules,
                approveAllSchedules,
                viewScheduleDetails,
                approveSchedule,
                rejectSchedule,
                
                // Calendar Navigation
                previousMonth,
                nextMonth,
                getRotationsForDate,
                getRotationEventsForDate
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
