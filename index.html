<!DOCTYPE html>
<html>
<head>
    <!-- Vue 3 PRODUCTION build -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* MINIMAL CSS to make it work */
        body { font-family: Arial; margin: 0; }
        .login { padding: 20px; }
        .app { display: flex; }
        .sidebar { width: 200px; background: #333; color: white; }
        .content { flex: 1; padding: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!user">
            <div class="login">
                <h2>Login</h2>
                <input v-model="email" placeholder="Email">
                <input type="password" v-model="password" placeholder="Password">
                <button @click="login">Login</button>
            </div>
        </div>
        
        <div v-else class="app">
            <div class="sidebar">
                <h3>Navigation</h3>
                <button @click="view = 'dashboard'">Dashboard</button>
                <button @click="view = 'staff'">Medical Staff</button>
                <button @click="view = 'units'">Training Units</button>
                <button @click="view = 'users'" v-if="user.role === 'system_admin'">
                    User Management
                </button>
            </div>
            
            <div class="content">
                <!-- DASHBOARD VIEW -->
                <div v-if="view === 'dashboard'">
                    <h1>Dashboard</h1>
                    <p>Welcome {{ user.name }} ({{ user.role }})</p>
                </div>
                
                <!-- MEDICAL STAFF VIEW -->
                <div v-if="view === 'staff' && canView('staff')">
                    <h1>Medical Staff</h1>
                    <table>
                        <tr v-for="person in staff" :key="person.id">
                            <td>{{ person.name }}</td>
                            <td>{{ person.role }}</td>
                        </tr>
                    </table>
                </div>
                
                <!-- TRAINING UNITS VIEW -->
                <div v-if="view === 'units' && canView('units')">
                    <h1>Training Units</h1>
                    <div v-for="unit in units" :key="unit.id">
                        {{ unit.name }} - {{ unit.capacity }}
                    </div>
                </div>
                
                <!-- USER MANAGEMENT (Admin only) -->
                <div v-if="view === 'users' && user.role === 'system_admin'">
                    <h1>User Management</h1>
                    <div v-for="u in users" :key="u.id">
                        {{ u.email }} - {{ u.role }}
                        <select @change="changeRole(u.id, $event.target.value)">
                            <option value="viewing_doctor">Viewing Doctor</option>
                            <option value="resident_manager">Resident Manager</option>
                            <option value="department_head">HOD</option>
                            <option value="system_admin">System Admin</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// WAIT for Vue to load
if (typeof Vue !== 'undefined') {
    const { createApp, ref, computed } = Vue;
    
    // Initialize Supabase INSIDE Vue
    const supabaseUrl = 'https://vssmguzuvekkecbmwcjw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzc21ndXp1dmVra2VjYm13Y2p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTI4NTIsImV4cCI6MjA4NDE2ODg1Mn0.8qPFsMEn4n5hDfxhgXvq2lQarts8OlL8hWiRYXb-vXw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    createApp({
        setup() {
            // State
            const user = ref(null);
            const view = ref('dashboard');
            const email = ref('');
            const password = ref('');
            
            // Data
            const staff = ref([]);
            const units = ref([]);
            const users = ref([]);
            
            // Permission matrix
            const permissions = {
                system_admin: { staff: true, units: true, users: true },
                department_head: { staff: true, units: true, users: false },
                resident_manager: { staff: true, units: true, users: false },
                viewing_doctor: { staff: false, units: true, users: false }
            };
            
            // Check permission
            const canView = (resource) => {
                if (!user.value) return false;
                return permissions[user.value.role]?.[resource] || false;
            };
            
            // Login
            const login = async () => {
                try {
                    // Demo login for testing
                    if (email.value === 'admin@hospital.org' && password.value === 'demo123') {
                        user.value = {
                            id: '1',
                            name: 'System Admin',
                            email: 'admin@hospital.org',
                            role: 'system_admin'
                        };
                        loadData();
                        return;
                    }
                    
                    // Real Supabase login
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email.value,
                        password: password.value
                    });
                    
                    if (error) throw error;
                    
                    // Get user from app_users
                    const { data: userData } = await supabase
                        .from('app_users')
                        .select('*')
                        .eq('email', data.user.email)
                        .single();
                    
                    if (userData) {
                        user.value = {
                            id: userData.id,
                            name: userData.full_name,
                            email: userData.email,
                            role: userData.user_role
                        };
                        loadData();
                    }
                    
                } catch (error) {
                    alert('Login failed: ' + error.message);
                }
            };
            
            // Load data
            const loadData = async () => {
                // Load medical staff
                const { data: staffData } = await supabase
                    .from('medical_staff')
                    .select('*');
                staff.value = staffData || [];
                
                // Load training units
                const { data: unitsData } = await supabase
                    .from('training_units')
                    .select('*');
                units.value = unitsData || [];
                
                // Load users (admin only)
                if (user.value.role === 'system_admin') {
                    const { data: usersData } = await supabase
                        .from('app_users')
                        .select('*');
                    users.value = usersData || [];
                }
            };
            
            // Change user role
            const changeRole = async (userId, newRole) => {
                if (user.value.role !== 'system_admin') return;
                
                await supabase
                    .from('app_users')
                    .update({ user_role: newRole })
                    .eq('id', userId);
                
                loadData(); // Refresh
            };
            
            // Return everything
            return {
                user, view, email, password,
                staff, units, users,
                canView, login, changeRole
            };
        }
    }).mount('#app');
    
} else {
    document.body.innerHTML = '<h2 style="color: red;">Error: Vue.js failed to load. Check internet connection.</h2>';
}
</script>
</body>
</html>
