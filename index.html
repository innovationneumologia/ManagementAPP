<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PneumoCare | Advanced Pulmonary Management</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
       /* ============ LUXURY MEDICAL DESIGN SYSTEM ============ */

/* Enhanced Color System with Medical Elegance */
:root {
    /* Primary Medical Palette - More Sophisticated */
    --medical-deep-blue: #003366;
    --medical-blue: #005b8e;
    --medical-teal: #008c8c;
    --medical-green: #10b981;
    --medical-amber: #f59e0b;
    --medical-red: #ef4444;
    --medical-purple: #8b5cf6;
    --medical-cyan: #06b6d4;
    --medical-emerald: #10b981;
    --medical-rose: #f43f5e;
    --medical-indigo: #4f46e5;
    
    /* Gradient Presets */
    --gradient-medical: linear-gradient(135deg, 
        rgba(0, 91, 142, 0.95), 
        rgba(6, 182, 212, 0.9));
    --gradient-success: linear-gradient(135deg, 
        rgba(16, 185, 129, 0.95), 
        rgba(6, 182, 212, 0.9));
    --gradient-warning: linear-gradient(135deg, 
        rgba(245, 158, 11, 0.95), 
        rgba(239, 68, 68, 0.9));
    --gradient-purple: linear-gradient(135deg, 
        rgba(139, 92, 246, 0.95), 
        rgba(79, 70, 229, 0.9));
    
    /* Glassmorphism Effects */
    --glass-bg: rgba(255, 255, 255, 0.92);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px rgba(0, 91, 142, 0.1);
    --glass-blur: blur(20px);
    
    /* Enhanced Shadows with Depth */
    --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.04);
    --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);
    --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
    --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.2);
    --shadow-glow: 0 0 32px rgba(0, 91, 142, 0.15);
    
    /* Enhanced Transitions */
    --transition-bouncy: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    --transition-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    
    /* Border Radius - More Rounded */
    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 20px;
    --radius-xl: 28px;
    --radius-2xl: 36px;
    --radius-full: 9999px;
    
    /* Spacing System */
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    --space-3xl: 4rem;
}

/* ============ LUXURY BASE STYLES ============ */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, 
        #f8fafc 0%, 
        #f1f5f9 50%, 
        #e2e8f0 100%);
    background-attachment: fixed;
    color: var(--gray-800);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    letter-spacing: -0.01em;
}

/* ============ LUXURY LOGIN SYSTEM ============ */
.login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg,
        var(--medical-deep-blue) 0%,
        #004080 25%,
        var(--medical-blue) 50%,
        var(--medical-teal) 75%,
        var(--medical-cyan) 100%);
    position: relative;
    overflow: hidden;
    padding: var(--space-lg);
}

.login-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 10% 20%, 
            rgba(255, 255, 255, 0.15) 0%, 
            transparent 40%),
        radial-gradient(circle at 90% 80%, 
            rgba(255, 255, 255, 0.1) 0%, 
            transparent 40%),
        radial-gradient(circle at 50% 50%, 
            rgba(255, 255, 255, 0.05) 0%, 
            transparent 60%);
    animation: gradientShift 20s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.login-card {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-2xl);
    padding: var(--space-3xl);
    width: 100%;
    max-width: 480px;
    box-shadow: 
        var(--shadow-2xl),
        var(--shadow-glow);
    border: 1px solid var(--glass-border);
    position: relative;
    z-index: 10;
    animation: cardFloat 6s ease-in-out infinite;
    overflow: hidden;
}

.login-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue),
        var(--medical-teal));
    border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
}

@keyframes cardFloat {
    0%, 100% { transform: translateY(0) rotate(0.5deg); }
    50% { transform: translateY(-10px) rotate(-0.5deg); }
}

.login-logo {
    width: 120px;
    height: 120px;
    background: var(--gradient-medical);
    border-radius: var(--radius-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
    margin: 0 auto var(--space-xl);
    box-shadow: 
        var(--shadow-xl),
        0 0 40px rgba(0, 91, 142, 0.3);
    position: relative;
    overflow: hidden;
    animation: logoPulse 3s ease-in-out infinite;
}

.login-logo::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 70%
    );
    animation: logoShine 3s ease-in-out infinite;
}

@keyframes logoPulse {
    0%, 100% { 
        transform: scale(1) rotate(0deg); 
        box-shadow: 
            var(--shadow-xl),
            0 0 40px rgba(0, 91, 142, 0.3);
    }
    50% { 
        transform: scale(1.05) rotate(5deg); 
        box-shadow: 
            var(--shadow-xl),
            0 0 60px rgba(0, 91, 142, 0.5);
    }
}

@keyframes logoShine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.login-title {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(135deg, 
        var(--medical-deep-blue) 0%, 
        var(--medical-blue) 50%,
        var(--medical-cyan) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
    text-align: center;
    letter-spacing: -0.025em;
    position: relative;
}

.login-subtitle {
    font-size: 1.1rem;
    color: var(--gray-600);
    text-align: center;
    font-weight: 500;
    margin-bottom: var(--space-2xl);
    opacity: 0.9;
}

/* ============ LUXURY ROLE SELECTOR ============ */
.role-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-2xl);
}

.role-card {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-xl);
    padding: var(--space-lg);
    cursor: pointer;
    transition: all 0.4s var(--transition-elastic);
    position: relative;
    overflow: hidden;
    text-align: center;
}

.role-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0) 0%,
        rgba(0, 91, 142, 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.role-card:hover {
    transform: translateY(-8px) scale(1.02);
    border-color: var(--medical-blue);
    box-shadow: 
        var(--shadow-xl),
        0 8px 32px rgba(0, 91, 142, 0.15);
}

.role-card:hover::before {
    opacity: 1;
}

.role-card.active {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.1) 0%,
        rgba(6, 182, 212, 0.1) 100%);
    border-color: var(--medical-blue);
    box-shadow: 
        inset 0 2px 4px rgba(0, 91, 142, 0.1),
        var(--shadow-medium);
    transform: translateY(-4px);
}

.role-icon {
    font-size: 2rem;
    margin-bottom: var(--space-md);
    color: var(--medical-blue);
    transition: all 0.3s ease;
}

.role-card:hover .role-icon {
    transform: scale(1.2) rotate(5deg);
    color: var(--medical-cyan);
}

.role-name {
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: var(--space-xs);
    font-size: 1rem;
}

.role-desc {
    font-size: 0.8rem;
    color: var(--gray-600);
    line-height: 1.4;
    margin-bottom: var(--space-sm);
}

/* ============ LUXURY PERMISSION BADGES ============ */
.permission-badge-elegant {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid;
    transition: all 0.3s var(--transition-smooth);
}

.permission-badge-elegant:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.permission-full-elegant {
    background: linear-gradient(135deg,
        rgba(16, 185, 129, 0.15) 0%,
        rgba(16, 185, 129, 0.05) 100%);
    color: var(--medical-green);
    border-color: rgba(16, 185, 129, 0.3);
}

.permission-write-elegant {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.15) 0%,
        rgba(0, 91, 142, 0.05) 100%);
    color: var(--medical-blue);
    border-color: rgba(0, 91, 142, 0.3);
}

.permission-read-elegant {
    background: linear-gradient(135deg,
        rgba(6, 182, 212, 0.15) 0%,
        rgba(6, 182, 212, 0.05) 100%);
    color: var(--medical-cyan);
    border-color: rgba(6, 182, 212, 0.3);
}

/* ============ LUXURY SIDEBAR ============ */
.sidebar {
    width: 300px;
    background: linear-gradient(180deg,
        var(--medical-deep-blue) 0%,
        #003d6e 30%,
        var(--medical-blue) 70%,
        rgba(0, 91, 142, 0.9) 100%);
    height: 100vh;
    position: fixed;
    box-shadow: 
        var(--shadow-xl),
        inset -1px 0 0 rgba(255, 255, 255, 0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: all 0.4s var(--transition-smooth);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%,
            rgba(255, 255, 255, 0.1) 0%,
            transparent 50%),
        radial-gradient(circle at 80% 20%,
            rgba(255, 255, 255, 0.05) 0%,
            transparent 50%);
    pointer-events: none;
}

.sidebar-header {
    padding: var(--space-xl);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    backdrop-filter: blur(10px);
}

.brand-logo-elegant {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.2),
        rgba(255, 255, 255, 0.05));
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.75rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
        var(--shadow-medium),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    margin-bottom: var(--space-md);
    animation: logoFloat 4s ease-in-out infinite;
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-5px) rotate(2deg); }
}

.brand-text h1 {
    font-size: 1.75rem;
    font-weight: 800;
    color: white;
    margin-bottom: 0.25rem;
    letter-spacing: -0.025em;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* ============ LUXURY NAVIGATION ============ */
.nav-section-title {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-sm);
    padding: 0 var(--space-lg);
    margin-top: var(--space-xl);
}

.nav-item-elegant {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    margin: 0 var(--space-lg) var(--space-xs);
    background: transparent;
    border: none;
    border-radius: var(--radius-lg);
    color: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    transition: all 0.3s var(--transition-smooth);
    position: relative;
    overflow: hidden;
    text-align: left;
}

.nav-item-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent);
    transition: left 0.6s ease;
}

.nav-item-elegant:hover::before {
    left: 100%;
}

.nav-item-elegant:hover {
    background: rgba(255, 255, 255, 0.12);
    color: white;
    transform: translateX(8px);
    box-shadow: 
        var(--shadow-medium),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.nav-item-elegant.active {
    background: linear-gradient(90deg,
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0.1) 100%);
    color: white;
    font-weight: 600;
    box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(0, 0, 0, 0.2);
}

.nav-item-elegant.active::after {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 60%;
    background: white;
    border-radius: var(--radius-full);
    animation: navPulse 2s ease-in-out infinite;
}

@keyframes navPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.nav-icon {
    font-size: 1.1rem;
    width: 24px;
    text-align: center;
    transition: transform 0.3s var(--transition-bouncy);
}

.nav-item-elegant:hover .nav-icon {
    transform: scale(1.2) rotate(5deg);
}

/* ============ LUXURY MAIN CONTENT ============ */
.main-content {
    margin-left: 300px;
    min-height: 100vh;
    background: linear-gradient(135deg,
        #f8fafc 0%,
        #f1f5f9 50%,
        #e2e8f0 100%);
    position: relative;
    overflow-x: hidden;
}

.content-header {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    padding: var(--space-xl) var(--space-2xl);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 0;
    z-index: 900;
    box-shadow: 
        var(--shadow-soft),
        0 1px 0 rgba(255, 255, 255, 0.8);
}

.header-title h1 {
    font-size: 2rem;
    font-weight: 800;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
    letter-spacing: -0.025em;
    position: relative;
    display: inline-block;
}

.header-title h1::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg,
        var(--medical-blue),
        var(--medical-cyan));
    border-radius: var(--radius-full);
    animation: titleUnderline 3s ease-in-out infinite;
}

@keyframes titleUnderline {
    0%, 100% { width: 60px; }
    50% { width: 100px; }
}

.header-title .subtitle {
    color: var(--gray-600);
    font-size: 0.95rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

/* ============ LUXURY CARD SYSTEM ============ */
.card-elegant {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 
        var(--shadow-large),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    overflow: hidden;
    transition: all 0.4s var(--transition-smooth);
    position: relative;
}

.card-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue),
        var(--medical-teal));
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    animation: cardGradient 6s ease infinite;
}

@keyframes cardGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.card-elegant:hover {
    transform: translateY(-8px);
    box-shadow: 
        var(--shadow-2xl),
        0 16px 48px rgba(0, 91, 142, 0.15);
}

.card-header-elegant {
    padding: var(--space-xl) var(--space-2xl);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg,
        rgba(248, 250, 252, 0.9) 0%,
        rgba(241, 245, 249, 0.8) 100%);
}

.card-title-elegant {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    letter-spacing: -0.015em;
}

.card-icon-elegant {
    width: 48px;
    height: 48px;
    background: var(--gradient-medical);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    box-shadow: 
        var(--shadow-medium),
        0 0 20px rgba(0, 91, 142, 0.2);
    animation: iconFloat 3s ease-in-out infinite;
}

@keyframes iconFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* ============ LUXURY METRIC CARDS ============ */
.metric-grid-elegant {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
}

.metric-card-elegant {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: var(--shadow-large);
    transition: all 0.4s var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.metric-card-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue));
}

.metric-card-elegant:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        var(--shadow-2xl),
        0 16px 48px rgba(0, 91, 142, 0.15);
}

.metric-value {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(135deg,
        var(--medical-blue) 0%,
        var(--medical-cyan) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0, 91, 142, 0.1);
}

.metric-label {
    font-size: 0.95rem;
    color: var(--gray-600);
    font-weight: 600;
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.metric-trend-elegant {
    height: 6px;
    background: rgba(0, 0, 0, 0.08);
    border-radius: var(--radius-full);
    overflow: hidden;
    position: relative;
}

.metric-trend-fill {
    height: 100%;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue));
    border-radius: var(--radius-full);
    transition: width 1s var(--transition-elastic);
    position: relative;
    overflow: hidden;
}

.metric-trend-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent);
    animation: trendShine 2s ease-in-out infinite;
}

@keyframes trendShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* ============ LUXURY FORM SYSTEM ============ */
.form-container-elegant {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.98) 0%,
        rgba(248, 250, 252, 0.95) 100%);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 
        var(--shadow-large),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    position: relative;
    overflow: hidden;
}

.form-container-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue),
        var(--medical-teal));
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.form-group-elegant {
    margin-bottom: var(--space-xl);
    position: relative;
}

.form-label-elegant {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-sm);
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--gray-800);
    letter-spacing: -0.01em;
}

.form-label-text {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.form-label-icon {
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg,
        var(--medical-blue),
        var(--medical-cyan));
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
    box-shadow: var(--shadow-soft);
}

.form-input-elegant {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 0.95rem;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(0, 0, 0, 0.08);
    border-radius: var(--radius-lg);
    color: var(--gray-900);
    transition: all 0.3s var(--transition-smooth);
    box-shadow: 
        var(--shadow-soft),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.form-input-elegant:hover {
    border-color: var(--medical-cyan);
    background: white;
    box-shadow: 
        0 8px 24px rgba(6, 182, 212, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

.form-input-elegant:focus {
    outline: none;
    border-color: var(--medical-blue);
    background: white;
    box-shadow: 
        0 0 0 4px rgba(0, 91, 142, 0.1),
        0 12px 32px rgba(0, 91, 142, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

/* Form input with icons */
.form-input-with-icon {
    position: relative;
}

.form-input-icon {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    transition: all 0.3s var(--transition-smooth);
}

.form-input-with-icon input {
    padding-left: 3.25rem;
}

.form-input-with-icon input:focus + .form-input-icon {
    color: var(--medical-blue);
    transform: translateY(-50%) scale(1.1);
}

/* Elegant Select */
.form-select-elegant {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 0.95rem;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(0, 0, 0, 0.08);
    border-radius: var(--radius-lg);
    color: var(--gray-900);
    cursor: pointer;
    transition: all 0.3s var(--transition-smooth);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 16px;
    box-shadow: 
        var(--shadow-soft),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.form-select-elegant:hover {
    border-color: var(--medical-cyan);
    background: white;
    box-shadow: 
        0 8px 24px rgba(6, 182, 212, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

.form-select-elegant:focus {
    outline: none;
    border-color: var(--medical-blue);
    background: white;
    box-shadow: 
        0 0 0 4px rgba(0, 91, 142, 0.1),
        0 12px 32px rgba(0, 91, 142, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

/* ============ LUXURY BUTTON SYSTEM ============ */
.btn-elegant {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: 0.875rem 1.75rem;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: var(--radius-lg);
    border: none;
    cursor: pointer;
    transition: all 0.3s var(--transition-smooth);
    position: relative;
    overflow: hidden;
    letter-spacing: 0.01em;
}

.btn-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent);
    transition: left 0.6s ease;
}

.btn-elegant:hover::before {
    left: 100%;
}

.btn-elegant:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.12),
        0 4px 8px rgba(0, 0, 0, 0.08);
}

.btn-elegant:active {
    transform: translateY(0);
}

/* Primary Button */
.btn-primary-elegant {
    background: var(--gradient-medical);
    color: white;
    box-shadow: 
        var(--shadow-medium),
        0 4px 12px rgba(0, 91, 142, 0.2);
}

.btn-primary-elegant:hover {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.95) 0%,
        rgba(6, 182, 212, 0.9) 100%);
    box-shadow: 
        0 12px 32px rgba(0, 91, 142, 0.25),
        0 4px 12px rgba(0, 91, 142, 0.15);
}

/* Secondary Button */
.btn-secondary-elegant {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(0, 91, 142, 0.2);
    color: var(--medical-blue);
    box-shadow: var(--shadow-soft);
}

.btn-secondary-elegant:hover {
    background: white;
    border-color: var(--medical-blue);
    color: var(--medical-blue);
    box-shadow: 
        0 8px 24px rgba(0, 91, 142, 0.12),
        0 4px 8px rgba(0, 91, 142, 0.08);
}

/* Success Button */
.btn-success-elegant {
    background: var(--gradient-success);
    color: white;
    box-shadow: 
        var(--shadow-medium),
        0 4px 12px rgba(16, 185, 129, 0.2);
}

/* Danger Button */
.btn-danger-elegant {
    background: var(--gradient-warning);
    color: white;
    box-shadow: 
        var(--shadow-medium),
        0 4px 12px rgba(239, 68, 68, 0.2);
}

/* Outline Button */
.btn-outline-elegant {
    background: transparent;
    border: 2px solid var(--medical-blue);
    color: var(--medical-blue);
    transition: all 0.3s var(--transition-smooth);
}

.btn-outline-elegant:hover {
    background: var(--medical-blue);
    color: white;
    transform: translateY(-2px);
    box-shadow: 
        0 8px 24px rgba(0, 91, 142, 0.15),
        0 4px 8px rgba(0, 91, 142, 0.1);
}

/* Ghost Button */
.btn-ghost-elegant {
    background: transparent;
    border: 2px solid transparent;
    color: var(--gray-700);
    transition: all 0.3s var(--transition-smooth);
}

.btn-ghost-elegant:hover {
    background: rgba(0, 0, 0, 0.04);
    color: var(--gray-900);
    transform: translateY(-2px);
}

/* Icon Button */
.btn-icon-elegant {
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: var(--radius-md);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.04);
    color: var(--gray-700);
    transition: all 0.3s var(--transition-smooth);
}

.btn-icon-elegant:hover {
    background: var(--medical-blue);
    color: white;
    transform: translateY(-2px) rotate(5deg);
    box-shadow: 
        var(--shadow-medium),
        0 4px 12px rgba(0, 91, 142, 0.2);
}

/* ============ LUXURY MODAL SYSTEM ============ */
.modal-overlay-elegant {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: var(--space-lg);
    animation: fadeIn 0.3s var(--transition-smooth);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-elegant {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-2xl);
    padding: var(--space-3xl);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 
        var(--shadow-2xl),
        0 32px 64px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: modalSlideUp 0.4s var(--transition-elastic);
    position: relative;
}

@keyframes modalSlideUp {
    from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue),
        var(--medical-teal));
    border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
    animation: modalGradient 6s ease infinite;
}

@keyframes modalGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.modal-header-elegant {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}

.modal-title-elegant {
    font-size: 2rem;
    font-weight: 800;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    letter-spacing: -0.025em;
}

.modal-title-icon {
    width: 56px;
    height: 56px;
    background: var(--gradient-medical);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 
        var(--shadow-large),
        0 0 24px rgba(0, 91, 142, 0.3);
    animation: modalIconFloat 4s ease-in-out infinite;
}

@keyframes modalIconFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-8px) rotate(5deg); }
}

.modal-close-elegant {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    border: none;
    background: rgba(0, 0, 0, 0.04);
    color: var(--gray-700);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    transition: all 0.3s var(--transition-smooth);
}

.modal-close-elegant:hover {
    background: var(--medical-red);
    color: white;
    transform: rotate(90deg) scale(1.1);
    box-shadow: var(--shadow-medium);
}

/* ============ LUXURY TABLE SYSTEM ============ */
.table-elegant {
    width: 100%;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-large);
    border: 1px solid rgba(255, 255, 255, 0.6);
}

.table-header-elegant {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.1) 0%,
        rgba(6, 182, 212, 0.1) 100%);
    padding: var(--space-lg) var(--space-xl);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}

.table-header-elegant th {
    padding: var(--space-md) var(--space-lg);
    text-align: left;
    font-weight: 600;
    color: var(--gray-800);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid var(--medical-blue);
}

.table-body-elegant tr {
    transition: all 0.3s var(--transition-smooth);
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

.table-body-elegant tr:hover {
    background: rgba(0, 91, 142, 0.04);
    transform: translateX(4px);
}

.table-body-elegant td {
    padding: var(--space-lg);
    color: var(--gray-700);
    font-size: 0.95rem;
}

/* ============ LUXURY TOAST SYSTEM ============ */
.toast-container-elegant {
    position: fixed;
    bottom: var(--space-xl);
    right: var(--space-xl);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    align-items: flex-end;
}

.toast-elegant {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    min-width: 320px;
    max-width: 400px;
    box-shadow: 
        var(--shadow-xl),
        0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    animation: toastSlideIn 0.4s var(--transition-elastic);
    position: relative;
    overflow: hidden;
}

@keyframes toastSlideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.toast-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.toast-elegant.success::before {
    background: var(--medical-green);
}

.toast-elegant.error::before {
    background: var(--medical-red);
}

.toast-elegant.warning::before {
    background: var(--medical-amber);
}

.toast-elegant.info::before {
    background: var(--medical-blue);
}

.toast-icon {
    font-size: 1.5rem;
    margin-top: 2px;
}

.toast-success .toast-icon { color: var(--medical-green); }
.toast-error .toast-icon { color: var(--medical-red); }
.toast-warning .toast-icon { color: var(--medical-amber); }
.toast-info .toast-icon { color: var(--medical-blue); }

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: var(--space-xs);
    font-size: 1rem;
}

.toast-message {
    color: var(--gray-700);
    font-size: 0.9rem;
    line-height: 1.4;
}

.toast-close {
    background: none;
    border: none;
    color: var(--gray-500);
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
}

.toast-close:hover {
    color: var(--gray-900);
    background: rgba(0, 0, 0, 0.04);
}

/* ============ LUXURY LOADING STATES ============ */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-3xl);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-large);
}

.loading-spinner-elegant {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(0, 91, 142, 0.1);
    border-radius: 50%;
    border-top-color: var(--medical-blue);
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-lg);
    position: relative;
}

.loading-spinner-elegant::after {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 3px solid transparent;
    border-radius: 50%;
    border-top-color: var(--medical-cyan);
    animation: spin 1.5s linear infinite reverse;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1rem;
    color: var(--gray-700);
    font-weight: 500;
    margin-top: var(--space-md);
}

/* ============ LUXURY EMPTY STATES ============ */
.empty-state-elegant {
    text-align: center;
    padding: var(--space-3xl);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-large);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: var(--space-lg);
    color: var(--gray-400);
    opacity: 0.5;
    animation: emptyStateFloat 4s ease-in-out infinite;
}

@keyframes emptyStateFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.empty-state-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-sm);
    letter-spacing: -0.025em;
}

.empty-state-description {
    font-size: 1rem;
    color: var(--gray-700);
    max-width: 400px;
    margin: 0 auto var(--space-lg);
    line-height: 1.5;
}

/* ============ LUXURY PERMISSION TOGGLE ============ */
.permission-toggle-container {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.permission-toggle-elegant {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
    cursor: pointer;
}

.permission-toggle-elegant input {
    opacity: 0;
    width: 0;
    height: 0;
}

.permission-toggle-slider-elegant {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
        rgba(0, 0, 0, 0.1),
        rgba(0, 0, 0, 0.05));
    transition: all 0.4s var(--transition-smooth);
    border-radius: var(--radius-full);
    border: 2px solid rgba(0, 0, 0, 0.1);
    box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.1),
        var(--shadow-soft);
}

.permission-toggle-slider-elegant:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background: white;
    transition: all 0.4s var(--transition-elastic);
    border-radius: 50%;
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.2),
        0 1px 2px rgba(0, 0, 0, 0.1);
}

input:checked + .permission-toggle-slider-elegant {
    background: var(--gradient-success);
    border-color: rgba(16, 185, 129, 0.3);
    box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.1),
        0 0 20px rgba(16, 185, 129, 0.3);
}

input:checked + .permission-toggle-slider-elegant:before {
    transform: translateX(30px);
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Different permission levels */
.permission-toggle-slider-elegant.read {
    background: linear-gradient(135deg,
        rgba(6, 182, 212, 0.5),
        rgba(6, 182, 212, 0.3));
}

.permission-toggle-slider-elegant.write {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.5),
        rgba(0, 91, 142, 0.3));
}

.permission-toggle-slider-elegant.full {
    background: linear-gradient(135deg,
        rgba(16, 185, 129, 0.5),
        rgba(16, 185, 129, 0.3));
}

/* ============ LUXURY STATUS CHIPS ============ */
.status-chip-elegant {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    backdrop-filter: blur(10px);
    border: 1px solid;
    transition: all 0.3s var(--transition-smooth);
}

.status-chip-elegant:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.status-available-elegant {
    background: linear-gradient(135deg,
        rgba(0, 91, 142, 0.15),
        rgba(0, 91, 142, 0.05));
    color: var(--medical-blue);
    border-color: rgba(0, 91, 142, 0.3);
}

.status-approved-elegant {
    background: linear-gradient(135deg,
        rgba(16, 185, 129, 0.15),
        rgba(16, 185, 129, 0.05));
    color: var(--medical-green);
    border-color: rgba(16, 185, 129, 0.3);
}

.status-pending-elegant {
    background: linear-gradient(135deg,
        rgba(245, 158, 11, 0.15),
        rgba(245, 158, 11, 0.05));
    color: var(--medical-amber);
    border-color: rgba(245, 158, 11, 0.3);
}

.status-critical-elegant {
    background: linear-gradient(135deg,
        rgba(239, 68, 68, 0.15),
        rgba(239, 68, 68, 0.05));
    color: var(--medical-red);
    border-color: rgba(239, 68, 68, 0.3);
}

/* ============ LUXURY PERSON CARDS ============ */
.person-card-elegant {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    padding: var(--space-xl);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: var(--shadow-large);
    transition: all 0.4s var(--transition-smooth);
    margin-bottom: var(--space-md);
    position: relative;
    overflow: hidden;
}

.person-card-elegant:hover {
    transform: translateY(-6px);
    box-shadow: 
        var(--shadow-2xl),
        0 16px 48px rgba(0, 91, 142, 0.15);
    border-color: var(--medical-blue);
}

.person-card-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom,
        var(--medical-cyan),
        var(--medical-blue));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.person-card-elegant:hover::before {
    opacity: 1;
}

.person-avatar-elegant {
    width: 72px;
    height: 72px;
    background: var(--gradient-medical);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    flex-shrink: 0;
    box-shadow: 
        var(--shadow-large),
        0 0 24px rgba(0, 91, 142, 0.3);
    position: relative;
    overflow: hidden;
}

.person-avatar-elegant::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 70%
    );
    animation: avatarShine 3s ease-in-out infinite;
}

@keyframes avatarShine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.person-info-elegant {
    flex: 1;
    min-width: 0;
}

.person-name-elegant {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-xs);
    letter-spacing: -0.015em;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
}

.person-clinic-elegant {
    font-size: 0.95rem;
    color: var(--gray-700);
    font-weight: 500;
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.person-meta-elegant {
    font-size: 0.9rem;
    color: var(--gray-600);
    line-height: 1.5;
}

/* ============ LUXURY ACTION BUTTONS ============ */
.action-buttons-elegant {
    display: flex;
    gap: var(--space-sm);
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s var(--transition-smooth);
}

.person-card-elegant:hover .action-buttons-elegant {
    opacity: 1;
    transform: translateX(0);
}

.action-button-elegant {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    border: none;
    background: rgba(0, 0, 0, 0.04);
    color: var(--gray-700);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s var(--transition-smooth);
    font-size: 0.9rem;
}

.action-button-elegant:hover {
    transform: translateY(-2px) rotate(5deg);
    box-shadow: var(--shadow-medium);
}

.action-button-elegant.edit:hover {
    background: var(--medical-blue);
    color: white;
}

.action-button-elegant.delete:hover {
    background: var(--medical-red);
    color: white;
}

.action-button-elegant.view:hover {
    background: var(--medical-cyan);
    color: white;
}

/* ============ LUXURY DATA GRID ============ */
.data-grid-elegant {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
}

.grid-item-elegant {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: var(--shadow-large);
    transition: all 0.4s var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.grid-item-elegant:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 
        var(--shadow-2xl),
        0 20px 60px rgba(0, 91, 142, 0.2);
}

.grid-item-elegant::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,
        var(--medical-cyan),
        var(--medical-blue));
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

/* ============ LUXURY SCROLLBAR ============ */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.04);
    border-radius: var(--radius-full);
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg,
        var(--medical-blue),
        var(--medical-cyan));
    border-radius: var(--radius-full);
    border: 2px solid transparent;
    background-clip: padding-box;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg,
        var(--medical-cyan),
        var(--medical-blue));
}

/* ============ LUXURY ANIMATIONS ============ */
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes glow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

/* ============ RESPONSIVE DESIGN ============ */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.mobile-open {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .mobile-menu-toggle {
        display: flex;
    }
    
    .data-grid-elegant {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

@media (max-width: 768px) {
    .login-card {
        padding: var(--space-xl);
    }
    
    .login-title {
        font-size: 2.5rem;
    }
    
    .login-logo {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
    }
    
    .role-selector {
        grid-template-columns: 1fr;
    }
    
    .metric-grid-elegant {
        grid-template-columns: 1fr;
    }
    
    .card-header-elegant {
        flex-direction: column;
        gap: var(--space-md);
        align-items: flex-start;
    }
    
    .modal-elegant {
        padding: var(--space-xl);
    }
    
    .modal-title-elegant {
        font-size: 1.75rem;
    }
    
    .person-card-elegant {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-lg);
    }
    
    .action-buttons-elegant {
        opacity: 1;
        transform: translateX(0);
        align-self: flex-end;
    }
}

@media (max-width: 480px) {
    :root {
        --space-xl: 1.5rem;
        --space-2xl: 2rem;
    }
    
    .login-card {
        padding: var(--space-lg);
    }
    
    .login-title {
        font-size: 2rem;
    }
    
    .card-header-elegant {
        padding: var(--space-lg);
    }
    
    .card-title-elegant {
        font-size: 1.25rem;
    }
    
    .modal-elegant {
        padding: var(--space-lg);
        margin: var(--space-sm);
    }
    
    .toast-elegant {
        min-width: 280px;
        max-width: calc(100vw - 40px);
    }
}

/* ============ PRINT STYLES ============ */
@media print {
    .sidebar,
    .content-header,
    .btn-elegant,
    .action-button-elegant,
    .permission-manager-toggle {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .card-elegant {
        box-shadow: none;
        border: 1px solid var(--gray-300);
    }
    
    .metric-card-elegant,
    .person-card-elegant {
        break-inside: avoid;
    }
}

/* ============ ACCESSIBILITY ============ */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ============ DARK MODE SUPPORT ============ */
@media (prefers-color-scheme: dark) {
    :root {
        --medical-deep-blue: #1e40af;
        --medical-blue: #3b82f6;
        --medical-teal: #0d9488;
        --medical-green: #10b981;
        --medical-amber: #f59e0b;
        --medical-red: #ef4444;
        --medical-purple: #8b5cf6;
        --medical-cyan: #06b6d4;
        --medical-emerald: #10b981;
        --medical-rose: #f43f5e;
        
        --glass-bg: rgba(15, 23, 42, 0.9);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-tertiary: #94a3b8;
        
        --background-primary: #0f172a;
        --background-secondary: #1e293b;
        --background-tertiary: #334155;
    }
    
    body {
        background: linear-gradient(135deg,
            #0f172a 0%,
            #1e293b 50%,
            #334155 100%);
    }
    
    .card-elegant,
    .modal-elegant,
    .form-container-elegant {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    .form-input-elegant,
    .form-select-elegant,
    .form-textarea-elegant {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(255, 255, 255, 0.1);
        color: #f1f5f9;
    }
    
    .form-input-elegant:hover,
    .form-input-elegant:focus,
    .form-select-elegant:hover,
    .form-select-elegant:focus {
        background: rgba(30, 41, 59, 1);
        border-color: var(--medical-blue);
    }
}

/* ============ PERFORMANCE OPTIMIZATIONS ============ */
@media (prefers-reduced-transparency: reduce) {
    .card-elegant,
    .modal-elegant,
    .form-container-elegant,
    .permission-badge-elegant,
    .status-chip-elegant {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: var(--background-secondary);
    }
    
    .sidebar {
        background: var(--medical-deep-blue);
    }
}
</head>
<body>
<!-- ============ LUXURY LOGIN SCREEN ============ -->
    <div id="app">
         <div class="app-wrapper">
        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">
                        <i class="fas fa-lungs"></i>
                    </div>
        
                    <h1 class="login-title">PneumoCare</h1>
                    <div class="login-subtitle">ADVANCED PULMONARY MANAGEMENT PLATFORM</div>
                    <div class="login-security-info">
                        <i class="fas fa-shield-alt"></i> 
                        <span>HIPAA Compliant  Enterprise Security  Real-time Analytics</span>
                    </div>
                </div>
                
                <div class="role-selector">
                    <div class="role-card" 
                         :class="{ active: loginForm.user_role === 'resident_manager' }" 
                         @click="loginForm.user_role = 'resident_manager'">
                        <div class="role-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="role-name">Resident Manager</div>
                        <div class="role-desc">Full resident management with administrative control</div>
                        <div class="role-permission-badge">
                            <span class="permission-badge-elegant permission-full-elegant">Full Access</span>
                        </div>
                    </div>
                    
                    <div class="role-card" 
                         :class="{ active: loginForm.user_role === 'department_head' }" 
                         @click="loginForm.user_role = 'department_head'">
                        <div class="role-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="role-name">Department Head</div>
                        <div class="role-desc">Strategic oversight and department administration</div>
                        <div class="role-permission-badge">
                            <span class="permission-badge-elegant permission-full-elegant">Executive</span>
                        </div>
                    </div>
                    
                    <div class="role-card" 
                         :class="{ active: loginForm.user_role === 'system_admin' }" 
                         @click="loginForm.user_role = 'system_admin'">
                        <div class="role-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="role-name">System Admin</div>
                        <div class="role-desc">Complete system configuration and permissions</div>
                        <div class="role-permission-badge">
                            <span class="permission-badge-elegant permission-full-elegant">Super Admin</span>
                        </div>
                    </div>
                    
                    <div class="role-card" 
                         :class="{ active: loginForm.user_role === 'viewing_doctor' }" 
                         @click="loginForm.user_role = 'viewing_doctor'">
                        <div class="role-icon">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="role-name">Viewing Doctor</div>
                        <div class="role-desc">Read-only access to schedules and assignments</div>
                        <div class="role-permission-badge">
                            <span class="permission-badge-elegant permission-read-elegant">Read Only</span>
                        </div>
                    </div>
                </div>
                
                <form @submit.prevent="handleAdvancedLogin" class="login-form-elegant">
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                Email Address
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="form-input-with-icon">
                            <input type="email" 
                                   class="form-input-elegant"
                                   v-model="loginForm.email" 
                                   required
                                   placeholder="your.email@hospital.org">
                            <i class="fas fa-envelope form-input-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-lock"></i>
                                </span>
                                Password
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="form-input-with-icon">
                            <input type="password" 
                                   class="form-input-elegant"
                                   v-model="loginForm.password" 
                                   required
                                   placeholder="">
                            <i class="fas fa-lock form-input-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant" v-if="loginForm.require_mfa">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </span>
                                Two-Factor Code
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="form-input-with-icon">
                            <input type="text" 
                                   class="form-input-elegant"
                                   v-model="loginForm.mfa_code"
                                   placeholder="000000"
                                   maxlength="6">
                            <i class="fas fa-shield-alt form-input-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-actions-elegant">
                        <div class="login-info">
                            <span class="current-role-display">
                                <i class="fas fa-user-tag"></i>
                                Logging in as: <strong>{{ getUserRoleDisplay(loginForm.user_role) }}</strong>
                            </span>
                        </div>
                        <button type="submit" 
                                class="btn-primary-elegant"
                                :disabled="loading"
                                style="min-width: 200px; padding: 1rem 2rem;">
                            <span v-if="loading" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-sign-in-alt"></i> 
                                {{ loginForm.require_mfa ? 'Verify & Sign In' : 'Secure Sign In' }}
                            </span>
                        </button>
                    </div>
                </form>
                
                <div class="login-footer">
                    <div class="system-stats">
                        <div class="stat-item">
                            <i class="fas fa-database"></i>
                            <span>System ID: PC-ENT-2024</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span>Last Updated: {{ new Date().toLocaleDateString() }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span>Active Users: {{ systemStats.active_users || 42 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
         </div>---

        <!-- ============ MAIN APPLICATION ============ -->
        <div v-else>
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" @click="toggleMobileMenu">
                <i class="fas fa-bars"></i>
            </button>

            <!-- ============ LUXURY SIDEBAR ============ -->
            <div class="sidebar" :class="{ 
                collapsed: sidebarCollapsed,
                'mobile-open': mobileMenuOpen 
            }">
                <div class="sidebar-header">
                    <div class="brand">
                        <div class="brand-logo-elegant">
                            <i class="fas fa-lungs"></i>
                        </div>
                        <div class="brand-text">
                            <h1>PneumoCare</h1>
                            <div class="brand-subtitle">PULMONARY EXCELLENCE</div>
                            <div class="permission-indicator">
                                <span class="permission-label">Access Level:</span>
                                <span class="permission-level-badge">{{ getUserPermissionLevel() }}</span>
                            </div>
                        </div>
                    </div>
                    <button class="collapse-toggle" @click="sidebarCollapsed = !sidebarCollapsed">
                        <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                    </button>
                </div>
                
                <nav class="sidebar-nav">
                    <!-- Resident Management Section -->
                    <div class="nav-section" v-if="hasAnyPermission(['medical_staff', 'training_units', 'resident_rotations', 'placements'])">
                        <div class="nav-section-title">Resident Management</div>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'medical_staff' }" 
                                @click="switchView('medical_staff'); closeMobileMenu()"
                                :data-permission="getViewPermission('medical_staff')">
                            <i class="fas fa-user-graduate nav-icon"></i>
                            <span>Medical Staff</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('medical_staff')}`">
                                {{ getViewPermission('medical_staff') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'training_units' }" 
                                @click="switchView('training_units'); closeMobileMenu()"
                                :data-permission="getViewPermission('training_units')">
                            <i class="fas fa-hospital-alt nav-icon"></i>
                            <span>Training Units</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('training_units')}`">
                                {{ getViewPermission('training_units') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'resident_rotations' }" 
                                @click="switchView('resident_rotations'); closeMobileMenu()"
                                :data-permission="getViewPermission('resident_rotations')">
                            <i class="fas fa-calendar-alt nav-icon"></i>
                            <span>Resident Rotations</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('resident_rotations')}`">
                                {{ getViewPermission('resident_rotations') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'placements' }" 
                                @click="switchView('placements'); closeMobileMenu()"
                                :data-permission="getViewPermission('placements')">
                            <i class="fas fa-map-marker-alt nav-icon"></i>
                            <span>Placements</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('placements')}`">
                                {{ getViewPermission('placements') }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- Department Oversight Section -->
                    <div class="nav-section" v-if="hasAnyPermission(['department_overview', 'staff_management', 'schedule_approval'])">
                        <div class="nav-section-title">Department Oversight</div>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'department_overview' }" 
                                @click="switchView('department_overview'); closeMobileMenu()"
                                :data-permission="getViewPermission('department_overview')">
                            <i class="fas fa-chart-line nav-icon"></i>
                            <span>Department Overview</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('department_overview')}`">
                                {{ getViewPermission('department_overview') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'staff_management' }" 
                                @click="switchView('staff_management'); closeMobileMenu()"
                                :data-permission="getViewPermission('staff_management')">
                            <i class="fas fa-users nav-icon"></i>
                            <span>Staff Management</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('staff_management')}`">
                                {{ getViewPermission('staff_management') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'schedule_approval' }" 
                                @click="switchView('schedule_approval'); closeMobileMenu()"
                                :data-permission="getViewPermission('schedule_approval')">
                            <i class="fas fa-calendar-check nav-icon"></i>
                            <span>Schedule Approval</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('schedule_approval')}`">
                                {{ getViewPermission('schedule_approval') }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- Operations Section -->
                    <div class="nav-section">
                        <div class="nav-section-title">Operations</div>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'daily_operations' }" 
                                @click="switchView('daily_operations'); closeMobileMenu()"
                                :data-permission="getViewPermission('daily_operations')">
                            <i class="fas fa-calendar-day nav-icon"></i>
                            <span>Daily Operations</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('daily_operations')}`">
                                {{ getViewPermission('daily_operations') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'oncall_schedule' }" 
                                @click="switchView('oncall_schedule'); closeMobileMenu()"
                                :data-permission="getViewPermission('oncall_schedule')">
                            <i class="fas fa-phone-alt nav-icon"></i>
                            <span>On-call Schedule</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('oncall_schedule')}`">
                                {{ getViewPermission('oncall_schedule') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'leave_requests' }" 
                                @click="switchView('leave_requests'); closeMobileMenu()"
                                :data-permission="getViewPermission('leave_requests')">
                            <i class="fas fa-calendar-times nav-icon"></i>
                            <span>Leave Requests</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('leave_requests')}`">
                                {{ getViewPermission('leave_requests') }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- Communications Section -->
                    <div class="nav-section">
                        <div class="nav-section-title">Communications</div>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'announcements' }" 
                                @click="switchView('announcements'); closeMobileMenu()"
                                :data-permission="getViewPermission('announcements')">
                            <i class="fas fa-bullhorn nav-icon"></i>
                            <span>Announcements</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('announcements')}`">
                                {{ getViewPermission('announcements') }}
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'audit_logs' }" 
                                @click="switchView('audit_logs'); closeMobileMenu()"
                                :data-permission="getViewPermission('audit_logs')">
                            <i class="fas fa-clipboard-list nav-icon"></i>
                            <span>Audit Logs</span>
                            <span class="nav-permission" :class="`permission-${getViewPermission('audit_logs')}`">
                                {{ getViewPermission('audit_logs') }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- Administration Section -->
                    <div class="nav-section" v-if="hasPermission('system', 'admin')">
                        <div class="nav-section-title">Administration</div>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'permission_management' }" 
                                @click="switchView('permission_management'); closeMobileMenu()">
                            <i class="fas fa-user-shield nav-icon"></i>
                            <span>Permission Management</span>
                            <span class="nav-permission permission-full-elegant">
                                Admin
                            </span>
                        </button>
                        
                        <button class="nav-item-elegant" 
                                :class="{ active: currentView === 'system_settings' }" 
                                @click="switchView('system_settings'); closeMobileMenu()">
                            <i class="fas fa-cogs nav-icon"></i>
                            <span>System Settings</span>
                            <span class="nav-permission permission-full-elegant">
                                Admin
                            </span>
                        </button>
                    </div>
                </nav>
                
                <div class="sidebar-footer">
                    <div class="user-profile-compact">
                        <div class="user-avatar-compact">
                            {{ getInitials(currentUser.full_name) }}
                        </div>
                        <div class="user-details-compact">
                            <div class="user-name-compact">{{ currentUser.full_name }}</div>
                            <div class="user-role-compact">
                                {{ getUserRoleDisplay(currentUser.user_role) }}
                                <span class="permission-badge-elegant permission-limited-elegant">
                                    {{ getUserPermissionLevel() }}
                                </span>
                            </div>
                        </div>
                        <button class="permission-manager-toggle" @click="togglePermissionManager" title="Permissions">
                            <i class="fas fa-shield-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============ LUXURY MAIN CONTENT ============ -->
            <div class="main-content" :class="{ expanded: sidebarCollapsed }">
                <!-- Luxury Header -->
                <header class="content-header">
                    <div class="header-left">
                        <div class="header-title">
                            <h1>{{ getCurrentTitle() }}</h1>
                            <div class="subtitle">
                                {{ getCurrentSubtitle() }}
                                <span class="permission-context">
                                    <span class="permission-context-label">Access Level:</span>
                                    <span class="permission-context-value">{{ getViewPermission(currentView) }}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <div class="search-container">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" 
                                       class="search-input"
                                       v-model="searchQuery" 
                                       :placeholder="getSearchPlaceholder()"
                                       @input="handleAdvancedSearch">
                            </div>
                        </div>
                        <div class="user-profile-header" @click="toggleUserMenu">
                            <div class="user-info-header">
                                <div class="user-name-header">{{ currentUser.full_name }}</div>
                                <div class="user-role-header">
                                    {{ getUserRoleDisplay(currentUser.user_role) }}
                                    <i class="fas fa-chevron-down dropdown-icon"></i>
                                </div>
                            </div>
                            <div class="user-avatar-header">
                                {{ getInitials(currentUser.full_name) }}
                                <div class="user-status-indicator active"></div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="content-area">
                    <!-- Loading State -->
                    <div v-if="loading && !permissionLoading" class="loading-container">
                        <div class="loading-spinner-elegant"></div>
                        <p class="loading-text">Loading System Data...</p>
                        <div class="loading-detail">
                            <i class="fas fa-shield-alt"></i>
                            <span>Verifying permissions...</span>
                        </div>
                    </div>

                    <!-- ============ MEDICAL STAFF VIEW ============ -->
                    <div v-if="currentView === 'medical_staff'">
                        <div class="card-elegant">
                            <div class="card-header-elegant">
                                <div class="card-title-elegant">
                                    <div class="card-icon-elegant">
                                        <i class="fas fa-user-md"></i>
                                    </div>
                                    Medical Staff Management
                                    <span class="permission-badge-elegant" :class="`permission-${getViewPermission('medical_staff')}-elegant`"
                                          style="margin-left: 1rem;">
                                        {{ getViewPermission('medical_staff') }}
                                    </span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-primary-elegant" 
                                            @click="showAddMedicalStaffModal"
                                            :disabled="!hasPermission('medical_staff', 'create')"
                                            :data-permission="hasPermission('medical_staff', 'create') ? 'write' : 'none'">
                                        <i class="fas fa-user-plus"></i> Add Medical Staff
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <!-- Metrics Grid -->
                                <div class="metric-grid-elegant">
                                    <div class="metric-card-elegant">
                                        <div class="metric-value">{{ stats.totalStaff }}</div>
                                        <div class="metric-label">
                                            <i class="fas fa-users"></i>
                                            Total Medical Staff
                                            <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                        </div>
                                        <div class="metric-trend-elegant">
                                            <div class="metric-trend-fill" :style="{ width: '75%' }"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card-elegant">
                                        <div class="metric-value">{{ stats.activeResidents }}</div>
                                        <div class="metric-label">
                                            <i class="fas fa-user-graduate"></i>
                                            Active Residents
                                            <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                        </div>
                                        <div class="metric-trend-elegant">
                                            <div class="metric-trend-fill" :style="{ width: '60%' }"></div>
                                        </div>
                                    </div>

                                    <div class="metric-card-elegant">
                                        <div class="metric-value">{{ stats.attendings }}</div>
                                        <div class="metric-label">
                                            <i class="fas fa-user-md"></i>
                                            Attending Physicians
                                            <span class="permission-badge-elegant permission-read-elegant">Visible</span>
                                        </div>
                                        <div class="metric-trend-elegant">
                                            <div class="metric-trend-fill" :style="{ width: '85%' }"></div>
                                        </div>
                                    </div>

                                    <div class="metric-card-elegant">
                                        <div class="metric-value">{{ stats.availableSupervisors }}</div>
                                        <div class="metric-label">
                                            <i class="fas fa-user-shield"></i>
                                            Available Supervisors
                                            <span class="permission-badge-elegant permission-limited-elegant">Limited</span>
                                        </div>
                                        <div class="metric-trend-elegant">
                                            <div class="metric-trend-fill" :style="{ width: '90%' }"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filters and Search -->
                                <div class="filters-section">
                                    <div class="filter-group">
                                        <select class="form-select-elegant" 
                                                style="width: 180px;" 
                                                v-model="staffFilter.staff_type"
                                                :data-permission="hasPermission('medical_staff', 'read') ? 'read' : 'none'">
                                            <option value="">All Types</option>
                                            <option value="medical_resident">Medical Resident</option>
                                            <option value="attending_physician">Attending Physician</option>
                                            <option value="fellow">Fellow</option>
                                            <option value="nurse_practitioner">Nurse Practitioner</option>
                                        </select>
                                        <select class="form-select-elegant" 
                                                style="width: 180px;" 
                                                v-model="staffFilter.employment_status"
                                                :data-permission="hasPermission('medical_staff', 'read') ? 'read' : 'none'">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="on_leave">On Leave</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                        <div class="search-box-small">
                                            <i class="fas fa-search"></i>
                                            <input type="text" 
                                                   class="search-input-small"
                                                   v-model="staffSearch" 
                                                   placeholder="Search staff...">
                                        </div>
                                        <div class="filter-results">
                                            <span class="results-count">{{ filteredMedicalStaff.length }} results</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Staff List -->
                                <div v-if="filteredMedicalStaff.length > 0" class="staff-list">
                                    <div v-for="staff in filteredMedicalStaff" 
                                         :key="staff.id" 
                                         class="person-card-elegant">
                                        <div class="person-avatar-elegant" 
                                             :class="{ 
                                                 resident: staff.staff_type === 'medical_resident',
                                                 attending: staff.staff_type === 'attending_physician'
                                             }">
                                            {{ getInitials(staff.full_name) }}
                                            <div class="person-status-indicator" 
                                                 :class="`status-${staff.employment_status}`"></div>
                                        </div>
                                        <div class="person-info-elegant">
                                            <div class="person-name-elegant">
                                                {{ staff.full_name }}
                                                <span class="staff-type-badge" :class="getStaffTypeClass(staff?.staff_type || '')">
                                                    {{ formatStaffType(staff.staff_type) }}
                                                </span>
                                                <span v-if="staff.can_supervise_residents" class="supervisor-badge">
                                                    <i class="fas fa-user-md"></i> Supervisor
                                                </span>
                                            </div>
                                            <div class="person-clinic-elegant">
                                                <i class="fas fa-id-card"></i> ID: {{ staff.staff_id }}
                                                <span v-if="staff.primary_clinic" class="clinic-info">
                                                    <i class="fas fa-hospital"></i> {{ staff.primary_clinic }}
                                                </span>
                                            </div>
                                            <div class="person-meta-elegant">
                                                <div v-if="staff.staff_type === 'medical_resident'">
                                                    <strong>Category:</strong> {{ formatResidentCategory(staff.resident_category) }}
                                                    <span v-if="staff.training_year">  <strong>Year:</strong> {{ staff.training_year }}</span>
                                                </div>
                                                <div v-if="staff.professional_email">
                                                    <strong>Email:</strong> {{ staff.professional_email }}
                                                </div>
                                                <div class="employment-status">
                                                    <i class="fas fa-user-check"></i> {{ formatEmploymentStatus(staff.employment_status) }}
                                                </div>
                                            </div>
                                            <div class="person-permissions">
                                                <span class="permission-badge-elegant permission-read-elegant">
                                                    Viewable by: All Staff
                                                </span>
                                                <span v-if="hasPermission('medical_staff', 'update')" 
                                                      class="permission-badge-elegant permission-write-elegant">
                                                    Editable by: {{ getUserRoleDisplay(currentUser.user_role) }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="action-buttons-elegant">
                                            <button class="action-button-elegant edit" 
                                                    @click="editMedicalStaff(staff)"
                                                    :title="hasPermission('medical_staff', 'update') ? 'Edit' : 'No edit permission'"
                                                    :disabled="!hasPermission('medical_staff', 'update')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-button-elegant view" 
                                                    @click="viewStaffSchedule(staff)"
                                                    title="View Schedule">
                                                <i class="fas fa-calendar"></i>
                                            </button>
                                            <button class="action-button-elegant delete" 
                                                    v-if="hasPermission('medical_staff', 'delete')"
                                                    @click="deleteMedicalStaff(staff)"
                                                    title="Delete"
                                                    data-permission-level="full">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="empty-state-elegant">
                                    <i class="fas fa-user-graduate empty-state-icon"></i>
                                    <div class="empty-state-title">No medical staff found</div>
                                    <div class="empty-state-description">
                                        {{ hasPermission('medical_staff', 'create') ? 
                                           'Add medical staff to get started' : 
                                           'You don\'t have permission to view medical staff' }}
                                    </div>
                                    <div class="empty-state-actions" v-if="hasPermission('medical_staff', 'create')">
                                        <button class="btn-primary-elegant" @click="showAddMedicalStaffModal">
                                            <i class="fas fa-user-plus"></i> Add First Staff Member
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ TRAINING UNITS VIEW ============ -->
                    <div v-if="currentView === 'training_units'">
                        <div class="card-elegant">
                            <div class="card-header-elegant">
                                <div class="card-title-elegant">
                                    <div class="card-icon-elegant">
                                        <i class="fas fa-hospital-alt"></i>
                                    </div>
                                    Training Units Management
                                    <span class="permission-badge-elegant" :class="`permission-${getViewPermission('training_units')}-elegant`"
                                          style="margin-left: 1rem;">
                                        {{ getViewPermission('training_units') }}
                                    </span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-primary-elegant" 
                                            @click="showAddTrainingUnitModal"
                                            :disabled="!hasPermission('training_units', 'create')">
                                        <i class="fas fa-plus"></i> Add Training Unit
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="units-grid-elegant">
                                    <div v-for="unit in trainingUnits" 
                                         :key="unit.id" 
                                         class="unit-card-elegant">
                                        <div class="unit-header-elegant">
                                            <div class="unit-name-elegant">{{ unit.unit_name }}</div>
                                            <div class="unit-capacity-elegant">
                                                <i class="fas fa-users"></i>
                                                {{ unit.current_residents || 0 }}/{{ unit.maximum_residents }}
                                            </div>
                                            <div class="unit-permission-tag">
                                                {{ getViewPermission('training_units') }}
                                            </div>
                                        </div>
                                        <div class="unit-description">
                                            {{ unit.unit_description }}
                                        </div>
                                        <div class="unit-tags">
                                            <span class="status-chip-elegant" :class="`status-${unit.unit_status}-elegant`">
                                                {{ unit.unit_status }}
                                            </span>
                                            <span v-if="unit.specialty" class="specialty-badge">
                                                {{ unit.specialty }}
                                            </span>
                                        </div>
                                        <div class="unit-residents-section">
                                            <h4>Assigned Residents</h4>
                                            <div v-if="unit.assigned_residents && unit.assigned_residents.length > 0" class="resident-list">
                                                <div v-for="resident in unit.assigned_residents.slice(0, 3)" 
                                                     :key="resident.id"
                                                     class="resident-item">
                                                    <div class="resident-name">{{ resident.full_name }}</div>
                                                </div>
                                                <div v-if="unit.assigned_residents.length > 3" class="more-residents">
                                                    +{{ unit.assigned_residents.length - 3 }} more residents
                                                </div>
                                            </div>
                                            <div v-else class="no-residents">
                                                No residents assigned
                                            </div>
                                        </div>
                                        <div class="unit-actions">
                                            <button class="btn-secondary-elegant"
                                                    @click="editTrainingUnit(unit)"
                                                    :disabled="!hasPermission('training_units', 'update')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn-outline-elegant"
                                                    @click="assignResidentsToUnit(unit)">
                                                <i class="fas fa-user-plus"></i> Assign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ DAILY OPERATIONS VIEW ============ -->
                    <div v-if="currentView === 'daily_operations'">
                        <div class="card-elegant">
                            <div class="card-header-elegant">
                                <div class="card-title-elegant">
                                    <div class="card-icon-elegant">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    Daily Operations Board
                                    <span class="permission-badge-elegant permission-read-elegant" style="margin-left: 1rem;">
                                        Read Only
                                    </span>
                                </div>
                                <div class="card-actions">
                                    <div class="permission-info">
                                        <i class="fas fa-eye"></i> Visible to all roles
                                    </div>
                                </div>
                            </div>
                            <div class="card-content">
                                <!-- Real-time Operations Grid -->
                                <div class="operations-grid">
                                    <!-- Today's Assignments -->
                                    <div class="operations-card">
                                        <div class="operations-card-header">
                                            <div class="operations-card-title">
                                                <i class="fas fa-tasks"></i> Today's Assignments
                                            </div>
                                            <span class="permission-badge-elegant permission-read-elegant">Public</span>
                                        </div>
                                        <div class="operations-card-content">
                                            <div v-if="todaysAssignments.length > 0" class="assignments-list">
                                                <div v-for="assignment in todaysAssignments" :key="assignment.id" 
                                                     class="assignment-item">
                                                    <div class="assignment-staff">{{ assignment.staff_name }}</div>
                                                    <div class="assignment-details">
                                                        {{ assignment.location_name }}  {{ formatTimeRange(assignment.start_time, assignment.end_time) }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="no-data">
                                                No assignments today
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- On-call Today -->
                                    <div class="operations-card">
                                        <div class="operations-card-header">
                                            <div class="operations-card-title">
                                                <i class="fas fa-phone"></i> On-call Today
                                            </div>
                                            <span class="permission-badge-elegant permission-read-elegant">Public</span>
                                        </div>
                                        <div class="operations-card-content">
                                            <div v-if="todaysOnCall.length > 0" class="oncall-list">
                                                <div v-for="oncall in todaysOnCall" :key="oncall.id" 
                                                     class="oncall-item">
                                                    <div class="oncall-primary">{{ oncall.primary_name }}</div>
                                                    <div class="oncall-details">
                                                        {{ oncall.shift_type }}  Backup: {{ oncall.backup_name || 'None' }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else class="no-data">
                                                No on-call scheduled
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Announcements -->
                                    <div class="operations-card">
                                        <div class="operations-card-header">
                                            <div class="operations-card-title">
                                                <i class="fas fa-bullhorn"></i> Announcements
                                            </div>
                                            <span class="permission-badge-elegant" :class="`permission-${getViewPermission('announcements')}-elegant`">
                                                {{ getViewPermission('announcements') }}
                                            </span>
                                        </div>
                                        <div class="operations-card-content">
                                            <div v-if="recentAnnouncements.length > 0" class="announcements-list">
                                                <div v-for="announcement in recentAnnouncements" :key="announcement.id" 
                                                     class="announcement-item">
                                                    <div class="announcement-title">{{ announcement.announcement_title }}</div>
                                                    <div class="announcement-date">{{ formatDateShort(announcement.publish_start_date) }}</div>
                                                </div>
                                            </div>
                                            <div v-else class="no-data">
                                                No announcements
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Coverage Alerts -->
                                <div v-if="coverageAlerts.length > 0" class="alerts-section">
                                    <h3 class="alerts-title">
                                        <i class="fas fa-exclamation-triangle" style="color: var(--medical-amber);"></i>
                                        Coverage Alerts
                                    </h3>
                                    <div class="alerts-list">
                                        <div v-for="alert in coverageAlerts" :key="alert.id" 
                                             class="alert-card" 
                                             style="border-left: 4px solid var(--medical-amber);">
                                            <div class="alert-content">
                                                <div class="alert-title">
                                                    {{ alert.unit_name }} needs residents
                                                </div>
                                                <div class="alert-details">
                                                    Current: {{ alert.current }}/{{ alert.capacity }}  
                                                    Priority: <span class="status-chip-elegant status-critical-elegant">High</span>
                                                </div>
                                            </div>
                                            <button class="btn-primary-elegant" 
                                                    v-if="hasPermission('placements', 'create')"
                                                    @click="quickAssignToUnit(alert)">
                                                <i class="fas fa-user-plus"></i> Assign Residents
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Emergency Alerts -->
                                <div v-if="emergencyAlerts.length > 0" class="emergency-alerts">
                                    <h3 class="emergency-title">
                                        <i class="fas fa-bell" style="color: var(--medical-red);"></i>
                                        Emergency Alerts
                                    </h3>
                                    <div class="emergency-list">
                                        <div v-for="alert in emergencyAlerts" :key="alert.id" 
                                             class="emergency-card">
                                            <div class="emergency-content">
                                                <div class="emergency-title">
                                                    <i class="fas fa-exclamation-circle"></i> {{ alert.title }}
                                                </div>
                                                <div class="emergency-details">
                                                    {{ alert.message }}
                                                </div>
                                            </div>
                                            <span class="status-chip-elegant status-critical-elegant">Emergency</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ PERMISSION MANAGEMENT VIEW ============ -->
                    <div v-if="currentView === 'permission_management' && hasPermission('system', 'admin')">
                        <div class="card-elegant">
                            <div class="card-header-elegant">
                                <div class="card-title-elegant">
                                    <div class="card-icon-elegant">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    Permission Management
                                </div>
                                <div class="card-actions">
                                    <span class="permission-required">
                                        <i class="fas fa-key"></i> Admin Access Required
                                    </span>
                                    <button class="btn-success-elegant" @click="showAddRoleModal">
                                        <i class="fas fa-plus"></i> New Role
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="permission-grid">
                                    <div v-for="role in systemRoles" :key="role.id" class="permission-card-elegant">
                                        <div class="permission-card-header">
                                            <div class="permission-card-title">{{ role.name }}</div>
                                            <div class="permission-badge-elegant" :class="`permission-${role.level}-elegant`">
                                                {{ role.level }}
                                            </div>
                                        </div>
                                        <div class="permission-card-content">
                                            <div class="role-description">{{ role.description }}</div>
                                            <div class="resource-permissions">
                                                <div v-for="(permissions, resource) in role.permissions" 
                                                     :key="resource"
                                                     class="resource-row">
                                                    <div class="resource-name">{{ formatResourceName(resource) }}</div>
                                                    <div class="permission-toggles">
                                                        <div class="permission-toggle-container" v-for="action in ['read', 'write', 'delete']" 
                                                              :key="action">
                                                            <label class="toggle-label">{{ formatActionName(action) }}</label>
                                                            <div class="permission-toggle-elegant">
                                                                <input type="checkbox" 
                                                                       :checked="permissions[action]"
                                                                       @change="togglePermission(resource, action, $event)">
                                                                <span class="permission-toggle-slider-elegant" :class="action"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="role-actions">
                                                <button class="btn-outline-elegant" 
                                                        @click="editRole(role)">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn-secondary-elegant" 
                                                        @click="cloneRole(role)">
                                                    <i class="fas fa-copy"></i> Clone
                                                </button>
                                                <button v-if="role.id !== 'admin'" 
                                                        class="btn-danger-elegant" 
                                                        @click="deleteRole(role)">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ AUDIT LOGS VIEW ============ -->
                    <div v-if="currentView === 'audit_logs' && hasPermission('audit', 'read')">
                        <div class="card-elegant">
                            <div class="card-header-elegant">
                                <div class="card-title-elegant">
                                    <div class="card-icon-elegant">
                                        <i class="fas fa-clipboard-list"></i>
                                    </div>
                                    Audit Logs
                                    <span class="permission-badge-elegant permission-limited-elegant" style="margin-left: 1rem;">
                                        Admin View
                                    </span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-primary-elegant" 
                                            @click="exportAuditLogs"
                                            :disabled="!hasPermission('audit', 'export')">
                                        <i class="fas fa-download"></i> Export Logs
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="audit-log-elegant">
                                    <div class="audit-log-header">
                                        <div>Recent Activities</div>
                                        <div class="audit-log-count">
                                            <span class="permission-badge-elegant permission-full-elegant">
                                                {{ auditLogs.length }} entries
                                            </span>
                                        </div>
                                    </div>
                                    <div class="audit-log-content">
                                        <div v-for="log in auditLogs" :key="log.id" class="audit-log-entry">
                                            <div class="audit-log-icon">
                                                <i :class="getAuditIcon(log.action)"></i>
                                            </div>
                                            <div class="audit-log-details">
                                                <div class="audit-log-action">{{ log.action }}</div>
                                                <div class="audit-log-meta">
                                                    <span class="audit-log-user">{{ log.user_name }}</span>
                                                    <span>{{ formatDateTime(log.timestamp) }}</span>
                                                    <span class="permission-badge-elegant" :class="`permission-${log.permission_level}-elegant`">
                                                        {{ log.permission_level }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add more views here following the same pattern... -->

                </div>
            </div>

            <!-- ============ LUXURY MODALS ============ -->
            
            <!-- Medical Staff Modal -->
            <div v-if="medicalStaffModal.show" class="modal-overlay-elegant">
                <div class="modal-elegant" style="max-width: 700px;">
                    <div class="modal-header-elegant">
                        <div class="modal-title-elegant">
                            <div class="modal-title-icon">
                                <i class="fas fa-user-md"></i>
                            </div>
                            {{ medicalStaffModal.mode === 'add' ? 'Add Medical Staff' : 'Edit Medical Staff' }}
                        </div>
                        <button class="modal-close-elegant" @click="medicalStaffModal.show = false">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-permission-banner">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <strong>Permission Level:</strong> 
                            <span class="permission-badge-elegant" :class="`permission-${getViewPermission('medical_staff')}-elegant`">
                                {{ getViewPermission('medical_staff') }}
                            </span>
                        </div>
                    </div>
                    
                    <form @submit.prevent="saveMedicalStaff" class="modal-form">
                        <div class="form-container-elegant">
                            <div class="form-section-elegant">
                                <div class="form-section-header">
                                    <div class="form-section-icon">
                                        <i class="fas fa-id-card"></i>
                                    </div>
                                    <div>
                                        <div class="form-section-title">Basic Information</div>
                                        <div class="form-section-description">Enter the staff member's basic details</div>
                                    </div>
                                </div>
                                
                                <div class="form-grid-elegant">
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-user"></i>
                                                </span>
                                                Full Name
                                            </span>
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <div class="form-input-with-icon">
                                            <input type="text" 
                                                   class="form-input-elegant"
                                                   v-model="medicalStaffModal.form.full_name" 
                                                   required
                                                   placeholder="Dr. John Doe">
                                            <i class="fas fa-user form-input-icon"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-tag"></i>
                                                </span>
                                                Staff Type
                                            </span>
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <select class="form-select-elegant" 
                                                v-model="medicalStaffModal.form.staff_type" 
                                                required>
                                            <option value="" disabled>Select staff type...</option>
                                            <option value="medical_resident">Medical Resident</option>
                                            <option value="attending_physician">Attending Physician</option>
                                            <option value="fellow">Fellow</option>
                                            <option value="nurse_practitioner">Nurse Practitioner</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-grid-elegant">
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-envelope"></i>
                                                </span>
                                                Professional Email
                                            </span>
                                        </label>
                                        <div class="form-input-with-icon">
                                            <input type="email" 
                                                   class="form-input-elegant"
                                                   v-model="medicalStaffModal.form.professional_email"
                                                   placeholder="doctor@hospital.org">
                                            <i class="fas fa-envelope form-input-icon"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-hospital"></i>
                                                </span>
                                                Primary Clinic
                                            </span>
                                        </label>
                                        <div class="form-input-with-icon">
                                            <input type="text" 
                                                   class="form-input-elegant"
                                                   v-model="medicalStaffModal.form.primary_clinic"
                                                   placeholder="e.g., ICU, Pulmonary Unit">
                                            <i class="fas fa-hospital form-input-icon"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resident-specific fields -->
                            <div v-if="medicalStaffModal.form.staff_type === 'medical_resident'" class="form-section-elegant">
                                <div class="form-section-header">
                                    <div class="form-section-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <div>
                                        <div class="form-section-title">Resident Information</div>
                                        <div class="form-section-description">Additional details for medical residents</div>
                                    </div>
                                </div>
                                
                                <div class="form-grid-elegant">
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-layer-group"></i>
                                                </span>
                                                Resident Category
                                            </span>
                                        </label>
                                        <select class="form-select-elegant" 
                                                v-model="medicalStaffModal.form.resident_category">
                                            <option value="">Select Category</option>
                                            <option value="pgy1">PGY-1</option>
                                            <option value="pgy2">PGY-2</option>
                                            <option value="pgy3">PGY-3</option>
                                            <option value="pgy4">PGY-4</option>
                                            <option value="pgy5">PGY-5</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                                Training Year
                                            </span>
                                        </label>
                                        <input type="number" 
                                               class="form-input-elegant"
                                               v-model="medicalStaffModal.form.training_year"
                                               min="2020" 
                                               max="2030"
                                               placeholder="2024">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Permissions Section -->
                            <div class="form-section-elegant">
                                <div class="form-section-header">
                                    <div class="form-section-icon">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div>
                                        <div class="form-section-title">Permissions & Status</div>
                                        <div class="form-section-description">Configure staff capabilities and employment status</div>
                                    </div>
                                </div>
                                
                                <div class="form-grid-elegant">
                                    <div class="form-group-elegant">
                                        <label class="form-label-elegant">
                                            <span class="form-label-text">
                                                <span class="form-label-icon">
                                                    <i class="fas fa-user-tie"></i>
                                                </span>
                                                Employment Status
                                            </span>
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <select class="form-select-elegant" 
                                                v-model="medicalStaffModal.form.employment_status" 
                                                required>
                                            <option value="active">Active</option>
                                            <option value="on_leave">On Leave</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-toggle-group">
                                        <div class="form-toggle-elegant" :class="{ active: medicalStaffModal.form.can_supervise_residents }">
                                            <div class="toggle-switch">
                                                <input type="checkbox" 
                                                       v-model="medicalStaffModal.form.can_supervise_residents"
                                                       :checked="medicalStaffModal.form.can_supervise_residents">
                                                <span class="toggle-slider"></span>
                                            </div>
                                            <div>
                                                <div class="toggle-label">Can Supervise Residents</div>
                                                <div class="toggle-description">Allow this staff member to supervise and evaluate residents</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="form-actions-elegant">
                                <div class="form-progress">
                                    <span>Form Complete:</span>
                                    <div class="progress-steps">
                                        <div class="progress-step active"></div>
                                        <div class="progress-step"></div>
                                        <div class="progress-step"></div>
                                    </div>
                                </div>
                                
                                <div class="action-buttons">
                                    <button type="button" 
                                            class="btn-secondary-elegant" 
                                            @click="medicalStaffModal.show = false">
                                        Cancel
                                    </button>
                                    <button type="submit" 
                                            class="btn-primary-elegant" 
                                            :disabled="saving">
                                        <span v-if="saving" class="loading-spinner-small"></span>
                                        <span v-else>
                                            <i class="fas fa-save"></i>
                                            {{ medicalStaffModal.mode === 'add' ? 'Add Staff' : 'Update Staff' }}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add other modals here following the same pattern... -->

            <!-- ============ LUXURY TOAST CONTAINER ============ -->
            <div class="toast-container-elegant">
                <div v-for="toast in toasts" 
                     :key="toast.id"
                     class="toast-elegant" 
                     :class="toast.type"
                     @click="removeToast(toast.id)">
                    <i :class="toast.icon" class="toast-icon"></i>
                    <div class="toast-content">
                        <div class="toast-title">{{ toast.title }}</div>
                        <div class="toast-message">{{ toast.message }}</div>
                    </div>
                    <button class="toast-close" @click.stop="removeToast(toast.id)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- ============ PERMISSION MANAGER PANEL ============ -->
            <div class="permission-manager-panel" :class="{ open: showPermissionManager }">
                <div class="permission-manager-header">
                    <div class="permission-manager-title">
                        <i class="fas fa-user-shield"></i> Permission Manager
                    </div>
                    <button class="modal-close-elegant" @click="showPermissionManager = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="permission-manager-content">
                    <div class="permission-manager-grid">
                        <div v-for="(resource, key) in permissionResources" :key="key" class="permission-manager-card">
                            <div class="permission-manager-card-header">
                                <div class="permission-manager-card-title">{{ resource.name }}</div>
                                <div class="permission-badge-elegant" :class="`permission-${getResourcePermissionLevel(key)}-elegant`">
                                    {{ getResourcePermissionLevel(key) }}
                                </div>
                            </div>
                            <div class="permission-manager-card-content">
                                <div class="permission-manager-actions">
                                    <div v-for="action in resource.actions" :key="action" class="permission-manager-action">
                                        <div class="action-name">{{ formatActionName(action) }}</div>
                                        <div class="action-toggle">
                                            <div class="permission-toggle-elegant">
                                                <input type="checkbox" 
                                                       :checked="hasPermission(key, action)"
                                                       @change="togglePermissionDirect(key, action, $event)">
                                                <span class="permission-toggle-slider-elegant" :class="getResourcePermissionLevel(key)"></span>
                                            </div>
                                        </div>
                                        <div class="action-description">
                                            {{ getPermissionDescription(key, action) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="permission-manager-footer">
                    <button class="btn-primary-elegant" @click="savePermissionChanges" :disabled="savingPermissions">
                        <i class="fas fa-save"></i> Save Permission Changes
                    </button>
                </div>
            </div>

            <!-- ============ USER MENU DROPDOWN ============ -->
            <div v-if="userMenuOpen" class="user-menu-dropdown">
                <div class="user-menu-content">
                    <div class="user-menu-header">
                        <div class="user-menu-avatar">
                            {{ getInitials(currentUser.full_name) }}
                        </div>
                        <div class="user-menu-info">
                            <div class="user-menu-name">{{ currentUser.full_name }}</div>
                            <div class="user-menu-role">{{ getUserRoleDisplay(currentUser.user_role) }}</div>
                        </div>
                    </div>
                    <div class="user-menu-items">
                        <button class="user-menu-item" @click="showUserProfile">
                            <i class="fas fa-user"></i>
                            <span>My Profile</span>
                        </button>
                        <button class="user-menu-item" @click="togglePermissionManager">
                            <i class="fas fa-shield-alt"></i>
                            <span>Permissions</span>
                        </button>
                        <button class="user-menu-item" @click="showSettings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </button>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item logout" @click="handleLogout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Add Role Modal -->
<div v-if="addRoleModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 600px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                {{ addRoleModal.mode === 'add' ? 'Create New Role' : 'Edit Role' }}
            </div>
            <button class="modal-close-elegant" @click="addRoleModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form @submit.prevent="saveRole" class="modal-form">
            <div class="form-container-elegant">
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-id-badge"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Role Details</div>
                            <div class="form-section-description">Define the role's basic information and permissions level</div>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-heading"></i>
                                </span>
                                Role Name
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="form-input-with-icon">
                            <input type="text" 
                                   class="form-input-elegant"
                                   v-model="addRoleModal.form.name" 
                                   required
                                   placeholder="e.g., Senior Resident Manager">
                            <i class="fas fa-tag form-input-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-align-left"></i>
                                </span>
                                Description
                            </span>
                        </label>
                        <textarea class="form-textarea-elegant" 
                                  v-model="addRoleModal.form.description"
                                  rows="3"
                                  placeholder="Describe the role's responsibilities and scope..."></textarea>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-layer-group"></i>
                                </span>
                                Permission Level
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <select class="form-select-elegant" 
                                v-model="addRoleModal.form.level" 
                                required>
                            <option value="" disabled>Select permission level...</option>
                            <option value="full">Full Control</option>
                            <option value="write">Read & Write</option>
                            <option value="read">Read Only</option>
                            <option value="limited">Limited Access</option>
                        </select>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            <span>Higher levels include all permissions from lower levels</span>
                        </div>
                    </div>
                    
                    <div v-if="addRoleModal.form.level" class="permission-preview">
                        <h4 class="preview-title">Permission Preview</h4>
                        <div class="preview-grid">
                            <div class="preview-item">
                                <i class="fas fa-check-circle success"></i>
                                <span>Full System Access</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-check-circle" :class="addRoleModal.form.level === 'full' || addRoleModal.form.level === 'write' ? 'success' : 'muted'"></i>
                                <span>Create & Edit Records</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-check-circle" :class="addRoleModal.form.level !== 'none' ? 'success' : 'muted'"></i>
                                <span>View Records</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-check-circle" :class="addRoleModal.form.level === 'full' ? 'success' : 'muted'"></i>
                                <span>Delete Records</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions-elegant">
                    <div class="form-validation">
                        <i class="fas fa-check-circle" :class="addRoleModal.form.name && addRoleModal.form.level ? 'valid' : 'invalid'"></i>
                        <span>All required fields are complete</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" 
                                class="btn-secondary-elegant" 
                                @click="addRoleModal.show = false">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="btn-primary-elegant" 
                                :disabled="saving || !addRoleModal.form.name || !addRoleModal.form.level">
                            <span v-if="saving" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-save"></i>
                                {{ addRoleModal.mode === 'add' ? 'Create Role' : 'Update Role' }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- On-Call Schedule Modal -->
<div v-if="onCallModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 700px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-phone-alt"></i>
                </div>
                {{ onCallModal.mode === 'add' ? 'Schedule On-Call Duty' : 'Edit On-Call Schedule' }}
            </div>
            <button class="modal-close-elegant" @click="onCallModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-permission-banner">
            <i class="fas fa-calendar-check"></i>
            <div>
                <strong>Schedule Management:</strong> 
                <span>Ensure 24/7 coverage for critical patient care</span>
            </div>
        </div>
        
        <form @submit.prevent="saveOnCallSchedule" class="modal-form">
            <div class="form-container-elegant">
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Schedule Details</div>
                            <div class="form-section-description">Define the on-call duty period and assignments</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                    Duty Date
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="onCallModal.form.duty_date" 
                                       required>
                                <i class="fas fa-calendar-alt form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    Shift Type
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="onCallModal.form.shift_type" 
                                    required>
                                <option value="" disabled>Select shift type...</option>
                                <option value="primary_call">Primary Call (08:00 - 20:00)</option>
                                <option value="backup_call">Backup Call (20:00 - 08:00)</option>
                                <option value="weekend_call">Weekend Call (24 hours)</option>
                                <option value="holiday_call">Holiday Call (24 hours)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-user-md"></i>
                                    </span>
                                    Primary Physician
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="onCallModal.form.primary_physician_id" 
                                    required>
                                <option value="" disabled>Select primary physician...</option>
                                <option v-for="doctor in availableDoctors" 
                                        :key="doctor.id" 
                                        :value="doctor.id">
                                    {{ doctor.full_name }} ({{ doctor.staff_id }})
                                </option>
                            </select>
                            <div class="form-help" v-if="onCallModal.form.primary_physician_id">
                                <i class="fas fa-info-circle"></i>
                                <span>Next available: {{ getNextAvailableDate(onCallModal.form.primary_physician_id) }}</span>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-user-plus"></i>
                                    </span>
                                    Backup Physician
                                </span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="onCallModal.form.backup_physician_id">
                                <option value="">None (No backup)</option>
                                <option v-for="doctor in availableDoctors" 
                                        :key="doctor.id" 
                                        :value="doctor.id"
                                        :disabled="doctor.id === onCallModal.form.primary_physician_id">
                                    {{ doctor.full_name }} ({{ doctor.staff_id }})
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-play-circle"></i>
                                    </span>
                                    Start Time
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="time" 
                                       class="form-input-elegant"
                                       v-model="onCallModal.form.start_time" 
                                       required>
                                <i class="fas fa-clock form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-stop-circle"></i>
                                    </span>
                                    End Time
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="time" 
                                       class="form-input-elegant"
                                       v-model="onCallModal.form.end_time" 
                                       required>
                                <i class="fas fa-clock form-input-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-stethoscope"></i>
                                </span>
                                Coverage Notes
                            </span>
                        </label>
                        <textarea class="form-textarea-elegant" 
                                  v-model="onCallModal.form.coverage_notes"
                                  rows="3"
                                  placeholder="Add any special instructions, contact information, or coverage details..."></textarea>
                        <div class="form-help">
                            <i class="fas fa-lightbulb"></i>
                            <span>Include emergency contact numbers, specialty coverage needs, or location details</span>
                        </div>
                    </div>
                    
                    <!-- Schedule Conflict Warning -->
                    <div v-if="hasScheduleConflict" class="conflict-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Schedule Conflict Detected!</strong>
                            <span>The selected physician has an overlapping schedule on this date.</span>
                        </div>
                    </div>
                    
                    <!-- Available Physicians List -->
                    <div class="available-physicians">
                        <h4 class="available-title">
                            <i class="fas fa-user-check"></i>
                            Available Physicians for {{ formatDate(onCallModal.form.duty_date) }}
                        </h4>
                        <div class="physicians-list">
                            <div v-for="doctor in availableDoctorsForDate" 
                                 :key="doctor.id"
                                 class="physician-item"
                                 :class="{ selected: doctor.id === onCallModal.form.primary_physician_id }"
                                 @click="onCallModal.form.primary_physician_id = doctor.id">
                                <div class="physician-avatar">
                                    {{ getInitials(doctor.full_name) }}
                                </div>
                                <div class="physician-info">
                                    <div class="physician-name">{{ doctor.full_name }}</div>
                                    <div class="physician-details">
                                        <span class="physician-id">{{ doctor.staff_id }}</span>
                                        <span class="physician-specialty">{{ doctor.specialty }}</span>
                                    </div>
                                </div>
                                <div class="physician-status">
                                    <span class="status-badge available">Available</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions-elegant">
                    <div class="form-validation">
                        <i class="fas fa-shield-alt"></i>
                        <span>Ensure 24/7 coverage compliance</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" 
                                class="btn-secondary-elegant" 
                                @click="onCallModal.show = false">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="btn-primary-elegant" 
                                :disabled="saving || hasScheduleConflict">
                            <span v-if="saving" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-calendar-plus"></i>
                                {{ onCallModal.mode === 'add' ? 'Schedule On-Call' : 'Update Schedule' }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Leave Request Modal -->
<div v-if="leaveRequestModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 650px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-calendar-times"></i>
                </div>
                {{ leaveRequestModal.mode === 'add' ? 'Request Leave' : leaveRequestModal.mode === 'review' ? 'Review Leave Request' : 'Edit Leave Request' }}
            </div>
            <button class="modal-close-elegant" @click="leaveRequestModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-permission-banner">
            <i class="fas fa-user-clock"></i>
            <div>
                <strong>Leave Management:</strong> 
                <span v-if="leaveRequestModal.mode === 'review'">Review and approve time-off requests</span>
                <span v-else>Submit your time-off request for approval</span>
            </div>
        </div>
        
        <form @submit.prevent="saveLeaveRequest" class="modal-form">
            <div class="form-container-elegant">
                <!-- Requestor Info (for reviewers) -->
                <div v-if="leaveRequestModal.mode === 'review' && leaveRequestModal.request" class="requestor-info">
                    <div class="requestor-header">
                        <div class="requestor-avatar">
                            {{ getInitials(leaveRequestModal.request.staff_name) }}
                        </div>
                        <div class="requestor-details">
                            <div class="requestor-name">{{ leaveRequestModal.request.staff_name }}</div>
                            <div class="requestor-meta">
                                <span class="requestor-id">ID: {{ leaveRequestModal.request.staff_id }}</span>
                                <span class="requestor-dept">Department: {{ leaveRequestModal.request.department }}</span>
                            </div>
                        </div>
                        <div class="request-status">
                            <span class="status-badge" :class="`status-${leaveRequestModal.request.status}`">
                                {{ leaveRequestModal.request.status }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Leave Period</div>
                            <div class="form-section-description">Specify the start and end dates of your leave</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-plane-departure"></i>
                                    </span>
                                    Start Date
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="leaveRequestModal.form.start_date" 
                                       required
                                       :min="minLeaveDate"
                                       :max="leaveRequestModal.form.end_date">
                                <i class="fas fa-calendar form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-plane-arrival"></i>
                                    </span>
                                    End Date
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="leaveRequestModal.form.end_date" 
                                       required
                                       :min="leaveRequestModal.form.start_date"
                                       :max="maxLeaveDate">
                                <i class="fas fa-calendar form-input-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Duration Calculator -->
                    <div class="duration-calculator">
                        <div class="duration-display">
                            <i class="fas fa-calculator"></i>
                            <div>
                                <span class="duration-label">Total Duration:</span>
                                <span class="duration-value">{{ calculateLeaveDuration() }} days</span>
                            </div>
                        </div>
                        <div class="working-days">
                            <i class="fas fa-briefcase"></i>
                            <span>{{ calculateWorkingDays() }} working days</span>
                        </div>
                    </div>
                    
                    <!-- Calendar Preview -->
                    <div class="calendar-preview">
                        <h4 class="calendar-title">Calendar Preview</h4>
                        <div class="calendar-grid">
                            <div v-for="day in leaveDaysPreview" 
                                 :key="day.date"
                                 class="calendar-day"
                                 :class="{
                                     'weekend': day.isWeekend,
                                     'holiday': day.isHoliday,
                                     'selected': day.isInLeavePeriod
                                 }">
                                <div class="day-number">{{ day.day }}</div>
                                <div class="day-name">{{ day.name }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Leave Details</div>
                            <div class="form-section-description">Provide details about your leave request</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-tags"></i>
                                    </span>
                                    Leave Type
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="leaveRequestModal.form.leave_type" 
                                    required>
                                <option value="" disabled>Select leave type...</option>
                                <option value="vacation">Vacation</option>
                                <option value="sick_leave">Sick Leave</option>
                                <option value="personal">Personal Leave</option>
                                <option value="maternity">Maternity Leave</option>
                                <option value="paternity">Paternity Leave</option>
                                <option value="educational">Educational Leave</option>
                                <option value="bereavement">Bereavement Leave</option>
                                <option value="medical">Medical Leave</option>
                            </select>
                        </div>
                        
                        <div v-if="leaveRequestModal.mode === 'review'" class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                    Status
                                </span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="leaveRequestModal.form.status">
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-comment-alt"></i>
                                </span>
                                Reason for Leave
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <textarea class="form-textarea-elegant" 
                                  v-model="leaveRequestModal.form.reason"
                                  rows="4"
                                  required
                                  placeholder="Please provide details about your leave request..."></textarea>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            <span>Be specific about the purpose of your leave. For medical leave, no diagnosis details needed.</span>
                        </div>
                    </div>
                    
                    <!-- Documents Upload -->
                    <div v-if="leaveRequestModal.form.leave_type === 'medical' || leaveRequestModal.form.leave_type === 'educational'" 
                         class="documents-upload">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-file-upload"></i>
                                </span>
                                Supporting Documents
                            </span>
                        </label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drop supporting documents here or click to browse</p>
                            <input type="file" 
                                   class="file-input"
                                   multiple
                                   accept=".pdf,.doc,.docx,.jpg,.png"
                                   @change="handleDocumentUpload">
                        </div>
                        <div v-if="uploadedDocuments.length > 0" class="uploaded-files">
                            <div v-for="doc in uploadedDocuments" 
                                 :key="doc.id"
                                 class="document-item">
                                <i class="fas fa-file-pdf"></i>
                                <span class="document-name">{{ doc.name }}</span>
                                <button class="document-remove" @click="removeDocument(doc.id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Approver Section (for reviewers) -->
                    <div v-if="leaveRequestModal.mode === 'review'" class="approver-section">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                    Approver Notes
                                </span>
                            </label>
                            <textarea class="form-textarea-elegant" 
                                      v-model="leaveRequestModal.form.approver_notes"
                                      rows="3"
                                      placeholder="Add approval notes, conditions, or feedback..."></textarea>
                        </div>
                        
                        <!-- Approval Quick Actions -->
                        <div class="approval-actions">
                            <button type="button" 
                                    class="btn-success-elegant"
                                    @click="approveLeaveRequest(leaveRequestModal.request)"
                                    v-if="leaveRequestModal.request?.status === 'pending'">
                                <i class="fas fa-check"></i> Approve Request
                            </button>
                            <button type="button" 
                                    class="btn-danger-elegant"
                                    @click="rejectLeaveRequest(leaveRequestModal.request)"
                                    v-if="leaveRequestModal.request?.status === 'pending'">
                                <i class="fas fa-times"></i> Reject Request
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Leave Balance -->
                <div class="leave-balance">
                    <h4 class="balance-title">
                        <i class="fas fa-chart-pie"></i>
                        Your Leave Balance
                    </h4>
                    <div class="balance-grid">
                        <div class="balance-item vacation">
                            <div class="balance-label">Vacation</div>
                            <div class="balance-values">
                                <span class="balance-used">Used: 5 days</span>
                                <span class="balance-remaining">Remaining: 15 days</span>
                            </div>
                            <div class="balance-bar">
                                <div class="bar-fill" style="width: 25%"></div>
                            </div>
                        </div>
                        <div class="balance-item sick">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-values">
                                <span class="balance-used">Used: 2 days</span>
                                <span class="balance-remaining">Remaining: 8 days</span>
                            </div>
                            <div class="balance-bar">
                                <div class="bar-fill" style="width: 20%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions-elegant">
                    <div class="form-validation">
                        <div v-if="hasLeaveConflict" class="conflict-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Potential schedule conflict detected</span>
                        </div>
                        <div v-else class="validation-success">
                            <i class="fas fa-check-circle"></i>
                            <span>Leave request is valid</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" 
                                class="btn-secondary-elegant" 
                                @click="leaveRequestModal.show = false">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="btn-primary-elegant" 
                                :disabled="saving || hasLeaveConflict">
                            <span v-if="saving" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-paper-plane"></i>
                                {{ leaveRequestModal.mode === 'add' ? 'Submit Request' : 
                                   leaveRequestModal.mode === 'review' ? 'Update Review' : 'Update Request' }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Announcement Modal -->
<div v-if="announcementModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 800px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                {{ announcementModal.mode === 'add' ? 'Create Announcement' : 'Edit Announcement' }}
            </div>
            <button class="modal-close-elegant" @click="announcementModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-permission-banner">
            <i class="fas fa-megaphone"></i>
            <div>
                <strong>Announcement Publisher:</strong> 
                <span>Communicate important updates to the department</span>
            </div>
        </div>
        
        <form @submit.prevent="saveAnnouncement" class="modal-form">
            <div class="form-container-elegant">
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Announcement Content</div>
                            <div class="form-section-description">Create clear and informative announcements</div>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-heading"></i>
                                </span>
                                Announcement Title
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="form-input-with-icon">
                            <input type="text" 
                                   class="form-input-elegant"
                                   v-model="announcementModal.form.announcement_title" 
                                   required
                                   placeholder="Enter a clear and descriptive title...">
                            <i class="fas fa-font form-input-icon"></i>
                        </div>
                        <div class="title-preview">
                            <span class="preview-label">Preview:</span>
                            <span class="preview-text">{{ announcementModal.form.announcement_title || 'Your title will appear here' }}</span>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-align-left"></i>
                                </span>
                                Announcement Content
                            </span>
                            <span class="required-indicator">*</span>
                        </label>
                        <div class="rich-text-editor">
                            <div class="editor-toolbar">
                                <button type="button" class="toolbar-btn" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="toolbar-btn" title="Image">
                                    <i class="fas fa-image"></i>
                                </button>
                            </div>
                            <textarea class="form-textarea-elegant editor-content"
                                      v-model="announcementModal.form.announcement_content"
                                      rows="8"
                                      required
                                      placeholder="Write your announcement here..."></textarea>
                            <div class="editor-stats">
                                <span class="word-count">{{ wordCount }} words</span>
                                <span class="char-count">{{ charCount }} characters</span>
                            </div>
                        </div>
                        <div class="content-tips">
                            <i class="fas fa-lightbulb"></i>
                            <span>Tip: Keep announcements concise, use bullet points for clarity, and include action items when needed.</span>
                        </div>
                    </div>
                    
                    <!-- Content Preview -->
                    <div class="content-preview" v-if="announcementModal.form.announcement_content">
                        <h4 class="preview-title">
                            <i class="fas fa-eye"></i>
                            Content Preview
                        </h4>
                        <div class="preview-content">
                            {{ announcementModal.form.announcement_content.substring(0, 200) }}...
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Distribution Settings</div>
                            <div class="form-section-description">Control when and to whom this announcement is visible</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-calendar-plus"></i>
                                    </span>
                                    Publish Date
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="announcementModal.form.publish_start_date" 
                                       required
                                       :min="today">
                                <i class="fas fa-calendar-plus form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-calendar-times"></i>
                                    </span>
                                    Expiry Date
                                </span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="announcementModal.form.publish_end_date"
                                       :min="announcementModal.form.publish_start_date">
                                <i class="fas fa-calendar-times form-input-icon"></i>
                            </div>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                <span>Leave empty for permanent announcement</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </span>
                                    Priority Level
                                </span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="announcementModal.form.priority_level">
                                <option value="low">Low Priority (Information)</option>
                                <option value="medium">Medium Priority (Important)</option>
                                <option value="high">High Priority (Urgent)</option>
                                <option value="urgent">Urgent (Critical)</option>
                            </select>
                            <div class="priority-preview" :class="announcementModal.form.priority_level">
                                <i class="fas fa-bell"></i>
                                <span>This will appear as a {{ announcementModal.form.priority_level }} priority announcement</span>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    Target Audience
                                </span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="announcementModal.form.target_audience">
                                <option value="all">All Staff</option>
                                <option value="residents">Residents Only</option>
                                <option value="attendings">Attending Physicians</option>
                                <option value="nursing">Nursing Staff</option>
                                <option value="admin">Administrative Staff</option>
                                <option value="specific">Specific Departments</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Department Selection (if specific audience) -->
                    <div v-if="announcementModal.form.target_audience === 'specific'" 
                         class="department-selection">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <i class="fas fa-building"></i>
                                Select Departments
                            </span>
                        </label>
                        <div class="department-checkboxes">
                            <div v-for="dept in departments" 
                                 :key="dept.id"
                                 class="checkbox-item">
                                <input type="checkbox" 
                                       :id="`dept-${dept.id}`"
                                       :value="dept.id"
                                       v-model="selectedDepartments">
                                <label :for="`dept-${dept.id}`">
                                    <i class="fas fa-hospital"></i>
                                    {{ dept.name }}
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="notification-settings">
                        <div class="setting-toggle">
                            <div class="toggle-label">
                                <i class="fas fa-bell"></i>
                                <div>
                                    <div class="toggle-title">Send Email Notification</div>
                                    <div class="toggle-description">All selected recipients will receive an email</div>
                                </div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" 
                                       v-model="sendEmailNotification"
                                       id="email-notification">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        
                        <div class="setting-toggle">
                            <div class="toggle-label">
                                <i class="fas fa-sms"></i>
                                <div>
                                    <div class="toggle-title">Send SMS Alert</div>
                                    <div class="toggle-description">For urgent announcements only</div>
                                </div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" 
                                       v-model="sendSMSNotification"
                                       id="sms-notification"
                                       :disabled="announcementModal.form.priority_level !== 'urgent'">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                        
                        <div class="setting-toggle">
                            <div class="toggle-label">
                                <i class="fas fa-pushpin"></i>
                                <div>
                                    <div class="toggle-title">Pin to Dashboard</div>
                                    <div class="toggle-description">Keep announcement visible at top</div>
                                </div>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" 
                                       v-model="pinToDashboard"
                                       id="pin-dashboard">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Count -->
                <div class="recipient-count">
                    <div class="count-card">
                        <i class="fas fa-user-friends"></i>
                        <div class="count-details">
                            <div class="count-number">{{ recipientCount }}</div>
                            <div class="count-label">Recipients</div>
                        </div>
                    </div>
                    <div class="recipient-breakdown">
                        <div class="breakdown-item" v-for="group in recipientBreakdown" :key="group.name">
                            <span class="breakdown-name">{{ group.name }}</span>
                            <span class="breakdown-count">{{ group.count }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions-elegant">
                    <div class="form-validation">
                        <div v-if="isValidAnnouncement" class="validation-success">
                            <i class="fas fa-check-circle"></i>
                            <span>Announcement ready for publishing</span>
                        </div>
                        <div v-else class="validation-warning">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Complete all required fields</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" 
                                class="btn-secondary-elegant" 
                                @click="saveDraft">
                            <i class="fas fa-save"></i> Save Draft
                        </button>
                        
                        <button type="button" 
                                class="btn-outline-elegant" 
                                @click="previewAnnouncement">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        
                        <button type="submit" 
                                class="btn-primary-elegant" 
                                :disabled="saving || !isValidAnnouncement">
                            <span v-if="saving" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-paper-plane"></i>
                                {{ announcementModal.mode === 'add' ? 'Publish Announcement' : 'Update Announcement' }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Training Unit Modal -->
<div v-if="trainingUnitModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 750px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-hospital-alt"></i>
                </div>
                {{ trainingUnitModal.mode === 'add' ? 'Create Training Unit' : 'Edit Training Unit' }}
            </div>
            <button class="modal-close-elegant" @click="trainingUnitModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-permission-banner">
            <i class="fas fa-graduation-cap"></i>
            <div>
                <strong>Training Unit Management:</strong> 
                <span>Configure clinical training environments for residents</span>
            </div>
        </div>
        
        <form @submit.prevent="saveTrainingUnit" class="modal-form">
            <div class="form-container-elegant">
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Unit Information</div>
                            <div class="form-section-description">Define the training unit's basic details</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-hospital"></i>
                                    </span>
                                    Unit Name
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="text" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.unit_name" 
                                       required
                                       placeholder="e.g., Pulmonary Intensive Care Unit">
                                <i class="fas fa-building form-input-icon"></i>
                            </div>
                            <div class="unit-code">
                                <span class="code-label">Unit Code:</span>
                                <span class="code-value">{{ generateUnitCode() }}</span>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-stethoscope"></i>
                                    </span>
                                    Specialty
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="trainingUnitModal.form.specialty" 
                                    required>
                                <option value="" disabled>Select specialty...</option>
                                <option value="pulmonology">Pulmonology</option>
                                <option value="critical_care">Critical Care</option>
                                <option value="sleep_medicine">Sleep Medicine</option>
                                <option value="interventional_pulmonology">Interventional Pulmonology</option>
                                <option value="allergy_immunology">Allergy & Immunology</option>
                                <option value="thoracic_surgery">Thoracic Surgery</option>
                                <option value="pulmonary_rehabilitation">Pulmonary Rehabilitation</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group-elegant">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <span class="form-label-icon">
                                    <i class="fas fa-align-left"></i>
                                </span>
                                Description
                            </span>
                        </label>
                        <textarea class="form-textarea-elegant" 
                                  v-model="trainingUnitModal.form.unit_description"
                                  rows="4"
                                  placeholder="Describe the training unit's focus, facilities, and training objectives..."></textarea>
                        <div class="description-tips">
                            <i class="fas fa-lightbulb"></i>
                            <span>Include key procedures, patient population, and training opportunities</span>
                        </div>
                    </div>
                    
                    <!-- Location Details -->
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </span>
                                    Location
                                </span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="text" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.location"
                                       placeholder="e.g., Main Hospital, 3rd Floor">
                                <i class="fas fa-location-arrow form-input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-phone-alt"></i>
                                    </span>
                                    Contact Number
                                </span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="tel" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.contact_number"
                                       placeholder="e.g., (555) 123-4567">
                                <i class="fas fa-phone form-input-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Capacity & Scheduling</div>
                            <div class="form-section-description">Configure training capacity and scheduling parameters</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    Maximum Residents
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="capacity-input">
                                <input type="number" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.maximum_residents" 
                                       required
                                       min="1" 
                                       max="50">
                                <div class="capacity-slider">
                                    <input type="range" 
                                           v-model="trainingUnitModal.form.maximum_residents"
                                           min="1" 
                                           max="50"
                                           class="slider">
                                </div>
                            </div>
                            <div class="capacity-preview">
                                <div class="capacity-bar">
                                    <div class="bar-fill" :style="{ width: (trainingUnitModal.form.current_residents || 0) / trainingUnitModal.form.maximum_residents * 100 + '%' }"></div>
                                </div>
                                <div class="capacity-stats">
                                    <span class="current-capacity">{{ trainingUnitModal.form.current_residents || 0 }} current</span>
                                    <span class="max-capacity">{{ trainingUnitModal.form.maximum_residents }} maximum</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                    Rotation Duration
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="duration-select">
                                <select class="form-select-elegant" 
                                        v-model="trainingUnitModal.form.rotation_duration"
                                        required>
                                    <option value="" disabled>Select duration...</option>
                                    <option value="4">4 weeks</option>
                                    <option value="6">6 weeks</option>
                                    <option value="8">8 weeks</option>
                                    <option value="12">12 weeks</option>
                                    <option value="24">24 weeks (6 months)</option>
                                    <option value="48">48 weeks (1 year)</option>
                                </select>
                                <div class="duration-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Standard rotation length for this unit</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule Configuration -->
                    <div class="schedule-configuration">
                        <h4 class="config-title">
                            <i class="fas fa-clock"></i>
                            Schedule Configuration
                        </h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <label class="config-label">Start Time</label>
                                <input type="time" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.start_time"
                                       value="07:00">
                            </div>
                            <div class="config-item">
                                <label class="config-label">End Time</label>
                                <input type="time" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.end_time"
                                       value="19:00">
                            </div>
                            <div class="config-item">
                                <label class="config-label">Call Schedule</label>
                                <select class="form-select-elegant" 
                                        v-model="trainingUnitModal.form.call_schedule">
                                    <option value="q4">Every 4th Night</option>
                                    <option value="q3">Every 3rd Night</option>
                                    <option value="home_call">Home Call</option>
                                    <option value="no_call">No Call Schedule</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Required Competencies -->
                    <div class="competencies-section">
                        <h4 class="competencies-title">
                            <i class="fas fa-tasks"></i>
                            Required Competencies
                        </h4>
                        <div class="competencies-list">
                            <div v-for="competency in competencies" 
                                 :key="competency.id"
                                 class="competency-item">
                                <input type="checkbox" 
                                       :id="`comp-${competency.id}`"
                                       :value="competency.id"
                                       v-model="selectedCompetencies">
                                <label :for="`comp-${competency.id}`">
                                    <i class="fas fa-check-circle"></i>
                                    {{ competency.name }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Supervision & Faculty</div>
                            <div class="form-section-description">Assign supervising faculty and configure supervision levels</div>
                        </div>
                    </div>
                    
                    <!-- Faculty Selection -->
                    <div class="faculty-selection">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <i class="fas fa-user-tie"></i>
                                Supervising Faculty
                            </span>
                        </label>
                        <div class="faculty-search">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" 
                                       v-model="facultySearch"
                                       placeholder="Search faculty by name...">
                            </div>
                        </div>
                        <div class="faculty-list">
                            <div v-for="faculty in filteredFaculty" 
                                 :key="faculty.id"
                                 class="faculty-item"
                                 :class="{ selected: isFacultySelected(faculty.id) }"
                                 @click="toggleFacultySelection(faculty.id)">
                                <div class="faculty-avatar">
                                    {{ getInitials(faculty.full_name) }}
                                </div>
                                <div class="faculty-info">
                                    <div class="faculty-name">{{ faculty.full_name }}</div>
                                    <div class="faculty-details">
                                        <span class="faculty-title">{{ faculty.title }}</span>
                                        <span class="faculty-specialty">{{ faculty.specialty }}</span>
                                    </div>
                                </div>
                                <div class="faculty-actions">
                                    <button type="button" 
                                            class="btn-icon-elegant"
                                            @click.stop="setPrimarySupervisor(faculty.id)">
                                        <i class="fas fa-crown"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Faculty -->
                        <div v-if="selectedFacultyList.length > 0" class="selected-faculty">
                            <h5 class="selected-title">Selected Faculty ({{ selectedFacultyList.length }})</h5>
                            <div class="selected-list">
                                <div v-for="faculty in selectedFacultyList" 
                                     :key="faculty.id"
                                     class="selected-item">
                                    <div class="selected-avatar">
                                        {{ getInitials(faculty.full_name) }}
                                        <span v-if="faculty.is_primary" class="primary-badge">
                                            <i class="fas fa-crown"></i>
                                        </span>
                                    </div>
                                    <div class="selected-name">{{ faculty.full_name }}</div>
                                    <button type="button" 
                                            class="remove-faculty"
                                            @click="removeFaculty(faculty.id)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Supervision Ratio -->
                    <div class="supervision-ratio">
                        <label class="form-label-elegant">
                            <span class="form-label-text">
                                <i class="fas fa-balance-scale"></i>
                                Supervision Ratio
                            </span>
                        </label>
                        <div class="ratio-config">
                            <div class="ratio-input">
                                <span class="ratio-label">Resident : Faculty</span>
                                <div class="ratio-controls">
                                    <input type="number" 
                                           class="form-input-elegant"
                                           v-model="trainingUnitModal.form.resident_ratio"
                                           min="1" 
                                           max="10"
                                           value="2">
                                    <span class="ratio-separator">:</span>
                                    <input type="number" 
                                           class="form-input-elegant"
                                           v-model="trainingUnitModal.form.faculty_ratio"
                                           min="1" 
                                           max="10"
                                           value="1">
                                </div>
                            </div>
                            <div class="ratio-info">
                                <i class="fas fa-info-circle"></i>
                                <span>ACCME guideline: Maximum 2:1 resident to faculty ratio</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status & Activation -->
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-toggle-on"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Status & Activation</div>
                            <div class="form-section-description">Control the unit's operational status</div>
                        </div>
                    </div>
                    
                    <div class="form-grid-elegant">
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-power-off"></i>
                                    </span>
                                    Unit Status
                                </span>
                                <span class="required-indicator">*</span>
                            </label>
                            <select class="form-select-elegant" 
                                    v-model="trainingUnitModal.form.unit_status" 
                                    required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="maintenance">Under Maintenance</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        
                        <div class="form-group-elegant">
                            <label class="form-label-elegant">
                                <span class="form-label-text">
                                    <span class="form-label-icon">
                                        <i class="fas fa-calendar-check"></i>
                                    </span>
                                    Activation Date
                                </span>
                            </label>
                            <div class="form-input-with-icon">
                                <input type="date" 
                                       class="form-input-elegant"
                                       v-model="trainingUnitModal.form.activation_date">
                                <i class="fas fa-calendar form-input-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Review Checklist -->
                    <div class="review-checklist">
                        <h4 class="checklist-title">
                            <i class="fas fa-clipboard-check"></i>
                            Activation Checklist
                        </h4>
                        <div class="checklist-items">
                            <div class="checklist-item" :class="{ completed: checklists.faculty }">
                                <i class="fas" :class="checklists.faculty ? 'fa-check-circle' : 'fa-circle'"></i>
                                <span>Faculty assigned and confirmed</span>
                            </div>
                            <div class="checklist-item" :class="{ completed: checklists.schedule }">
                                <i class="fas" :class="checklists.schedule ? 'fa-check-circle' : 'fa-circle'"></i>
                                <span>Schedule configured</span>
                            </div>
                            <div class="checklist-item" :class="{ completed: checklists.resources }">
                                <i class="fas" :class="checklists.resources ? 'fa-check-circle' : 'fa-circle'"></i>
                                <span>Resources and equipment available</span>
                            </div>
                            <div class="checklist-item" :class="{ completed: checklists.training }">
                                <i class="fas" :class="checklists.training ? 'fa-check-circle' : 'fa-circle'"></i>
                                <span>Training materials prepared</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions-elegant">
                    <div class="form-validation">
                        <div v-if="isUnitConfigValid" class="validation-success">
                            <i class="fas fa-check-circle"></i>
                            <span>Unit configuration is valid</span>
                        </div>
                        <div v-else class="validation-warning">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Complete all required fields</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" 
                                class="btn-secondary-elegant" 
                                @click="trainingUnitModal.show = false">
                            Cancel
                        </button>
                        
                        <button type="button" 
                                class="btn-outline-elegant" 
                                @click="previewUnit"
                                v-if="trainingUnitModal.mode === 'add'">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        
                        <button type="submit" 
                                class="btn-primary-elegant" 
                                :disabled="saving || !isUnitConfigValid">
                            <span v-if="saving" class="loading-spinner-small"></span>
                            <span v-else>
                                <i class="fas fa-save"></i>
                                {{ trainingUnitModal.mode === 'add' ? 'Create Training Unit' : 'Update Training Unit' }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Resident Rotation Modal -->
<div v-if="rotationModal.show" class="modal-overlay-elegant">
    <div class="modal-elegant" style="max-width: 850px;">
        <div class="modal-header-elegant">
            <div class="modal-title-elegant">
                <div class="modal-title-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                {{ rotationModal.mode === 'add' ? 'Schedule Rotation' : 'Edit Rotation' }}
            </div>
            <button class="modal-close-elegant" @click="rotationModal.show = false">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-permission-banner">
            <i class="fas fa-user-graduate"></i>
            <div>
                <strong>Rotation Management:</strong> 
                <span>Schedule and track resident clinical rotations</span>
            </div>
        </div>
        
        <form @submit.prevent="saveRotation" class="modal-form">
            <div class="form-container-elegant">
                <!-- Quick Selection Wizard -->
                <div v-if="rotationModal.mode === 'add'" class="selection-wizard">
                    <div class="wizard-steps">
                        <div class="wizard-step active">
                            <div class="step-number">1</div>
                            <div class="step-label">Select Resident</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-number">2</div>
                            <div class="step-label">Choose Unit</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-number">3</div>
                            <div class="step-label">Set Dates</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-number">4</div>
                            <div class="step-label">Confirm</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Resident Selection</div>
                            <div class="form-section-description">Select the resident for this rotation</div>
                        </div>
                    </div>
                    
                    <!-- Resident Search and Filter -->
                    <div class="resident-selection">
                        <div class="selection-header">
                            <div class="search-filter">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" 
                                           v-model="residentSearch"
                                           placeholder="Search residents by name or ID...">
                                </div>
                                <div class="filter-options">
                                    <select class="form-select-elegant" 
                                            v-model="residentFilter.category"
                                            style="width: 150px;">
                                        <option value="">All Categories</option>
                                        <option value="pgy1">PGY-1</option>
                                        <option value="pgy2">PGY-2</option>
                                        <option value="pgy3">PGY-3</option>
                                        <option value="pgy4">PGY-4</option>
                                        <option value="pgy5">PGY-5</option>
                                    </select>
                                    <select class="form-select-elegant" 
                                            v-model="residentFilter.status"
                                            style="width: 150px;">
                                        <option value="">All Status</option>
                                        <option value="available">Available</option>
                                        <option value="on_rotation">On Rotation</option>
                                        <option value="on_leave">On Leave</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Residents Grid -->
                        <div class="residents-grid">
                            <div v-for="resident in filteredResidents" 
                                 :key="resident.id"
                                 class="resident-card"
                                 :class="{ selected: rotationModal.form.resident_id === resident.id }"
                                 @click="selectResident(resident)">
                                <div class="resident-avatar">
                                    {{ getInitials(resident.full_name) }}
                                    <div class="resident-status" :class="resident.status"></div>
                                </div>
                                <div class="resident-info">
                                    <div class="resident-name">{{ resident.full_name }}</div>
                                    <div class="resident-details">
                                        <span class="resident-id">{{ resident.staff_id }}</span>
                                        <span class="resident-category">{{ formatResidentCategory(resident.resident_category) }}</span>
                                    </div>
                                    <div class="resident-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-hospital"></i>
                                            <span>{{ resident.current_unit || 'No current rotation' }}</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-calendar"></i>
                                            <span>Available: {{ resident.available_date ? formatDateShort(resident.available_date) : 'Now' }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="resident-actions">
                                    <button type="button" 
                                            class="btn-icon-elegant"
                                            @click.stop="viewResidentSchedule(resident.id)">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Resident Info -->
                        <div v-if="selectedResident" class="selected-resident-info">
                            <div class="selected-header">
                                <div class="selected-avatar">
                                    {{ getInitials(selectedResident.full_name) }}
                                </div>
                                <div class="selected-details">
                                    <div class="selected-name">{{ selectedResident.full_name }}</div>
                                    <div class="selected-meta">
                                        <span class="selected-id">{{ selectedResident.staff_id }}</span>
                                        <span class="selected-category">{{ formatResidentCategory(selectedResident.resident_category) }}</span>
                                        <span class="selected-year">Year: {{ selectedResident.training_year }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="selected-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Completed Rotations</div>
                                    <div class="stat-value">{{ selectedResident.completed_rotations || 0 }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Current Rotation</div>
                                    <div class="stat-value">{{ selectedResident.current_unit || 'None' }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Days Available</div>
                                    <div class="stat-value">{{ selectedResident.days_available || 0 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="rotationModal.form.resident_id" class="form-section-elegant">
                    <div class="form-section-header">
                        <div class="form-section-icon">
                            <i class="fas fa-hospital-alt"></i>
                        </div>
                        <div>
                            <div class="form-section-title">Training Unit Selection</div>
                            <div class="form-section-description">Choose the training unit for this rotation</div>
                        </div>
                    </div>
                    
                    <!-- Unit Selection -->
                    <div class="unit-selection">
                        <div class="unit-filters">
                            <div class="filter-group">
                                <label>Filter by:</label>
                                <select class="form-select-elegant" 
                                        v-model="unitFilter.specialty"
                                        style="width: 200px;">
                                    <option value="">All Specialties</option>
                                    <option value="pulmonology">Pulmonology</option>
                                    <option value="critical_care">Critical Care</option>
                                    <option value="sleep_medicine">Sleep Medicine</option>
                                </select>
                                <select class="form-select-elegant" 
                                        v-model="unitFilter.availability"
                                        style="width: 180px;">
                                    <option value="">All Availability</option>
                                    <option value="available">Available Now</option>
                                    <option value="full">Full Capacity</option>
                                    <option value="limited">Limited Spots</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Units Grid -->
                        <div class="units-grid">
                            <div v-for="unit in filteredUnits" 
                                 :key="unit.id"
                                 class="unit-card"
                                 :class="{ 
                                     selected: rotationModal.form.training_unit_id === unit.id,
                                     full: unit.current_residents >= unit.maximum_residents
                                 }"
                                 @click="selectUnit(unit)">
                                <div class="unit-header">
                                    <div class="unit-icon">
                                        <i class="fas fa-hospital"></i>
                                    </div>
                                    <div class="unit-info">
                                        <div class="unit-name">{{ unit.unit_name }}</div>
                                        <div class="unit-specialty">{{ unit.specialty }}</div>
                                    </div>
                                    <div class="unit-capacity">
                                        <span class="capacity-text">{{ unit.current_residents }}/{{ unit.maximum_residents }}</span>
                                    </div>
                                </div>
                                <div class="unit-description">
                                    {{ unit.unit_description?.substring(0, 80) }}...
                                </div>
                                <div class="unit-details">
                                    <div class="detail-item">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ unit.rotation_duration }} weeks</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-user-md"></i>
                                        <span>{{ unit.supervisors?.length || 0 }} supervisors</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-star"></i>
                                        <span>{{ unit.rating || 'N/A' }}</span>
                                    </div>
                                </div>
                                <div class="unit-availability">
                                    <div class="availability-bar">
                                        <div class="bar-fill" :style="{ width: (unit.current_residents / unit.maximum_residents * 100) + '%' }"></div>
                                    </div>
                                    <div class="availability-text">
                                        <span v-if="unit.current_residents < unit.maximum_residents" class="available">
                                            {{ unit.maximum_residents - unit.current_residents }} spots available
                                        </span>
                                        <span v-else class="full">Full capacity</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Unit Info -->
                        <div v-if="selectedUnit" class="selected-unit-info">
                            <div class="unit-detail-header">
                                <div class="unit-detail-name">{{ selectedUnit.unit_name }}</div>
                                <div class="unit-detail-specialty">{{ selectedUnit.specialty }}</div>
                            </div>
                            <div class="unit-detail-content">
                                <div class="detail-section">
                                    <h5>Description</h5>
                                    <p>{{ selectedUnit.unit_description }}</p>
                                </div>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <i class="fas fa-calendar"></i>
                                        <div>
                                            <div class="detail-label">Rotation Duration</div>
                                            <div class="detail-value">{{ selectedUnit.rotation_duration }} weeks</div>
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-users"></i>
                                        <div>
                                            <div class="detail-label">Current Residents</div>
                                            <div class="detail-value">{{ selectedUnit.current_residents }} of {{ selectedUnit.maximum_residents }}</div>
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-user-md"></i>
                                        <div>
                                            <div class="detail-label">Supervising Faculty</div>
                                            <div class="detail-value">{{ selectedUnit.supervisors?.length || 0 }}</div>
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <div>
                                            <div class="detail-label">Location</div>
                                            <div class="detail-value">{{ selectedUnit.location }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Required Competencies -->
                                <div class="competencies-section">
                                    <h5>Required Competencies</h5>
                                    <div class="competencies-list">
                                        <span v-for="comp in selectedUnit.competencies" 
                                              :key="comp"
                                              class="competency-tag">
                                            {{ comp }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Continue with date selection, supervisor assignment, etc. -->
                <!-- (The rest of the modal follows similar patterns) -->
                
            </div>
        </form>
    </div>
</div>
<!-- Permission Manager Panel -->
<div class="permission-manager-panel" :class="{ open: showPermissionManager }">
    <div class="permission-manager-header">
        <div class="permission-manager-title">
            <i class="fas fa-user-shield"></i> Permission Manager
        </div>
        <button class="modal-close-elegant" @click="showPermissionManager = false">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="permission-manager-tabs">
        <div class="tabs-header">
            <button class="tab-btn" 
                    :class="{ active: activeTab === 'roles' }"
                    @click="activeTab = 'roles'">
                <i class="fas fa-users"></i>
                <span>Roles</span>
            </button>
            <button class="tab-btn" 
                    :class="{ active: activeTab === 'resources' }"
                    @click="activeTab = 'resources'">
                <i class="fas fa-database"></i>
                <span>Resources</span>
            </button>
            <button class="tab-btn" 
                    :class="{ active: activeTab === 'users' }"
                    @click="activeTab = 'users'">
                <i class="fas fa-user"></i>
                <span>Users</span>
            </button>
            <button class="tab-btn" 
                    :class="{ active: activeTab === 'audit' }"
                    @click="activeTab = 'audit'">
                <i class="fas fa-history"></i>
                <span>Audit Log</span>
            </button>
        </div>
        
        <!-- Roles Tab -->
        <div v-if="activeTab === 'roles'" class="tab-content">
            <div class="roles-grid">
                <div v-for="role in systemRoles" :key="role.id" class="role-card">
                    <div class="role-header">
                        <div class="role-icon">
                            <i class="fas" :class="getRoleIcon(role.level)"></i>
                        </div>
                        <div class="role-info">
                            <div class="role-name">{{ role.name }}</div>
                            <div class="role-level">
                                <span class="level-badge" :class="role.level">{{ role.level }}</span>
                            </div>
                        </div>
                        <div class="role-users">
                            <i class="fas fa-user-friends"></i>
                            <span>{{ role.user_count || 0 }} users</span>
                        </div>
                    </div>
                    <div class="role-description">{{ role.description }}</div>
                    <div class="role-permissions-summary">
                        <div class="permission-count">
                            <i class="fas fa-key"></i>
                            <span>{{ getPermissionCount(role) }} permissions</span>
                        </div>
                        <div class="permission-breakdown">
                            <span class="breakdown-item full">{{ getPermissionByLevel(role, 'full') }} full</span>
                            <span class="breakdown-item write">{{ getPermissionByLevel(role, 'write') }} write</span>
                            <span class="breakdown-item read">{{ getPermissionByLevel(role, 'read') }} read</span>
                        </div>
                    </div>
                    <div class="role-actions">
                        <button class="btn-icon-elegant" 
                                @click="editRole(role)"
                                title="Edit Role">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon-elegant" 
                                @click="cloneRole(role)"
                                title="Clone Role">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-icon-elegant danger" 
                                @click="deleteRole(role)"
                                :disabled="role.protected"
                                :title="role.protected ? 'Protected role' : 'Delete Role'">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Add New Role Card -->
                <div class="add-role-card" @click="showAddRoleModal">
                    <div class="add-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="add-text">Create New Role</div>
                    <div class="add-description">Define custom permission sets</div>
                </div>
            </div>
        </div>
        
        <!-- Resources Tab -->
        <div v-if="activeTab === 'resources'" class="tab-content">
            <div class="resources-container">
                <div class="resources-filters">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               v-model="resourceSearch"
                               placeholder="Search resources...">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn" 
                                :class="{ active: resourceFilter === 'all' }"
                                @click="resourceFilter = 'all'">
                            All Resources
                        </button>
                        <button class="filter-btn" 
                                :class="{ active: resourceFilter === 'medical' }"
                                @click="resourceFilter = 'medical'">
                            Medical
                        </button>
                        <button class="filter-btn" 
                                :class="{ active: resourceFilter === 'admin' }"
                                @click="resourceFilter = 'admin'">
                            Administrative
                        </button>
                    </div>
                </div>
                
                <div class="resources-grid">
                    <div v-for="(resource, key) in filteredResources" :key="key" class="resource-card">
                        <div class="resource-header">
                            <div class="resource-icon">
                                <i :class="getResourceIcon(key)"></i>
                            </div>
                            <div class="resource-name">{{ resource.name }}</div>
                            <div class="resource-actions">
                                <button class="btn-icon-elegant small"
                                        @click="expandResource(key)">
                                    <i class="fas" :class="expandedResource === key ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="resource-description">
                            {{ resource.description }}
                        </div>
                        
                        <!-- Permission Matrix -->
                        <div v-if="expandedResource === key" class="permission-matrix">
                            <div class="matrix-header">
                                <div class="matrix-cell">Action</div>
                                <div class="matrix-cell">Description</div>
                                <div class="matrix-cell">Roles</div>
                                <div class="matrix-cell">Status</div>
                            </div>
                            <div v-for="action in resource.actions" 
                                 :key="action"
                                 class="matrix-row">
                                <div class="matrix-cell action-name">
                                    <i :class="getActionIcon(action)"></i>
                                    <span>{{ formatActionName(action) }}</span>
                                </div>
                                <div class="matrix-cell action-desc">
                                    {{ getPermissionDescription(key, action) }}
                                </div>
                                <div class="matrix-cell action-roles">
                                    <div class="role-tags">
                                        <span v-for="role in getRolesWithPermission(key, action)" 
                                              :key="role.id"
                                              class="role-tag"
                                              :class="role.level">
                                            {{ role.name }}
                                        </span>
                                    </div>
                                </div>
                                <div class="matrix-cell action-status">
                                    <div class="permission-toggle-elegant">
                                        <input type="checkbox" 
                                               :checked="hasPermission(key, action)"
                                               @change="togglePermission(key, action, $event)">
                                        <span class="permission-toggle-slider-elegant" :class="getResourcePermissionLevel(key)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Permissions -->
                        <div class="quick-permissions">
                            <div class="quick-title">Quick Permissions</div>
                            <div class="quick-buttons">
                                <button class="quick-btn full" 
                                        @click="setAllPermissions(key, 'full')">
                                    Grant All
                                </button>
                                <button class="quick-btn write" 
                                        @click="setAllPermissions(key, 'write')">
                                    Read/Write
                                </button>
                                <button class="quick-btn read" 
                                        @click="setAllPermissions(key, 'read')">
                                    Read Only
                                </button>
                                <button class="quick-btn none" 
                                        @click="setAllPermissions(key, 'none')">
                                    Revoke All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users Tab -->
        <div v-if="activeTab === 'users'" class="tab-content">
            <div class="users-management">
                <div class="users-header">
                    <div class="users-search">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" 
                                   v-model="userSearch"
                                   placeholder="Search users...">
                        </div>
                        <button class="btn-primary-elegant" @click="showAddUserModal">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                </div>
                
                <div class="users-table">
                    <div class="table-header">
                        <div class="table-cell">User</div>
                        <div class="table-cell">Role</div>
                        <div class="table-cell">Permissions</div>
                        <div class="table-cell">Last Active</div>
                        <div class="table-cell">Status</div>
                        <div class="table-cell">Actions</div>
                    </div>
                    
                    <div v-for="user in filteredUsers" :key="user.id" class="table-row">
                        <div class="table-cell user-info">
                            <div class="user-avatar">
                                {{ getInitials(user.full_name) }}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ user.full_name }}</div>
                                <div class="user-email">{{ user.email }}</div>
                            </div>
                        </div>
                        <div class="table-cell user-role">
                            <div class="role-badge" :class="user.role_level">
                                {{ getUserRoleDisplay(user.user_role) }}
                            </div>
                        </div>
                        <div class="table-cell user-permissions">
                            <div class="permission-summary">
                                <div class="permission-dots">
                                    <span v-for="i in 3" 
                                          :key="i"
                                          class="permission-dot"
                                          :class="getPermissionDotClass(user, i)"></span>
                                </div>
                                <div class="permission-text">
                                    {{ getPermissionSummary(user) }}
                                </div>
                            </div>
                        </div>
                        <div class="table-cell user-activity">
                            <div class="activity-time">{{ formatDateTimeShort(user.last_active) }}</div>
                            <div class="activity-status" :class="getActivityStatus(user.last_active)">
                                {{ getActivityStatusText(user.last_active) }}
                            </div>
                        </div>
                        <div class="table-cell user-status">
                            <div class="status-indicator" :class="user.account_status"></div>
                            <span class="status-text">{{ user.account_status }}</span>
                        </div>
                        <div class="table-cell user-actions">
                            <div class="action-buttons">
                                <button class="btn-icon-elegant small"
                                        @click="editUserPermissions(user)"
                                        title="Edit Permissions">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn-icon-elegant small"
                                        @click="impersonateUser(user)"
                                        title="Impersonate User"
                                        v-if="hasPermission('system', 'admin')">
                                    <i class="fas fa-user-secret"></i>
                                </button>
                                <button class="btn-icon-elegant small danger"
                                        @click="deactivateUser(user)"
                                        :title="user.account_status === 'active' ? 'Deactivate User' : 'Activate User'">
                                    <i class="fas" :class="user.account_status === 'active' ? 'fa-user-slash' : 'fa-user-check'"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="permission-manager-footer">
        <div class="footer-info">
            <div class="info-item">
                <i class="fas fa-sync-alt"></i>
                <span>Changes auto-save every 30 seconds</span>
            </div>
            <div class="info-item">
                <i class="fas fa-history"></i>
                <span>All changes are logged for audit</span>
            </div>
        </div>
        <div class="footer-actions">
            <button class="btn-secondary-elegant" @click="showPermissionManager = false">
                Close
            </button>
            <button class="btn-primary-elegant" @click="savePermissionChanges" :disabled="savingPermissions">
                <span v-if="savingPermissions" class="loading-spinner-small"></span>
                <span v-else>
                    <i class="fas fa-save"></i> Save All Changes
                </span>
            </button>
        </div>
    </div>
</div>


    <script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

// Supabase Configuration
const SUPABASE_URL = 'https://vssmguzuvekkecbmwcjw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzc21ndXp1dmVra2VjYm13Y2p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTI4NTIsImV4cCI6MjA4NDE2ODg1Mn0.8qPFsMEn4n5hDfxhgXvq2lQarts8OlL8hWiRYXb-vXw';

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false,
        storage: window.localStorage
    }
});

// Advanced DRBA Permission System
const PermissionSystem = {
    resources: {
        medical_staff: {
            name: 'Medical Staff',
            actions: ['create', 'read', 'update', 'delete', 'export'],
            description: 'Manage medical staff records'
        },
        training_units: {
            name: 'Training Units',
            actions: ['create', 'read', 'update', 'delete', 'assign'],
            description: 'Manage training units and capacities'
        },
        resident_rotations: {
            name: 'Resident Rotations',
            actions: ['create', 'read', 'update', 'delete', 'extend'],
            description: 'Manage resident rotation schedules'
        },
        placements: {
            name: 'Placements',
            actions: ['create', 'read', 'update', 'delete', 'drag_drop'],
            description: 'Assign residents to training units'
        },
        daily_operations: {
            name: 'Daily Operations',
            actions: ['read', 'update', 'alert'],
            description: 'View and manage daily operations'
        },
        oncall_schedule: {
            name: 'On-call Schedule',
            actions: ['create', 'read', 'update', 'delete', 'override'],
            description: 'Manage on-call schedules'
        },
        leave_requests: {
            name: 'Leave Requests',
            actions: ['create', 'read', 'update', 'approve', 'reject'],
            description: 'Manage leave requests and approvals'
        },
        announcements: {
            name: 'Announcements',
            actions: ['create', 'read', 'update', 'delete', 'publish'],
            description: 'Create and manage announcements'
        },
        audit: {
            name: 'Audit Logs',
            actions: ['read', 'export', 'clear'],
            description: 'View system audit logs'
        },
        system: {
            name: 'System Settings',
            actions: ['read', 'update', 'admin'],
            description: 'Manage system settings and permissions'
        }
    },

    roles: {
        system_admin: {
            name: 'System Administrator',
            level: 'full',
            description: 'Full system access and permission management',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: true, export: true },
                training_units: { create: true, read: true, update: true, delete: true, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: true, extend: true },
                placements: { create: true, read: true, update: true, delete: true, drag_drop: true },
                daily_operations: { read: true, update: true, alert: true },
                oncall_schedule: { create: true, read: true, update: true, delete: true, override: true },
                leave_requests: { create: true, read: true, update: true, approve: true, reject: true },
                announcements: { create: true, read: true, update: true, delete: true, publish: true },
                audit: { read: true, export: true, clear: true },
                system: { read: true, update: true, admin: true }
            }
        },
        department_head: {
            name: 'Head of Department',
            level: 'full',
            description: 'Department-wide oversight and management',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: false, export: true },
                training_units: { create: true, read: true, update: true, delete: false, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: false, extend: true },
                placements: { create: true, read: true, update: true, delete: false, drag_drop: true },
                daily_operations: { read: true, update: true, alert: true },
                oncall_schedule: { create: true, read: true, update: true, delete: false, override: true },
                leave_requests: { create: true, read: true, update: true, approve: true, reject: true },
                announcements: { create: true, read: true, update: true, delete: true, publish: true },
                audit: { read: true, export: true, clear: false },
                system: { read: true, update: false, admin: false }
            }
        },
        resident_manager: {
            name: 'Resident Manager',
            level: 'write',
            description: 'Manage residents and training units',
            permissions: {
                medical_staff: { create: true, read: true, update: true, delete: false, export: false },
                training_units: { create: true, read: true, update: true, delete: false, assign: true },
                resident_rotations: { create: true, read: true, update: true, delete: false, extend: true },
                placements: { create: true, read: true, update: true, delete: false, drag_drop: true },
                daily_operations: { read: true, update: true, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: true, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false }
            }
        },
        attending_physician: {
            name: 'Attending Physician',
            level: 'limited',
            description: 'Supervise residents and view schedules',
            permissions: {
                medical_staff: { create: false, read: true, update: false, delete: false, export: false },
                training_units: { create: false, read: true, update: false, delete: false, assign: false },
                resident_rotations: { create: false, read: true, update: false, delete: false, extend: false },
                placements: { create: false, read: true, update: false, delete: false, drag_drop: false },
                daily_operations: { read: true, update: false, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: true, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false }
            }
        },
        viewing_doctor: {
            name: 'Viewing Doctor',
            level: 'read',
            description: 'Read-only access to schedules and assignments',
            permissions: {
                medical_staff: { create: false, read: true, update: false, delete: false, export: false },
                training_units: { create: false, read: true, update: false, delete: false, assign: false },
                resident_rotations: { create: false, read: true, update: false, delete: false, extend: false },
                placements: { create: false, read: true, update: false, delete: false, drag_drop: false },
                daily_operations: { read: true, update: false, alert: false },
                oncall_schedule: { create: false, read: true, update: false, delete: false, override: false },
                leave_requests: { create: false, read: true, update: false, approve: false, reject: false },
                announcements: { create: false, read: true, update: false, delete: false, publish: false },
                audit: { read: false, export: false, clear: false },
                system: { read: false, update: false, admin: false }
            }
        }
    },

    // Check if user has permission for a resource action
    hasPermission(userRole, resource, action) {
        const role = this.roles[userRole];
        if (!role || !role.permissions[resource]) return false;
        return role.permissions[resource][action] === true;
    },

    // Get permission level for a resource
    getPermissionLevel(userRole, resource) {
        const role = this.roles[userRole];
        if (!role || !role.permissions[resource]) return 'none';
        
        const permissions = role.permissions[resource];
        if (permissions.create && permissions.update && permissions.delete) return 'full';
        if (permissions.create || permissions.update) return 'write';
        if (permissions.read) return 'read';
        return 'none';
    },

    // Get all resources user has access to
    getAccessibleResources(userRole) {
        const role = this.roles[userRole];
        if (!role) return [];
        
        return Object.keys(this.resources).filter(resource => 
            Object.values(role.permissions[resource] || {}).some(v => v === true)
        );
    }
};

// Create the Vue App
    const app = createApp({
    setup() {
        // ============ ADVANCED STATE MANAGEMENT ============
        const currentUser = ref(null);
        const loginForm = ref({
            email: '',
            password: '',
            user_role: 'resident_manager',
            require_mfa: false,
            mfa_code: ''
        });
        
        const loading = ref(false);
        const saving = ref(false);
        const permissionLoading = ref(false);
        const savingPermissions = ref(false);

        // Navigation states
        const currentView = ref('login');
        const sidebarCollapsed = ref(false);
        const mobileMenuOpen = ref(false);
        const showPermissionManager = ref(false);
        const searchQuery = ref('');
        const permissionFilter = ref([]);
        const userMenuOpen = ref(false);

        // Data stores
        const medicalStaff = ref([]);
        const trainingUnits = ref([]);
        const residentRotations = ref([]);
        const dailyAssignments = ref([]);
        const leaveRequests = ref([]);
        const onCallSchedule = ref([]);
        const announcements = ref([]);
        const auditLogs = ref([]);
        const systemRoles = ref([]);
        const systemSettings = ref({});
        const userNotifications = ref([]);
        const emergencyContacts = ref([]);
        
        const systemStats = ref({
            active_users: 0,
            total_staff: 0,
            today_assignments: 0,
            pending_approvals: 0
        });

        // Toast system
        const toasts = ref([]);
        let toastId = 0;

        // ============ MODAL STATES ============
        // Medical Staff Modal
        const medicalStaffModal = ref({
            show: false,
            mode: 'add',
            staff: null,
            form: {
                full_name: '',
                staff_type: 'medical_resident',
                staff_id: '',
                employment_status: 'active',
                can_supervise_residents: false,
                primary_clinic: '',
                professional_email: '',
                resident_category: '',
                training_year: null
            }
        });
        const quickPlacementModal = ref({
            show: false,
            form: {
                resident_id: '',
                unit_id: '',
                duration: 4
            }
        });

        // Add Role Modal
        const addRoleModal = ref({
            show: false,
            mode: 'add',
            role: null,
            form: {
                name: '',
                description: '',
                level: 'read'
            }
        });

        // Announcement Modal
        const announcementModal = ref({
            show: false,
            mode: 'add',
            announcement: null,
            form: {
                announcement_title: '',
                announcement_content: '',
                publish_start_date: '',
                publish_end_date: '',
                priority_level: 'medium',
                target_audience: 'all'
            }
        });

        // On-Call Schedule Modal
        const onCallModal = ref({
            show: false,
            mode: 'add',
            schedule: null,
            form: {
                duty_date: '',
                schedule_id: '',
                shift_type: 'backup_call',
                primary_physician_id: '',
                backup_physician_id: '',
                start_time: '08:00',
                end_time: '20:00',
                coverage_notes: ''
            }
        });

        // Training Unit Modal
        const trainingUnitModal = ref({
            show: false,
            mode: 'add',
            unit: null,
            form: {
                unit_name: '',
                unit_description: '',
                unit_status: 'active',
                maximum_residents: 10,
                specialty: '',
                current_residents: 0
            }
        });

        // Leave Request Modal
        const leaveRequestModal = ref({
            show: false,
            mode: 'add',
            request: null,
            form: {
                start_date: '',
                end_date: '',
                leave_type: 'vacation',
                reason: '',
                status: 'pending',
                approver_notes: ''
            }
        });

        // Resident Rotation Modal
        const rotationModal = ref({
            show: false,
            mode: 'add',
            rotation: null,
            form: {
                rotation_id: '',
                resident_id: '',
                training_unit_id: '',
                supervising_attending_id: '',
                rotation_start_date: '',
                rotation_end_date: '',
                rotation_category: 'clinical_rotation',
                rotation_status: 'scheduled',
                clinical_notes: '',
                supervisor_evaluation: ''
            }
        });

        // System Settings Modal
        const systemSettingsModal = ref({
            show: false,
            form: {
                hospital_name: 'PneumoCare Hospital',
                department_name: 'Pulmonary Medicine',
                max_residents_per_unit: 10,
                enable_audit_logging: true,
                require_mfa: false,
                maintenance_mode: false
            }
        });

        // User Profile Modal
        const userProfileModal = ref({
            show: false,
            form: {
                full_name: '',
                email: '',
                phone: '',
                department: '',
                notifications_enabled: true
            }
        });

        // Import/Export Modal
        const importExportModal = ref({
            show: false,
            mode: 'import', // 'import' or 'export'
            selectedTable: 'medical_staff',
            importFile: null,
            exportFormat: 'csv'
        });

        // Filter states
        const staffSearch = ref('');
        const staffFilter = ref({
            staff_type: '',
            employment_status: ''
        });
        const rotationFilter = ref({
            status: '',
            category: '',
            search: ''
        });

        // ============ PERMISSION SYSTEM ============
        const userPermissions = ref({});
        const permissionResources = ref(PermissionSystem.resources);

        // Initialize user permissions based on role
        const initializePermissions = (userRole) => {
            const role = PermissionSystem.roles[userRole];
            if (role) {
                userPermissions.value = role.permissions;
            }
            logAudit('PERMISSION_INIT', `Permissions initialized for ${userRole}`, 'system');
        };

        // FIXED: hasPermission function - now properly checks permissions
        const hasPermission = (resource, action) => {
            if (!currentUser.value) return false;
            
            // System admin always has permission
            if (currentUser.value.user_role === 'system_admin') {
                return true;
            }
            
            const role = PermissionSystem.roles[currentUser.value.user_role];
            if (!role || !role.permissions[resource]) {
                return false;
            }
            
            return role.permissions[resource][action] === true;
        };

        const hasAnyPermission = (resources) => {
            if (!currentUser.value) return false;
            return resources.some(resource => 
                Object.keys(userPermissions.value[resource] || {}).some(
                    action => userPermissions.value[resource][action]
                )
            );
        };

        const getViewPermission = (view) => {
            if (!currentUser.value) return 'none';
            
            const viewMap = {
                medical_staff: 'medical_staff',
                training_units: 'training_units',
                resident_rotations: 'resident_rotations',
                placements: 'placements',
                daily_operations: 'daily_operations',
                oncall_schedule: 'oncall_schedule',
                leave_requests: 'leave_requests',
                announcements: 'announcements',
                audit_logs: 'audit',
                department_overview: 'medical_staff',
                staff_management: 'medical_staff',
                schedule_approval: 'leave_requests',
                permission_management: 'system',
                system_settings: 'system'
            };
            
            const resource = viewMap[view];
            if (!resource) return 'none';
            
            return PermissionSystem.getPermissionLevel(currentUser.value.user_role, resource);
        };

        const getUserPermissionLevel = () => {
            if (!currentUser.value) return 'none';
            const role = PermissionSystem.roles[currentUser.value.user_role];
            return role ? role.level : 'none';
        };

        // FIXED: Permission toggle function that actually works
        const togglePermission = (roleId, resource, action) => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            const roleIndex = systemRoles.value.findIndex(r => r.id === roleId);
            if (roleIndex === -1) return;
            
            const currentState = systemRoles.value[roleIndex].permissions[resource]?.[action] || false;
            const newState = !currentState;
            
            // Update the role's permissions
            if (!systemRoles.value[roleIndex].permissions[resource]) {
                systemRoles.value[roleIndex].permissions[resource] = {};
            }
            systemRoles.value[roleIndex].permissions[resource][action] = newState;
            
            showAdvancedToast(
                'Permission Updated',
                `${action} permission for ${resource} ${newState ? 'granted' : 'revoked'}`,
                'permission'
            );
            
            logAudit('PERMISSION_TOGGLE', 
                `Toggled ${action} permission for ${resource} in role ${roleId} to ${newState}`, 
                'system'
            );
        };

        // Save permission changes to backend
        const savePermissionChanges = async () => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            savingPermissions.value = true;
            try {
                // In a real implementation, save to database
                // For demo, simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showAdvancedToast(
                    'Permissions Saved',
                    'All permission changes have been saved',
                    'success'
                );
                logAudit('PERMISSIONS_SAVED', 'Updated system permissions', 'system');
            } catch (error) {
                console.error('Error saving permissions:', error);
                showAdvancedToast('Save Failed', 'Failed to save permission changes', 'error');
            } finally {
                savingPermissions.value = false;
                showPermissionManager.value = false;
            }
        };

        const getResourcePermissionLevel = (resource) => {
            if (!currentUser.value) return 'none';
            return PermissionSystem.getPermissionLevel(currentUser.value.user_role, resource);
        };

        const getPermissionDescription = (resource, action) => {
            const descriptions = {
                create: 'Create new records',
                read: 'View records',
                update: 'Edit existing records',
                delete: 'Remove records',
                export: 'Export data',
                approve: 'Approve requests',
                override: 'Override restrictions'
            };
            return descriptions[action] || action;
        };

        const formatActionName = (action) => {
            return action.charAt(0).toUpperCase() + action.slice(1);
        };

        const formatResourceName = (resource) => {
            return resource.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        };

        // ============ AUDIT LOGGING SYSTEM ============
        const generateAuditId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        const logAudit = async (action, details, resource, resourceId = null) => {
            const logEntry = {
                id: generateAuditId(),
                timestamp: new Date().toISOString(),
                user_id: currentUser.value?.id,
                user_name: currentUser.value?.full_name,
                user_role: currentUser.value?.user_role,
                action,
                details,
                resource,
                resource_id: resourceId,
                permission_level: getUserPermissionLevel(),
                ip_address: 'system',
                user_agent: navigator.userAgent
            };
            
            auditLogs.value.unshift(logEntry);
            
            try {
                await supabaseClient.from('audit_logs').insert([logEntry]);
            } catch (error) {
                console.error('Failed to save audit log:', error);
            }
        };

        // ============ ADVANCED UTILITIES ============
        const showAdvancedToast = (title, message, type = 'info', duration = 5000) => {
            const icons = {
                info: 'fas fa-info-circle',
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                permission: 'fas fa-shield-alt'
            };
            
            const toast = {
                id: ++toastId,
                title,
                message,
                type,
                icon: icons[type] || icons.info,
                duration
            };
            
            toasts.value.push(toast);
            
            setTimeout(() => {
                removeToast(toast.id);
            }, duration);
        };

        const removeToast = (id) => {
            const index = toasts.value.findIndex(t => t.id === id);
            if (index > -1) {
                toasts.value.splice(index, 1);
            }
        };

        const getInitials = (name) => {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        };

        const formatDateTime = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatTimeRange = (start, end) => {
            const formatTime = (time) => {
                if (!time) return '';
                const [hours, minutes] = time.split(':');
                const hour = parseInt(hours);
                return `${hour % 12 || 12}:${minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
            };
            return `${formatTime(start)} - ${formatTime(end)}`;
        };

        const generateUUID = () => {
            return crypto.randomUUID();
        };

        const getUserRoleDisplay = (role) => {
            const roles = {
                resident_manager: 'Resident Manager',
                department_head: 'Head of Department',
                system_admin: 'System Administrator',
                viewing_doctor: 'Viewing Doctor',
                attending_physician: 'Attending Physician'
            };
            return roles[role] || role;
        };

        const formatStaffType = (type) => {
            const types = {
                medical_resident: 'Medical Resident',
                attending_physician: 'Attending Physician',
                fellow: 'Fellow',
                nurse_practitioner: 'Nurse Practitioner'
            };
            return types[type] || type;
        };

        const getStaffTypeClass = (type) => {
            return type === 'medical_resident' ? 'badge-resident-advanced' : 
                   type === 'attending_physician' ? 'badge-attending-advanced' : 
                   'badge-admin-advanced';
        };

        const getAuditIcon = (action) => {
            const icons = {
                CREATE: 'fas fa-plus-circle',
                UPDATE: 'fas fa-edit',
                DELETE: 'fas fa-trash',
                READ: 'fas fa-eye',
                LOGIN: 'fas fa-sign-in-alt',
                LOGOUT: 'fas fa-sign-out-alt',
                PERMISSION_CHANGE: 'fas fa-user-shield'
            };
            return icons[action] || 'fas fa-info-circle';
        };

        const formatResidentCategory = (category) => {
            if (!category || category === 'null' || category === null) return 'N/A';
            const categories = {
                department_internal: 'Department Internal',
                rotating_other_dept: 'Rotating Other Dept',
                pgy1: 'PGY-1',
                pgy2: 'PGY-2',
                pgy3: 'PGY-3',
                pgy4: 'PGY-4',
                pgy5: 'PGY-5'
            };
            return categories[category] || category;
        };

        const formatEmploymentStatus = (status) => {
            const statuses = {
                active: 'Active',
                on_leave: 'On Leave',
                inactive: 'Inactive'
            };
            return statuses[status] || status;
        };

        // ============ NEW HELPER FUNCTIONS ============
        const getResidentName = (residentId) => {
            const resident = medicalStaff.value.find(s => s.id === residentId);
            return resident ? resident.full_name : `Resident ${residentId?.substring(0, 8) || 'Unknown'}`;
        };

        const getTrainingUnitName = (unitId) => {
            const unit = trainingUnits.value.find(u => u.id === unitId);
            return unit ? unit.unit_name : `Unit ${unitId?.substring(0, 8) || 'Unknown'}`;
        };

        const getAttendingName = (attendingId) => {
            const attending = medicalStaff.value.find(s => s.id === attendingId && s.staff_type === 'attending_physician');
            return attending ? attending.full_name : `Attending ${attendingId?.substring(0, 8) || 'Unknown'}`;
        };

        const getAssignedResidents = (unitId) => {
            const rotationIds = residentRotations.value
                .filter(r => r.training_unit_id === unitId && (r.rotation_status === 'active' || r.rotation_status === 'scheduled'))
                .map(r => r.resident_id);
            
            return medicalStaff.value.filter(staff => 
                staff.staff_type === 'medical_resident' && rotationIds.includes(staff.id)
            );
        };

        const formatRotationCategory = (category) => {
            const categories = {
                clinical_rotation: 'Clinical Rotation',
                elective_rotation: 'Elective Rotation',
                research_rotation: 'Research',
                vacation_rotation: 'Vacation'
            };
            return categories[category] || category;
        };

        const getRotationCategoryClass = (category) => {
            return category === 'clinical_rotation' ? 'badge-attending-advanced' :
                   category === 'elective_rotation' ? 'badge-resident-advanced' :
                   category === 'research_rotation' ? 'badge-admin-advanced' :
                   'badge-supervisor-advanced';
        };

        const formatPriorityLevel = (priority) => {
            const priorities = {
                low: 'Low',
                medium: 'Medium',
                high: 'High',
                urgent: 'Urgent'
            };
            return priorities[priority] || priority;
        };

        const getPriorityClass = (priority) => {
            return priority === 'urgent' ? 'status-critical' :
                   priority === 'high' ? 'status-reported' :
                   priority === 'medium' ? 'status-oncall' :
                   'status-available';
        };

        const formatAudience = (audience) => {
            const audiences = {
                all: 'All Staff',
                residents: 'Residents Only',
                attendings: 'Attending Physicians',
                nursing: 'Nursing Staff'
            };
            return audiences[audience] || audience;
        };

        const formatDateShort = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        };

        // ============ COMPUTED PROPERTIES ============
        const stats = computed(() => {
            const residents = medicalStaff.value.filter(s => 
                s.staff_type === 'medical_resident' && s.employment_status === 'active'
            );
            const attendings = medicalStaff.value.filter(s => 
                s.staff_type === 'attending_physician' && s.employment_status === 'active'
            );
            const supervisors = medicalStaff.value.filter(s => 
                s.can_supervise_residents && s.employment_status === 'active'
            );
            
            return {
                totalStaff: medicalStaff.value.length,
                activeResidents: residents.length,
                attendings: attendings.length,
                availableSupervisors: supervisors.length
            };
        });

        const filteredMedicalStaff = computed(() => {
            let filtered = medicalStaff.value;
            
            if (staffSearch.value) {
                const search = staffSearch.value.toLowerCase();
                filtered = filtered.filter(s => 
                    s.full_name.toLowerCase().includes(search) ||
                    (s.staff_id && s.staff_id.toLowerCase().includes(search))
                );
            }
            
            if (staffFilter.value.staff_type) {
                filtered = filtered.filter(s => s.staff_type === staffFilter.value.staff_type);
            }
            
            if (staffFilter.value.employment_status) {
                filtered = filtered.filter(s => s.employment_status === staffFilter.value.employment_status);
            }
            
            return filtered;
        });

        const todaysAssignments = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return dailyAssignments.value
                .filter(a => a.assignment_date === today)
                .slice(0, 5);
        });

        const todaysOnCall = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return onCallSchedule.value
                .filter(o => o.duty_date === today)
                .slice(0, 3);
        });

        const recentAnnouncements = computed(() => {
            const today = new Date().toISOString().split('T')[0];
            return announcements.value
                .filter(a => a.publish_start_date <= today && (!a.publish_end_date || a.publish_end_date >= today))
                .slice(0, 3);
        });

        const coverageAlerts = computed(() => {
            return trainingUnits.value
                .filter(u => u.unit_status === 'active' && (u.current_residents || 0) < u.maximum_residents * 0.5)
                .map(u => ({
                    id: u.id,
                    unit_name: u.unit_name,
                    current: u.current_residents || 0,
                    capacity: u.maximum_residents,
                    priority: 'high'
                }));
        });

        const emergencyAlerts = computed(() => {
            return [
                {
                    id: 1,
                    title: 'ICU Capacity Warning',
                    message: 'ICU at 95% capacity - Consider diverting non-critical cases',
                    priority: 'high'
                }
            ];
        });

        const departmentStats = computed(() => {
            const activeStaff = medicalStaff.value.filter(s => s.employment_status === 'active').length;
            const activeUnits = trainingUnits.value.filter(u => u.unit_status === 'active').length;
            
            return {
                totalStaff: medicalStaff.value.length,
                activeUnits: activeUnits,
                coverageRate: medicalStaff.value.length > 0 ? Math.round((activeStaff / medicalStaff.value.length) * 100) : 0,
                pendingApprovals: leaveRequests.value.filter(r => r.status === 'pending').length
            };
        });

        const nextSevenDays = computed(() => {
            const days = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                
                const schedule = onCallSchedule.value.find(o => o.duty_date === dateString);
                
                days.push({
                    date: dateString,
                    schedule: schedule,
                    status: schedule ? 'covered' : 'uncovered'
                });
            }
            
            return days;
        });
        
        const filteredRotations = computed(() => {
            let filtered = residentRotations.value;
            
            if (rotationFilter.value.status) {
                filtered = filtered.filter(r => r.rotation_status === rotationFilter.value.status);
            }
            
            if (rotationFilter.value.category) {
                filtered = filtered.filter(r => r.rotation_category === rotationFilter.value.category);
            }
            
            if (rotationFilter.value.search) {
                const search = rotationFilter.value.search.toLowerCase();
                filtered = filtered.filter(r => 
                    r.rotation_id.toLowerCase().includes(search) ||
                    getResidentName(r.resident_id).toLowerCase().includes(search) ||
                    getTrainingUnitName(r.training_unit_id).toLowerCase().includes(search)
                );
            }
            
            return filtered;
        });

        const availableResidents = computed(() => {
            const residentsInRotations = new Set(
                residentRotations.value
                    .filter(r => r.rotation_status === 'active' || r.rotation_status === 'scheduled')
                    .map(r => r.resident_id)
            );
            
            return medicalStaff.value.filter(staff => 
                staff.staff_type === 'medical_resident' && 
                staff.employment_status === 'active' &&
                !residentsInRotations.has(staff.id)
            );
        });

        const pendingSchedules = computed(() => {
            return residentRotations.value.filter(r => 
                r.rotation_status === 'pending_approval' || 
                (r.approval_status && r.approval_status === 'pending')
            );
        });

        const departmentAnalytics = computed(() => {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const recentRotations = residentRotations.value.filter(r => 
                new Date(r.rotation_start_date) >= thirtyDaysAgo
            );
            
            const activeStaff = medicalStaff.value.filter(s => 
                s.employment_status === 'active'
            ).length;
            
            // Calculate occupancy rate
            let totalCapacity = 0;
            let totalOccupied = 0;
            trainingUnits.value.forEach(unit => {
                totalCapacity += unit.maximum_residents || 0;
                totalOccupied += unit.current_residents || 0;
            });
            
            const occupancyRate = totalCapacity > 0 ? Math.round((totalOccupied / totalCapacity) * 100) : 0;
            
            return {
                recentRotations: recentRotations.length,
                activeStaff: activeStaff,
                occupancyRate: occupancyRate,
                complianceRate: 95 // Mock data
            };
        });

        // ============ NEW COMPUTED PROPERTIES ============
        const unreadNotifications = computed(() => {
            return userNotifications.value.filter(n => !n.read).length;
        });

        const criticalAlerts = computed(() => {
            return emergencyAlerts.value.filter(a => a.priority === 'high' || a.priority === 'urgent');
        });

        const staffByDepartment = computed(() => {
            const departments = {};
            medicalStaff.value.forEach(staff => {
                const dept = staff.primary_clinic || 'Unassigned';
                if (!departments[dept]) {
                    departments[dept] = [];
                }
                departments[dept].push(staff);
            });
            return departments;
        });

        // ============ NAVIGATION & UI ============
        const switchView = async (view) => {
            currentView.value = view;
            closeMobileMenu();
            logAudit('VIEW_CHANGE', `Switched to ${view} view`, 'navigation');
            
            await loadViewData(view);
        };

        const getCurrentTitle = () => {
            const titles = {
                medical_staff: 'Medical Staff Management',
                training_units: 'Training Units',
                daily_operations: 'Daily Operations Board',
                permission_management: 'Permission Management',
                audit_logs: 'Audit Logs',
                oncall_schedule: 'On-call Schedule',
                leave_requests: 'Leave Requests',
                department_overview: 'Department Overview',
                staff_management: 'Staff Management',
                schedule_approval: 'Schedule Approval',
                system_settings: 'System Settings',
                user_profile: 'User Profile'
            };
            return titles[currentView.value] || 'PneumoCare';
        };

        const getCurrentSubtitle = () => {
            const subtitles = {
                medical_staff: 'Manage medical staff with advanced permissions',
                daily_operations: 'Real-time department operations dashboard',
                permission_management: 'Configure system permissions and roles',
                audit_logs: 'Track all system activities and changes',
                oncall_schedule: 'Manage on-call duties and coverage',
                leave_requests: 'Review and approve leave requests',
                department_overview: 'Department analytics and insights',
                system_settings: 'Configure system-wide settings'
            };
            return subtitles[currentView.value] || 'Advanced DRBA Hospital Management System';
        };

        const getSearchPlaceholder = () => {
            const placeholders = {
                medical_staff: 'Search medical staff by name, ID, or department...',
                daily_operations: 'Search assignments, alerts, or announcements...',
                audit_logs: 'Search audit logs by user, action, or resource...',
                training_units: 'Search training units by name or specialty...',
                resident_rotations: 'Search rotations by resident, unit, or ID...'
            };
            return placeholders[currentView.value] || 'Search...';
        };

        const toggleMobileMenu = () => {
            mobileMenuOpen.value = !mobileMenuOpen.value;
        };

        const closeMobileMenu = () => {
            mobileMenuOpen.value = false;
        };

        const togglePermissionManager = () => {
            showPermissionManager.value = !showPermissionManager.value;
            userMenuOpen.value = false;
            if (showPermissionManager.value) {
                loadSystemRoles();
                logAudit('PERMISSION_MANAGER_OPEN', 'Opened permission manager', 'system');
            }
        };

        const toggleUserMenu = () => {
            userMenuOpen.value = !userMenuOpen.value;
        };

        const getDayStatus = (day) => {
            return day.status === 'covered' ? 'status-available' : 'status-critical';
        };

        // ============ AUTHENTICATION ============
        const handleAdvancedLogin = async () => {
            loading.value = true;
            
            try {
                const email = loginForm.value.email.trim().toLowerCase();
                const password = loginForm.value.password;
                const selectedRole = loginForm.value.user_role;
                
                if (!email || !password || !selectedRole) {
                    throw new Error('Please fill in all fields');
                }
                
                // For demo purposes, we'll use mock authentication
                const mockUsers = {
                    'admin@hospital.org': { role: 'system_admin', name: 'System Administrator' },
                    'head@hospital.org': { role: 'department_head', name: 'Department Head' },
                    'manager@hospital.org': { role: 'resident_manager', name: 'Resident Manager' },
                    'doctor@hospital.org': { role: 'viewing_doctor', name: 'Viewing Doctor' }
                };
                
                let userData;
                
                if (email in mockUsers && password === 'password123') {
                    userData = {
                        id: generateUUID(),
                        email: email,
                        full_name: mockUsers[email].name,
                        user_role: mockUsers[email].role,
                        account_status: 'active'
                    };
                } else {
                    // Try to get from app_users table
                    const { data: existingUser } = await supabaseClient
                        .from('app_users')
                        .select('*')
                        .eq('email', email)
                        .maybeSingle();
                    
                    if (existingUser) {
                        userData = existingUser;
                    } else {
                        // Create new user for demo
                        userData = {
                            id: generateUUID(),
                            email: email,
                            full_name: email.split('@')[0].replace(/\./g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            user_role: selectedRole,
                            account_status: 'active'
                        };
                        
                        // Save to database
                        await supabaseClient.from('app_users').insert([userData]);
                    }
                }
                
                currentUser.value = userData;
                initializePermissions(userData.user_role);
                
                // Load user-specific data
                await loadCurrentUserProfile();
                await loadUserNotifications();
                
                showAdvancedToast(
                    'Login Successful',
                    `Welcome ${userData.full_name}!`,
                    'success'
                );
                
                logAudit('LOGIN_SUCCESS', `User logged in as ${userData.user_role}`, 'auth', userData.id);
                
                await loadInitialData();
                
                // Set initial view based on permissions
                if (hasPermission('daily_operations', 'read')) {
                    currentView.value = 'daily_operations';
                } else if (hasPermission('medical_staff', 'read')) {
                    currentView.value = 'medical_staff';
                } else {
                    currentView.value = 'daily_operations';
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showAdvancedToast(
                    'Login Failed',
                    error.message || 'Invalid credentials',
                    'error'
                );
                logAudit('LOGIN_FAILED', `Failed login attempt: ${error.message}`, 'auth');
            } finally {
                loading.value = false;
            }
        };

        const handleLogout = async () => {
            try {
                logAudit('LOGOUT', 'User logged out', 'auth');
                currentUser.value = null;
                currentView.value = 'login';
                userMenuOpen.value = false;
                showAdvancedToast('Logged Out', 'You have been successfully logged out', 'info');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // ============ DATA LOADING ============
        const loadInitialData = async () => {
            loading.value = true;
            try {
                await Promise.all([
                    loadMedicalStaff(),
                    loadTrainingUnits(),
                    loadResidentRotations(),
                    loadLeaveRequests(),
                    loadDailyAssignments(),
                    loadOnCallSchedule(),
                    loadAnnouncements(),
                    loadAuditLogs(),
                    loadSystemStats(),
                    loadEmergencyContacts(),
                    loadSystemSettings()
                ]);
                
                showAdvancedToast('System Ready', 'All data loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAdvancedToast('Data Load Error', 'Failed to load system data', 'error');
            } finally {
                loading.value = false;
            }
        };

        const loadViewData = async (view) => {
            try {
                switch (view) {
                    case 'medical_staff':
                        await loadMedicalStaff();
                        break;
                    case 'training_units':
                        await loadTrainingUnits();
                        break;
                    case 'daily_operations':
                        await Promise.all([
                            loadDailyAssignments(),
                            loadOnCallSchedule(),
                            loadAnnouncements()
                        ]);
                        break;
                    case 'audit_logs':
                        await loadAuditLogs();
                        break;
                    case 'leave_requests':
                        await loadLeaveRequests();
                        break;
                    case 'oncall_schedule':
                        await loadOnCallSchedule();
                        break;
                    case 'resident_rotations':
                        await loadResidentRotations();
                        break;
                    case 'department_overview':
                        await loadDepartmentAnalytics();
                        break;
                    case 'system_settings':
                        await loadSystemSettings();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${view} data:`, error);
            }
        };

        // ============ API FUNCTIONS ============
        const loadMedicalStaff = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('medical_staff')
                    .select('*')
                    .order('full_name');
                
                if (error) throw error;
                medicalStaff.value = data || [];
            } catch (error) {
                console.error('Error loading medical staff:', error);
                // For demo, create mock data
                medicalStaff.value = [
                    {
                        id: '1',
                        full_name: 'Dr. Sarah Chen',
                        staff_type: 'attending_physician',
                        staff_id: 'ATT-001',
                        employment_status: 'active',
                        can_supervise_residents: true,
                        primary_clinic: 'Pulmonary Unit',
                        professional_email: 's.chen@hospital.org',
                        resident_category: null,
                        training_year: null
                    },
                    {
                        id: '2',
                        full_name: 'Dr. Michael Rodriguez',
                        staff_type: 'medical_resident',
                        staff_id: 'RES-001',
                        employment_status: 'active',
                        can_supervise_residents: false,
                        primary_clinic: 'ICU',
                        professional_email: 'm.rodriguez@hospital.org',
                        resident_category: 'pgy3',
                        training_year: 2024
                    }
                ];
            }
        };

        const loadTrainingUnits = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('training_units')
                    .select('*')
                    .order('unit_name');
                
                if (error) throw error;
                trainingUnits.value = data || [];
            } catch (error) {
                console.error('Error loading training units:', error);
                // Mock data
                trainingUnits.value = [
                    {
                        id: '1',
                        unit_name: 'Pulmonary Unit',
                        unit_description: 'Specializes in pulmonary diseases and critical care',
                        unit_status: 'active',
                        maximum_residents: 8,
                        current_residents: 6,
                        specialty: 'Pulmonology'
                    },
                    {
                        id: '2',
                        unit_name: 'ICU',
                        unit_description: 'Intensive Care Unit for critical patients',
                        unit_status: 'active',
                        maximum_residents: 12,
                        current_residents: 9,
                        specialty: 'Critical Care'
                    }
                ];
            }
        };

        const loadResidentRotations = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('resident_rotations')
                    .select('*')
                    .order('rotation_start_date', { ascending: false });
                
                if (error) throw error;
                residentRotations.value = data || [];
            } catch (error) {
                console.error('Error loading resident rotations:', error);
                residentRotations.value = [];
            }
        };

        const loadLeaveRequests = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('leave_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                leaveRequests.value = data || [];
            } catch (error) {
                console.error('Error loading leave requests:', error);
                leaveRequests.value = [];
            }
        };

        const loadDailyAssignments = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('daily_assignments')
                    .select('*')
                    .order('assignment_date', { ascending: false });
                
                if (error) throw error;
                dailyAssignments.value = data || [];
            } catch (error) {
                console.error('Error loading daily assignments:', error);
                dailyAssignments.value = [];
            }
        };

        const loadOnCallSchedule = async () => {
            try {
                console.log(' Loading on-call schedule...');
                
                const { data, error } = await supabaseClient
                    .from('oncall_schedule')
                    .select('*')
                    .order('duty_date', { ascending: true });
                
                if (error) {
                    console.error(' Error loading on-call schedule:', error);
                    throw error;
                }
                
                console.log(' Loaded on-call schedule data:', data);
                onCallSchedule.value = data || [];
                
            } catch (error) {
                console.error(' Failed to load on-call schedule:', error);
                onCallSchedule.value = [];
            }
        };

        const loadAnnouncements = async () => {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('department_announcements')
                    .select('*')
                    .lte('publish_start_date', today)
                    .or(`publish_end_date.is.null,publish_end_date.gte.${today}`)
                    .order('priority_level', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                announcements.value = data || [];
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcements.value = [];
            }
        };

        const loadAuditLogs = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('audit_logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                auditLogs.value = data || [];
            } catch (error) {
                console.error('Error loading audit logs:', error);
                auditLogs.value = [];
            }
        };

        const loadSystemStats = async () => {
            systemStats.value = {
                active_users: 42,
                total_staff: medicalStaff.value.length,
                today_assignments: todaysAssignments.value.length,
                pending_approvals: leaveRequests.value.filter(r => r.status === 'pending').length
            };
        };

        const loadSystemRoles = () => {
            systemRoles.value = Object.entries(PermissionSystem.roles).map(([id, role]) => ({
                id,
                ...role
            }));
        };

        // ============ NEW DATA LOADING FUNCTIONS ============
        const loadSystemSettings = async () => {
            try {
                // For demo, use default settings
                systemSettings.value = {
                    hospital_name: 'PneumoCare Hospital',
                    department_name: 'Pulmonary Medicine',
                    max_residents_per_unit: 10,
                    enable_audit_logging: true,
                    require_mfa: false,
                    maintenance_mode: false,
                    email_notifications: true,
                    sms_alerts: false
                };
            } catch (error) {
                console.error('Error loading system settings:', error);
                systemSettings.value = {};
            }
        };

        const loadCurrentUserProfile = async () => {
            if (!currentUser.value) return;
            
            try {
                // In a real app, load from database
                // For demo, just set basic info
                if (!currentUser.value.phone) {
                    currentUser.value.phone = '+1 (555) 123-4567';
                }
                if (!currentUser.value.department) {
                    currentUser.value.department = 'Pulmonary Medicine';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        };

        const loadUserNotifications = async () => {
            try {
                // For demo, create mock notifications
                userNotifications.value = [
                    {
                        id: '1',
                        title: 'New Rotation Assigned',
                        message: 'You have been assigned to ICU rotation starting next week',
                        type: 'info',
                        read: false,
                        created_at: new Date().toISOString()
                    },
                    {
                        id: '2',
                        title: 'Leave Request Approved',
                        message: 'Your vacation request for Dec 15-22 has been approved',
                        type: 'success',
                        read: true,
                        created_at: new Date(Date.now() - 86400000).toISOString()
                    }
                ];
            } catch (error) {
                console.error('Error loading notifications:', error);
                userNotifications.value = [];
            }
        };

        const loadEmergencyContacts = async () => {
            try {
                // For demo, create mock contacts
                emergencyContacts.value = [
                    {
                        id: '1',
                        contact_name: 'Hospital Security',
                        phone: '+1 (555) 911-0000',
                        email: 'security@hospital.org',
                        department: 'Security',
                        emergency_type: 'security'
                    },
                    {
                        id: '2',
                        contact_name: 'IT Support',
                        phone: '+1 (555) 555-1234',
                        email: 'it-support@hospital.org',
                        department: 'IT',
                        emergency_type: 'technical'
                    }
                ];
            } catch (error) {
                console.error('Error loading emergency contacts:', error);
                emergencyContacts.value = [];
            }
        };

        const loadDepartmentAnalytics = async () => {
            // This would normally load analytics from the database
            // For demo, use computed properties
            return departmentAnalytics.value;
        };

        // ============ MEDICAL STAFF CRUD ============
        const showAddMedicalStaffModal = () => {
            if (!hasPermission('medical_staff', 'create')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need create permission to add medical staff',
                    'permission'
                );
                return;
            }
            
            medicalStaffModal.value = {
                show: true,
                mode: 'add',
                staff: null,
                form: {
                    full_name: '',
                    staff_type: 'medical_resident',
                    staff_id: `MD-${Date.now().toString().slice(-6)}`,
                    employment_status: 'active',
                    can_supervise_residents: false,
                    primary_clinic: '',
                    professional_email: '',
                    resident_category: '',
                    training_year: new Date().getFullYear()
                }
            };
            
            logAudit('STAFF_MODAL_OPEN', 'Opened add medical staff modal', 'medical_staff');
        };

        const editMedicalStaff = (staff) => {
            if (!hasPermission('medical_staff', 'update')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need update permission to edit medical staff',
                    'permission'
                );
                return;
            }
            
            medicalStaffModal.value = {
                show: true,
                mode: 'edit',
                staff: staff,
                form: { ...staff }
            };
            
            logAudit('STAFF_EDIT', `Editing staff member: ${staff.full_name}`, 'medical_staff', staff.id);
        };

        const saveMedicalStaff = async () => {
            if (!hasPermission('medical_staff', medicalStaffModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                // Validate form
                if (!medicalStaffModal.value.form.full_name.trim()) {
                    throw new Error('Full name is required');
                }
                
                if (medicalStaffModal.value.mode === 'add') {
                    // Add new staff
                    const { data, error } = await supabaseClient
                        .from('medical_staff')
                        .insert([{
                            ...medicalStaffModal.value.form,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    medicalStaff.value.unshift(data);
                    showAdvancedToast('Success', 'Medical staff added successfully', 'success');
                    logAudit('STAFF_CREATE', `Added: ${data.full_name}`, 'medical_staff', data.id);
                } else {
                    // Update existing staff
                    const { data, error } = await supabaseClient
                        .from('medical_staff')
                        .update({
                            ...medicalStaffModal.value.form,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', medicalStaffModal.value.staff.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update in local array
                    const index = medicalStaff.value.findIndex(s => s.id === data.id);
                    if (index !== -1) {
                        medicalStaff.value[index] = data;
                    }
                    
                    showAdvancedToast('Success', 'Medical staff updated successfully', 'success');
                    logAudit('STAFF_UPDATE', `Updated: ${data.full_name}`, 'medical_staff', data.id);
                }
                
                medicalStaffModal.value.show = false;
            } catch (error) {
                console.error('Error saving medical staff:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const deleteMedicalStaff = async (staff) => {
            if (!hasPermission('medical_staff', 'delete')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need delete permission to remove medical staff',
                    'permission'
                );
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${staff.full_name}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('medical_staff')
                    .delete()
                    .eq('id', staff.id);
                
                if (error) throw error;
                
                // Remove from local array
                const index = medicalStaff.value.findIndex(s => s.id === staff.id);
                if (index !== -1) {
                    medicalStaff.value.splice(index, 1);
                }
                
                showAdvancedToast('Deleted', `${staff.full_name} has been removed`, 'success');
                logAudit('STAFF_DELETE', `Deleted: ${staff.full_name}`, 'medical_staff', staff.id);
            } catch (error) {
                console.error('Error deleting medical staff:', error);
                showAdvancedToast('Delete Failed', error.message, 'error');
            }
        };

        // ============ ANNOUNCEMENTS MODAL FUNCTIONS ============
        const showAddAnnouncementModal = () => {
            if (!hasPermission('announcements', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            announcementModal.value = {
                show: true,
                mode: 'add',
                announcement: null,
                form: {
                    announcement_title: '',
                    announcement_content: '',
                    publish_start_date: today,
                    publish_end_date: '',
                    priority_level: 'medium',
                    target_audience: 'all'
                }
            };
        };

        const editAnnouncement = (announcement) => {
            if (!hasPermission('announcements', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            announcementModal.value = {
                show: true,
                mode: 'edit',
                announcement: announcement,
                form: {
                    announcement_title: announcement.announcement_title,
                    announcement_content: announcement.announcement_content,
                    publish_start_date: announcement.publish_start_date,
                    publish_end_date: announcement.publish_end_date || '',
                    priority_level: announcement.priority_level || 'medium',
                    target_audience: announcement.target_audience || 'all'
                }
            };
        };

        const saveAnnouncement = async () => {
            if (!hasPermission('announcements', announcementModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!announcementModal.value.form.announcement_title.trim()) {
                    throw new Error('Title is required');
                }
                if (!announcementModal.value.form.announcement_content.trim()) {
                    throw new Error('Content is required');
                }
                if (!announcementModal.value.form.publish_start_date) {
                    throw new Error('Publish date is required');
                }
                
                const announcementData = {
                    announcement_title: announcementModal.value.form.announcement_title,
                    announcement_content: announcementModal.value.form.announcement_content,
                    publish_start_date: announcementModal.value.form.publish_start_date,
                    publish_end_date: announcementModal.value.form.publish_end_date || null,
                    priority_level: announcementModal.value.form.priority_level,
                    target_audience: announcementModal.value.form.target_audience,
                    created_by: currentUser.value?.full_name,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (announcementModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('department_announcements')
                        .insert([{
                            ...announcementData,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    announcements.value.unshift(result);
                    showAdvancedToast('Published', 'Announcement published successfully', 'success');
                    logAudit('ANNOUNCEMENT_CREATE', `Published: ${result.announcement_title}`, 'announcements', result.id);
                    
                } else {
                    const { data, error } = await supabaseClient
                        .from('department_announcements')
                        .update(announcementData)
                        .eq('id', announcementModal.value.announcement.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    const index = announcements.value.findIndex(a => a.id === result.id);
                    if (index !== -1) announcements.value[index] = result;
                    
                    showAdvancedToast('Updated', 'Announcement updated successfully', 'success');
                    logAudit('ANNOUNCEMENT_UPDATE', `Updated: ${result.announcement_title}`, 'announcements', result.id);
                }
                
                announcementModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving announcement:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const deleteAnnouncement = async (announcement) => {
            if (!hasPermission('announcements', 'delete')) {
                showAdvancedToast('Permission Denied', 'Need delete permission', 'permission');
                return;
            }
            
            if (!confirm(`Delete announcement "${announcement.announcement_title}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('department_announcements')
                    .delete()
                    .eq('id', announcement.id);
                
                if (error) throw error;
                
                announcements.value = announcements.value.filter(a => a.id !== announcement.id);
                
                showAdvancedToast('Deleted', 'Announcement deleted', 'success');
                logAudit('ANNOUNCEMENT_DELETE', `Deleted: ${announcement.announcement_title}`, 'announcements', announcement.id);
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showAdvancedToast('Delete Failed', error.message, 'error');
            }
        };

        // ============ LEAVE REQUESTS MODAL FUNCTIONS ============
        const showAddLeaveRequestModal = () => {
            if (!hasPermission('leave_requests', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            // Set default dates (next week)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const startDate = new Date().toISOString().split('T')[0];
            const endDate = nextWeek.toISOString().split('T')[0];
            
            leaveRequestModal.value = {
                show: true,
                mode: 'add',
                request: null,
                form: {
                    start_date: startDate,
                    end_date: endDate,
                    leave_type: 'vacation',
                    reason: '',
                    status: 'pending',
                    approver_notes: ''
                }
            };
        };

        const viewLeaveRequestDetails = (request) => {
            leaveRequestModal.value = {
                show: true,
                mode: 'review',
                request: request,
                form: {
                    start_date: request.start_date,
                    end_date: request.end_date,
                    leave_type: request.leave_type,
                    reason: request.reason,
                    status: request.status,
                    approver_notes: request.approver_notes || ''
                }
            };
        };

        const approveLeaveRequest = async (request) => {
            if (!hasPermission('leave_requests', 'approve')) {
                showAdvancedToast('Permission Denied', 'Need approve permission', 'permission');
                return;
            }
            
            if (!confirm(`Approve leave request for ${request.staff_name}?`)) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('leave_requests')
                    .update({
                        status: 'approved',
                        approver_notes: `Approved by ${currentUser.value.full_name}`,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', request.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update local state
                const index = leaveRequests.value.findIndex(r => r.id === data.id);
                if (index !== -1) leaveRequests.value[index] = data;
                
                showAdvancedToast('Approved', `Leave request approved`, 'success');
                logAudit('LEAVE_APPROVE', `Approved leave request for ${request.staff_name}`, 'leave_requests', request.id);
                
            } catch (error) {
                console.error('Error approving leave:', error);
                showAdvancedToast('Approval Failed', error.message, 'error');
            }
        };

        const rejectLeaveRequest = async (request) => {
            if (!hasPermission('leave_requests', 'reject')) {
                showAdvancedToast('Permission Denied', 'Need reject permission', 'permission');
                return;
            }
            
            if (!confirm(`Reject leave request for ${request.staff_name}?`)) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('leave_requests')
                    .update({
                        status: 'rejected',
                        approver_notes: `Rejected by ${currentUser.value.full_name}`,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', request.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update local state
                const index = leaveRequests.value.findIndex(r => r.id === data.id);
                if (index !== -1) leaveRequests.value[index] = data;
                
                showAdvancedToast('Rejected', `Leave request rejected`, 'error');
                logAudit('LEAVE_REJECT', `Rejected leave request for ${request.staff_name}`, 'leave_requests', request.id);
                
            } catch (error) {
                console.error('Error rejecting leave:', error);
                showAdvancedToast('Rejection Failed', error.message, 'error');
            }
        };

        const saveLeaveRequest = async () => {
            saving.value = true;
            try {
                if (!leaveRequestModal.value.form.start_date || !leaveRequestModal.value.form.end_date) {
                    throw new Error('Start and end dates are required');
                }
                
                if (leaveRequestModal.value.mode === 'add') {
                    // Add new leave request
                    if (!hasPermission('leave_requests', 'create')) {
                        throw new Error('No permission to create leave requests');
                    }
                    
                    const { data, error } = await supabaseClient
                        .from('leave_requests')
                        .insert([{
                            staff_id: currentUser.value.id,
                            staff_name: currentUser.value.full_name,
                            start_date: leaveRequestModal.value.form.start_date,
                            end_date: leaveRequestModal.value.form.end_date,
                            leave_type: leaveRequestModal.value.form.leave_type,
                            reason: leaveRequestModal.value.form.reason,
                            status: 'pending',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    leaveRequests.value.unshift(data);
                    showAdvancedToast('Success', 'Leave request submitted', 'success');
                    logAudit('LEAVE_CREATE', `Submitted leave request`, 'leave_requests', data.id);
                    
                } else {
                    // Update/review existing request
                    if (!hasPermission('leave_requests', 'update')) {
                        throw new Error('No permission to update leave requests');
                    }
                    
                    const { data, error } = await supabaseClient
                        .from('leave_requests')
                        .update({
                            status: leaveRequestModal.value.form.status,
                            approver_notes: leaveRequestModal.value.form.approver_notes,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', leaveRequestModal.value.request.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local state
                    const index = leaveRequests.value.findIndex(r => r.id === data.id);
                    if (index !== -1) leaveRequests.value[index] = data;
                    
                    showAdvancedToast('Success', 'Leave request updated', 'success');
                    logAudit('LEAVE_UPDATE', `Updated leave request status to ${data.status}`, 'leave_requests', data.id);
                }
                
                leaveRequestModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving leave request:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ RESIDENT ROTATIONS MODAL FUNCTIONS ============
        const showAddRotationModal = () => {
            if (!hasPermission('resident_rotations', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            // Generate rotation ID
            const date = new Date();
            const rotationId = `ROT-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            
            // Set default dates (next month)
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + 30);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 90);
            
            rotationModal.value = {
                show: true,
                mode: 'add',
                rotation: null,
                form: {
                    rotation_id: rotationId,
                    resident_id: '',
                    training_unit_id: '',
                    supervising_attending_id: '',
                    rotation_start_date: startDate.toISOString().split('T')[0],
                    rotation_end_date: endDate.toISOString().split('T')[0],
                    rotation_category: 'clinical_rotation',
                    rotation_status: 'scheduled',
                    clinical_notes: '',
                    supervisor_evaluation: ''
                }
            };
        };

        const editRotation = (rotation) => {
            if (!hasPermission('resident_rotations', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            rotationModal.value = {
                show: true,
                mode: 'edit',
                rotation: rotation,
                form: {
                    rotation_id: rotation.rotation_id,
                    resident_id: rotation.resident_id,
                    training_unit_id: rotation.training_unit_id,
                    supervising_attending_id: rotation.supervising_attending_id || '',
                    rotation_start_date: rotation.rotation_start_date,
                    rotation_end_date: rotation.rotation_end_date,
                    rotation_category: rotation.rotation_category,
                    rotation_status: rotation.rotation_status,
                    clinical_notes: rotation.clinical_notes || '',
                    supervisor_evaluation: rotation.supervisor_evaluation || ''
                }
            };
        };

        const extendRotation = (rotation) => {
            if (!hasPermission('resident_rotations', 'extend')) {
                showAdvancedToast('Permission Denied', 'Need extend permission', 'permission');
                return;
            }
            
            // Copy rotation and extend end date by 30 days
            const newEndDate = new Date(rotation.rotation_end_date);
            newEndDate.setDate(newEndDate.getDate() + 30);
            
            rotationModal.value = {
                show: true,
                mode: 'edit',
                rotation: rotation,
                form: {
                    rotation_id: rotation.rotation_id + '-EXT',
                    resident_id: rotation.resident_id,
                    training_unit_id: rotation.training_unit_id,
                    supervising_attending_id: rotation.supervising_attending_id || '',
                    rotation_start_date: rotation.rotation_end_date, // Start from previous end date
                    rotation_end_date: newEndDate.toISOString().split('T')[0],
                    rotation_category: rotation.rotation_category,
                    rotation_status: 'scheduled',
                    clinical_notes: 'Extended rotation - ' + rotation.clinical_notes,
                    supervisor_evaluation: ''
                }
            };
        };

        const saveRotation = async () => {
            const permissionNeeded = rotationModal.value.mode === 'add' ? 'create' : 'update';
            if (!hasPermission('resident_rotations', permissionNeeded)) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                // Validate
                if (!rotationModal.value.form.rotation_id) throw new Error('Rotation ID required');
                if (!rotationModal.value.form.resident_id) throw new Error('Resident ID required');
                if (!rotationModal.value.form.training_unit_id) throw new Error('Training Unit ID required');
                if (!rotationModal.value.form.rotation_start_date) throw new Error('Start date required');
                if (!rotationModal.value.form.rotation_end_date) throw new Error('End date required');
                
                const rotationData = {
                    rotation_id: rotationModal.value.form.rotation_id,
                    resident_id: rotationModal.value.form.resident_id,
                    training_unit_id: rotationModal.value.form.training_unit_id,
                    supervising_attending_id: rotationModal.value.form.supervising_attending_id || null,
                    rotation_start_date: rotationModal.value.form.rotation_start_date,
                    rotation_end_date: rotationModal.value.form.rotation_end_date,
                    rotation_category: rotationModal.value.form.rotation_category,
                    rotation_status: rotationModal.value.form.rotation_status,
                    clinical_notes: rotationModal.value.form.clinical_notes,
                    supervisor_evaluation: rotationModal.value.form.supervisor_evaluation,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (rotationModal.value.mode === 'add') {
                    // Add new rotation
                    const { data, error } = await supabaseClient
                        .from('resident_rotations')
                        .insert([{
                            ...rotationData,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    residentRotations.value.unshift(result);
                    showAdvancedToast('Success', 'Rotation scheduled successfully', 'success');
                    logAudit('ROTATION_CREATE', `Created rotation ${rotationData.rotation_id}`, 'resident_rotations', result.id);
                    
                } else {
                    // Update existing rotation
                    const { data, error } = await supabaseClient
                        .from('resident_rotations')
                        .update(rotationData)
                        .eq('id', rotationModal.value.rotation.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    // Update local state
                    const index = residentRotations.value.findIndex(r => r.id === result.id);
                    if (index !== -1) residentRotations.value[index] = result;
                    
                    showAdvancedToast('Success', 'Rotation updated successfully', 'success');
                    logAudit('ROTATION_UPDATE', `Updated rotation ${rotationData.rotation_id}`, 'resident_rotations', result.id);
                }
                
                rotationModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving rotation:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // Drag & drop placement function
        const handleDragDropPlacement = async (residentId, unitId) => {
            if (!hasPermission('placements', 'drag_drop')) {
                showAdvancedToast('Permission Denied', 'Need drag & drop permission', 'permission');
                return;
            }
            
            try {
                const rotationId = `PLACEMENT-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random()*1000)}`;
                const startDate = new Date().toISOString().split('T')[0];
                const endDate = new Date();
                endDate.setMonth(endDate.getMonth() + 3);
                
                const { data, error } = await supabaseClient
                    .from('resident_rotations')
                    .insert([{
                        rotation_id: rotationId,
                        resident_id: residentId,
                        training_unit_id: unitId,
                        rotation_start_date: startDate,
                        rotation_end_date: endDate.toISOString().split('T')[0],
                        rotation_category: 'clinical_rotation',
                        rotation_status: 'scheduled',
                        clinical_notes: 'Placed via drag & drop',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                residentRotations.value.unshift(data);
                showAdvancedToast('Placement Created', 'Resident placed in unit via drag & drop', 'success');
                logAudit('PLACEMENT_CREATE', `Drag & drop placement created`, 'placements', data.id);
                
            } catch (error) {
                console.error('Drag & drop error:', error);
                showAdvancedToast('Placement Failed', error.message, 'error');
            }
        };

        // ============ TRAINING UNIT FUNCTIONS ============
        const showAddTrainingUnitModal = () => {
            if (!hasPermission('training_units', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            trainingUnitModal.value = {
                show: true,
                mode: 'add',
                unit: null,
                form: {
                    unit_name: '',
                    unit_description: '',
                    unit_status: 'active',
                    maximum_residents: 10,
                    specialty: '',
                    current_residents: 0
                }
            };
        };

        const editTrainingUnit = (unit) => {
            if (!hasPermission('training_units', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            trainingUnitModal.value = {
                show: true,
                mode: 'edit',
                unit: unit,
                form: { ...unit }
            };
        };

        const saveTrainingUnit = async () => {
            if (!hasPermission('training_units', trainingUnitModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!trainingUnitModal.value.form.unit_name.trim()) {
                    throw new Error('Unit name required');
                }
                
                const unitData = {
                    ...trainingUnitModal.value.form,
                    updated_at: new Date().toISOString()
                };
                
                if (trainingUnitModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('training_units')
                        .insert([{
                            ...unitData,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    trainingUnits.value.unshift(data);
                    showAdvancedToast('Success', 'Training unit added', 'success');
                    logAudit('TRAINING_UNIT_CREATE', `Added unit: ${unitData.unit_name}`, 'training_units', data.id);
                } else {
                    const { data, error } = await supabaseClient
                        .from('training_units')
                        .update(unitData)
                        .eq('id', trainingUnitModal.value.unit.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    const index = trainingUnits.value.findIndex(u => u.id === data.id);
                    if (index !== -1) trainingUnits.value[index] = data;
                    showAdvancedToast('Success', 'Training unit updated', 'success');
                    logAudit('TRAINING_UNIT_UPDATE', `Updated unit: ${unitData.unit_name}`, 'training_units', data.id);
                }
                
                trainingUnitModal.value.show = false;
            } catch (error) {
                console.error('Error saving training unit:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ ON-CALL SCHEDULE FUNCTIONS ============
        const showAddOnCallModal = () => {
            if (!hasPermission('oncall_schedule', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateString = tomorrow.toISOString().split('T')[0];
            
            onCallModal.value = {
                show: true,
                mode: 'add',
                schedule: null,
                form: {
                    duty_date: dateString,
                    schedule_id: `ONCALL-${dateString.replace(/-/g, '')}-001`,
                    shift_type: 'backup_call',
                    primary_physician_id: '',
                    backup_physician_id: '',
                    start_time: '08:00',
                    end_time: '20:00',
                    coverage_notes: ''
                }
            };
        };

        const editOnCallSchedule = (day) => {
            if (!hasPermission('oncall_schedule', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission', 'permission');
                return;
            }
            
            if (!day.schedule) {
                onCallModal.value = {
                    show: true,
                    mode: 'add',
                    schedule: null,
                    form: {
                        duty_date: day.date,
                        schedule_id: `ONCALL-${day.date.replace(/-/g, '')}-001`,
                        shift_type: 'backup_call',
                        primary_physician_id: '',
                        backup_physician_id: '',
                        start_time: '08:00',
                        end_time: '20:00',
                        coverage_notes: ''
                    }
                };
                return;
            }
            
            onCallModal.value = {
                show: true,
                mode: 'edit',
                schedule: day.schedule,
                form: {
                    duty_date: day.schedule.duty_date,
                    schedule_id: day.schedule.schedule_id,
                    shift_type: day.schedule.shift_type || 'backup_call',
                    primary_physician_id: day.schedule.primary_physician_id,
                    backup_physician_id: day.schedule.backup_physician_id || '',
                    start_time: day.schedule.start_time?.slice(0, 5) || '08:00',
                    end_time: day.schedule.end_time?.slice(0, 5) || '20:00',
                    coverage_notes: day.schedule.coverage_notes || ''
                }
            };
        };

        const saveOnCallSchedule = async () => {
            if (!hasPermission('oncall_schedule', onCallModal.value.mode === 'add' ? 'create' : 'update')) {
                showAdvancedToast('Permission Denied', 'Insufficient permissions', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!onCallModal.value.form.duty_date) throw new Error('Date required');
                if (!onCallModal.value.form.primary_physician_id) throw new Error('Primary physician required');
                
                const scheduleData = {
                    duty_date: onCallModal.value.form.duty_date,
                    schedule_id: onCallModal.value.form.schedule_id,
                    shift_type: onCallModal.value.form.shift_type,
                    primary_physician_id: onCallModal.value.form.primary_physician_id,
                    backup_physician_id: onCallModal.value.form.backup_physician_id || null,
                    start_time: onCallModal.value.form.start_time + ':00',
                    end_time: onCallModal.value.form.end_time + ':00',
                    coverage_notes: onCallModal.value.form.coverage_notes,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (onCallModal.value.mode === 'add') {
                    const { data, error } = await supabaseClient
                        .from('oncall_schedule')
                        .insert([{
                            ...scheduleData,
                            created_at: new Date().toISOString(),
                            created_by: currentUser.value?.id
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    onCallSchedule.value.push(result);
                    showAdvancedToast('Success', 'On-call schedule created', 'success');
                    
                } else {
                    const { data, error } = await supabaseClient
                        .from('oncall_schedule')
                        .update(scheduleData)
                        .eq('id', onCallModal.value.schedule.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    result = data;
                    
                    const index = onCallSchedule.value.findIndex(s => s.id === result.id);
                    if (index !== -1) onCallSchedule.value[index] = result;
                    
                    showAdvancedToast('Success', 'On-call schedule updated', 'success');
                }
                
                onCallModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving on-call schedule:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const overrideOnCall = (day) => {
            if (!hasPermission('oncall_schedule', 'override')) {
                showAdvancedToast('Permission Denied', 'Need override permission', 'permission');
                return;
            }
            
            if (!confirm(`Emergency override for ${formatDate(day.date)}?`)) return;
            
            onCallModal.value = {
                show: true,
                mode: 'add',
                schedule: null,
                form: {
                    duty_date: day.date,
                    schedule_id: `EMERGENCY-${day.date.replace(/-/g, '')}-${Date.now().toString().slice(-4)}`,
                    shift_type: 'backup_call',
                    primary_physician_id: '',
                    backup_physician_id: '',
                    start_time: '00:00',
                    end_time: '23:59',
                    coverage_notes: 'EMERGENCY OVERRIDE'
                }
            };
        };

        // ============ DRAG & DROP FUNCTIONS ============
        const handleDragStart = (event, resident) => {
            event.dataTransfer.setData('text/plain', resident.id);
            event.dataTransfer.effectAllowed = 'move';
        };

        const handleDrop = async (event, unit) => {
            event.preventDefault();
            
            const residentId = event.dataTransfer.getData('text/plain');
            if (!residentId || !unit) return;
            
            if (!hasPermission('placements', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission for placements', 'permission');
                return;
            }
            
            try {
                await handleDragDropPlacement(residentId, unit.id);
                
                // Update unit current residents count
                const unitIndex = trainingUnits.value.findIndex(u => u.id === unit.id);
                if (unitIndex !== -1) {
                    trainingUnits.value[unitIndex].current_residents = 
                        (trainingUnits.value[unitIndex].current_residents || 0) + 1;
                }
                
                const residentName = getResidentName(residentId);
                showAdvancedToast('Placement Created', `${residentName} assigned to ${unit.unit_name}`, 'success');
                
            } catch (error) {
                console.error('Drop error:', error);
                showAdvancedToast('Placement Failed', error.message, 'error');
            }
        };

        const removePlacement = async (residentId, unitId) => {
            if (!hasPermission('placements', 'delete')) {
                showAdvancedToast('Permission Denied', 'Need delete permission', 'permission');
                return;
            }
            
            const residentName = getResidentName(residentId);
            const unitName = getTrainingUnitName(unitId);
            
            if (!confirm(`Remove ${residentName} from ${unitName}?`)) return;
            
            try {
                // Find and update the rotation status
                const rotationIndex = residentRotations.value.findIndex(r => 
                    r.resident_id === residentId && 
                    r.training_unit_id === unitId && 
                    (r.rotation_status === 'active' || r.rotation_status === 'scheduled')
                );
                
                if (rotationIndex !== -1) {
                    const rotation = residentRotations.value[rotationIndex];
                    
                    const { data, error } = await supabaseClient
                        .from('resident_rotations')
                        .update({
                            rotation_status: 'cancelled',
                            clinical_notes: (rotation.clinical_notes || '') + '\nRemoved via placement interface',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', rotation.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local state
                    residentRotations.value[rotationIndex] = data;
                    
                    // Update unit current residents count
                    const unitIndex = trainingUnits.value.findIndex(u => u.id === unitId);
                    if (unitIndex !== -1) {
                        trainingUnits.value[unitIndex].current_residents = 
                            Math.max(0, (trainingUnits.value[unitIndex].current_residents || 0) - 1);
                    }
                    
                    showAdvancedToast('Placement Removed', `${residentName} removed from ${unitName}`, 'success');
                    logAudit('PLACEMENT_REMOVE', `Removed resident ${residentName} from unit ${unitName}`, 'placements', rotation.id);
                }
                
            } catch (error) {
                console.error('Error removing placement:', error);
                showAdvancedToast('Removal Failed', error.message, 'error');
            }
        };

        // ============ QUICK PLACEMENT MODAL FUNCTIONS ============
        const showQuickPlacementModal = () => {
            if (!hasPermission('placements', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission for placements', 'permission');
                return;
            }
            
            quickPlacementModal.value = {
                show: true,
                form: {
                    resident_id: '',
                    unit_id: '',
                    duration: 4
                }
            };
        };

        const saveQuickPlacement = async () => {
            if (!hasPermission('placements', 'create')) {
                showAdvancedToast('Permission Denied', 'Need create permission', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                if (!quickPlacementModal.value.form.resident_id || !quickPlacementModal.value.form.unit_id) {
                    throw new Error('Please select both resident and unit');
                }
                
                // Create a new rotation
                const rotationId = `PLACEMENT-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random()*1000)}`;
                const startDate = new Date().toISOString().split('T')[0];
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + (quickPlacementModal.value.form.duration * 7));
                
                const { data, error } = await supabaseClient
                    .from('resident_rotations')
                    .insert([{
                        rotation_id: rotationId,
                        resident_id: quickPlacementModal.value.form.resident_id,
                        training_unit_id: quickPlacementModal.value.form.unit_id,
                        rotation_start_date: startDate,
                        rotation_end_date: endDate.toISOString().split('T')[0],
                        rotation_category: 'clinical_rotation',
                        rotation_status: 'scheduled',
                        clinical_notes: 'Placed via quick placement',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Add to local state
                residentRotations.value.unshift(data);
                
                // Update unit current residents count
                const unitIndex = trainingUnits.value.findIndex(u => u.id === quickPlacementModal.value.form.unit_id);
                if (unitIndex !== -1) {
                    trainingUnits.value[unitIndex].current_residents = 
                        (trainingUnits.value[unitIndex].current_residents || 0) + 1;
                }
                
                showAdvancedToast('Success', 'Resident placed successfully', 'success');
                logAudit('QUICK_PLACEMENT', `Quick placement created for resident`, 'placements', data.id);
                
                quickPlacementModal.value.show = false;
                
            } catch (error) {
                console.error('Error saving quick placement:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ DELETE ROTATION FUNCTION ============
        const deleteRotation = async (rotation) => {
            if (!hasPermission('resident_rotations', 'delete')) {
                showAdvancedToast('Permission Denied', 'Need delete permission', 'permission');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete rotation "${rotation.rotation_id}"?`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('resident_rotations')
                    .delete()
                    .eq('id', rotation.id);
                
                if (error) throw error;
                
                // Remove from local array
                const index = residentRotations.value.findIndex(r => r.id === rotation.id);
                if (index !== -1) {
                    residentRotations.value.splice(index, 1);
                }
                
                showAdvancedToast('Deleted', `Rotation ${rotation.rotation_id} has been removed`, 'success');
                logAudit('ROTATION_DELETE', `Deleted rotation: ${rotation.rotation_id}`, 'resident_rotations', rotation.id);
            } catch (error) {
                console.error('Error deleting rotation:', error);
                showAdvancedToast('Delete Failed', error.message, 'error');
            }
        };

        // ============ ROLE MANAGEMENT ============
        const showAddRoleModal = () => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            addRoleModal.value = {
                show: true,
                mode: 'add',
                role: null,
                form: {
                    name: '',
                    description: '',
                    level: 'read'
                }
            };
        };

        const editRole = (role) => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            addRoleModal.value = {
                show: true,
                mode: 'edit',
                role: role,
                form: {
                    name: role.name,
                    description: role.description,
                    level: role.level
                }
            };
        };

        const cloneRole = (role) => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            addRoleModal.value = {
                show: true,
                mode: 'add',
                role: null,
                form: {
                    name: `${role.name} (Copy)`,
                    description: role.description,
                    level: role.level
                }
            };
        };

        const deleteRole = (role) => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            if (role.id === 'system_admin') {
                showAdvancedToast('Cannot Delete', 'System Admin role cannot be deleted', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the "${role.name}" role?`)) {
                systemRoles.value = systemRoles.value.filter(r => r.id !== role.id);
                showAdvancedToast('Role Deleted', `${role.name} has been removed`, 'success');
                logAudit('ROLE_DELETE', `Deleted role: ${role.name}`, 'system');
            }
        };

        const saveRole = async () => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                const newRole = {
                    id: addRoleModal.value.mode === 'add' ? 
                        addRoleModal.value.form.name.toLowerCase().replace(/\s+/g, '_') : 
                        addRoleModal.value.role.id,
                    name: addRoleModal.value.form.name,
                    description: addRoleModal.value.form.description,
                    level: addRoleModal.value.form.level,
                    permissions: {}
                };
                
                // Copy permissions from a similar role
                const templateRole = PermissionSystem.roles[addRoleModal.value.form.level === 'full' ? 'system_admin' : 'resident_manager'];
                if (templateRole) {
                    newRole.permissions = { ...templateRole.permissions };
                }
                
                if (addRoleModal.value.mode === 'add') {
                    systemRoles.value.push(newRole);
                    showAdvancedToast('Success', 'New role created successfully', 'success');
                    logAudit('ROLE_CREATE', `Created role: ${newRole.name}`, 'system');
                } else {
                    const index = systemRoles.value.findIndex(r => r.id === newRole.id);
                    if (index !== -1) {
                        systemRoles.value[index] = newRole;
                    }
                    showAdvancedToast('Success', 'Role updated successfully', 'success');
                    logAudit('ROLE_UPDATE', `Updated role: ${newRole.name}`, 'system');
                }
                
                addRoleModal.value.show = false;
            } catch (error) {
                console.error('Error saving role:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ SYSTEM SETTINGS FUNCTIONS ============
        const showSystemSettingsModal = () => {
            if (!hasPermission('system', 'read')) {
                showAdvancedToast('Permission Denied', 'Need read permission for system settings', 'permission');
                return;
            }
            
            systemSettingsModal.value = {
                show: true,
                form: { ...systemSettings.value }
            };
        };

        const saveSystemSettings = async () => {
            if (!hasPermission('system', 'update')) {
                showAdvancedToast('Permission Denied', 'Need update permission for system settings', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                // In a real app, save to database
                // For demo, update local state
                systemSettings.value = { ...systemSettingsModal.value.form };
                
                showAdvancedToast('Settings Saved', 'System settings updated successfully', 'success');
                logAudit('SETTINGS_UPDATE', 'Updated system settings', 'system');
                
                systemSettingsModal.value.show = false;
            } catch (error) {
                console.error('Error saving system settings:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ USER PROFILE FUNCTIONS ============
        const showUserProfileModal = () => {
            userProfileModal.value = {
                show: true,
                form: {
                    full_name: currentUser.value?.full_name || '',
                    email: currentUser.value?.email || '',
                    phone: currentUser.value?.phone || '',
                    department: currentUser.value?.department || '',
                    notifications_enabled: true
                }
            };
            userMenuOpen.value = false;
        };

        const saveUserProfile = async () => {
            saving.value = true;
            try {
                // Update current user
                currentUser.value = {
                    ...currentUser.value,
                    ...userProfileModal.value.form
                };
                
                showAdvancedToast('Profile Updated', 'Your profile has been updated', 'success');
                logAudit('PROFILE_UPDATE', 'Updated user profile', 'user_profile');
                
                userProfileModal.value.show = false;
            } catch (error) {
                console.error('Error saving profile:', error);
                showAdvancedToast('Save Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        // ============ IMPORT/EXPORT FUNCTIONS ============
        const showImportExportModal = (mode = 'export', table = null) => {
            if (mode === 'export' && !hasPermission('audit', 'export')) {
                showAdvancedToast('Permission Denied', 'Need export permission', 'permission');
                return;
            }
            
            if (mode === 'import' && !hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required for import', 'permission');
                return;
            }
            
            importExportModal.value = {
                show: true,
                mode: mode,
                selectedTable: table || 'medical_staff',
                importFile: null,
                exportFormat: 'csv'
            };
        };

        const exportData = async () => {
            if (!hasPermission('audit', 'export')) {
                showAdvancedToast('Permission Denied', 'Need export permission', 'permission');
                return;
            }
            
            saving.value = true;
            try {
                let data = [];
                let filename = '';
                
                switch (importExportModal.value.selectedTable) {
                    case 'medical_staff':
                        data = medicalStaff.value;
                        filename = 'medical_staff';
                        break;
                    case 'training_units':
                        data = trainingUnits.value;
                        filename = 'training_units';
                        break;
                    case 'resident_rotations':
                        data = residentRotations.value;
                        filename = 'resident_rotations';
                        break;
                    case 'audit_logs':
                        data = auditLogs.value;
                        filename = 'audit_logs';
                        break;
                    default:
                        throw new Error('Invalid table selected');
                }
                
                if (data.length === 0) {
                    throw new Error('No data to export');
                }
                
                // Convert to CSV
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(row => 
                    Object.values(row).map(value => 
                        typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value
                    ).join(',')
                );
                
                const csvContent = [headers, ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAdvancedToast('Export Complete', `${data.length} records exported`, 'success');
                logAudit('DATA_EXPORT', `Exported ${filename} data`, 'export');
                
                importExportModal.value.show = false;
            } catch (error) {
                console.error('Error exporting data:', error);
                showAdvancedToast('Export Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const importData = async () => {
            if (!hasPermission('system', 'admin')) {
                showAdvancedToast('Permission Denied', 'Admin access required', 'permission');
                return;
            }
            
            if (!importExportModal.value.importFile) {
                showAdvancedToast('Import Failed', 'Please select a file', 'error');
                return;
            }
            
            saving.value = true;
            try {
                const file = importExportModal.value.importFile;
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        const data = lines.slice(1)
                            .filter(line => line.trim())
                            .map(line => {
                                const values = line.split(',');
                                const obj = {};
                                headers.forEach((header, index) => {
                                    let value = values[index] || '';
                                    value = value.trim().replace(/^"|"$/g, '');
                                    
                                    // Parse numbers and booleans
                                    if (!isNaN(value) && value !== '') {
                                        value = Number(value);
                                    } else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                                        value = value.toLowerCase() === 'true';
                                    }
                                    
                                    obj[header] = value;
                                });
                                return obj;
                            });
                        
                        // Insert data into database
                        const { error } = await supabaseClient
                            .from(importExportModal.value.selectedTable)
                            .insert(data);
                        
                        if (error) throw error;
                        
                        // Reload the data
                        await loadViewData(importExportModal.value.selectedTable.replace('_', ''));
                        
                        showAdvancedToast('Import Successful', `${data.length} records imported`, 'success');
                        logAudit('DATA_IMPORT', `Imported ${data.length} records to ${importExportModal.value.selectedTable}`, 'import');
                        
                        importExportModal.value.show = false;
                    } catch (error) {
                        console.error('Error processing import:', error);
                        showAdvancedToast('Import Failed', error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing data:', error);
                showAdvancedToast('Import Failed', error.message, 'error');
            } finally {
                saving.value = false;
            }
        };

        const handleFileSelect = (event) => {
            importExportModal.value.importFile = event.target.files[0];
        };

        // ============ NOTIFICATION FUNCTIONS ============
        const markNotificationAsRead = (notificationId) => {
            const index = userNotifications.value.findIndex(n => n.id === notificationId);
            if (index !== -1) {
                userNotifications.value[index].read = true;
            }
        };

        const markAllNotificationsAsRead = () => {
            userNotifications.value.forEach(n => n.read = true);
            showAdvancedToast('Notifications Cleared', 'All notifications marked as read', 'success');
        };

        // ============ ACTION HANDLERS ============
        const viewStaffSchedule = (staff) => {
            showAdvancedToast('Info', `Viewing schedule for ${staff.full_name}`, 'info');
            logAudit('SCHEDULE_VIEW', `Viewed schedule for ${staff.full_name}`, 'schedules', staff.id);
        };

        const quickAssignToUnit = (alert) => {
            if (!hasPermission('placements', 'create')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need create permission to assign residents',
                    'permission'
                );
                return;
            }
            
            showAdvancedToast('Assign', `Assigning residents to ${alert.unit_name}`, 'info');
            logAudit('QUICK_ASSIGN', `Quick assigning to unit: ${alert.unit_name}`, 'placements', alert.id);
        };

        const exportAuditLogs = () => {
            if (!hasPermission('audit', 'export')) {
                showAdvancedToast(
                    'Permission Denied',
                    'You need export permission to download audit logs',
                    'permission'
                );
                return;
            }
            
            showImportExportModal('export', 'audit_logs');
        };

        const handleAdvancedSearch = () => {
            logAudit('SEARCH', `Searched for: ${searchQuery.value}`, 'system');
        };

        const togglePermissionFilter = (level) => {
            const index = permissionFilter.value.indexOf(level);
            if (index > -1) {
                permissionFilter.value.splice(index, 1);
            } else {
                permissionFilter.value.push(level);
            }
        };

        const showUserProfile = () => {
            userMenuOpen.value = false;
            showUserProfileModal();
        };

        const assignResidentsToUnit = (unit) => {
            showAdvancedToast('Info', `Assigning residents to ${unit.unit_name}`, 'info');
        };

        const showAddStaffModal = () => {
            showAdvancedToast('Info', 'Add staff modal would open here', 'info');
        };

        // ============ INITIALIZATION ============
        onMounted(() => {
            // Check for existing session
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('Existing session found');
                }
            }).catch(error => {
                console.error('Error getting session:', error);
            });
            
            // Load system roles
            loadSystemRoles();
        });

        // ============ RETURN ============
        return {
            // ============ STATE ============
            // User & Auth
            currentUser,
            loginForm,
            loading,
            saving,
            permissionLoading,
            savingPermissions,
            
            // Navigation
            currentView,
            sidebarCollapsed,
            mobileMenuOpen,
            showPermissionManager,
            searchQuery,
            permissionFilter,
            userMenuOpen,
            
            // ============ MODAL STATES ============
            medicalStaffModal,
            addRoleModal,
            announcementModal,
            onCallModal,
            leaveRequestModal,
            trainingUnitModal,
            rotationModal,
            quickPlacementModal,
            systemSettingsModal,
            userProfileModal,
            importExportModal,
            
            // ============ DATA STORES ============
            medicalStaff,
            trainingUnits,
            residentRotations,
            dailyAssignments,
            leaveRequests,
            onCallSchedule,
            announcements,
            auditLogs,
            systemRoles,
            systemSettings,
            userNotifications,
            emergencyContacts,
            systemStats,
            
            // ============ FILTER & SEARCH ============
            staffSearch,
            staffFilter,
            rotationFilter,
            
            // ============ UI STATES ============
            toasts,
            permissionResources,
            
            // ============ COMPUTED PROPERTIES ============
            stats,
            filteredMedicalStaff,
            todaysAssignments,
            todaysOnCall,
            recentAnnouncements,
            coverageAlerts,
            emergencyAlerts,
            departmentStats,
            nextSevenDays,
            filteredRotations,
            availableResidents,
            pendingSchedules,
            departmentAnalytics,
            unreadNotifications,
            criticalAlerts,
            staffByDepartment,
            
            // ============ PERMISSION SYSTEM ============
            hasPermission,
            hasAnyPermission,
            getViewPermission,
            getUserPermissionLevel,
            getResourcePermissionLevel,
            getPermissionDescription,
            formatActionName,
            formatResourceName,
            userPermissions,
            togglePermission,
            savePermissionChanges,
            
            // ============ NAVIGATION ============
            switchView,
            getCurrentTitle,
            getCurrentSubtitle,
            getSearchPlaceholder,
            toggleMobileMenu,
            closeMobileMenu,
            togglePermissionManager,
            toggleUserMenu,
            getDayStatus,
            
            // ============ AUTHENTICATION ============
            handleAdvancedLogin,
            handleLogout,
            
            // ============ UTILITIES ============
            getInitials,
            formatDate,
            formatDateTime,
            formatTimeRange,
            getUserRoleDisplay,
            formatStaffType,
            getStaffTypeClass,
            getAuditIcon,
            formatResidentCategory,
            formatEmploymentStatus,
            generateUUID,
            showAdvancedToast,
            
            // ============ HELPER FUNCTIONS ============
            getResidentName,
            getTrainingUnitName,
            getAttendingName,
            getAssignedResidents,
            formatRotationCategory,
            getRotationCategoryClass,
            formatPriorityLevel,
            getPriorityClass,
            formatAudience,
            formatDateShort,
            
            // ============ MEDICAL STAFF ============
            showAddMedicalStaffModal,
            editMedicalStaff,
            saveMedicalStaff,
            deleteMedicalStaff,
            viewStaffSchedule,
            
            // ============ ROLE MANAGEMENT ============
            showAddRoleModal,
            editRole,
            cloneRole,
            deleteRole,
            saveRole,
            
            // ============ ANNOUNCEMENTS ===========
            showAddAnnouncementModal,
            editAnnouncement,
            saveAnnouncement,
            deleteAnnouncement,
            
            // ============ ON-CALL SCHEDULE ============
            showAddOnCallModal,
            editOnCallSchedule,
            saveOnCallSchedule,
            overrideOnCall,
            
            // ============ LEAVE REQUESTS ============
            showAddLeaveRequestModal,
            viewLeaveRequestDetails,
            approveLeaveRequest,
            rejectLeaveRequest,
            saveLeaveRequest,
            
            // ============ TRAINING UNITS ============
            showAddTrainingUnitModal,
            editTrainingUnit,
            saveTrainingUnit,
            assignResidentsToUnit,
            
            // ============ RESIDENT ROTATIONS ============
            showAddRotationModal,
            editRotation,
            extendRotation,
            saveRotation,
            handleDragDropPlacement,
            deleteRotation,
            
            // ============ DRAG & DROP ============
            handleDragStart,
            handleDrop,
            removePlacement,
            
            // ============ QUICK PLACEMENT ============
            showQuickPlacementModal,
            saveQuickPlacement,
            
            // ============ SYSTEM SETTINGS ============
            showSystemSettingsModal,
            saveSystemSettings,
            
            // ============ USER PROFILE ============
            showUserProfileModal,
            saveUserProfile,
            
            // ============ IMPORT/EXPORT ============
            showImportExportModal,
            exportData,
            importData,
            handleFileSelect,
            
            // ============ NOTIFICATIONS ============
            markNotificationAsRead,
            markAllNotificationsAsRead,
            
            // ============ ACTIONS ============
            quickAssignToUnit,
            exportAuditLogs,
            handleAdvancedSearch,
            togglePermissionFilter,
            showUserProfile,
            
            // ============ STAFF MANAGEMENT ============
            showAddStaffModal,
            
            // ============ DATA LOADING ============
            loadInitialData,
            loadViewData,
            
            // ============ AUDIT LOGGING ============
            logAudit,
                  // ============ TOAST SYSTEM ============
            removeToast
        };
    }
});

app.mount('#app');
</script>
</body>
</html>
